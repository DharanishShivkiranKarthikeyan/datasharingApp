import{getAuth as ge,GoogleAuthProvider as K,signInWithPopup as fe,onAuthStateChanged as me,signInWithRedirect as re,signOut as ye}from"https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";import{getFirestore as we,getDocs as z,collection as H,doc as v,setDoc as E,updateDoc as Q,increment as be,getDoc as se}from"https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";import"https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/+esm";import ie from"https://cdn.jsdelivr.net/npm/peerjs@1.5.4/+esm";import{initializeApp as xe}from"https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function t(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=t(r);fetch(r.href,s)}})();const Be="modulepreload",Ie=function(n){return"/datasharingApp/"+n},V={},ke=function(e,t,o){let r=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),a=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));r=Promise.allSettled(t.map(c=>{if(c=Ie(c),c in V)return;V[c]=!0;const l=c.endsWith(".css"),h=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${h}`))return;const p=document.createElement("link");if(p.rel=l?"stylesheet":Be,l||(p.as="script"),p.crossOrigin="",p.href=c,a&&p.setAttribute("nonce",a),document.head.appendChild(p),l)return new Promise((m,b)=>{p.addEventListener("load",m),p.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${c}`)))})}))}function s(i){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=i,window.dispatchEvent(a),!a.defaultPrevented)throw i}return r.then(i=>{for(const a of i||[])a.status==="rejected"&&s(a.reason);return e().catch(s)})},ve={apiKey:"AIzaSyBrdrwvY-lPObZgortEgw7YWycUOGsBlyM",authDomain:"dcrypt-edb9c.firebaseapp.com",projectId:"dcrypt-edb9c",storageBucket:"dcrypt-edb9c.firebasestorage.app",messagingSenderId:"952133736604",appId:"1:952133736604:web:32d799360f200bce84f559",measurementId:"G-7KCDLQ6JNH"},ae=xe(ve),ce=ge(ae),N=we(ae),Se=Object.freeze(Object.defineProperty({__proto__:null,auth:ce,db:N},Symbol.toStringTag,{value:"Module"}));var oe;const $=(oe=globalThis.crypto)==null?void 0:oe.subtle;if(!$)throw new Error("Web Crypto API is not available in this environment");function De(){const n=new Uint8Array(12);for(let e=0;e<12;e++)n[e]=Math.floor(Math.random()*256);return n}function Pe(n,e,t,o,r,s,i){return{content:new Uint8Array(n),content_type:e,tags:t||[],is_premium:o,price_usd:r,creator_id:new Uint8Array(s),file_type:i}}function Ee(n){return n.content}async function le(n){const e=await $.digest("SHA-256",n);return new Uint8Array(e)}async function $e(n,e,t){const o=n.content,r=Math.ceil(o.length/t),s=[],i=await $.importKey("raw",new Uint8Array(e.slice(0,32)),{name:"AES-GCM"},!1,["encrypt"]);for(let a=0;a<t;a++){const c=a*r,l=Math.min(c+r,o.length),h=o.slice(c,l),p=De(),m=await $.encrypt({name:"AES-GCM",iv:p},i,h),b={data:new Uint8Array(m),nonce:p,index:a,file_type:n.file_type};s.push(b)}return s}function Ce(n){const e=new Uint8Array(new Int32Array([n.index]).buffer),t=new Uint8Array([...n.data,...n.nonce,...e]);return le(t)}function Y(n){return n.index}async function Ae(n,e){const t=await $.importKey("raw",new Uint8Array(e.slice(0,32)),{name:"AES-GCM"},!1,["decrypt"]),o=await $.decrypt({name:"AES-GCM",iv:n.nonce},t,n.data);return new Uint8Array(o)}function Te(n){return n.file_type}class de{constructor(e,t=!1){this.peers=new Map,this.channels=new Map,this.knownObjects=new Map,this.chunkToPeerMap=new Map,this.pendingRequests=new Map,this.db=null,this.keypair=e,this.activeNodes=new Set,this.nodes=new Set,this.offlineQueue=[],this.isNode=t,this.peerId=null,this.peer=null,this.connectionAttempts=new Map,this.maxConnectionAttempts=3,this.connectionRetryDelay=5e3,this.averageLatency=0,this.initializeKnownNodes()}async initializeKnownNodes(){const e=async()=>{try{const t=await z(H(N,"nodes"));this.nodes.clear(),t.empty?console.warn("No nodes found in Firestore. Using empty node list."):t.forEach(o=>{const r=`node-${o.id}`;this.nodes.add(r)}),console.log("Fetched nodes:",Array.from(this.nodes))}catch(t){console.error("Failed to fetch nodes from Firestore:",t),this.nodes.clear(),console.warn("No nodes available. Peer discovery will be limited to regular peers.")}};await e(),setInterval(e,5*60*1e3)}async measureLatency(){const e=[],t=Array.from(this.activeNodes).slice(0,5);for(const o of t){const r=this.peers.get(o);if(r&&r.connected&&r.conn){const s=Date.now();await new Promise(a=>{const c=`${o}-ping-${Date.now()}`;r.conn.send({type:"ping",requestId:c}),this.pendingRequests.set(c,{resolve:a}),setTimeout(()=>{this.pendingRequests.has(c)&&(this.pendingRequests.delete(c),a())},2e3)});const i=Date.now()-s;e.push(i)}}this.averageLatency=e.length>0?e.reduce((o,r)=>o+r,0)/e.length:0,console.log(`Average latency: ${this.averageLatency} ms`)}async initDB(){return new Promise((e,t)=>{const o=indexedDB.open("dcrypt_db",4);let r;o.onupgradeneeded=s=>{console.log("onupgradeneeded triggered for dcrypt_db version",s.target.result.version),r=o.result,r.objectStoreNames.contains("store")||(r.createObjectStore("store",{keyPath:"id"}),console.log("Created object store: store")),r.objectStoreNames.contains("transactions")||(r.createObjectStore("transactions",{keyPath:"id",autoIncrement:!0}),console.log("Created object store: transactions")),r.objectStoreNames.contains("offlineQueue")||(r.createObjectStore("offlineQueue",{keyPath:"id",autoIncrement:!0}),console.log("Created object store: offlineQueue")),r.objectStoreNames.contains("chunkCache")||(r.createObjectStore("chunkCache",{keyPath:"id"}),console.log("Created object store: chunkCache"))},o.onsuccess=()=>{this.db=o.result,console.log("IndexedDB opened successfully"),Promise.all([this.loadIdentity(),this.loadOfflineQueue(),this.loadTransactions()]).then(()=>{console.log("IndexedDB initialized successfully"),e()}).catch(s=>{console.error("Failed to load data after IndexedDB initialization:",s),t(new Error(`Failed to load data: ${s.message}`))})},o.onerror=s=>{console.error("Failed to initialize IndexedDB:",s.target.error),t(new Error(`Failed to initialize IndexedDB: ${s.target.error.message}`))}})}async syncUserData(){if(!this.db)throw new Error("IndexedDB not initialized");try{await this.dbPut("store",{id:"dcrypt_identity",value:this.uint8ArrayToHex(this.keypair)}),await this.updateBalance(),this.activeNodes.size>0&&await this.processOfflineQueue();const e={type:"userData",peerId:this.peerId,keypair:this.uint8ArrayToHex(this.keypair),balance:await this.getBalance(this.keypair),timestamp:Date.now()};this.broadcast(e),console.log("User data synced successfully")}catch(e){throw console.error("Sync failed:",e),e}}async saveUserData(){if(!this.db)throw new Error("IndexedDB not initialized");try{await this.dbPut("store",{id:"dcrypt_identity",value:this.uint8ArrayToHex(this.keypair)}),await this.updateBalance(),console.log("User data saved to IndexedDB")}catch(e){throw console.error("Save failed:",e),e}}async initSwarm(){try{const e=new TextDecoder().decode(this.keypair);return this.peerId=this.isNode?`node-${e}`:e,console.log("Initializing PeerJS with Peer ID:",this.peerId),this.peer=new ie(this.peerId,{host:"0.peerjs.com",port:443,path:"/",secure:!0,debug:2}),new Promise((t,o)=>{this.peer.on("open",r=>{console.log(`PeerJS connection opened with ID: ${r}`),this.activeNodes.add(this.peerId),this.peer.on("connection",s=>{this.handleConnection(s)}),this.peer.on("error",s=>{var i;if(console.error("PeerJS error:",s.type,s.message),s.type==="peer-unavailable"){const a=(i=s.message.match(/Peer (.+) is unavailable/))==null?void 0:i[1];a&&this.handlePeerDisconnect(a)}}),this.peer.on("disconnected",()=>{console.log("PeerJS disconnected. Attempting to reconnect..."),this.peer.reconnect()}),setInterval(()=>this.discoverPeers(),5e3),setInterval(()=>this.measureLatency(),6e4),t()}),this.peer.on("error",r=>{console.error("Failed to initialize PeerJS:",r),o(r)})})}catch(e){throw console.error("initSwarm failed:",e),e}}discoverPeers(){console.log("Discovering peers..."),console.log("My peer ID:",this.peerId),console.log("Known peer IDs:",Array.from(this.nodes));const e=[...Array.from(this.nodes)].filter(t=>t!==this.peerId);if(e.length===0){console.warn("No known peers to connect to. Waiting for nodes to be discovered.");return}e.forEach(t=>{this.peers.has(t)||(this.peers.set(t,{connected:!1,conn:null}),console.log("Discovered peer:",t),this.connectToPeer(t))}),this.peers.forEach((t,o)=>{!t.connected&&this.connectionAttempts.get(o)>=this.maxConnectionAttempts&&(console.log(`Removing unreachable peer: ${o}`),this.peers.delete(o),this.connectionAttempts.delete(o),this.activeNodes.delete(o))})}connectToPeer(e){var r;if((r=this.peers.get(e))!=null&&r.connected)return;const t=this.connectionAttempts.get(e)||0;if(t>=this.maxConnectionAttempts)return;console.log(`Attempting to connect to peer: ${e} (Attempt ${t+1}/${this.maxConnectionAttempts})`);const o=this.peer.connect(e,{reliable:!0});o.on("open",()=>{console.log(`Connected to peer: ${e}`),this.peers.set(e,{connected:!0,conn:o}),this.activeNodes.add(e),this.connectionAttempts.delete(e),o.send({type:"handshake",peerId:this.peerId})}),o.on("data",s=>{this.handlePeerData(s,e)}),o.on("close",()=>{console.log(`Connection closed with peer: ${e}`),this.handlePeerDisconnect(e)}),o.on("error",s=>{console.warn(`Connection error with peer ${e}: ${s.message}`),this.handlePeerDisconnect(e)}),this.connectionAttempts.set(e,t+1)}handleConnection(e){const t=e.peer;console.log(`Incoming connection from peer: ${t}`),this.peers.set(t,{connected:!0,conn:e}),this.activeNodes.add(t),e.on("data",o=>{this.handlePeerData(o,t)}),e.on("close",()=>{console.log(`Connection closed with peer: ${t}`),this.handlePeerDisconnect(t)}),e.on("error",o=>{console.error(`Connection error with peer ${t}:`,o),this.handlePeerDisconnect(t)})}handlePeerDisconnect(e){const t=this.peers.get(e);t&&(t.connected=!1,t.conn=null,this.activeNodes.delete(e),console.log(`Peer disconnected: ${e}. Will attempt to reconnect on next discovery.`))}handlePeerData(e,t){switch(console.log(`Received data from peer ${t}:`,e),e.type){case"handshake":console.log(`Handshake received from peer: ${t}`),this.activeNodes.add(t);break;case"chunk":this.chunkToPeerMap.set(e.chunkHash,new Set([...this.chunkToPeerMap.get(e.chunkHash)||[],t])),console.log(`Updated chunkToPeerMap for chunk ${e.chunkHash} with peer ${t}`);break;case"ip":this.knownObjects.set(e.ipHash,{metadata:e.metadata,chunks:e.chunkHashes}),this.dbPut("store",{id:e.ipHash,value:JSON.stringify({metadata:e.metadata,chunks:e.chunkHashes})}),console.log(`Received IP ${e.ipHash} from peer ${t}`);break;case"chunkRequest":this.handleChunkRequest(e,t);break;case"chunkResponse":this.handleChunkResponse(e);break;case"userData":console.log(`Received user data from peer ${t}:`,e);break;case"storeChunk":this.storeChunkFromPeer(e.chunkHash,e.chunkData,t);break;case"ping":const o=this.peers.get(t);o&&o.connected&&o.conn&&o.conn.send({type:"pong",requestId:e.requestId});break;case"pong":const r=this.pendingRequests.get(e.requestId);r&&(r.resolve(),this.pendingRequests.delete(e.requestId));break;case"commission":console.log(`Received commission of ${e.amount}. New balance: ${e.newBalance}`);break;default:console.warn(`Unknown data type received from peer ${t}:`,e.type)}}async storeChunkFromPeer(e,t,o){try{await this.dbPut("chunkCache",{id:e,value:t});let r=this.chunkToPeerMap.get(e)||new Set;r.add(this.peerId),this.chunkToPeerMap.set(e,r),console.log(`Stored chunk ${e} from peer ${o}`)}catch(r){console.error(`Failed to store chunk ${e} from peer ${o}:`,r)}}async publishChunk(e,t,o,r){if(!this.db)throw new Error("IndexedDB not initialized");try{if(console.log("publishChunk: chunkHash=",e,"chunkData=",t),!e||typeof e!="string"||e.trim()==="")throw new Error("Invalid chunk hash");await this.dbPut("chunkCache",{id:e,value:t});let s=this.chunkToPeerMap.get(e)||new Set;if(s.add(this.peerId),this.chunkToPeerMap.set(e,s),this.activeNodes.size>0){const i=Array.from(this.activeNodes).filter(c=>c.startsWith("node-"));if(i.length>0){const c=o%i.length,l=i[c],h=this.peers.get(l);h&&h.connected&&h.conn&&(h.conn.send({type:"storeChunk",chunkHash:e,chunkData:t,peerId:this.peerId}),s.add(l),this.chunkToPeerMap.set(e,s),console.log(`Sent chunk ${e} to node ${l}`))}const a=Array.from(this.activeNodes).filter(c=>!c.startsWith("node-")&&c!==this.peerId);if(a.length>0){const c=a[Math.floor(Math.random()*a.length)],l=this.peers.get(c);l&&l.connected&&l.conn&&(l.conn.send({type:"storeChunk",chunkHash:e,chunkData:t,peerId:this.peerId}),s.add(c),this.chunkToPeerMap.set(e,s),console.log(`Sent chunk ${e} to random peer ${c}`))}}else await this.queueOfflineOperation({type:"publishChunk",chunkHash:e,chunkData:t,chunkIndex:o,totalChunks:r});this.broadcastChunk(e)}catch(s){throw console.error("publishChunk failed:",s),s}}broadcastChunk(e){const t={type:"chunk",chunkHash:e,peerId:this.peerId};this.broadcast(t),console.log(`Broadcasted chunk ${e} to ${this.activeNodes.size} peers`)}async publishIP(e,t,o){if(!this.db)throw new Error("IndexedDB not initialized");if(!this.keypair)throw new Error("Keypair not initialized");try{const r=Array.isArray(e.tags)?e.tags.map(f=>typeof f!="string"?(console.warn(`Invalid tag: ${f}, converting to string`),String(f)):f).filter(f=>f.trim()!==""):[];console.log("Processed tags:",r);const s=!!e.isPremium,i=s?e.priceUsd||30:0,a=new Uint8Array(t),c=e.content_type||"",l=this.keypair instanceof Uint8Array?this.keypair:new Uint8Array(this.keypair),p=Pe(a,c,r,s,i,l,o||"text/plain"),m=Ee(p),b=await le(m),B=this.uint8ArrayToHex(b),k=Array.from(this.activeNodes).filter(f=>f.startsWith("node-")),y=k.length>0?k.length:1,w=await $e(p,Array.from(this.keypair),y),S=[];for(let f=0;f<w.length;f++){const M=w[f],_=await Ce(M),pe=this.uint8ArrayToHex(_);S.push(pe)}const D={...e,chunk_count:w.length,isPremium:s,priceUsd:s?i:0},U={metadata:D,chunks:S};this.knownObjects.set(B,U),await this.dbPut("store",{id:B,value:JSON.stringify(U)});for(let f=0;f<w.length;f++){const M=w[f],_=S[f];await this.publishChunk(_,M,f,w.length)}return this.activeNodes.size>0?this.broadcastIP(B,D,S):await this.queueOfflineOperation({type:"publishIP",ipHash:B,metadata:D,chunkHashes:S}),B}catch(r){throw console.error("publishIP failed:",r),r}}broadcastIP(e,t,o){const r={type:"ip",ipHash:e,metadata:t,chunkHashes:o,peerId:this.peerId};this.broadcast(r),console.log(`Broadcasted IP ${e} to ${this.activeNodes.size} peers`)}async requestData(e){if(!this.db)throw new Error("IndexedDB not initialized");try{if(!e||typeof e!="string")throw new Error("Invalid IP hash");const t=this.knownObjects.get(e);if(!t)throw new Error("IP not found");const o=[];for(const l of t.chunks){const h=await this.dbGet("chunkCache",l);if(h&&h.value){o.push({chunk:h.value,hash:l});continue}const p=this.chunkToPeerMap.get(l);if(!p||p.size===0)throw new Error(`No peers found with chunk ${l}`);const m=Array.from(p).filter(y=>y.startsWith("node-")),b=Array.from(p).filter(y=>!y.startsWith("node-"));let B=!1,k=null;for(const y of[...m,...b])if(this.activeNodes.has(y))try{const w=await this.fetchChunkFromPeer(y,l);await this.dbPut("chunkCache",{id:l,value:w}),o.push({chunk:w,hash:l}),B=!0;break}catch(w){k=w,console.error(`Failed to fetch chunk ${l} from peer ${y}:`,w);continue}if(!B)throw k||new Error(`No available peer for chunk ${l}`)}const r=o.sort((l,h)=>{const p=Y(l.chunk),m=Y(h.chunk);return p-m}),s=[];for(const{chunk:l}of r){const h=await Ae(l,Array.from(this.keypair));s.push(h)}const i=new Uint8Array(s.reduce((l,h)=>l+h.length,0));let a=0;for(const l of s)i.set(l,a),a+=l.length;const c=Te(r[0].chunk);return{data:i,fileType:c}}catch(t){throw console.error("requestData failed:",t),t}}async fetchChunkFromPeer(e,t){const o=this.peers.get(e);if(!o||!o.connected||!o.conn)throw new Error(`Peer ${e} is not connected`);const r=`${e}-${t}-${Date.now()}`,s={type:"chunkRequest",requestId:r,chunkHash:t,peerId:this.peerId};return o.conn.send(s),new Promise((i,a)=>{this.pendingRequests.set(r,{resolve:i,reject:a,hash:t}),setTimeout(()=>{this.pendingRequests.has(r)&&(this.pendingRequests.delete(r),a(new Error(`Request for chunk ${t} from peer ${e} timed out`)))},1e4)})}handleChunkRequest(e,t){const{requestId:o,chunkHash:r}=e;this.dbGet("chunkCache",r).then(s=>{if(s&&s.value){const i={type:"chunkResponse",requestId:o,chunkHash:r,chunkData:s.value,peerId:this.peerId},a=this.peers.get(t);a&&a.connected&&a.conn&&(a.conn.send(i),console.log(`Sent chunk ${r} to peer ${t}`))}else console.warn(`Chunk ${r} not found for peer ${t}`)}).catch(s=>{console.error(`Failed to retrieve chunk ${r} for peer ${t}:`,s)})}handleChunkResponse(e){const{requestId:t,chunkHash:o,chunkData:r}=e,s=this.pendingRequests.get(t);s&&(s.hash===o?s.resolve(r):s.reject(new Error(`Received chunk hash ${o} does not match requested hash ${s.hash}`)),this.pendingRequests.delete(t))}async distributeCommission(e){const t=Array.from(this.activeNodes).filter(r=>r.startsWith("node-"));if(t.length===0){console.log("No active nodes to distribute commission to.");return}const o=e/t.length;console.log(`Distributing commission of ${e} to ${t.length} nodes (${o} per node)`);for(const r of t){const s=this.hexToUint8Array(r.replace("node-","")),a=await this.getBalance(s)+o;await this.putBalance(s,a),console.log(`Awarded ${o} to node ${r}. New balance: ${a}`);const c=this.peers.get(r);c&&c.connected&&c.conn&&c.conn.send({type:"commission",amount:o,newBalance:a,peerId:this.peerId})}}async getBalance(e){if(!this.db)throw new Error("IndexedDB not initialized");const t=await this.dbGet("store","balance_"+this.uint8ArrayToHex(e));return t&&t.value?parseFloat(t.value):0}async putBalance(e,t){if(!this.db)throw new Error("IndexedDB not initialized");if(typeof t!="number"||t<0)throw new Error("Invalid balance amount");await this.dbPut("store",{id:"balance_"+this.uint8ArrayToHex(e),value:t.toString()}),this.activeNodes.size>0&&this.broadcast({type:"userData",peerId:this.peerId,keypair:this.uint8ArrayToHex(this.keypair),balance:t,timestamp:Date.now()})}async updateBalance(){if(!this.db)throw new Error("IndexedDB not initialized");const e=await this.getBalance(this.keypair);await this.putBalance(this.keypair,e)}async queueOfflineOperation(e){if(!this.db)throw new Error("IndexedDB not initialized");this.offlineQueue.push(e),await this.dbAdd("offlineQueue",{id:Date.now().toString(),value:e}),console.log("Queued offline operation:",e)}async processOfflineQueue(){if(this.offlineQueue.length===0)return;console.log("Processing offline queue...");const e=[...this.offlineQueue];this.offlineQueue=[];const o=this.db.transaction("offlineQueue","readwrite").objectStore("offlineQueue");await new Promise(r=>{o.clear().onsuccess=r});for(const r of e)try{switch(r.type){case"publishChunk":await this.publishChunk(r.chunkHash,r.chunkData,r.chunkIndex,r.totalChunks);break;case"publishIP":await this.broadcastIP(r.ipHash,r.metadata,r.chunkHashes);break;default:console.warn("Unknown offline operation type:",r.type)}}catch(s){console.error(`Failed to process offline operation ${r.type}:`,s),this.offlineQueue.push(r),await this.dbAdd("offlineQueue",{id:Date.now().toString(),value:r})}}async loadIdentity(){if(this.db)try{const e=await this.dbGet("store","dcrypt_identity");e&&e.value&&typeof e.value=="string"&&(this.keypair=this.hexToUint8Array(e.value),console.log("Loaded identity from IndexedDB"))}catch(e){console.error("Failed to load identity:",e)}}async loadOfflineQueue(){if(this.db)try{const e=await this.dbGetAll("offlineQueue");this.offlineQueue=e.map(t=>t.value),console.log("Loaded offline queue:",this.offlineQueue)}catch(e){console.error("Failed to load offline queue:",e)}}async loadTransactions(){if(this.db)try{const e=await this.dbGetAll("transactions");console.log("Loaded transactions:",e)}catch(e){console.error("Failed to load transactions:",e)}}async dbPut(e,t){if(!this.db)throw new Error("IndexedDB not initialized");return new Promise((o,r)=>{const a=this.db.transaction(e,"readwrite").objectStore(e).put(t);a.onsuccess=()=>o(),a.onerror=c=>r(new Error(`DB put failed: ${c.target.error.message}`))})}async dbAdd(e,t){if(!this.db)throw new Error("IndexedDB not initialized");return new Promise((o,r)=>{const a=this.db.transaction(e,"readwrite").objectStore(e).add(t);a.onsuccess=()=>o(),a.onerror=c=>r(new Error(`DB add failed: ${c.target.error.message}`))})}async dbGet(e,t){if(!this.db)throw new Error("IndexedDB not initialized");return new Promise((o,r)=>{const a=this.db.transaction(e,"readonly").objectStore(e).get(t);a.onsuccess=()=>o(a.result),a.onerror=c=>r(new Error(`DB get failed: ${c.target.error.message}`))})}async dbGetAll(e){if(!this.db)throw new Error("IndexedDB not initialized");return new Promise((t,o)=>{const i=this.db.transaction(e,"readonly").objectStore(e).getAll();i.onsuccess=()=>t(i.result),i.onerror=a=>o(new Error(`DB getAll failed: ${a.target.error.message}`))})}uint8ArrayToHex(e){return Array.from(e).map(t=>t.toString(16).padStart(2,"0")).join("")}hexToUint8Array(e){if(!e||typeof e!="string")return new Uint8Array(0);const t=e.match(/.{1,2}/g);return t?new Uint8Array(t.map(o=>parseInt(o,16))):new Uint8Array(0)}broadcast(e){this.peers.forEach((t,o)=>{t.connected&&t.conn&&t.conn.send(e)})}}function Le(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)})}async function Ue(){const n=[];for(let t=0;t<3;t++){const o=`node-test-${Le()}`;console.log(`Initializing test peer with ID: ${o}`);const r=new ie(o,{host:"0.peerjs.com",port:443,path:"/",secure:!0,debug:2}),s=new Promise((i,a)=>{r.on("open",()=>{console.log(`Test peer ${o} opened`),n.push({peer:r,peerId:o}),i()}),r.on("error",c=>{console.error(`Test peer ${o} error:`,c),a(c)}),r.on("disconnected",()=>{console.log(`Test peer ${o} disconnected`)})});try{await s}catch(i){console.error(`Failed to initialize test peer ${o}:`,i)}}return n}(window.location.pathname==="/datasharingApp/signup.html"||window.location.pathname==="/signup.html")&&document.addEventListener("DOMContentLoaded",()=>{const n=document.getElementById("signupButton");if(!n){console.error("Sign-up button not found");return}n.addEventListener("click",Fe)});async function Fe(){Z(!0);try{const n=new K,t=(await fe(ce,n)).user;if(console.log("Signed up user UID:",t.uid),document.querySelector('input[name="role"]:checked').value==="node"){const s=v(N,"nodes",t.uid);await E(s,{uid:t.uid,createdAt:Date.now(),status:"active"}),console.log("User registered as a node"),W("Signed up as a node successfully!"),window.location.href="/datasharingApp/node-instructions.html"}else{const s=v(N,"users",t.uid);await E(s,{uid:t.uid,createdAt:Date.now(),balance:0},{merge:!0}),console.log("User registered as a regular user"),W("Signed up successfully!"),window.location.href="/datasharingApp/index.html"}}catch(n){console.error("Sign-up failed:",n),W(`Sign-up failed: ${n.message}`)}finally{Z(!1)}}function W(n){const e=document.getElementById("toast");e&&(e.textContent=n,e.style.display="block",setTimeout(()=>{e.style.display="none"},3e3))}function Z(n){const e=document.getElementById("loading");e&&(e.style.display=n?"flex":"none")}if(window.location.pathname==="/datasharingApp/node-instructions.html"||window.location.pathname==="/node-instructions.html"){let n;document.addEventListener("DOMContentLoaded",async()=>{ee(!0);try{const e=localStorage.getItem("nodeId");if(localStorage.getItem("role")!=="node"||!e){X("You must be signed in as a node to view this page."),window.location.href="/datasharingApp/signup.html";return}const r=new TextEncoder().encode(e);n=new de(r,!0),await n.initDB(),await n.initSwarm(),await n.syncUserData();const i=(await n.dbGetAll("transactions")).filter(c=>c.type==="commission").reduce((c,l)=>c+(l.amount||0),0),a=document.getElementById("nodeEarnings");a&&(a.textContent=`Total Earnings: ${i.toFixed(2)} DCT`)}catch(e){console.error("Error initializing node instructions:",e),X(`Initialization failed: ${e.message}`)}finally{ee(!1)}})}function X(n){const e=document.getElementById("toast");e&&(e.textContent=n,e.style.display="block",setTimeout(()=>{e.style.display="none"},3e3))}function ee(n){const e=document.getElementById("loading");e&&(e.style.display=n?"flex":"none")}self.addEventListener("install",n=>{n.waitUntil(caches.open("dcrypt-v1").then(e=>e.addAll(["/","/index.html","/assets/index.js","/wasm/dcrypt_wasm.js","/wasm/dcrypt_wasm_bg.wasm"])))});self.addEventListener("fetch",n=>{n.respondWith(caches.match(n.request).then(e=>e||fetch(n.request).catch(()=>caches.match("/index.html"))))});self.addEventListener("message",async n=>{if(n.data.type==="cache_chunk"){const{chunkHash:e,data:t}=n.data,o=await caches.open("dcrypt-chunks"),r=new Blob([t],{type:"application/octet-stream"}),s=new Response(r,{headers:{"Content-Type":"application/octet-stream"}});await o.put(`/chunks/${e}`,s),console.log(`Service Worker: Cached chunk ${e}`)}});self.addEventListener("fetch",n=>{const e=new URL(n.request.url);e.pathname.startsWith("/chunks/")?n.respondWith(caches.open("dcrypt-chunks").then(t=>t.match(n.request).then(o=>o?(console.log(`Service Worker: Serving chunk ${e.pathname} from cache`),o):fetch(n.request).catch(()=>new Response("Chunk not available offline",{status:503}))))):n.respondWith(caches.match(n.request).then(t=>t||fetch(n.request).catch(()=>caches.match("/index.html"))))});let x=null,I=null,d=null,F=!1,P=0,R=[],C=!1,G=!1;async function Re(){try{const n=await ke(()=>Promise.resolve().then(()=>Se),void 0);x=n.auth,I=n.db,console.log("Firebase services initialized successfully")}catch(n){throw console.error("Failed to initialize Firebase services:",n),u("Failed to initialize Firebase. Please try again later.",!0),n}}function Ne(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)})}function A(){return!!(x!=null&&x.currentUser)||localStorage.getItem("role")==="node"}function u(n,e=!1){const t=document.getElementById("toast");t&&(t.textContent=n,t.className="toast",e&&t.classList.add("error-toast"),t.style.display="block",setTimeout(()=>{t.style.display="none"},3e3))}function g(n){const e=document.getElementById("loading");e&&(e.style.display=n?"flex":"none")}function q(){var e;const n={publishedItemsTableBody:(e=document.getElementById("publishedItems"))==null?void 0:e.querySelector("tbody"),transactionList:document.getElementById("transactionList"),userBalanceElement:document.getElementById("userBalance")};n.publishedItemsTableBody&&(n.publishedItemsTableBody.innerHTML=""),n.transactionList&&(n.transactionList.innerHTML="No transactions yet."),n.userBalanceElement&&(n.userBalanceElement.textContent="Balance: 0 DCT"),P=0}async function T(){const n=document.getElementById("userBalance");if(n){if(!d){n.textContent="Balance: 0 DCT",P=0;return}try{P=await d.getBalance(d.keypair)||0,n.textContent=`Balance: ${P} DCT`}catch(e){console.error("Failed to update balance:",e),n.textContent="Balance: 0 DCT",P=0}}}async function L(){const n=document.getElementById("transactionList");if(n){if(!d){n.innerHTML="Not initialized.";return}try{const e=await d.dbGetAll("transactions");if(e.length===0){n.innerHTML="No transactions yet.";return}n.innerHTML=e.map(t=>`<p class="py-1">${t.type} - ${t.amount} DCT - ${new Date(t.timestamp).toLocaleString()}</p>`).join("")}catch(e){console.error("Failed to update transaction history:",e),n.innerHTML="Failed to load transactions."}}}async function O(){var e;const n=(e=document.getElementById("publishedItems"))==null?void 0:e.querySelector("tbody");if(n){n.innerHTML="";try{const t=await z(H(I,"snippets")),o={};t.forEach(r=>{o[r.id]=r.data()}),d&&d.knownObjects.forEach((r,s)=>{const i=o[s]||{averageRating:0,reviewStatus:"active"};if(i.reviewStatus!=="active")return;const c=(r.metadata.isPremium||!1)&&r.metadata.priceUsd||0,l=c>0?`${c} DCT`:"Free",h=document.createElement("tr");h.innerHTML=`
          <td class="py-2 px-4">${r.metadata.content_type}</td>
          <td class="py-2 px-4">${r.metadata.description||"No description"}</td>
          <td class="py-2 px-4">${r.metadata.tags.join(", ")||"No tags"}</td>
          <td class="py-2 px-4">${i.averageRating} / 5</td>
          <td class="py-2 px-4">
            <button onclick="window.buySnippet('${s}')" class="bg-purple-500 text-white rounded hover:bg-purple-600 px-3 py-1 mr-2">Get (${l})</button>
            <button onclick="window.flagSnippet('${s}')" class="bg-red-500 text-white rounded hover:bg-red-600 px-3 py-1">Flag</button>
          </td>
        `,n.appendChild(h)})}catch(t){console.error("Failed to update live feed:",t),u("Failed to load live feed.",!0)}}}async function j(){var e;const n=((e=x.currentUser)==null?void 0:e.uid)||localStorage.getItem("nodeId");if(n)try{const t=v(I,"users",n),o=d?await d.getBalance(d.keypair):0;await E(t,{balance:o,lastUpdated:Date.now()},{merge:!0}),console.log("User data uploaded to Firebase")}catch(t){console.error("Failed to upload user data to Firebase:",t)}}function qe(){const n=document.getElementById("transactionHistory");n&&(n.style.display=n.style.display==="none"?"block":"none")}function ze(n,e,t){const o=document.getElementById("snippetDisplay");if(!o)return;o.innerHTML="";const r=document.createElement("div");r.className="p-4 bg-gray-800 rounded-lg mt-4";const s=document.createElement("h3");if(s.className="text-lg font-semibold mb-2",s.textContent=t||"Snippet Content",r.appendChild(s),e.startsWith("text")){const i=new TextDecoder().decode(n),a=document.createElement("pre");a.className="text-sm text-gray-300 whitespace-pre-wrap",a.textContent=i,r.appendChild(a)}else if(e.startsWith("image")){const i=new Blob([n],{type:e}),a=URL.createObjectURL(i),c=document.createElement("img");c.src=a,c.className="max-w-full h-auto rounded",c.onload=()=>URL.revokeObjectURL(a),r.appendChild(c)}else{const i=new Blob([n],{type:e}),a=URL.createObjectURL(i),c=document.createElement("a");c.href=a,c.download=t||"downloaded_file",c.className="text-blue-400 hover:underline",c.textContent="Download File",c.onclick=()=>setTimeout(()=>URL.revokeObjectURL(a),1e3),r.appendChild(c)}o.appendChild(r)}function He(){const n=document.getElementById("isPremium"),e=document.getElementById("priceInput");n&&e&&n.addEventListener("change",t=>{console.log("Premium toggle:",t.target.checked),e.classList.toggle("hidden",!t.target.checked),t.target.checked||(e.value="")})}async function J(){return new Promise((n,e)=>{const t=indexedDB.open("dcrypt_db",1);t.onsuccess=()=>{const o=t.result,r=o.version;if(console.log("Current IndexedDB version:",r),o.objectStoreNames.contains("store"))if(r<5){o.close();const s=indexedDB.open("dcrypt_db",5);s.onupgradeneeded=i=>{s.result,console.log("onupgradeneeded triggered for version alignment to 5")},s.onsuccess=()=>{console.log("IndexedDB version aligned to 5"),n(s.result)},s.onerror=()=>{console.error("Failed to align IndexedDB version:",s.error),e(new Error(`Failed to align IndexedDB version: ${s.error.message}`))}}else console.log('IndexedDB already has "store" and is at version 5 or higher'),n(o);else{console.log('Object store "store" not found, upgrading database...'),o.close();const s=indexedDB.open("dcrypt_db",5);s.onupgradeneeded=i=>{const a=s.result;console.log("onupgradeneeded triggered for dcrypt_db version",a.version),a.objectStoreNames.contains("store")||(a.createObjectStore("store",{keyPath:"id"}),console.log("Created object store: store in index.js"))},s.onsuccess=()=>{console.log("IndexedDB upgraded and opened successfully"),n(s.result)},s.onerror=()=>{console.error("Failed to upgrade IndexedDB:",s.error),e(new Error(`Failed to upgrade IndexedDB: ${s.error.message}`))}}},t.onerror=()=>{console.error("Failed to open IndexedDB initially:",t.error),e(new Error(`Failed to open IndexedDB initially: ${t.error.message}`))}})}async function ue(n){return new Promise((e,t)=>{try{const s=n.transaction("store","readonly").objectStore("store").get("dcrypt_identity");s.onsuccess=()=>{var i;(i=s.result)!=null&&i.value?(console.log("Loaded keypair from IndexedDB:",s.result.value),e(new TextEncoder().encode(s.result.value))):e(null)},s.onerror=()=>{console.error("Failed to load keypair from IndexedDB:",s.error),t(new Error("Failed to load keypair from IndexedDB"))}}catch(o){console.error('Error accessing "store" object store:',o),t(o)}})}async function Oe(n,e){return new Promise((t,o)=>{try{const i=n.transaction("store","readwrite").objectStore("store").put({id:"dcrypt_identity",value:e});i.onsuccess=()=>{console.log("Stored keypair in IndexedDB:",e),t()},i.onerror=()=>{console.error("Failed to store keypair in IndexedDB:",i.error),o(new Error("Failed to store keypair in IndexedDB"))}}catch(r){console.error('Error storing keypair in "store" object store:',r),o(r)}})}async function te(n){if(G){console.log("Initialization already in progress, skipping...");return}G=!0,console.log("Initializing app with userId:",n),g(!0);try{const e=await J();let t=await ue(e);if(!t&&n&&(await Oe(e,n),t=new TextEncoder().encode(n)),!t)throw new Error("No keypair available and no userId provided to create one");F=await je(n),console.log(`User is ${F?"":"not "}a node.`),R.length===0&&(console.log("Creating test peers..."),R=await Ue(),console.log("Test peers created:",R.map(o=>o.peerId))),console.log("Initializing DHT..."),d=new de(t,F),window.dht=d,await d.initDB(),console.log("IndexedDB initialized via DHT."),await d.initSwarm(),console.log("DHT swarm initialized."),await d.syncUserData(),console.log("User data synced."),await Promise.all([O(),T(),L()]),console.log("UI updated.")}catch(e){console.error("Error initializing application:",e),u(`Initialization failed: ${e.message}`,!0),d=null,window.dht=null,P=0,q()}finally{g(!1),He(),G=!1}}async function je(n){try{const e=v(I,"nodes",n);return(await se(e)).exists()}catch(e){return console.error("Failed to check node status:",e),!1}}async function Me(){var o;if(console.log("handleSignup function called"),C){console.log("Signup already in progress, ignoring additional clicks");return}C=!0;const n=document.getElementById("signupButton");n&&(n.disabled=!0,n.textContent="Signing Up...",console.log("Signup button disabled and text updated"));const e=document.querySelectorAll('input[name="role"]');if(!e.length){console.error("Role inputs not found"),u("Role selection not found.",!0),C=!1,n&&(n.disabled=!1,n.textContent="Sign Up with Google");return}const t=(o=Array.from(e).find(r=>r.checked))==null?void 0:o.value;if(!t){console.error("No role selected"),u("Please select a role.",!0),C=!1,n&&(n.disabled=!1,n.textContent="Sign Up with Google");return}console.log("Selected role:",t),localStorage.setItem("pendingRole",t);try{const r=new K;console.log("Initiating signInWithRedirect for signup"),await re(x,r)}catch(r){console.error("Signup failed:",r),u(`Sign-up failed: ${r.message}`,!0),C=!1,n&&(n.disabled=!1,n.textContent="Sign Up with Google")}}async function _e(){console.log("signIn function called");try{if(!x)throw new Error("Firebase Auth is not initialized");const n=new K;console.log("Initiating signInWithRedirect"),g(!0),await re(x,n)}catch(n){console.error("Login failed:",n),u(`Login failed: ${n.message}`,!0),g(!1)}}async function ne(){console.log("signOutUser function called");try{localStorage.getItem("role")==="node"?(localStorage.removeItem("nodeId"),localStorage.removeItem("role"),u("Node signed out successfully!")):(await ye(x),u("Signed out successfully!"));const t=(await J()).transaction("store","readwrite").objectStore("store");await new Promise((o,r)=>{const s=t.delete("dcrypt_identity");s.onsuccess=()=>o(),s.onerror=()=>r(new Error("Failed to delete keypair from IndexedDB"))}),d=null,window.dht=null,R=[],P=0,q()}catch(n){console.error("Sign-out failed:",n),u(`Sign-out failed: ${n.message}`,!0)}}async function We(n,e,t,o,r){var s,i;if(!A()){u("Please sign in to publish.");return}g(!0);try{if(!d)throw new Error("DHT not initialized");if(!n)throw new Error("Title is required");let a=o||"",c="text/plain";if((s=r==null?void 0:r.files)!=null&&s.length){const y=r.files[0];c=y.type||"application/octet-stream",a=await new Promise((w,S)=>{const D=new FileReader;D.onload=U=>w(new Uint8Array(U.target.result)),D.onerror=()=>S(new Error("Failed to read file")),D.readAsArrayBuffer(y)})}else a=new TextEncoder().encode(a);const l=document.getElementById("isPremium").checked,h=document.getElementById("priceInput"),p=l&&h&&parseFloat(h.value)||0,m={content_type:n,description:e||"",tags:t?t.split(",").map(y=>y.trim()):[],isPremium:l,priceUsd:p},b=await d.publishIP(m,a,c),B=((i=x.currentUser)==null?void 0:i.uid)||localStorage.getItem("nodeId"),k=v(I,"snippets",b);await E(k,{ipHash:b,flagCount:0,averageRating:0,reviewStatus:"active",createdAt:Date.now(),creatorId:B},{merge:!0}),u("Snippet published successfully!"),await Promise.all([O(),L(),T(),j()])}catch(a){console.error("publishSnippet failed:",a),u(`Publish failed: ${a.message}`,!0)}finally{g(!1)}}async function he(n){if(!A())return u("Please sign in to buy."),null;g(!0);try{if(!d)throw new Error("DHT not initialized");if(!n)throw new Error("Hash is required");const e=d.knownObjects.get(n);if(!e)throw new Error("Snippet not found");const r=(e.metadata.isPremium||!1)&&e.metadata.priceUsd||0;if(r>0){const c=await d.getBalance(d.keypair);if(c<r)throw new Error("Insufficient balance");const l=r*.05;await d.distributeCommission(l),await d.putBalance(d.keypair,c-r),await d.dbAdd("transactions",{type:"buy",amount:r,timestamp:Date.now()})}else console.log("This snippet is free!"),await d.dbAdd("transactions",{type:"buy",amount:0,timestamp:Date.now()});const{data:s,fileType:i}=await d.requestData(n);u("Snippet retrieved successfully!"),await Promise.all([L(),T(),j()]);const a=prompt("Please rate this snippet (1-5 stars):","5");if(a!==null){const c=parseInt(a);c>=1&&c<=5?(await Qe(n,c),u(`Rated ${c} stars!`),await O()):u("Invalid rating. Please enter a number between 1 and 5.",!0)}return ze(s,i,e.metadata.content_type),{data:s,fileType:i}}catch(e){return console.error("buySnippet failed:",e),u(`Purchase failed: ${e.message}`,!0),null}finally{g(!1)}}async function Ge(n){var o;const e=n||((o=document.getElementById("buyHashInput"))==null?void 0:o.value.trim());if(!e){u("Please enter a valid hash.",!0);return}await he(e)&&u("Snippet purchased and displayed below!")}async function Qe(n,e){var o;const t=((o=x.currentUser)==null?void 0:o.uid)||localStorage.getItem("nodeId");if(t)try{const r=v(I,"snippets",n,"ratings",t);await E(r,{rating:e,timestamp:Date.now()});const i=(await z(H(I,"snippets",n,"ratings"))).docs.map(l=>l.data().rating),a=i.length>0?i.reduce((l,h)=>l+h,0)/i.length:0,c=v(I,"snippets",n);await Q(c,{averageRating:a.toFixed(1)})}catch(r){console.error("Failed to submit rating:",r),u(`Failed to submit rating: ${r.message}`,!0)}}async function Ke(n){var t;if(!(((t=x.currentUser)==null?void 0:t.uid)||localStorage.getItem("nodeId"))){u("Please sign in to flag content.");return}try{const o=v(I,"snippets",n);await Q(o,{flagCount:be(1)}),((await se(o)).data().flagCount||0)>=3?(await Q(o,{reviewStatus:"under_review"}),u("Snippet has been flagged and is under review."),await O()):u("Snippet flagged. It will be reviewed if flagged by more users.")}catch(o){console.error("Failed to flag snippet:",o),u(`Failed to flag snippet: ${o.message}`,!0)}}async function Je(n){if(!A()){u("Please sign in to search.");return}g(!0);try{if(!d)throw new Error("DHT not initialized");if(!n)throw new Error("Search query is required");console.log("Starting search with query:",n);const e=document.getElementById("publishedItems").querySelector("tbody");e.innerHTML="";const t=await z(H(I,"snippets")),o={};t.forEach(i=>{o[i.id]=i.data()});let r=!1;const s=n.toLowerCase();d.knownObjects.forEach((i,a)=>{const{content_type:c,description:l,tags:h}=i.metadata,p=o[a]||{averageRating:0,reviewStatus:"active"};if(p.reviewStatus==="active"&&(c.toLowerCase().includes(s)||l&&l.toLowerCase().includes(s)||h&&h.some(m=>m.toLowerCase().includes(s)))){r=!0;const b=(i.metadata.isPremium||!1)&&i.metadata.priceUsd||0,B=b>0?`${b} DCT`:"Free",k=document.createElement("tr");k.innerHTML=`
          <td class="py-2 px-4">${c}</td>
          <td class="py-2 px-4">${l||"No description"}</td>
          <td class="py-2 px-4">${h.join(", ")||"No tags"}</td>
          <td class="py-2 px-4">${p.averageRating} / 5</td>
          <td class="py-2 px-4">
            <button onclick="window.buySnippet('${a}')" class="bg-purple-500 text-white rounded hover:bg-purple-600 px-3 py-1 mr-2">Get (${B})</button>
            <button onclick="window.flagSnippet('${a}')" class="bg-red-500 text-white rounded hover:bg-red-600 px-3 py-1">Flag</button>
          </td>
        `,e.appendChild(k)}}),u(r?"Search completed!":"No snippets found matching your search.")}catch(e){console.error("searchSnippets failed:",e),u(`Search failed: ${e.message}`,!0)}finally{g(!1)}}async function Ve(n){if(!A()){u("Please sign in to deposit.");return}g(!0);try{if(!d)throw new Error("DHT not initialized");if(!n||n<=0)throw new Error("Invalid deposit amount");const t=await d.getBalance(d.keypair)+n;await d.putBalance(d.keypair,t),await d.dbAdd("transactions",{type:"deposit",amount:n,timestamp:Date.now()}),u(`Deposited ${n} DCT successfully!`),await Promise.all([L(),T(),j()])}catch(e){console.error("deposit failed:",e),u(`Deposit failed: ${e.message}`,!0)}finally{g(!1)}}async function Ye(n){if(!A()){u("Please sign in to withdraw.");return}g(!0);try{if(!d)throw new Error("DHT not initialized");if(!n||n<=0)throw new Error("Invalid withdrawal amount");const e=await d.getBalance(d.keypair);if(e<n)throw new Error("Insufficient balance");await d.putBalance(d.keypair,e-n),await d.dbAdd("transactions",{type:"withdraw",amount:n,timestamp:Date.now()}),u(`Withdrew ${n} DCT successfully!`),await Promise.all([L(),T(),j()])}catch(e){console.error("withdraw failed:",e),u(`Withdrawal failed: ${e.message}`,!0)}finally{g(!1)}}document.addEventListener("DOMContentLoaded",async()=>{var s;console.log("DOMContentLoaded event fired"),console.log("Current pathname:",window.location.pathname);try{await Re()}catch(i){console.error("Firebase initialization failed, aborting setup:",i),u("Firebase initialization failed. Please check your configuration.",!0);return}const n=localStorage.getItem("role"),e=localStorage.getItem("nodeId");if((window.location.pathname.includes("index.html")||window.location.pathname==="/"||window.location.pathname==="/datasharingApp/")&&n==="node"&&e){console.log("Node detected on index.html, redirecting to node-instructions.html"),window.location.href="/datasharingApp/node-instructions.html";return}const o={signupButton:document.getElementById("signupButton"),loginButton:document.getElementById("loginButton"),logoutButton:document.getElementById("logoutButton"),userBalanceElement:document.getElementById("userBalance"),publishButton:document.getElementById("publishButton"),searchButton:document.getElementById("searchButton"),depositButton:document.getElementById("depositButton"),withdrawButton:document.getElementById("withdrawButton"),toggleHistoryButton:document.getElementById("toggleHistoryButton"),transactionHistory:document.getElementById("transactionHistory"),publishedItemsTableBody:(s=document.getElementById("publishedItems"))==null?void 0:s.querySelector("tbody"),buyHashButton:document.getElementById("buyHashButton")};Object.values(o).every(i=>i!=null)?(console.log("On index.html, setting up UI and event listeners"),n==="node"&&e&&(F=!0,console.log("Node detected, but should have been redirected already.")),me(x,async i=>{if(g(!0),i){console.log("User is signed in:",i.uid),o.signupButton.classList.add("hidden"),o.loginButton.classList.add("hidden"),o.logoutButton.classList.remove("hidden"),o.publishButton.disabled=!1,o.searchButton.disabled=!1,o.depositButton.disabled=!1,o.withdrawButton.disabled=!1,o.toggleHistoryButton.disabled=!1,o.buyHashButton.disabled=!1;const a=localStorage.getItem("pendingRole")||"user";localStorage.removeItem("pendingRole");const c=window.location.pathname;if(a==="user"){const l=v(I,"users",i.uid);if(await E(l,{role:"user",createdAt:Date.now(),balance:0},{merge:!0}),!c.includes("index.html")&&c!=="/datasharingApp/"){console.log("Redirecting to index.html for user role"),window.location.href="/datasharingApp/index.html",g(!1);return}}else{const l=Ne();localStorage.setItem("nodeId",l),localStorage.setItem("role","node");const h=v(I,"nodes",l);if(await E(h,{role:"node",createdAt:Date.now(),status:"active"},{merge:!0}),!c.includes("node-instructions.html")){console.log("Redirecting to node-instructions.html for node role"),window.location.href="/datasharingApp/node-instructions.html",g(!1);return}}await te(i.uid)}else{console.log("No user is signed in. Checking IndexedDB for keypair...");try{const a=await J(),c=await ue(a);c?(console.log("Found keypair in IndexedDB, initializing app..."),o.signupButton.classList.add("hidden"),o.loginButton.classList.add("hidden"),o.logoutButton.classList.remove("hidden"),o.publishButton.disabled=!1,o.searchButton.disabled=!1,o.depositButton.disabled=!1,o.withdrawButton.disabled=!1,o.toggleHistoryButton.disabled=!1,o.buyHashButton.disabled=!1,await te(new TextDecoder().decode(c))):(console.log("No keypair found in IndexedDB."),o.signupButton.classList.remove("hidden"),o.loginButton.classList.remove("hidden"),o.logoutButton.classList.add("hidden"),o.publishButton.disabled=!0,o.searchButton.disabled=!0,o.depositButton.disabled=!0,o.withdrawButton.disabled=!0,o.toggleHistoryButton.disabled=!0,o.buyHashButton.disabled=!0,q())}catch(a){console.error("Failed to initialize IndexedDB or load keypair:",a),o.signupButton.classList.remove("hidden"),o.loginButton.classList.remove("hidden"),o.logoutButton.classList.add("hidden"),o.publishButton.disabled=!0,o.searchButton.disabled=!0,o.depositButton.disabled=!0,o.withdrawButton.disabled=!0,o.toggleHistoryButton.disabled=!0,o.buyHashButton.disabled=!0,q()}}g(!1)},i=>{console.error("onAuthStateChanged error:",i),u("Failed to monitor authentication state.",!0),g(!1)}),o.loginButton.addEventListener("click",i=>{i.preventDefault(),console.log("Login button clicked"),_e()}),o.logoutButton.addEventListener("click",i=>{i.preventDefault(),console.log("Logout button clicked"),ne()})):console.log("Not on index.html, skipping index.html-specific setup"),window.logout=ne,window.publishSnippet=We,window.buySnippet=he,window.buySnippetByHash=Ge,window.searchSnippets=Je,window.deposit=Ve,window.withdraw=Ye,window.toggleTransactionHistory=qe,window.flagSnippet=Ke,window.handleSignup=Me});
