var z3=Object.defineProperty;var h1=n=>{throw TypeError(n)};var K3=(n,e,t)=>e in n?z3(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var d=(n,e,t)=>K3(n,typeof e!="symbol"?e+"":e,t),Yo=(n,e,t)=>e.has(n)||h1("Cannot "+t);var D=(n,e,t)=>(Yo(n,e,"read from private field"),t?t.call(n):e.get(n)),re=(n,e,t)=>e.has(n)?h1("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),de=(n,e,t,r)=>(Yo(n,e,"write to private field"),r?r.call(n,t):e.set(n,t),t),te=(n,e,t)=>(Yo(n,e,"access private method"),t);var qn=(n,e,t,r)=>({set _(s){de(n,e,s,t)},get _(){return D(n,e,r)}});import{getAuth as j3,onAuthStateChanged as f1,setPersistence as G3,browserLocalPersistence as W3,GoogleAuthProvider as Hd,signInWithPopup as qd,signOut as Q3}from"https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";import{getFirestore as Y3,getDocs as Ui,collection as is,doc as At,setDoc as Nn,updateDoc as os,increment as Fi,getDoc as Gc,query as $i,where as qa,onSnapshot as J3}from"https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";import{getStorage as Z3}from"https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";import{initializeApp as X3}from"https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";function e4(n,e){for(var t=0;t<e.length;t++){const r=e[t];if(typeof r!="string"&&!Array.isArray(r)){for(const s in r)if(s!=="default"&&!(s in n)){const i=Object.getOwnPropertyDescriptor(r,s);i&&Object.defineProperty(n,s,i.get?i:{enumerable:!0,get:()=>r[s]})}}}return Object.freeze(Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}))}(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const t4="modulepreload",r4=function(n){return"/datasharingApp/"+n},p1={},n4=function(e,t,r){let s=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),a=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));s=Promise.allSettled(t.map(c=>{if(c=r4(c),c in p1)return;p1[c]=!0;const l=c.endsWith(".css"),u=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${u}`))return;const h=document.createElement("link");if(h.rel=l?"stylesheet":t4,l||(h.as="script"),h.crossOrigin="",h.href=c,a&&h.setAttribute("nonce",a),document.head.appendChild(h),l)return new Promise((f,g)=>{h.addEventListener("load",f),h.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${c}`)))})}))}function i(o){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=o,window.dispatchEvent(a),!a.defaultPrevented)throw o}return s.then(o=>{for(const a of o||[])a.status==="rejected"&&i(a.reason);return e().catch(i)})};class s4{constructor(){this.encoder=new TextEncoder,this._pieces=[],this._parts=[]}append_buffer(e){this.flush(),this._parts.push(e)}append(e){this._pieces.push(e)}flush(){if(this._pieces.length>0){const e=new Uint8Array(this._pieces);this._parts.push(e),this._pieces=[]}}toArrayBuffer(){const e=[];for(const t of this._parts)e.push(t);return i4(e).buffer}}function i4(n){let e=0;for(const s of n)e+=s.byteLength;const t=new Uint8Array(e);let r=0;for(const s of n){const i=new Uint8Array(s.buffer,s.byteOffset,s.byteLength);t.set(i,r),r+=s.byteLength}return t}function zd(n){return new o4(n).unpack()}function Kd(n){const e=new a4,t=e.pack(n);return t instanceof Promise?t.then(()=>e.getBuffer()):e.getBuffer()}class o4{constructor(e){this.index=0,this.dataBuffer=e,this.dataView=new Uint8Array(this.dataBuffer),this.length=this.dataBuffer.byteLength}unpack(){const e=this.unpack_uint8();if(e<128)return e;if((e^224)<32)return(e^224)-32;let t;if((t=e^160)<=15)return this.unpack_raw(t);if((t=e^176)<=15)return this.unpack_string(t);if((t=e^144)<=15)return this.unpack_array(t);if((t=e^128)<=15)return this.unpack_map(t);switch(e){case 192:return null;case 193:return;case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 212:return;case 213:return;case 214:return;case 215:return;case 216:return t=this.unpack_uint16(),this.unpack_string(t);case 217:return t=this.unpack_uint32(),this.unpack_string(t);case 218:return t=this.unpack_uint16(),this.unpack_raw(t);case 219:return t=this.unpack_uint32(),this.unpack_raw(t);case 220:return t=this.unpack_uint16(),this.unpack_array(t);case 221:return t=this.unpack_uint32(),this.unpack_array(t);case 222:return t=this.unpack_uint16(),this.unpack_map(t);case 223:return t=this.unpack_uint32(),this.unpack_map(t)}}unpack_uint8(){const e=this.dataView[this.index]&255;return this.index++,e}unpack_uint16(){const e=this.read(2),t=(e[0]&255)*256+(e[1]&255);return this.index+=2,t}unpack_uint32(){const e=this.read(4),t=((e[0]*256+e[1])*256+e[2])*256+e[3];return this.index+=4,t}unpack_uint64(){const e=this.read(8),t=((((((e[0]*256+e[1])*256+e[2])*256+e[3])*256+e[4])*256+e[5])*256+e[6])*256+e[7];return this.index+=8,t}unpack_int8(){const e=this.unpack_uint8();return e<128?e:e-256}unpack_int16(){const e=this.unpack_uint16();return e<32768?e:e-65536}unpack_int32(){const e=this.unpack_uint32();return e<2**31?e:e-2**32}unpack_int64(){const e=this.unpack_uint64();return e<2**63?e:e-2**64}unpack_raw(e){if(this.length<this.index+e)throw new Error(`BinaryPackFailure: index is out of range ${this.index} ${e} ${this.length}`);const t=this.dataBuffer.slice(this.index,this.index+e);return this.index+=e,t}unpack_string(e){const t=this.read(e);let r=0,s="",i,o;for(;r<e;)i=t[r],i<160?(o=i,r++):(i^192)<32?(o=(i&31)<<6|t[r+1]&63,r+=2):(i^224)<16?(o=(i&15)<<12|(t[r+1]&63)<<6|t[r+2]&63,r+=3):(o=(i&7)<<18|(t[r+1]&63)<<12|(t[r+2]&63)<<6|t[r+3]&63,r+=4),s+=String.fromCodePoint(o);return this.index+=e,s}unpack_array(e){const t=new Array(e);for(let r=0;r<e;r++)t[r]=this.unpack();return t}unpack_map(e){const t={};for(let r=0;r<e;r++){const s=this.unpack();t[s]=this.unpack()}return t}unpack_float(){const e=this.unpack_uint32(),t=e>>31,r=(e>>23&255)-127,s=e&8388607|8388608;return(t===0?1:-1)*s*2**(r-23)}unpack_double(){const e=this.unpack_uint32(),t=this.unpack_uint32(),r=e>>31,s=(e>>20&2047)-1023,o=(e&1048575|1048576)*2**(s-20)+t*2**(s-52);return(r===0?1:-1)*o}read(e){const t=this.index;if(t+e<=this.length)return this.dataView.subarray(t,t+e);throw new Error("BinaryPackFailure: read index out of range")}}class a4{getBuffer(){return this._bufferBuilder.toArrayBuffer()}pack(e){if(typeof e=="string")this.pack_string(e);else if(typeof e=="number")Math.floor(e)===e?this.pack_integer(e):this.pack_double(e);else if(typeof e=="boolean")e===!0?this._bufferBuilder.append(195):e===!1&&this._bufferBuilder.append(194);else if(e===void 0)this._bufferBuilder.append(192);else if(typeof e=="object")if(e===null)this._bufferBuilder.append(192);else{const t=e.constructor;if(e instanceof Array){const r=this.pack_array(e);if(r instanceof Promise)return r.then(()=>this._bufferBuilder.flush())}else if(e instanceof ArrayBuffer)this.pack_bin(new Uint8Array(e));else if("BYTES_PER_ELEMENT"in e){const r=e;this.pack_bin(new Uint8Array(r.buffer,r.byteOffset,r.byteLength))}else if(e instanceof Date)this.pack_string(e.toString());else{if(e instanceof Blob)return e.arrayBuffer().then(r=>{this.pack_bin(new Uint8Array(r)),this._bufferBuilder.flush()});if(t==Object||t.toString().startsWith("class")){const r=this.pack_object(e);if(r instanceof Promise)return r.then(()=>this._bufferBuilder.flush())}else throw new Error(`Type "${t.toString()}" not yet supported`)}}else throw new Error(`Type "${typeof e}" not yet supported`);this._bufferBuilder.flush()}pack_bin(e){const t=e.length;if(t<=15)this.pack_uint8(160+t);else if(t<=65535)this._bufferBuilder.append(218),this.pack_uint16(t);else if(t<=4294967295)this._bufferBuilder.append(219),this.pack_uint32(t);else throw new Error("Invalid length");this._bufferBuilder.append_buffer(e)}pack_string(e){const t=this._textEncoder.encode(e),r=t.length;if(r<=15)this.pack_uint8(176+r);else if(r<=65535)this._bufferBuilder.append(216),this.pack_uint16(r);else if(r<=4294967295)this._bufferBuilder.append(217),this.pack_uint32(r);else throw new Error("Invalid length");this._bufferBuilder.append_buffer(t)}pack_array(e){const t=e.length;if(t<=15)this.pack_uint8(144+t);else if(t<=65535)this._bufferBuilder.append(220),this.pack_uint16(t);else if(t<=4294967295)this._bufferBuilder.append(221),this.pack_uint32(t);else throw new Error("Invalid length");const r=s=>{if(s<t){const i=this.pack(e[s]);return i instanceof Promise?i.then(()=>r(s+1)):r(s+1)}};return r(0)}pack_integer(e){if(e>=-32&&e<=127)this._bufferBuilder.append(e&255);else if(e>=0&&e<=255)this._bufferBuilder.append(204),this.pack_uint8(e);else if(e>=-128&&e<=127)this._bufferBuilder.append(208),this.pack_int8(e);else if(e>=0&&e<=65535)this._bufferBuilder.append(205),this.pack_uint16(e);else if(e>=-32768&&e<=32767)this._bufferBuilder.append(209),this.pack_int16(e);else if(e>=0&&e<=4294967295)this._bufferBuilder.append(206),this.pack_uint32(e);else if(e>=-2147483648&&e<=2147483647)this._bufferBuilder.append(210),this.pack_int32(e);else if(e>=-9223372036854776e3&&e<=9223372036854776e3)this._bufferBuilder.append(211),this.pack_int64(e);else if(e>=0&&e<=18446744073709552e3)this._bufferBuilder.append(207),this.pack_uint64(e);else throw new Error("Invalid integer")}pack_double(e){let t=0;e<0&&(t=1,e=-e);const r=Math.floor(Math.log(e)/Math.LN2),s=e/2**r-1,i=Math.floor(s*2**52),o=2**32,a=t<<31|r+1023<<20|i/o&1048575,c=i%o;this._bufferBuilder.append(203),this.pack_int32(a),this.pack_int32(c)}pack_object(e){const t=Object.keys(e),r=t.length;if(r<=15)this.pack_uint8(128+r);else if(r<=65535)this._bufferBuilder.append(222),this.pack_uint16(r);else if(r<=4294967295)this._bufferBuilder.append(223),this.pack_uint32(r);else throw new Error("Invalid length");const s=i=>{if(i<t.length){const o=t[i];if(e.hasOwnProperty(o)){this.pack(o);const a=this.pack(e[o]);if(a instanceof Promise)return a.then(()=>s(i+1))}return s(i+1)}};return s(0)}pack_uint8(e){this._bufferBuilder.append(e)}pack_uint16(e){this._bufferBuilder.append(e>>8),this._bufferBuilder.append(e&255)}pack_uint32(e){const t=e&4294967295;this._bufferBuilder.append((t&4278190080)>>>24),this._bufferBuilder.append((t&16711680)>>>16),this._bufferBuilder.append((t&65280)>>>8),this._bufferBuilder.append(t&255)}pack_uint64(e){const t=e/4294967296,r=e%2**32;this._bufferBuilder.append((t&4278190080)>>>24),this._bufferBuilder.append((t&16711680)>>>16),this._bufferBuilder.append((t&65280)>>>8),this._bufferBuilder.append(t&255),this._bufferBuilder.append((r&4278190080)>>>24),this._bufferBuilder.append((r&16711680)>>>16),this._bufferBuilder.append((r&65280)>>>8),this._bufferBuilder.append(r&255)}pack_int8(e){this._bufferBuilder.append(e&255)}pack_int16(e){this._bufferBuilder.append((e&65280)>>8),this._bufferBuilder.append(e&255)}pack_int32(e){this._bufferBuilder.append(e>>>24&255),this._bufferBuilder.append((e&16711680)>>>16),this._bufferBuilder.append((e&65280)>>>8),this._bufferBuilder.append(e&255)}pack_int64(e){const t=Math.floor(e/4294967296),r=e%2**32;this._bufferBuilder.append((t&4278190080)>>>24),this._bufferBuilder.append((t&16711680)>>>16),this._bufferBuilder.append((t&65280)>>>8),this._bufferBuilder.append(t&255),this._bufferBuilder.append((r&4278190080)>>>24),this._bufferBuilder.append((r&16711680)>>>16),this._bufferBuilder.append((r&65280)>>>8),this._bufferBuilder.append(r&255)}constructor(){this._bufferBuilder=new s4,this._textEncoder=new TextEncoder}}let jd=!0,Gd=!0;function bi(n,e,t){const r=n.match(e);return r&&r.length>=t&&parseInt(r[t],10)}function Qr(n,e,t){if(!n.RTCPeerConnection)return;const r=n.RTCPeerConnection.prototype,s=r.addEventListener;r.addEventListener=function(o,a){if(o!==e)return s.apply(this,arguments);const c=l=>{const u=t(l);u&&(a.handleEvent?a.handleEvent(u):a(u))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(a,c),s.apply(this,[o,c])};const i=r.removeEventListener;r.removeEventListener=function(o,a){if(o!==e||!this._eventMap||!this._eventMap[e])return i.apply(this,arguments);if(!this._eventMap[e].has(a))return i.apply(this,arguments);const c=this._eventMap[e].get(a);return this._eventMap[e].delete(a),this._eventMap[e].size===0&&delete this._eventMap[e],Object.keys(this._eventMap).length===0&&delete this._eventMap,i.apply(this,[o,c])},Object.defineProperty(r,"on"+e,{get(){return this["_on"+e]},set(o){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),o&&this.addEventListener(e,this["_on"+e]=o)},enumerable:!0,configurable:!0})}function c4(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):(jd=n,n?"adapter.js logging disabled":"adapter.js logging enabled")}function l4(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):(Gd=!n,"adapter.js deprecation warnings "+(n?"disabled":"enabled"))}function Wd(){if(typeof window=="object"){if(jd)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function Wc(n,e){Gd&&console.warn(n+" is deprecated, please use "+e+" instead.")}function u4(n){const e={browser:null,version:null};if(typeof n>"u"||!n.navigator||!n.navigator.userAgent)return e.browser="Not a browser.",e;const{navigator:t}=n;if(t.userAgentData&&t.userAgentData.brands){const r=t.userAgentData.brands.find(s=>s.brand==="Chromium");if(r)return{browser:"chrome",version:parseInt(r.version,10)}}if(t.mozGetUserMedia)e.browser="firefox",e.version=bi(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia||n.isSecureContext===!1&&n.webkitRTCPeerConnection)e.browser="chrome",e.version=bi(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(n.RTCPeerConnection&&t.userAgent.match(/AppleWebKit\/(\d+)\./))e.browser="safari",e.version=bi(t.userAgent,/AppleWebKit\/(\d+)\./,1),e.supportsUnifiedPlan=n.RTCRtpTransceiver&&"currentDirection"in n.RTCRtpTransceiver.prototype;else return e.browser="Not a supported browser.",e;return e}function g1(n){return Object.prototype.toString.call(n)==="[object Object]"}function Qd(n){return g1(n)?Object.keys(n).reduce(function(e,t){const r=g1(n[t]),s=r?Qd(n[t]):n[t],i=r&&!Object.keys(s).length;return s===void 0||i?e:Object.assign(e,{[t]:s})},{}):n}function za(n,e,t){!e||t.has(e.id)||(t.set(e.id,e),Object.keys(e).forEach(r=>{r.endsWith("Id")?za(n,n.get(e[r]),t):r.endsWith("Ids")&&e[r].forEach(s=>{za(n,n.get(s),t)})}))}function m1(n,e,t){const r=t?"outbound-rtp":"inbound-rtp",s=new Map;if(e===null)return s;const i=[];return n.forEach(o=>{o.type==="track"&&o.trackIdentifier===e.id&&i.push(o)}),i.forEach(o=>{n.forEach(a=>{a.type===r&&a.trackId===o.id&&za(n,a,s)})}),s}const y1=Wd;function Yd(n,e){const t=n&&n.navigator;if(!t.mediaDevices)return;const r=function(a){if(typeof a!="object"||a.mandatory||a.optional)return a;const c={};return Object.keys(a).forEach(l=>{if(l==="require"||l==="advanced"||l==="mediaSource")return;const u=typeof a[l]=="object"?a[l]:{ideal:a[l]};u.exact!==void 0&&typeof u.exact=="number"&&(u.min=u.max=u.exact);const h=function(f,g){return f?f+g.charAt(0).toUpperCase()+g.slice(1):g==="deviceId"?"sourceId":g};if(u.ideal!==void 0){c.optional=c.optional||[];let f={};typeof u.ideal=="number"?(f[h("min",l)]=u.ideal,c.optional.push(f),f={},f[h("max",l)]=u.ideal,c.optional.push(f)):(f[h("",l)]=u.ideal,c.optional.push(f))}u.exact!==void 0&&typeof u.exact!="number"?(c.mandatory=c.mandatory||{},c.mandatory[h("",l)]=u.exact):["min","max"].forEach(f=>{u[f]!==void 0&&(c.mandatory=c.mandatory||{},c.mandatory[h(f,l)]=u[f])})}),a.advanced&&(c.optional=(c.optional||[]).concat(a.advanced)),c},s=function(a,c){if(e.version>=61)return c(a);if(a=JSON.parse(JSON.stringify(a)),a&&typeof a.audio=="object"){const l=function(u,h,f){h in u&&!(f in u)&&(u[f]=u[h],delete u[h])};a=JSON.parse(JSON.stringify(a)),l(a.audio,"autoGainControl","googAutoGainControl"),l(a.audio,"noiseSuppression","googNoiseSuppression"),a.audio=r(a.audio)}if(a&&typeof a.video=="object"){let l=a.video.facingMode;l=l&&(typeof l=="object"?l:{ideal:l});const u=e.version<66;if(l&&(l.exact==="user"||l.exact==="environment"||l.ideal==="user"||l.ideal==="environment")&&!(t.mediaDevices.getSupportedConstraints&&t.mediaDevices.getSupportedConstraints().facingMode&&!u)){delete a.video.facingMode;let h;if(l.exact==="environment"||l.ideal==="environment"?h=["back","rear"]:(l.exact==="user"||l.ideal==="user")&&(h=["front"]),h)return t.mediaDevices.enumerateDevices().then(f=>{f=f.filter(p=>p.kind==="videoinput");let g=f.find(p=>h.some(m=>p.label.toLowerCase().includes(m)));return!g&&f.length&&h.includes("back")&&(g=f[f.length-1]),g&&(a.video.deviceId=l.exact?{exact:g.deviceId}:{ideal:g.deviceId}),a.video=r(a.video),y1("chrome: "+JSON.stringify(a)),c(a)})}a.video=r(a.video)}return y1("chrome: "+JSON.stringify(a)),c(a)},i=function(a){return e.version>=64?a:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[a.name]||a.name,message:a.message,constraint:a.constraint||a.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},o=function(a,c,l){s(a,u=>{t.webkitGetUserMedia(u,c,h=>{l&&l(i(h))})})};if(t.getUserMedia=o.bind(t),t.mediaDevices.getUserMedia){const a=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(c){return s(c,l=>a(l).then(u=>{if(l.audio&&!u.getAudioTracks().length||l.video&&!u.getVideoTracks().length)throw u.getTracks().forEach(h=>{h.stop()}),new DOMException("","NotFoundError");return u},u=>Promise.reject(i(u))))}}}function Jd(n){n.MediaStream=n.MediaStream||n.webkitMediaStream}function Zd(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("ontrack"in n.RTCPeerConnection.prototype)){Object.defineProperty(n.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(t){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=t)},enumerable:!0,configurable:!0});const e=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=r=>{r.stream.addEventListener("addtrack",s=>{let i;n.RTCPeerConnection.prototype.getReceivers?i=this.getReceivers().find(a=>a.track&&a.track.id===s.track.id):i={track:s.track};const o=new Event("track");o.track=s.track,o.receiver=i,o.transceiver={receiver:i},o.streams=[r.stream],this.dispatchEvent(o)}),r.stream.getTracks().forEach(s=>{let i;n.RTCPeerConnection.prototype.getReceivers?i=this.getReceivers().find(a=>a.track&&a.track.id===s.id):i={track:s};const o=new Event("track");o.track=s,o.receiver=i,o.transceiver={receiver:i},o.streams=[r.stream],this.dispatchEvent(o)})},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else Qr(n,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function Xd(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("getSenders"in n.RTCPeerConnection.prototype)&&"createDTMFSender"in n.RTCPeerConnection.prototype){const e=function(s,i){return{track:i,get dtmf(){return this._dtmf===void 0&&(i.kind==="audio"?this._dtmf=s.createDTMFSender(i):this._dtmf=null),this._dtmf},_pc:s}};if(!n.RTCPeerConnection.prototype.getSenders){n.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const s=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(a,c){let l=s.apply(this,arguments);return l||(l=e(this,a),this._senders.push(l)),l};const i=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(a){i.apply(this,arguments);const c=this._senders.indexOf(a);c!==-1&&this._senders.splice(c,1)}}const t=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(i){this._senders=this._senders||[],t.apply(this,[i]),i.getTracks().forEach(o=>{this._senders.push(e(this,o))})};const r=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(i){this._senders=this._senders||[],r.apply(this,[i]),i.getTracks().forEach(o=>{const a=this._senders.find(c=>c.track===o);a&&this._senders.splice(this._senders.indexOf(a),1)})}}else if(typeof n=="object"&&n.RTCPeerConnection&&"getSenders"in n.RTCPeerConnection.prototype&&"createDTMFSender"in n.RTCPeerConnection.prototype&&n.RTCRtpSender&&!("dtmf"in n.RTCRtpSender.prototype)){const e=n.RTCPeerConnection.prototype.getSenders;n.RTCPeerConnection.prototype.getSenders=function(){const r=e.apply(this,[]);return r.forEach(s=>s._pc=this),r},Object.defineProperty(n.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function e2(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender&&n.RTCRtpReceiver))return;if(!("getStats"in n.RTCRtpSender.prototype)){const t=n.RTCPeerConnection.prototype.getSenders;t&&(n.RTCPeerConnection.prototype.getSenders=function(){const i=t.apply(this,[]);return i.forEach(o=>o._pc=this),i});const r=n.RTCPeerConnection.prototype.addTrack;r&&(n.RTCPeerConnection.prototype.addTrack=function(){const i=r.apply(this,arguments);return i._pc=this,i}),n.RTCRtpSender.prototype.getStats=function(){const i=this;return this._pc.getStats().then(o=>m1(o,i.track,!0))}}if(!("getStats"in n.RTCRtpReceiver.prototype)){const t=n.RTCPeerConnection.prototype.getReceivers;t&&(n.RTCPeerConnection.prototype.getReceivers=function(){const s=t.apply(this,[]);return s.forEach(i=>i._pc=this),s}),Qr(n,"track",r=>(r.receiver._pc=r.srcElement,r)),n.RTCRtpReceiver.prototype.getStats=function(){const s=this;return this._pc.getStats().then(i=>m1(i,s.track,!1))}}if(!("getStats"in n.RTCRtpSender.prototype&&"getStats"in n.RTCRtpReceiver.prototype))return;const e=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof n.MediaStreamTrack){const r=arguments[0];let s,i,o;return this.getSenders().forEach(a=>{a.track===r&&(s?o=!0:s=a)}),this.getReceivers().forEach(a=>(a.track===r&&(i?o=!0:i=a),a.track===r)),o||s&&i?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):s?s.getStats():i?i.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function t2(n){n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(o=>this._shimmedLocalStreams[o][0])};const e=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(o,a){if(!a)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const c=e.apply(this,arguments);return this._shimmedLocalStreams[a.id]?this._shimmedLocalStreams[a.id].indexOf(c)===-1&&this._shimmedLocalStreams[a.id].push(c):this._shimmedLocalStreams[a.id]=[a,c],c};const t=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(o){this._shimmedLocalStreams=this._shimmedLocalStreams||{},o.getTracks().forEach(l=>{if(this.getSenders().find(h=>h.track===l))throw new DOMException("Track already exists.","InvalidAccessError")});const a=this.getSenders();t.apply(this,arguments);const c=this.getSenders().filter(l=>a.indexOf(l)===-1);this._shimmedLocalStreams[o.id]=[o].concat(c)};const r=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[o.id],r.apply(this,arguments)};const s=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},o&&Object.keys(this._shimmedLocalStreams).forEach(a=>{const c=this._shimmedLocalStreams[a].indexOf(o);c!==-1&&this._shimmedLocalStreams[a].splice(c,1),this._shimmedLocalStreams[a].length===1&&delete this._shimmedLocalStreams[a]}),s.apply(this,arguments)}}function r2(n,e){if(!n.RTCPeerConnection)return;if(n.RTCPeerConnection.prototype.addTrack&&e.version>=65)return t2(n);const t=n.RTCPeerConnection.prototype.getLocalStreams;n.RTCPeerConnection.prototype.getLocalStreams=function(){const u=t.apply(this);return this._reverseStreams=this._reverseStreams||{},u.map(h=>this._reverseStreams[h.id])};const r=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(u){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},u.getTracks().forEach(h=>{if(this.getSenders().find(g=>g.track===h))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[u.id]){const h=new n.MediaStream(u.getTracks());this._streams[u.id]=h,this._reverseStreams[h.id]=u,u=h}r.apply(this,[u])};const s=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(u){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},s.apply(this,[this._streams[u.id]||u]),delete this._reverseStreams[this._streams[u.id]?this._streams[u.id].id:u.id],delete this._streams[u.id]},n.RTCPeerConnection.prototype.addTrack=function(u,h){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const f=[].slice.call(arguments,1);if(f.length!==1||!f[0].getTracks().find(m=>m===u))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(m=>m.track===u))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const p=this._streams[h.id];if(p)p.addTrack(u),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const m=new n.MediaStream([u]);this._streams[h.id]=m,this._reverseStreams[m.id]=h,this.addStream(m)}return this.getSenders().find(m=>m.track===u)};function i(l,u){let h=u.sdp;return Object.keys(l._reverseStreams||[]).forEach(f=>{const g=l._reverseStreams[f],p=l._streams[g.id];h=h.replace(new RegExp(p.id,"g"),g.id)}),new RTCSessionDescription({type:u.type,sdp:h})}function o(l,u){let h=u.sdp;return Object.keys(l._reverseStreams||[]).forEach(f=>{const g=l._reverseStreams[f],p=l._streams[g.id];h=h.replace(new RegExp(g.id,"g"),p.id)}),new RTCSessionDescription({type:u.type,sdp:h})}["createOffer","createAnswer"].forEach(function(l){const u=n.RTCPeerConnection.prototype[l],h={[l](){const f=arguments;return arguments.length&&typeof arguments[0]=="function"?u.apply(this,[p=>{const m=i(this,p);f[0].apply(null,[m])},p=>{f[1]&&f[1].apply(null,p)},arguments[2]]):u.apply(this,arguments).then(p=>i(this,p))}};n.RTCPeerConnection.prototype[l]=h[l]});const a=n.RTCPeerConnection.prototype.setLocalDescription;n.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?a.apply(this,arguments):(arguments[0]=o(this,arguments[0]),a.apply(this,arguments))};const c=Object.getOwnPropertyDescriptor(n.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(n.RTCPeerConnection.prototype,"localDescription",{get(){const l=c.get.apply(this);return l.type===""?l:i(this,l)}}),n.RTCPeerConnection.prototype.removeTrack=function(u){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!u._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(u._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let f;Object.keys(this._streams).forEach(g=>{this._streams[g].getTracks().find(m=>u.track===m)&&(f=this._streams[g])}),f&&(f.getTracks().length===1?this.removeStream(this._reverseStreams[f.id]):f.removeTrack(u.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Ka(n,e){!n.RTCPeerConnection&&n.webkitRTCPeerConnection&&(n.RTCPeerConnection=n.webkitRTCPeerConnection),n.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){const r=n.RTCPeerConnection.prototype[t],s={[t](){return arguments[0]=new(t==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}};n.RTCPeerConnection.prototype[t]=s[t]})}function n2(n,e){Qr(n,"negotiationneeded",t=>{const r=t.target;if(!((e.version<72||r.getConfiguration&&r.getConfiguration().sdpSemantics==="plan-b")&&r.signalingState!=="stable"))return t})}const b1=Object.freeze(Object.defineProperty({__proto__:null,fixNegotiationNeeded:n2,shimAddTrackRemoveTrack:r2,shimAddTrackRemoveTrackWithNative:t2,shimGetSendersWithDtmf:Xd,shimGetUserMedia:Yd,shimMediaStream:Jd,shimOnTrack:Zd,shimPeerConnection:Ka,shimSenderReceiverGetStats:e2},Symbol.toStringTag,{value:"Module"}));function s2(n,e){const t=n&&n.navigator,r=n&&n.MediaStreamTrack;if(t.getUserMedia=function(s,i,o){Wc("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),t.mediaDevices.getUserMedia(s).then(i,o)},!(e.version>55&&"autoGainControl"in t.mediaDevices.getSupportedConstraints())){const s=function(o,a,c){a in o&&!(c in o)&&(o[c]=o[a],delete o[a])},i=t.mediaDevices.getUserMedia.bind(t.mediaDevices);if(t.mediaDevices.getUserMedia=function(o){return typeof o=="object"&&typeof o.audio=="object"&&(o=JSON.parse(JSON.stringify(o)),s(o.audio,"autoGainControl","mozAutoGainControl"),s(o.audio,"noiseSuppression","mozNoiseSuppression")),i(o)},r&&r.prototype.getSettings){const o=r.prototype.getSettings;r.prototype.getSettings=function(){const a=o.apply(this,arguments);return s(a,"mozAutoGainControl","autoGainControl"),s(a,"mozNoiseSuppression","noiseSuppression"),a}}if(r&&r.prototype.applyConstraints){const o=r.prototype.applyConstraints;r.prototype.applyConstraints=function(a){return this.kind==="audio"&&typeof a=="object"&&(a=JSON.parse(JSON.stringify(a)),s(a,"autoGainControl","mozAutoGainControl"),s(a,"noiseSuppression","mozNoiseSuppression")),o.apply(this,[a])}}}}function d4(n,e){n.navigator.mediaDevices&&"getDisplayMedia"in n.navigator.mediaDevices||n.navigator.mediaDevices&&(n.navigator.mediaDevices.getDisplayMedia=function(r){if(!(r&&r.video)){const s=new DOMException("getDisplayMedia without video constraints is undefined");return s.name="NotFoundError",s.code=8,Promise.reject(s)}return r.video===!0?r.video={mediaSource:e}:r.video.mediaSource=e,n.navigator.mediaDevices.getUserMedia(r)})}function i2(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function ja(n,e){if(typeof n!="object"||!(n.RTCPeerConnection||n.mozRTCPeerConnection))return;!n.RTCPeerConnection&&n.mozRTCPeerConnection&&(n.RTCPeerConnection=n.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(s){const i=n.RTCPeerConnection.prototype[s],o={[s](){return arguments[0]=new(s==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};n.RTCPeerConnection.prototype[s]=o[s]});const t={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},r=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){const[i,o,a]=arguments;return r.apply(this,[i||null]).then(c=>{if(e.version<53&&!o)try{c.forEach(l=>{l.type=t[l.type]||l.type})}catch(l){if(l.name!=="TypeError")throw l;c.forEach((u,h)=>{c.set(h,Object.assign({},u,{type:t[u.type]||u.type}))})}return c}).then(o,a)}}function o2(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender)||n.RTCRtpSender&&"getStats"in n.RTCRtpSender.prototype)return;const e=n.RTCPeerConnection.prototype.getSenders;e&&(n.RTCPeerConnection.prototype.getSenders=function(){const s=e.apply(this,[]);return s.forEach(i=>i._pc=this),s});const t=n.RTCPeerConnection.prototype.addTrack;t&&(n.RTCPeerConnection.prototype.addTrack=function(){const s=t.apply(this,arguments);return s._pc=this,s}),n.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function a2(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender)||n.RTCRtpSender&&"getStats"in n.RTCRtpReceiver.prototype)return;const e=n.RTCPeerConnection.prototype.getReceivers;e&&(n.RTCPeerConnection.prototype.getReceivers=function(){const r=e.apply(this,[]);return r.forEach(s=>s._pc=this),r}),Qr(n,"track",t=>(t.receiver._pc=t.srcElement,t)),n.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function c2(n){!n.RTCPeerConnection||"removeStream"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.removeStream=function(t){Wc("removeStream","removeTrack"),this.getSenders().forEach(r=>{r.track&&t.getTracks().includes(r.track)&&this.removeTrack(r)})})}function l2(n){n.DataChannel&&!n.RTCDataChannel&&(n.RTCDataChannel=n.DataChannel)}function u2(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const e=n.RTCPeerConnection.prototype.addTransceiver;e&&(n.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let r=arguments[1]&&arguments[1].sendEncodings;r===void 0&&(r=[]),r=[...r];const s=r.length>0;s&&r.forEach(o=>{if("rid"in o&&!/^[a-z0-9]{0,16}$/i.test(o.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in o&&!(parseFloat(o.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in o&&!(parseFloat(o.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const i=e.apply(this,arguments);if(s){const{sender:o}=i,a=o.getParameters();(!("encodings"in a)||a.encodings.length===1&&Object.keys(a.encodings[0]).length===0)&&(a.encodings=r,o.sendEncodings=r,this.setParametersPromises.push(o.setParameters(a).then(()=>{delete o.sendEncodings}).catch(()=>{delete o.sendEncodings})))}return i})}function d2(n){if(!(typeof n=="object"&&n.RTCRtpSender))return;const e=n.RTCRtpSender.prototype.getParameters;e&&(n.RTCRtpSender.prototype.getParameters=function(){const r=e.apply(this,arguments);return"encodings"in r||(r.encodings=[].concat(this.sendEncodings||[{}])),r})}function h2(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const e=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}function f2(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const e=n.RTCPeerConnection.prototype.createAnswer;n.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}const w1=Object.freeze(Object.defineProperty({__proto__:null,shimAddTransceiver:u2,shimCreateAnswer:f2,shimCreateOffer:h2,shimGetDisplayMedia:d4,shimGetParameters:d2,shimGetUserMedia:s2,shimOnTrack:i2,shimPeerConnection:ja,shimRTCDataChannel:l2,shimReceiverGetStats:a2,shimRemoveStream:c2,shimSenderGetStats:o2},Symbol.toStringTag,{value:"Module"}));function p2(n){if(!(typeof n!="object"||!n.RTCPeerConnection)){if("getLocalStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in n.RTCPeerConnection.prototype)){const e=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addStream=function(r){this._localStreams||(this._localStreams=[]),this._localStreams.includes(r)||this._localStreams.push(r),r.getAudioTracks().forEach(s=>e.call(this,s,r)),r.getVideoTracks().forEach(s=>e.call(this,s,r))},n.RTCPeerConnection.prototype.addTrack=function(r,...s){return s&&s.forEach(i=>{this._localStreams?this._localStreams.includes(i)||this._localStreams.push(i):this._localStreams=[i]}),e.apply(this,arguments)}}"removeStream"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.removeStream=function(t){this._localStreams||(this._localStreams=[]);const r=this._localStreams.indexOf(t);if(r===-1)return;this._localStreams.splice(r,1);const s=t.getTracks();this.getSenders().forEach(i=>{s.includes(i.track)&&this.removeTrack(i)})})}}function g2(n){if(!(typeof n!="object"||!n.RTCPeerConnection)&&("getRemoteStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in n.RTCPeerConnection.prototype))){Object.defineProperty(n.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(t){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=t),this.addEventListener("track",this._onaddstreampoly=r=>{r.streams.forEach(s=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(s))return;this._remoteStreams.push(s);const i=new Event("addstream");i.stream=s,this.dispatchEvent(i)})})}});const e=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){const r=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(s){s.streams.forEach(i=>{if(r._remoteStreams||(r._remoteStreams=[]),r._remoteStreams.indexOf(i)>=0)return;r._remoteStreams.push(i);const o=new Event("addstream");o.stream=i,r.dispatchEvent(o)})}),e.apply(r,arguments)}}}function m2(n){if(typeof n!="object"||!n.RTCPeerConnection)return;const e=n.RTCPeerConnection.prototype,t=e.createOffer,r=e.createAnswer,s=e.setLocalDescription,i=e.setRemoteDescription,o=e.addIceCandidate;e.createOffer=function(l,u){const h=arguments.length>=2?arguments[2]:arguments[0],f=t.apply(this,[h]);return u?(f.then(l,u),Promise.resolve()):f},e.createAnswer=function(l,u){const h=arguments.length>=2?arguments[2]:arguments[0],f=r.apply(this,[h]);return u?(f.then(l,u),Promise.resolve()):f};let a=function(c,l,u){const h=s.apply(this,[c]);return u?(h.then(l,u),Promise.resolve()):h};e.setLocalDescription=a,a=function(c,l,u){const h=i.apply(this,[c]);return u?(h.then(l,u),Promise.resolve()):h},e.setRemoteDescription=a,a=function(c,l,u){const h=o.apply(this,[c]);return u?(h.then(l,u),Promise.resolve()):h},e.addIceCandidate=a}function y2(n){const e=n&&n.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){const t=e.mediaDevices,r=t.getUserMedia.bind(t);e.mediaDevices.getUserMedia=s=>r(b2(s))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=(function(r,s,i){e.mediaDevices.getUserMedia(r).then(s,i)}).bind(e))}function b2(n){return n&&n.video!==void 0?Object.assign({},n,{video:Qd(n.video)}):n}function w2(n){if(!n.RTCPeerConnection)return;const e=n.RTCPeerConnection;n.RTCPeerConnection=function(r,s){if(r&&r.iceServers){const i=[];for(let o=0;o<r.iceServers.length;o++){let a=r.iceServers[o];a.urls===void 0&&a.url?(Wc("RTCIceServer.url","RTCIceServer.urls"),a=JSON.parse(JSON.stringify(a)),a.urls=a.url,delete a.url,i.push(a)):i.push(r.iceServers[o])}r.iceServers=i}return new e(r,s)},n.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(n.RTCPeerConnection,"generateCertificate",{get(){return e.generateCertificate}})}function v2(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function E2(n){const e=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(r){if(r){typeof r.offerToReceiveAudio<"u"&&(r.offerToReceiveAudio=!!r.offerToReceiveAudio);const s=this.getTransceivers().find(o=>o.receiver.track.kind==="audio");r.offerToReceiveAudio===!1&&s?s.direction==="sendrecv"?s.setDirection?s.setDirection("sendonly"):s.direction="sendonly":s.direction==="recvonly"&&(s.setDirection?s.setDirection("inactive"):s.direction="inactive"):r.offerToReceiveAudio===!0&&!s&&this.addTransceiver("audio",{direction:"recvonly"}),typeof r.offerToReceiveVideo<"u"&&(r.offerToReceiveVideo=!!r.offerToReceiveVideo);const i=this.getTransceivers().find(o=>o.receiver.track.kind==="video");r.offerToReceiveVideo===!1&&i?i.direction==="sendrecv"?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":i.direction==="recvonly"&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):r.offerToReceiveVideo===!0&&!i&&this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function S2(n){typeof n!="object"||n.AudioContext||(n.AudioContext=n.webkitAudioContext)}const v1=Object.freeze(Object.defineProperty({__proto__:null,shimAudioContext:S2,shimCallbacksAPI:m2,shimConstraints:b2,shimCreateOfferLegacy:E2,shimGetUserMedia:y2,shimLocalStreamsAPI:p2,shimRTCIceServerUrls:w2,shimRemoteStreamsAPI:g2,shimTrackEventTransceiver:v2},Symbol.toStringTag,{value:"Module"}));var _2=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Us(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var x2={exports:{}};(function(n){const e={};e.generateIdentifier=function(){return Math.random().toString(36).substring(2,12)},e.localCName=e.generateIdentifier(),e.splitLines=function(t){return t.trim().split(`
`).map(r=>r.trim())},e.splitSections=function(t){return t.split(`
m=`).map((s,i)=>(i>0?"m="+s:s).trim()+`\r
`)},e.getDescription=function(t){const r=e.splitSections(t);return r&&r[0]},e.getMediaSections=function(t){const r=e.splitSections(t);return r.shift(),r},e.matchPrefix=function(t,r){return e.splitLines(t).filter(s=>s.indexOf(r)===0)},e.parseCandidate=function(t){let r;t.indexOf("a=candidate:")===0?r=t.substring(12).split(" "):r=t.substring(10).split(" ");const s={foundation:r[0],component:{1:"rtp",2:"rtcp"}[r[1]]||r[1],protocol:r[2].toLowerCase(),priority:parseInt(r[3],10),ip:r[4],address:r[4],port:parseInt(r[5],10),type:r[7]};for(let i=8;i<r.length;i+=2)switch(r[i]){case"raddr":s.relatedAddress=r[i+1];break;case"rport":s.relatedPort=parseInt(r[i+1],10);break;case"tcptype":s.tcpType=r[i+1];break;case"ufrag":s.ufrag=r[i+1],s.usernameFragment=r[i+1];break;default:s[r[i]]===void 0&&(s[r[i]]=r[i+1]);break}return s},e.writeCandidate=function(t){const r=[];r.push(t.foundation);const s=t.component;s==="rtp"?r.push(1):s==="rtcp"?r.push(2):r.push(s),r.push(t.protocol.toUpperCase()),r.push(t.priority),r.push(t.address||t.ip),r.push(t.port);const i=t.type;return r.push("typ"),r.push(i),i!=="host"&&t.relatedAddress&&t.relatedPort&&(r.push("raddr"),r.push(t.relatedAddress),r.push("rport"),r.push(t.relatedPort)),t.tcpType&&t.protocol.toLowerCase()==="tcp"&&(r.push("tcptype"),r.push(t.tcpType)),(t.usernameFragment||t.ufrag)&&(r.push("ufrag"),r.push(t.usernameFragment||t.ufrag)),"candidate:"+r.join(" ")},e.parseIceOptions=function(t){return t.substring(14).split(" ")},e.parseRtpMap=function(t){let r=t.substring(9).split(" ");const s={payloadType:parseInt(r.shift(),10)};return r=r[0].split("/"),s.name=r[0],s.clockRate=parseInt(r[1],10),s.channels=r.length===3?parseInt(r[2],10):1,s.numChannels=s.channels,s},e.writeRtpMap=function(t){let r=t.payloadType;t.preferredPayloadType!==void 0&&(r=t.preferredPayloadType);const s=t.channels||t.numChannels||1;return"a=rtpmap:"+r+" "+t.name+"/"+t.clockRate+(s!==1?"/"+s:"")+`\r
`},e.parseExtmap=function(t){const r=t.substring(9).split(" ");return{id:parseInt(r[0],10),direction:r[0].indexOf("/")>0?r[0].split("/")[1]:"sendrecv",uri:r[1],attributes:r.slice(2).join(" ")}},e.writeExtmap=function(t){return"a=extmap:"+(t.id||t.preferredId)+(t.direction&&t.direction!=="sendrecv"?"/"+t.direction:"")+" "+t.uri+(t.attributes?" "+t.attributes:"")+`\r
`},e.parseFmtp=function(t){const r={};let s;const i=t.substring(t.indexOf(" ")+1).split(";");for(let o=0;o<i.length;o++)s=i[o].trim().split("="),r[s[0].trim()]=s[1];return r},e.writeFmtp=function(t){let r="",s=t.payloadType;if(t.preferredPayloadType!==void 0&&(s=t.preferredPayloadType),t.parameters&&Object.keys(t.parameters).length){const i=[];Object.keys(t.parameters).forEach(o=>{t.parameters[o]!==void 0?i.push(o+"="+t.parameters[o]):i.push(o)}),r+="a=fmtp:"+s+" "+i.join(";")+`\r
`}return r},e.parseRtcpFb=function(t){const r=t.substring(t.indexOf(" ")+1).split(" ");return{type:r.shift(),parameter:r.join(" ")}},e.writeRtcpFb=function(t){let r="",s=t.payloadType;return t.preferredPayloadType!==void 0&&(s=t.preferredPayloadType),t.rtcpFeedback&&t.rtcpFeedback.length&&t.rtcpFeedback.forEach(i=>{r+="a=rtcp-fb:"+s+" "+i.type+(i.parameter&&i.parameter.length?" "+i.parameter:"")+`\r
`}),r},e.parseSsrcMedia=function(t){const r=t.indexOf(" "),s={ssrc:parseInt(t.substring(7,r),10)},i=t.indexOf(":",r);return i>-1?(s.attribute=t.substring(r+1,i),s.value=t.substring(i+1)):s.attribute=t.substring(r+1),s},e.parseSsrcGroup=function(t){const r=t.substring(13).split(" ");return{semantics:r.shift(),ssrcs:r.map(s=>parseInt(s,10))}},e.getMid=function(t){const r=e.matchPrefix(t,"a=mid:")[0];if(r)return r.substring(6)},e.parseFingerprint=function(t){const r=t.substring(14).split(" ");return{algorithm:r[0].toLowerCase(),value:r[1].toUpperCase()}},e.getDtlsParameters=function(t,r){return{role:"auto",fingerprints:e.matchPrefix(t+r,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(t,r){let s="a=setup:"+r+`\r
`;return t.fingerprints.forEach(i=>{s+="a=fingerprint:"+i.algorithm+" "+i.value+`\r
`}),s},e.parseCryptoLine=function(t){const r=t.substring(9).split(" ");return{tag:parseInt(r[0],10),cryptoSuite:r[1],keyParams:r[2],sessionParams:r.slice(3)}},e.writeCryptoLine=function(t){return"a=crypto:"+t.tag+" "+t.cryptoSuite+" "+(typeof t.keyParams=="object"?e.writeCryptoKeyParams(t.keyParams):t.keyParams)+(t.sessionParams?" "+t.sessionParams.join(" "):"")+`\r
`},e.parseCryptoKeyParams=function(t){if(t.indexOf("inline:")!==0)return null;const r=t.substring(7).split("|");return{keyMethod:"inline",keySalt:r[0],lifeTime:r[1],mkiValue:r[2]?r[2].split(":")[0]:void 0,mkiLength:r[2]?r[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(t){return t.keyMethod+":"+t.keySalt+(t.lifeTime?"|"+t.lifeTime:"")+(t.mkiValue&&t.mkiLength?"|"+t.mkiValue+":"+t.mkiLength:"")},e.getCryptoParameters=function(t,r){return e.matchPrefix(t+r,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(t,r){const s=e.matchPrefix(t+r,"a=ice-ufrag:")[0],i=e.matchPrefix(t+r,"a=ice-pwd:")[0];return s&&i?{usernameFragment:s.substring(12),password:i.substring(10)}:null},e.writeIceParameters=function(t){let r="a=ice-ufrag:"+t.usernameFragment+`\r
a=ice-pwd:`+t.password+`\r
`;return t.iceLite&&(r+=`a=ice-lite\r
`),r},e.parseRtpParameters=function(t){const r={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},i=e.splitLines(t)[0].split(" ");r.profile=i[2];for(let a=3;a<i.length;a++){const c=i[a],l=e.matchPrefix(t,"a=rtpmap:"+c+" ")[0];if(l){const u=e.parseRtpMap(l),h=e.matchPrefix(t,"a=fmtp:"+c+" ");switch(u.parameters=h.length?e.parseFmtp(h[0]):{},u.rtcpFeedback=e.matchPrefix(t,"a=rtcp-fb:"+c+" ").map(e.parseRtcpFb),r.codecs.push(u),u.name.toUpperCase()){case"RED":case"ULPFEC":r.fecMechanisms.push(u.name.toUpperCase());break}}}e.matchPrefix(t,"a=extmap:").forEach(a=>{r.headerExtensions.push(e.parseExtmap(a))});const o=e.matchPrefix(t,"a=rtcp-fb:* ").map(e.parseRtcpFb);return r.codecs.forEach(a=>{o.forEach(c=>{a.rtcpFeedback.find(u=>u.type===c.type&&u.parameter===c.parameter)||a.rtcpFeedback.push(c)})}),r},e.writeRtpDescription=function(t,r){let s="";s+="m="+t+" ",s+=r.codecs.length>0?"9":"0",s+=" "+(r.profile||"UDP/TLS/RTP/SAVPF")+" ",s+=r.codecs.map(o=>o.preferredPayloadType!==void 0?o.preferredPayloadType:o.payloadType).join(" ")+`\r
`,s+=`c=IN IP4 0.0.0.0\r
`,s+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,r.codecs.forEach(o=>{s+=e.writeRtpMap(o),s+=e.writeFmtp(o),s+=e.writeRtcpFb(o)});let i=0;return r.codecs.forEach(o=>{o.maxptime>i&&(i=o.maxptime)}),i>0&&(s+="a=maxptime:"+i+`\r
`),r.headerExtensions&&r.headerExtensions.forEach(o=>{s+=e.writeExtmap(o)}),s},e.parseRtpEncodingParameters=function(t){const r=[],s=e.parseRtpParameters(t),i=s.fecMechanisms.indexOf("RED")!==-1,o=s.fecMechanisms.indexOf("ULPFEC")!==-1,a=e.matchPrefix(t,"a=ssrc:").map(f=>e.parseSsrcMedia(f)).filter(f=>f.attribute==="cname"),c=a.length>0&&a[0].ssrc;let l;const u=e.matchPrefix(t,"a=ssrc-group:FID").map(f=>f.substring(17).split(" ").map(p=>parseInt(p,10)));u.length>0&&u[0].length>1&&u[0][0]===c&&(l=u[0][1]),s.codecs.forEach(f=>{if(f.name.toUpperCase()==="RTX"&&f.parameters.apt){let g={ssrc:c,codecPayloadType:parseInt(f.parameters.apt,10)};c&&l&&(g.rtx={ssrc:l}),r.push(g),i&&(g=JSON.parse(JSON.stringify(g)),g.fec={ssrc:c,mechanism:o?"red+ulpfec":"red"},r.push(g))}}),r.length===0&&c&&r.push({ssrc:c});let h=e.matchPrefix(t,"b=");return h.length&&(h[0].indexOf("b=TIAS:")===0?h=parseInt(h[0].substring(7),10):h[0].indexOf("b=AS:")===0?h=parseInt(h[0].substring(5),10)*1e3*.95-50*40*8:h=void 0,r.forEach(f=>{f.maxBitrate=h})),r},e.parseRtcpParameters=function(t){const r={},s=e.matchPrefix(t,"a=ssrc:").map(a=>e.parseSsrcMedia(a)).filter(a=>a.attribute==="cname")[0];s&&(r.cname=s.value,r.ssrc=s.ssrc);const i=e.matchPrefix(t,"a=rtcp-rsize");r.reducedSize=i.length>0,r.compound=i.length===0;const o=e.matchPrefix(t,"a=rtcp-mux");return r.mux=o.length>0,r},e.writeRtcpParameters=function(t){let r="";return t.reducedSize&&(r+=`a=rtcp-rsize\r
`),t.mux&&(r+=`a=rtcp-mux\r
`),t.ssrc!==void 0&&t.cname&&(r+="a=ssrc:"+t.ssrc+" cname:"+t.cname+`\r
`),r},e.parseMsid=function(t){let r;const s=e.matchPrefix(t,"a=msid:");if(s.length===1)return r=s[0].substring(7).split(" "),{stream:r[0],track:r[1]};const i=e.matchPrefix(t,"a=ssrc:").map(o=>e.parseSsrcMedia(o)).filter(o=>o.attribute==="msid");if(i.length>0)return r=i[0].value.split(" "),{stream:r[0],track:r[1]}},e.parseSctpDescription=function(t){const r=e.parseMLine(t),s=e.matchPrefix(t,"a=max-message-size:");let i;s.length>0&&(i=parseInt(s[0].substring(19),10)),isNaN(i)&&(i=65536);const o=e.matchPrefix(t,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substring(12),10),protocol:r.fmt,maxMessageSize:i};const a=e.matchPrefix(t,"a=sctpmap:");if(a.length>0){const c=a[0].substring(10).split(" ");return{port:parseInt(c[0],10),protocol:c[1],maxMessageSize:i}}},e.writeSctpDescription=function(t,r){let s=[];return t.protocol!=="DTLS/SCTP"?s=["m="+t.kind+" 9 "+t.protocol+" "+r.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+r.port+`\r
`]:s=["m="+t.kind+" 9 "+t.protocol+" "+r.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+r.port+" "+r.protocol+` 65535\r
`],r.maxMessageSize!==void 0&&s.push("a=max-message-size:"+r.maxMessageSize+`\r
`),s.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(t,r,s){let i;const o=r!==void 0?r:2;return t?i=t:i=e.generateSessionId(),`v=0\r
o=`+(s||"thisisadapterortc")+" "+i+" "+o+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},e.getDirection=function(t,r){const s=e.splitLines(t);for(let i=0;i<s.length;i++)switch(s[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return s[i].substring(2)}return r?e.getDirection(r):"sendrecv"},e.getKind=function(t){return e.splitLines(t)[0].split(" ")[0].substring(2)},e.isRejected=function(t){return t.split(" ",2)[1]==="0"},e.parseMLine=function(t){const s=e.splitLines(t)[0].substring(2).split(" ");return{kind:s[0],port:parseInt(s[1],10),protocol:s[2],fmt:s.slice(3).join(" ")}},e.parseOLine=function(t){const s=e.matchPrefix(t,"o=")[0].substring(2).split(" ");return{username:s[0],sessionId:s[1],sessionVersion:parseInt(s[2],10),netType:s[3],addressType:s[4],address:s[5]}},e.isValidSDP=function(t){if(typeof t!="string"||t.length===0)return!1;const r=e.splitLines(t);for(let s=0;s<r.length;s++)if(r[s].length<2||r[s].charAt(1)!=="=")return!1;return!0},n.exports=e})(x2);var k2=x2.exports;const dn=Us(k2),h4=e4({__proto__:null,default:dn},[k2]);function wi(n){if(!n.RTCIceCandidate||n.RTCIceCandidate&&"foundation"in n.RTCIceCandidate.prototype)return;const e=n.RTCIceCandidate;n.RTCIceCandidate=function(r){if(typeof r=="object"&&r.candidate&&r.candidate.indexOf("a=")===0&&(r=JSON.parse(JSON.stringify(r)),r.candidate=r.candidate.substring(2)),r.candidate&&r.candidate.length){const s=new e(r),i=dn.parseCandidate(r.candidate);for(const o in i)o in s||Object.defineProperty(s,o,{value:i[o]});return s.toJSON=function(){return{candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s}return new e(r)},n.RTCIceCandidate.prototype=e.prototype,Qr(n,"icecandidate",t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new n.RTCIceCandidate(t.candidate),writable:"false"}),t))}function Ga(n){!n.RTCIceCandidate||n.RTCIceCandidate&&"relayProtocol"in n.RTCIceCandidate.prototype||Qr(n,"icecandidate",e=>{if(e.candidate){const t=dn.parseCandidate(e.candidate.candidate);t.type==="relay"&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e})}function vi(n,e){if(!n.RTCPeerConnection)return;"sctp"in n.RTCPeerConnection.prototype||Object.defineProperty(n.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp}});const t=function(a){if(!a||!a.sdp)return!1;const c=dn.splitSections(a.sdp);return c.shift(),c.some(l=>{const u=dn.parseMLine(l);return u&&u.kind==="application"&&u.protocol.indexOf("SCTP")!==-1})},r=function(a){const c=a.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(c===null||c.length<2)return-1;const l=parseInt(c[1],10);return l!==l?-1:l},s=function(a){let c=65536;return e.browser==="firefox"&&(e.version<57?a===-1?c=16384:c=2147483637:e.version<60?c=e.version===57?65535:65536:c=2147483637),c},i=function(a,c){let l=65536;e.browser==="firefox"&&e.version===57&&(l=65535);const u=dn.matchPrefix(a.sdp,"a=max-message-size:");return u.length>0?l=parseInt(u[0].substring(19),10):e.browser==="firefox"&&c!==-1&&(l=2147483637),l},o=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,e.browser==="chrome"&&e.version>=76){const{sdpSemantics:c}=this.getConfiguration();c==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp},enumerable:!0,configurable:!0})}if(t(arguments[0])){const c=r(arguments[0]),l=s(c),u=i(arguments[0],c);let h;l===0&&u===0?h=Number.POSITIVE_INFINITY:l===0||u===0?h=Math.max(l,u):h=Math.min(l,u);const f={};Object.defineProperty(f,"maxMessageSize",{get(){return h}}),this._sctp=f}return o.apply(this,arguments)}}function Ei(n){if(!(n.RTCPeerConnection&&"createDataChannel"in n.RTCPeerConnection.prototype))return;function e(r,s){const i=r.send;r.send=function(){const a=arguments[0],c=a.length||a.size||a.byteLength;if(r.readyState==="open"&&s.sctp&&c>s.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+s.sctp.maxMessageSize+" bytes)");return i.apply(r,arguments)}}const t=n.RTCPeerConnection.prototype.createDataChannel;n.RTCPeerConnection.prototype.createDataChannel=function(){const s=t.apply(this,arguments);return e(s,this),s},Qr(n,"datachannel",r=>(e(r.channel,r.target),r))}function Wa(n){if(!n.RTCPeerConnection||"connectionState"in n.RTCPeerConnection.prototype)return;const e=n.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(t){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),t&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=t)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(t=>{const r=e[t];e[t]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=s=>{const i=s.target;if(i._lastConnectionState!==i.connectionState){i._lastConnectionState=i.connectionState;const o=new Event("connectionstatechange",s);i.dispatchEvent(o)}return s},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)}})}function Qa(n,e){if(!n.RTCPeerConnection||e.browser==="chrome"&&e.version>=71||e.browser==="safari"&&e.version>=605)return;const t=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(s){if(s&&s.sdp&&s.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const i=s.sdp.split(`
`).filter(o=>o.trim()!=="a=extmap-allow-mixed").join(`
`);n.RTCSessionDescription&&s instanceof n.RTCSessionDescription?arguments[0]=new n.RTCSessionDescription({type:s.type,sdp:i}):s.sdp=i}return t.apply(this,arguments)}}function Si(n,e){if(!(n.RTCPeerConnection&&n.RTCPeerConnection.prototype))return;const t=n.RTCPeerConnection.prototype.addIceCandidate;!t||t.length===0||(n.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(e.browser==="chrome"&&e.version<78||e.browser==="firefox"&&e.version<68||e.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function _i(n,e){if(!(n.RTCPeerConnection&&n.RTCPeerConnection.prototype))return;const t=n.RTCPeerConnection.prototype.setLocalDescription;!t||t.length===0||(n.RTCPeerConnection.prototype.setLocalDescription=function(){let s=arguments[0]||{};if(typeof s!="object"||s.type&&s.sdp)return t.apply(this,arguments);if(s={type:s.type,sdp:s.sdp},!s.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":s.type="offer";break;default:s.type="answer";break}return s.sdp||s.type!=="offer"&&s.type!=="answer"?t.apply(this,[s]):(s.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(o=>t.apply(this,[o]))})}const f4=Object.freeze(Object.defineProperty({__proto__:null,removeExtmapAllowMixed:Qa,shimAddIceCandidateNullOrEmpty:Si,shimConnectionState:Wa,shimMaxMessageSize:vi,shimParameterlessSetLocalDescription:_i,shimRTCIceCandidate:wi,shimRTCIceCandidateRelayProtocol:Ga,shimSendThrowTypeError:Ei},Symbol.toStringTag,{value:"Module"}));function p4({window:n}={},e={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){const t=Wd,r=u4(n),s={browserDetails:r,commonShim:f4,extractVersion:bi,disableLog:c4,disableWarnings:l4,sdp:h4};switch(r.browser){case"chrome":if(!b1||!Ka||!e.shimChrome)return t("Chrome shim is not included in this adapter release."),s;if(r.version===null)return t("Chrome shim can not determine version, not shimming."),s;t("adapter.js shimming chrome."),s.browserShim=b1,Si(n,r),_i(n),Yd(n,r),Jd(n),Ka(n,r),Zd(n),r2(n,r),Xd(n),e2(n),n2(n,r),wi(n),Ga(n),Wa(n),vi(n,r),Ei(n),Qa(n,r);break;case"firefox":if(!w1||!ja||!e.shimFirefox)return t("Firefox shim is not included in this adapter release."),s;t("adapter.js shimming firefox."),s.browserShim=w1,Si(n,r),_i(n),s2(n,r),ja(n,r),i2(n),c2(n),o2(n),a2(n),l2(n),u2(n),d2(n),h2(n),f2(n),wi(n),Wa(n),vi(n,r),Ei(n);break;case"safari":if(!v1||!e.shimSafari)return t("Safari shim is not included in this adapter release."),s;t("adapter.js shimming safari."),s.browserShim=v1,Si(n,r),_i(n),w2(n),E2(n),m2(n),p2(n),g2(n),v2(n),y2(n),S2(n),wi(n),Ga(n),vi(n,r),Ei(n),Qa(n,r);break;default:t("Unsupported browser!");break}return s}const E1=p4({window:typeof window>"u"?void 0:window});function Yr(n,e,t,r){Object.defineProperty(n,e,{get:t,set:r,enumerable:!0,configurable:!0})}class C2{constructor(){this.chunkedMTU=16300,this._dataCount=1,this.chunk=e=>{const t=[],r=e.byteLength,s=Math.ceil(r/this.chunkedMTU);let i=0,o=0;for(;o<r;){const a=Math.min(r,o+this.chunkedMTU),c=e.slice(o,a),l={__peerData:this._dataCount,n:i,data:c,total:s};t.push(l),o=a,i++}return this._dataCount++,t}}}function g4(n){let e=0;for(const s of n)e+=s.byteLength;const t=new Uint8Array(e);let r=0;for(const s of n)t.set(s,r),r+=s.byteLength;return t}const Jo=E1.default||E1,zn=new class{isWebRTCSupported(){return typeof RTCPeerConnection<"u"}isBrowserSupported(){const n=this.getBrowser(),e=this.getVersion();return this.supportedBrowsers.includes(n)?n==="chrome"?e>=this.minChromeVersion:n==="firefox"?e>=this.minFirefoxVersion:n==="safari"?!this.isIOS&&e>=this.minSafariVersion:!1:!1}getBrowser(){return Jo.browserDetails.browser}getVersion(){return Jo.browserDetails.version||0}isUnifiedPlanSupported(){const n=this.getBrowser(),e=Jo.browserDetails.version||0;if(n==="chrome"&&e<this.minChromeVersion)return!1;if(n==="firefox"&&e>=this.minFirefoxVersion)return!0;if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;let t,r=!1;try{t=new RTCPeerConnection,t.addTransceiver("audio"),r=!0}catch{}finally{t&&t.close()}return r}toString(){return`Supports:
    browser:${this.getBrowser()}
    version:${this.getVersion()}
    isIOS:${this.isIOS}
    isWebRTCSupported:${this.isWebRTCSupported()}
    isBrowserSupported:${this.isBrowserSupported()}
    isUnifiedPlanSupported:${this.isUnifiedPlanSupported()}`}constructor(){this.isIOS=typeof navigator<"u"?["iPad","iPhone","iPod"].includes(navigator.platform):!1,this.supportedBrowsers=["firefox","chrome","safari"],this.minFirefoxVersion=59,this.minChromeVersion=72,this.minSafariVersion=605}},m4=n=>!n||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.test(n),A2=()=>Math.random().toString(36).slice(2),S1={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:["turn:eu-0.turn.peerjs.com:3478","turn:us-0.turn.peerjs.com:3478"],username:"peerjs",credential:"peerjsp"}],sdpSemantics:"unified-plan"};class y4 extends C2{noop(){}blobToArrayBuffer(e,t){const r=new FileReader;return r.onload=function(s){s.target&&t(s.target.result)},r.readAsArrayBuffer(e),r}binaryStringToArrayBuffer(e){const t=new Uint8Array(e.length);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r)&255;return t.buffer}isSecure(){return location.protocol==="https:"}constructor(...e){super(...e),this.CLOUD_HOST="0.peerjs.com",this.CLOUD_PORT=443,this.chunkedBrowsers={Chrome:1,chrome:1},this.defaultConfig=S1,this.browser=zn.getBrowser(),this.browserVersion=zn.getVersion(),this.pack=Kd,this.unpack=zd,this.supports=function(){const t={browser:zn.isBrowserSupported(),webRTC:zn.isWebRTCSupported(),audioVideo:!1,data:!1,binaryBlob:!1,reliable:!1};if(!t.webRTC)return t;let r;try{r=new RTCPeerConnection(S1),t.audioVideo=!0;let s;try{s=r.createDataChannel("_PEERJSTEST",{ordered:!0}),t.data=!0,t.reliable=!!s.ordered;try{s.binaryType="blob",t.binaryBlob=!zn.isIOS}catch{}}catch{}finally{s&&s.close()}}catch{}finally{r&&r.close()}return t}(),this.validateId=m4,this.randomToken=A2}}const nt=new y4,b4="PeerJS: ";var _1;(function(n){n[n.Disabled=0]="Disabled",n[n.Errors=1]="Errors",n[n.Warnings=2]="Warnings",n[n.All=3]="All"})(_1||(_1={}));class w4{get logLevel(){return this._logLevel}set logLevel(e){this._logLevel=e}log(...e){this._logLevel>=3&&this._print(3,...e)}warn(...e){this._logLevel>=2&&this._print(2,...e)}error(...e){this._logLevel>=1&&this._print(1,...e)}setLogFunction(e){this._print=e}_print(e,...t){const r=[b4,...t];for(const s in r)r[s]instanceof Error&&(r[s]="("+r[s].name+") "+r[s].message);e>=3?console.log(...r):e>=2?console.warn("WARNING",...r):e>=1&&console.error("ERROR",...r)}constructor(){this._logLevel=0}}var L=new w4,Qc={},v4=Object.prototype.hasOwnProperty,Ze="~";function as(){}Object.create&&(as.prototype=Object.create(null),new as().__proto__||(Ze=!1));function E4(n,e,t){this.fn=n,this.context=e,this.once=t||!1}function I2(n,e,t,r,s){if(typeof t!="function")throw new TypeError("The listener must be a function");var i=new E4(t,r||n,s),o=Ze?Ze+e:e;return n._events[o]?n._events[o].fn?n._events[o]=[n._events[o],i]:n._events[o].push(i):(n._events[o]=i,n._eventsCount++),n}function xi(n,e){--n._eventsCount===0?n._events=new as:delete n._events[e]}function je(){this._events=new as,this._eventsCount=0}je.prototype.eventNames=function(){var e=[],t,r;if(this._eventsCount===0)return e;for(r in t=this._events)v4.call(t,r)&&e.push(Ze?r.slice(1):r);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e};je.prototype.listeners=function(e){var t=Ze?Ze+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var s=0,i=r.length,o=new Array(i);s<i;s++)o[s]=r[s].fn;return o};je.prototype.listenerCount=function(e){var t=Ze?Ze+e:e,r=this._events[t];return r?r.fn?1:r.length:0};je.prototype.emit=function(e,t,r,s,i,o){var a=Ze?Ze+e:e;if(!this._events[a])return!1;var c=this._events[a],l=arguments.length,u,h;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),l){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,r),!0;case 4:return c.fn.call(c.context,t,r,s),!0;case 5:return c.fn.call(c.context,t,r,s,i),!0;case 6:return c.fn.call(c.context,t,r,s,i,o),!0}for(h=1,u=new Array(l-1);h<l;h++)u[h-1]=arguments[h];c.fn.apply(c.context,u)}else{var f=c.length,g;for(h=0;h<f;h++)switch(c[h].once&&this.removeListener(e,c[h].fn,void 0,!0),l){case 1:c[h].fn.call(c[h].context);break;case 2:c[h].fn.call(c[h].context,t);break;case 3:c[h].fn.call(c[h].context,t,r);break;case 4:c[h].fn.call(c[h].context,t,r,s);break;default:if(!u)for(g=1,u=new Array(l-1);g<l;g++)u[g-1]=arguments[g];c[h].fn.apply(c[h].context,u)}}return!0};je.prototype.on=function(e,t,r){return I2(this,e,t,r,!1)};je.prototype.once=function(e,t,r){return I2(this,e,t,r,!0)};je.prototype.removeListener=function(e,t,r,s){var i=Ze?Ze+e:e;if(!this._events[i])return this;if(!t)return xi(this,i),this;var o=this._events[i];if(o.fn)o.fn===t&&(!s||o.once)&&(!r||o.context===r)&&xi(this,i);else{for(var a=0,c=[],l=o.length;a<l;a++)(o[a].fn!==t||s&&!o[a].once||r&&o[a].context!==r)&&c.push(o[a]);c.length?this._events[i]=c.length===1?c[0]:c:xi(this,i)}return this};je.prototype.removeAllListeners=function(e){var t;return e?(t=Ze?Ze+e:e,this._events[t]&&xi(this,t)):(this._events=new as,this._eventsCount=0),this};je.prototype.off=je.prototype.removeListener;je.prototype.addListener=je.prototype.on;je.prefixed=Ze;je.EventEmitter=je;Qc=je;var Jr={};Yr(Jr,"ConnectionType",()=>Vt);Yr(Jr,"PeerErrorType",()=>ye);Yr(Jr,"BaseConnectionErrorType",()=>cs);Yr(Jr,"DataConnectionErrorType",()=>ls);Yr(Jr,"SerializationType",()=>En);Yr(Jr,"SocketEventType",()=>$t);Yr(Jr,"ServerMessageType",()=>Ie);var Vt;(function(n){n.Data="data",n.Media="media"})(Vt||(Vt={}));var ye;(function(n){n.BrowserIncompatible="browser-incompatible",n.Disconnected="disconnected",n.InvalidID="invalid-id",n.InvalidKey="invalid-key",n.Network="network",n.PeerUnavailable="peer-unavailable",n.SslUnavailable="ssl-unavailable",n.ServerError="server-error",n.SocketError="socket-error",n.SocketClosed="socket-closed",n.UnavailableID="unavailable-id",n.WebRTC="webrtc"})(ye||(ye={}));var cs;(function(n){n.NegotiationFailed="negotiation-failed",n.ConnectionClosed="connection-closed"})(cs||(cs={}));var ls;(function(n){n.NotOpenYet="not-open-yet",n.MessageToBig="message-too-big"})(ls||(ls={}));var En;(function(n){n.Binary="binary",n.BinaryUTF8="binary-utf8",n.JSON="json",n.None="raw"})(En||(En={}));var $t;(function(n){n.Message="message",n.Disconnected="disconnected",n.Error="error",n.Close="close"})($t||($t={}));var Ie;(function(n){n.Heartbeat="HEARTBEAT",n.Candidate="CANDIDATE",n.Offer="OFFER",n.Answer="ANSWER",n.Open="OPEN",n.Error="ERROR",n.IdTaken="ID-TAKEN",n.InvalidKey="INVALID-KEY",n.Leave="LEAVE",n.Expire="EXPIRE"})(Ie||(Ie={}));var Yc={};Yc=JSON.parse('{"name":"peerjs","version":"1.5.4","keywords":["peerjs","webrtc","p2p","rtc"],"description":"PeerJS client","homepage":"https://peerjs.com","bugs":{"url":"https://github.com/peers/peerjs/issues"},"repository":{"type":"git","url":"https://github.com/peers/peerjs"},"license":"MIT","contributors":["Michelle Bu <michelle@michellebu.com>","afrokick <devbyru@gmail.com>","ericz <really.ez@gmail.com>","Jairo <kidandcat@gmail.com>","Jonas Gloning <34194370+jonasgloning@users.noreply.github.com>","Jairo Caro-Accino Viciana <jairo@galax.be>","Carlos Caballero <carlos.caballero.gonzalez@gmail.com>","hc <hheennrryy@gmail.com>","Muhammad Asif <capripio@gmail.com>","PrashoonB <prashoonbhattacharjee@gmail.com>","Harsh Bardhan Mishra <47351025+HarshCasper@users.noreply.github.com>","akotynski <aleksanderkotbury@gmail.com>","lmb <i@lmb.io>","Jairooo <jairocaro@msn.com>","Moritz Stückler <moritz.stueckler@gmail.com>","Simon <crydotsnakegithub@gmail.com>","Denis Lukov <denismassters@gmail.com>","Philipp Hancke <fippo@andyet.net>","Hans Oksendahl <hansoksendahl@gmail.com>","Jess <jessachandler@gmail.com>","khankuan <khankuan@gmail.com>","DUODVK <kurmanov.work@gmail.com>","XiZhao <kwang1imsa@gmail.com>","Matthias Lohr <matthias@lohr.me>","=frank tree <=frnktrb@googlemail.com>","Andre Eckardt <aeckardt@outlook.com>","Chris Cowan <agentme49@gmail.com>","Alex Chuev <alex@chuev.com>","alxnull <alxnull@e.mail.de>","Yemel Jardi <angel.jardi@gmail.com>","Ben Parnell <benjaminparnell.94@gmail.com>","Benny Lichtner <bennlich@gmail.com>","fresheneesz <bitetrudpublic@gmail.com>","bob.barstead@exaptive.com <bob.barstead@exaptive.com>","chandika <chandika@gmail.com>","emersion <contact@emersion.fr>","Christopher Van <cvan@users.noreply.github.com>","eddieherm <edhermoso@gmail.com>","Eduardo Pinho <enet4mikeenet@gmail.com>","Evandro Zanatta <ezanatta@tray.net.br>","Gardner Bickford <gardner@users.noreply.github.com>","Gian Luca <gianluca.cecchi@cynny.com>","PatrickJS <github@gdi2290.com>","jonnyf <github@jonathanfoss.co.uk>","Hizkia Felix <hizkifw@gmail.com>","Hristo Oskov <hristo.oskov@gmail.com>","Isaac Madwed <i.madwed@gmail.com>","Ilya Konanykhin <ilya.konanykhin@gmail.com>","jasonbarry <jasbarry@me.com>","Jonathan Burke <jonathan.burke.1311@googlemail.com>","Josh Hamit <josh.hamit@gmail.com>","Jordan Austin <jrax86@gmail.com>","Joel Wetzell <jwetzell@yahoo.com>","xizhao <kevin.wang@cloudera.com>","Alberto Torres <kungfoobar@gmail.com>","Jonathan Mayol <mayoljonathan@gmail.com>","Jefferson Felix <me@jsfelix.dev>","Rolf Erik Lekang <me@rolflekang.com>","Kevin Mai-Husan Chia <mhchia@users.noreply.github.com>","Pepijn de Vos <pepijndevos@gmail.com>","JooYoung <qkdlql@naver.com>","Tobias Speicher <rootcommander@gmail.com>","Steve Blaurock <sblaurock@gmail.com>","Kyrylo Shegeda <shegeda@ualberta.ca>","Diwank Singh Tomer <singh@diwank.name>","Sören Balko <Soeren.Balko@gmail.com>","Arpit Solanki <solankiarpit1997@gmail.com>","Yuki Ito <yuki@gnnk.net>","Artur Zayats <zag2art@gmail.com>"],"funding":{"type":"opencollective","url":"https://opencollective.com/peer"},"collective":{"type":"opencollective","url":"https://opencollective.com/peer"},"files":["dist/*"],"sideEffects":["lib/global.ts","lib/supports.ts"],"main":"dist/bundler.cjs","module":"dist/bundler.mjs","browser-minified":"dist/peerjs.min.js","browser-unminified":"dist/peerjs.js","browser-minified-msgpack":"dist/serializer.msgpack.mjs","types":"dist/types.d.ts","engines":{"node":">= 14"},"targets":{"types":{"source":"lib/exports.ts"},"main":{"source":"lib/exports.ts","sourceMap":{"inlineSources":true}},"module":{"source":"lib/exports.ts","includeNodeModules":["eventemitter3"],"sourceMap":{"inlineSources":true}},"browser-minified":{"context":"browser","outputFormat":"global","optimize":true,"engines":{"browsers":"chrome >= 83, edge >= 83, firefox >= 80, safari >= 15"},"source":"lib/global.ts"},"browser-unminified":{"context":"browser","outputFormat":"global","optimize":false,"engines":{"browsers":"chrome >= 83, edge >= 83, firefox >= 80, safari >= 15"},"source":"lib/global.ts"},"browser-minified-msgpack":{"context":"browser","outputFormat":"esmodule","isLibrary":true,"optimize":true,"engines":{"browsers":"chrome >= 83, edge >= 83, firefox >= 102, safari >= 15"},"source":"lib/dataconnection/StreamConnection/MsgPack.ts"}},"scripts":{"contributors":"git-authors-cli --print=false && prettier --write package.json && git add package.json package-lock.json && git commit -m \\"chore(contributors): update and sort contributors list\\"","check":"tsc --noEmit && tsc -p e2e/tsconfig.json --noEmit","watch":"parcel watch","build":"rm -rf dist && parcel build","prepublishOnly":"npm run build","test":"jest","test:watch":"jest --watch","coverage":"jest --coverage --collectCoverageFrom=\\"./lib/**\\"","format":"prettier --write .","format:check":"prettier --check .","semantic-release":"semantic-release","e2e":"wdio run e2e/wdio.local.conf.ts","e2e:bstack":"wdio run e2e/wdio.bstack.conf.ts"},"devDependencies":{"@parcel/config-default":"^2.9.3","@parcel/packager-ts":"^2.9.3","@parcel/transformer-typescript-tsc":"^2.9.3","@parcel/transformer-typescript-types":"^2.9.3","@semantic-release/changelog":"^6.0.1","@semantic-release/git":"^10.0.1","@swc/core":"^1.3.27","@swc/jest":"^0.2.24","@types/jasmine":"^4.3.4","@wdio/browserstack-service":"^8.11.2","@wdio/cli":"^8.11.2","@wdio/globals":"^8.11.2","@wdio/jasmine-framework":"^8.11.2","@wdio/local-runner":"^8.11.2","@wdio/spec-reporter":"^8.11.2","@wdio/types":"^8.10.4","http-server":"^14.1.1","jest":"^29.3.1","jest-environment-jsdom":"^29.3.1","mock-socket":"^9.0.0","parcel":"^2.9.3","prettier":"^3.0.0","semantic-release":"^21.0.0","ts-node":"^10.9.1","typescript":"^5.0.0","wdio-geckodriver-service":"^5.0.1"},"dependencies":{"@msgpack/msgpack":"^2.8.0","eventemitter3":"^4.0.7","peerjs-js-binarypack":"^2.1.0","webrtc-adapter":"^9.0.0"},"alias":{"process":false,"buffer":false}}');class S4 extends Qc.EventEmitter{constructor(e,t,r,s,i,o=5e3){super(),this.pingInterval=o,this._disconnected=!0,this._messagesQueue=[];const a=e?"wss://":"ws://";this._baseUrl=a+t+":"+r+s+"peerjs?key="+i}start(e,t){this._id=e;const r=`${this._baseUrl}&id=${e}&token=${t}`;this._socket||!this._disconnected||(this._socket=new WebSocket(r+"&version="+Yc.version),this._disconnected=!1,this._socket.onmessage=s=>{let i;try{i=JSON.parse(s.data),L.log("Server message received:",i)}catch{L.log("Invalid server message",s.data);return}this.emit($t.Message,i)},this._socket.onclose=s=>{this._disconnected||(L.log("Socket closed.",s),this._cleanup(),this._disconnected=!0,this.emit($t.Disconnected))},this._socket.onopen=()=>{this._disconnected||(this._sendQueuedMessages(),L.log("Socket open"),this._scheduleHeartbeat())})}_scheduleHeartbeat(){this._wsPingTimer=setTimeout(()=>{this._sendHeartbeat()},this.pingInterval)}_sendHeartbeat(){if(!this._wsOpen()){L.log("Cannot send heartbeat, because socket closed");return}const e=JSON.stringify({type:Ie.Heartbeat});this._socket.send(e),this._scheduleHeartbeat()}_wsOpen(){return!!this._socket&&this._socket.readyState===1}_sendQueuedMessages(){const e=[...this._messagesQueue];this._messagesQueue=[];for(const t of e)this.send(t)}send(e){if(this._disconnected)return;if(!this._id){this._messagesQueue.push(e);return}if(!e.type){this.emit($t.Error,"Invalid message");return}if(!this._wsOpen())return;const t=JSON.stringify(e);this._socket.send(t)}close(){this._disconnected||(this._cleanup(),this._disconnected=!0)}_cleanup(){this._socket&&(this._socket.onopen=this._socket.onmessage=this._socket.onclose=null,this._socket.close(),this._socket=void 0),clearTimeout(this._wsPingTimer)}}class P2{constructor(e){this.connection=e}startConnection(e){const t=this._startPeerConnection();if(this.connection.peerConnection=t,this.connection.type===Vt.Media&&e._stream&&this._addTracksToConnection(e._stream,t),e.originator){const r=this.connection,s={ordered:!!e.reliable},i=t.createDataChannel(r.label,s);r._initializeDataChannel(i),this._makeOffer()}else this.handleSDP("OFFER",e.sdp)}_startPeerConnection(){L.log("Creating RTCPeerConnection.");const e=new RTCPeerConnection(this.connection.provider.options.config);return this._setupListeners(e),e}_setupListeners(e){const t=this.connection.peer,r=this.connection.connectionId,s=this.connection.type,i=this.connection.provider;L.log("Listening for ICE candidates."),e.onicecandidate=o=>{!o.candidate||!o.candidate.candidate||(L.log(`Received ICE candidates for ${t}:`,o.candidate),i.socket.send({type:Ie.Candidate,payload:{candidate:o.candidate,type:s,connectionId:r},dst:t}))},e.oniceconnectionstatechange=()=>{switch(e.iceConnectionState){case"failed":L.log("iceConnectionState is failed, closing connections to "+t),this.connection.emitError(cs.NegotiationFailed,"Negotiation of connection to "+t+" failed."),this.connection.close();break;case"closed":L.log("iceConnectionState is closed, closing connections to "+t),this.connection.emitError(cs.ConnectionClosed,"Connection to "+t+" closed."),this.connection.close();break;case"disconnected":L.log("iceConnectionState changed to disconnected on the connection with "+t);break;case"completed":e.onicecandidate=()=>{};break}this.connection.emit("iceStateChanged",e.iceConnectionState)},L.log("Listening for data channel"),e.ondatachannel=o=>{L.log("Received data channel");const a=o.channel;i.getConnection(t,r)._initializeDataChannel(a)},L.log("Listening for remote stream"),e.ontrack=o=>{L.log("Received remote stream");const a=o.streams[0],c=i.getConnection(t,r);if(c.type===Vt.Media){const l=c;this._addStreamToMediaConnection(a,l)}}}cleanup(){L.log("Cleaning up PeerConnection to "+this.connection.peer);const e=this.connection.peerConnection;if(!e)return;this.connection.peerConnection=null,e.onicecandidate=e.oniceconnectionstatechange=e.ondatachannel=e.ontrack=()=>{};const t=e.signalingState!=="closed";let r=!1;const s=this.connection.dataChannel;s&&(r=!!s.readyState&&s.readyState!=="closed"),(t||r)&&e.close()}async _makeOffer(){const e=this.connection.peerConnection,t=this.connection.provider;try{const r=await e.createOffer(this.connection.options.constraints);L.log("Created offer."),this.connection.options.sdpTransform&&typeof this.connection.options.sdpTransform=="function"&&(r.sdp=this.connection.options.sdpTransform(r.sdp)||r.sdp);try{await e.setLocalDescription(r),L.log("Set localDescription:",r,`for:${this.connection.peer}`);let s={sdp:r,type:this.connection.type,connectionId:this.connection.connectionId,metadata:this.connection.metadata};if(this.connection.type===Vt.Data){const i=this.connection;s={...s,label:i.label,reliable:i.reliable,serialization:i.serialization}}t.socket.send({type:Ie.Offer,payload:s,dst:this.connection.peer})}catch(s){s!="OperationError: Failed to set local offer sdp: Called in wrong state: kHaveRemoteOffer"&&(t.emitError(ye.WebRTC,s),L.log("Failed to setLocalDescription, ",s))}}catch(r){t.emitError(ye.WebRTC,r),L.log("Failed to createOffer, ",r)}}async _makeAnswer(){const e=this.connection.peerConnection,t=this.connection.provider;try{const r=await e.createAnswer();L.log("Created answer."),this.connection.options.sdpTransform&&typeof this.connection.options.sdpTransform=="function"&&(r.sdp=this.connection.options.sdpTransform(r.sdp)||r.sdp);try{await e.setLocalDescription(r),L.log("Set localDescription:",r,`for:${this.connection.peer}`),t.socket.send({type:Ie.Answer,payload:{sdp:r,type:this.connection.type,connectionId:this.connection.connectionId},dst:this.connection.peer})}catch(s){t.emitError(ye.WebRTC,s),L.log("Failed to setLocalDescription, ",s)}}catch(r){t.emitError(ye.WebRTC,r),L.log("Failed to create answer, ",r)}}async handleSDP(e,t){t=new RTCSessionDescription(t);const r=this.connection.peerConnection,s=this.connection.provider;L.log("Setting remote description",t);const i=this;try{await r.setRemoteDescription(t),L.log(`Set remoteDescription:${e} for:${this.connection.peer}`),e==="OFFER"&&await i._makeAnswer()}catch(o){s.emitError(ye.WebRTC,o),L.log("Failed to setRemoteDescription, ",o)}}async handleCandidate(e){L.log("handleCandidate:",e);try{await this.connection.peerConnection.addIceCandidate(e),L.log(`Added ICE candidate for:${this.connection.peer}`)}catch(t){this.connection.provider.emitError(ye.WebRTC,t),L.log("Failed to handleCandidate, ",t)}}_addTracksToConnection(e,t){if(L.log(`add tracks from stream ${e.id} to peer connection`),!t.addTrack)return L.error("Your browser does't support RTCPeerConnection#addTrack. Ignored.");e.getTracks().forEach(r=>{t.addTrack(r,e)})}_addStreamToMediaConnection(e,t){L.log(`add stream ${e.id} to media connection ${t.connectionId}`),t.addStream(e)}}class T2 extends Qc.EventEmitter{emitError(e,t){L.error("Error:",t),this.emit("error",new _4(`${e}`,t))}}class _4 extends Error{constructor(e,t){typeof t=="string"?super(t):(super(),Object.assign(this,t)),this.type=e}}class R2 extends T2{get open(){return this._open}constructor(e,t,r){super(),this.peer=e,this.provider=t,this.options=r,this._open=!1,this.metadata=r.metadata}}var qc;const ns=class ns extends R2{get type(){return Vt.Media}get localStream(){return this._localStream}get remoteStream(){return this._remoteStream}constructor(e,t,r){super(e,t,r),this._localStream=this.options._stream,this.connectionId=this.options.connectionId||ns.ID_PREFIX+nt.randomToken(),this._negotiator=new P2(this),this._localStream&&this._negotiator.startConnection({_stream:this._localStream,originator:!0})}_initializeDataChannel(e){this.dataChannel=e,this.dataChannel.onopen=()=>{L.log(`DC#${this.connectionId} dc connection success`),this.emit("willCloseOnRemote")},this.dataChannel.onclose=()=>{L.log(`DC#${this.connectionId} dc closed for:`,this.peer),this.close()}}addStream(e){L.log("Receiving stream",e),this._remoteStream=e,super.emit("stream",e)}handleMessage(e){const t=e.type,r=e.payload;switch(e.type){case Ie.Answer:this._negotiator.handleSDP(t,r.sdp),this._open=!0;break;case Ie.Candidate:this._negotiator.handleCandidate(r.candidate);break;default:L.warn(`Unrecognized message type:${t} from peer:${this.peer}`);break}}answer(e,t={}){if(this._localStream){L.warn("Local stream already exists on this MediaConnection. Are you answering a call twice?");return}this._localStream=e,t&&t.sdpTransform&&(this.options.sdpTransform=t.sdpTransform),this._negotiator.startConnection({...this.options._payload,_stream:e});const r=this.provider._getMessages(this.connectionId);for(const s of r)this.handleMessage(s);this._open=!0}close(){this._negotiator&&(this._negotiator.cleanup(),this._negotiator=null),this._localStream=null,this._remoteStream=null,this.provider&&(this.provider._removeConnection(this),this.provider=null),this.options&&this.options._stream&&(this.options._stream=null),this.open&&(this._open=!1,super.emit("close"))}};qc=new WeakMap,re(ns,qc,ns.ID_PREFIX="mc_");let Vi=ns;class x4{constructor(e){this._options=e}_buildRequest(e){const t=this._options.secure?"https":"http",{host:r,port:s,path:i,key:o}=this._options,a=new URL(`${t}://${r}:${s}${i}${o}/${e}`);return a.searchParams.set("ts",`${Date.now()}${Math.random()}`),a.searchParams.set("version",Yc.version),fetch(a.href,{referrerPolicy:this._options.referrerPolicy})}async retrieveId(){try{const e=await this._buildRequest("id");if(e.status!==200)throw new Error(`Error. Status:${e.status}`);return e.text()}catch(e){L.error("Error retrieving ID",e);let t="";throw this._options.path==="/"&&this._options.host!==nt.CLOUD_HOST&&(t=" If you passed in a `path` to your self-hosted PeerServer, you'll also need to pass in that same path when creating a new Peer."),new Error("Could not get an ID from the server."+t)}}async listAllPeers(){try{const e=await this._buildRequest("peers");if(e.status!==200){if(e.status===401){let t="";throw this._options.host===nt.CLOUD_HOST?t="It looks like you're using the cloud server. You can email team@peerjs.com to enable peer listing for your API key.":t="You need to enable `allow_discovery` on your self-hosted PeerServer to use this feature.",new Error("It doesn't look like you have permission to list peers IDs. "+t)}throw new Error(`Error. Status:${e.status}`)}return e.json()}catch(e){throw L.error("Error retrieving list peers",e),new Error("Could not get list peers from the server."+e)}}}var zc,Kc;const Br=class Br extends R2{get type(){return Vt.Data}constructor(e,t,r){super(e,t,r),this.connectionId=this.options.connectionId||Br.ID_PREFIX+A2(),this.label=this.options.label||this.connectionId,this.reliable=!!this.options.reliable,this._negotiator=new P2(this),this._negotiator.startConnection(this.options._payload||{originator:!0,reliable:this.reliable})}_initializeDataChannel(e){this.dataChannel=e,this.dataChannel.onopen=()=>{L.log(`DC#${this.connectionId} dc connection success`),this._open=!0,this.emit("open")},this.dataChannel.onmessage=t=>{L.log(`DC#${this.connectionId} dc onmessage:`,t.data)},this.dataChannel.onclose=()=>{L.log(`DC#${this.connectionId} dc closed for:`,this.peer),this.close()}}close(e){if(e!=null&&e.flush){this.send({__peerData:{type:"close"}});return}this._negotiator&&(this._negotiator.cleanup(),this._negotiator=null),this.provider&&(this.provider._removeConnection(this),this.provider=null),this.dataChannel&&(this.dataChannel.onopen=null,this.dataChannel.onmessage=null,this.dataChannel.onclose=null,this.dataChannel=null),this.open&&(this._open=!1,super.emit("close"))}send(e,t=!1){if(!this.open){this.emitError(ls.NotOpenYet,"Connection is not open. You should listen for the `open` event before sending messages.");return}return this._send(e,t)}async handleMessage(e){const t=e.payload;switch(e.type){case Ie.Answer:await this._negotiator.handleSDP(e.type,t.sdp);break;case Ie.Candidate:await this._negotiator.handleCandidate(t.candidate);break;default:L.warn("Unrecognized message type:",e.type,"from peer:",this.peer);break}}};zc=new WeakMap,Kc=new WeakMap,re(Br,zc,Br.ID_PREFIX="dc_"),re(Br,Kc,Br.MAX_BUFFERED_AMOUNT=8388608);let Hi=Br;class Jc extends Hi{get bufferSize(){return this._bufferSize}_initializeDataChannel(e){super._initializeDataChannel(e),this.dataChannel.binaryType="arraybuffer",this.dataChannel.addEventListener("message",t=>this._handleDataMessage(t))}_bufferedSend(e){(this._buffering||!this._trySend(e))&&(this._buffer.push(e),this._bufferSize=this._buffer.length)}_trySend(e){if(!this.open)return!1;if(this.dataChannel.bufferedAmount>Hi.MAX_BUFFERED_AMOUNT)return this._buffering=!0,setTimeout(()=>{this._buffering=!1,this._tryBuffer()},50),!1;try{this.dataChannel.send(e)}catch(t){return L.error(`DC#:${this.connectionId} Error when sending:`,t),this._buffering=!0,this.close(),!1}return!0}_tryBuffer(){if(!this.open||this._buffer.length===0)return;const e=this._buffer[0];this._trySend(e)&&(this._buffer.shift(),this._bufferSize=this._buffer.length,this._tryBuffer())}close(e){if(e!=null&&e.flush){this.send({__peerData:{type:"close"}});return}this._buffer=[],this._bufferSize=0,super.close()}constructor(...e){super(...e),this._buffer=[],this._bufferSize=0,this._buffering=!1}}class Zo extends Jc{close(e){super.close(e),this._chunkedData={}}constructor(e,t,r){super(e,t,r),this.chunker=new C2,this.serialization=En.Binary,this._chunkedData={}}_handleDataMessage({data:e}){const t=zd(e),r=t.__peerData;if(r){if(r.type==="close"){this.close();return}this._handleChunk(t);return}this.emit("data",t)}_handleChunk(e){const t=e.__peerData,r=this._chunkedData[t]||{data:[],count:0,total:e.total};if(r.data[e.n]=new Uint8Array(e.data),r.count++,this._chunkedData[t]=r,r.total===r.count){delete this._chunkedData[t];const s=g4(r.data);this._handleDataMessage({data:s})}}_send(e,t){const r=Kd(e);if(r instanceof Promise)return this._send_blob(r);if(!t&&r.byteLength>this.chunker.chunkedMTU){this._sendChunks(r);return}this._bufferedSend(r)}async _send_blob(e){const t=await e;if(t.byteLength>this.chunker.chunkedMTU){this._sendChunks(t);return}this._bufferedSend(t)}_sendChunks(e){const t=this.chunker.chunk(e);L.log(`DC#${this.connectionId} Try to send ${t.length} chunks...`);for(const r of t)this.send(r,!0)}}class k4 extends Jc{_handleDataMessage({data:e}){super.emit("data",e)}_send(e,t){this._bufferedSend(e)}constructor(...e){super(...e),this.serialization=En.None}}class C4 extends Jc{_handleDataMessage({data:e}){const t=this.parse(this.decoder.decode(e)),r=t.__peerData;if(r&&r.type==="close"){this.close();return}this.emit("data",t)}_send(e,t){const r=this.encoder.encode(this.stringify(e));if(r.byteLength>=nt.chunkedMTU){this.emitError(ls.MessageToBig,"Message too big for JSON channel");return}this._bufferedSend(r)}constructor(...e){super(...e),this.serialization=En.JSON,this.encoder=new TextEncoder,this.decoder=new TextDecoder,this.stringify=JSON.stringify,this.parse=JSON.parse}}var jc;const ss=class ss extends T2{get id(){return this._id}get options(){return this._options}get open(){return this._open}get socket(){return this._socket}get connections(){const e=Object.create(null);for(const[t,r]of this._connections)e[t]=r;return e}get destroyed(){return this._destroyed}get disconnected(){return this._disconnected}constructor(e,t){super(),this._serializers={raw:k4,json:C4,binary:Zo,"binary-utf8":Zo,default:Zo},this._id=null,this._lastServerId=null,this._destroyed=!1,this._disconnected=!1,this._open=!1,this._connections=new Map,this._lostMessages=new Map;let r;if(e&&e.constructor==Object?t=e:e&&(r=e.toString()),t={debug:0,host:nt.CLOUD_HOST,port:nt.CLOUD_PORT,path:"/",key:ss.DEFAULT_KEY,token:nt.randomToken(),config:nt.defaultConfig,referrerPolicy:"strict-origin-when-cross-origin",serializers:{},...t},this._options=t,this._serializers={...this._serializers,...this.options.serializers},this._options.host==="/"&&(this._options.host=window.location.hostname),this._options.path&&(this._options.path[0]!=="/"&&(this._options.path="/"+this._options.path),this._options.path[this._options.path.length-1]!=="/"&&(this._options.path+="/")),this._options.secure===void 0&&this._options.host!==nt.CLOUD_HOST?this._options.secure=nt.isSecure():this._options.host==nt.CLOUD_HOST&&(this._options.secure=!0),this._options.logFunction&&L.setLogFunction(this._options.logFunction),L.logLevel=this._options.debug||0,this._api=new x4(t),this._socket=this._createServerConnection(),!nt.supports.audioVideo&&!nt.supports.data){this._delayedAbort(ye.BrowserIncompatible,"The current browser does not support WebRTC");return}if(r&&!nt.validateId(r)){this._delayedAbort(ye.InvalidID,`ID "${r}" is invalid`);return}r?this._initialize(r):this._api.retrieveId().then(s=>this._initialize(s)).catch(s=>this._abort(ye.ServerError,s))}_createServerConnection(){const e=new S4(this._options.secure,this._options.host,this._options.port,this._options.path,this._options.key,this._options.pingInterval);return e.on($t.Message,t=>{this._handleMessage(t)}),e.on($t.Error,t=>{this._abort(ye.SocketError,t)}),e.on($t.Disconnected,()=>{this.disconnected||(this.emitError(ye.Network,"Lost connection to server."),this.disconnect())}),e.on($t.Close,()=>{this.disconnected||this._abort(ye.SocketClosed,"Underlying socket is already closed.")}),e}_initialize(e){this._id=e,this.socket.start(e,this._options.token)}_handleMessage(e){const t=e.type,r=e.payload,s=e.src;switch(t){case Ie.Open:this._lastServerId=this.id,this._open=!0,this.emit("open",this.id);break;case Ie.Error:this._abort(ye.ServerError,r.msg);break;case Ie.IdTaken:this._abort(ye.UnavailableID,`ID "${this.id}" is taken`);break;case Ie.InvalidKey:this._abort(ye.InvalidKey,`API KEY "${this._options.key}" is invalid`);break;case Ie.Leave:L.log(`Received leave message from ${s}`),this._cleanupPeer(s),this._connections.delete(s);break;case Ie.Expire:this.emitError(ye.PeerUnavailable,`Could not connect to peer ${s}`);break;case Ie.Offer:{const i=r.connectionId;let o=this.getConnection(s,i);if(o&&(o.close(),L.warn(`Offer received for existing Connection ID:${i}`)),r.type===Vt.Media){const c=new Vi(s,this,{connectionId:i,_payload:r,metadata:r.metadata});o=c,this._addConnection(s,o),this.emit("call",c)}else if(r.type===Vt.Data){const c=new this._serializers[r.serialization](s,this,{connectionId:i,_payload:r,metadata:r.metadata,label:r.label,serialization:r.serialization,reliable:r.reliable});o=c,this._addConnection(s,o),this.emit("connection",c)}else{L.warn(`Received malformed connection type:${r.type}`);return}const a=this._getMessages(i);for(const c of a)o.handleMessage(c);break}default:{if(!r){L.warn(`You received a malformed message from ${s} of type ${t}`);return}const i=r.connectionId,o=this.getConnection(s,i);o&&o.peerConnection?o.handleMessage(e):i?this._storeMessage(i,e):L.warn("You received an unrecognized message:",e);break}}}_storeMessage(e,t){this._lostMessages.has(e)||this._lostMessages.set(e,[]),this._lostMessages.get(e).push(t)}_getMessages(e){const t=this._lostMessages.get(e);return t?(this._lostMessages.delete(e),t):[]}connect(e,t={}){if(t={serialization:"default",...t},this.disconnected){L.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect, or call reconnect on this peer if you believe its ID to still be available."),this.emitError(ye.Disconnected,"Cannot connect to new Peer after disconnecting from server.");return}const r=new this._serializers[t.serialization](e,this,t);return this._addConnection(e,r),r}call(e,t,r={}){if(this.disconnected){L.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect."),this.emitError(ye.Disconnected,"Cannot connect to new Peer after disconnecting from server.");return}if(!t){L.error("To call a peer, you must provide a stream from your browser's `getUserMedia`.");return}const s=new Vi(e,this,{...r,_stream:t});return this._addConnection(e,s),s}_addConnection(e,t){L.log(`add connection ${t.type}:${t.connectionId} to peerId:${e}`),this._connections.has(e)||this._connections.set(e,[]),this._connections.get(e).push(t)}_removeConnection(e){const t=this._connections.get(e.peer);if(t){const r=t.indexOf(e);r!==-1&&t.splice(r,1)}this._lostMessages.delete(e.connectionId)}getConnection(e,t){const r=this._connections.get(e);if(!r)return null;for(const s of r)if(s.connectionId===t)return s;return null}_delayedAbort(e,t){setTimeout(()=>{this._abort(e,t)},0)}_abort(e,t){L.error("Aborting!"),this.emitError(e,t),this._lastServerId?this.disconnect():this.destroy()}destroy(){this.destroyed||(L.log(`Destroy peer with ID:${this.id}`),this.disconnect(),this._cleanup(),this._destroyed=!0,this.emit("close"))}_cleanup(){for(const e of this._connections.keys())this._cleanupPeer(e),this._connections.delete(e);this.socket.removeAllListeners()}_cleanupPeer(e){const t=this._connections.get(e);if(t)for(const r of t)r.close()}disconnect(){if(this.disconnected)return;const e=this.id;L.log(`Disconnect peer with ID:${e}`),this._disconnected=!0,this._open=!1,this.socket.close(),this._lastServerId=e,this._id=null,this.emit("disconnected",e)}reconnect(){if(this.disconnected&&!this.destroyed)L.log(`Attempting reconnection to server with ID ${this._lastServerId}`),this._disconnected=!1,this._initialize(this._lastServerId);else{if(this.destroyed)throw new Error("This peer cannot reconnect to the server. It has already been destroyed.");if(!this.disconnected&&!this.open)L.error("In a hurry? We're still trying to make the initial connection!");else throw new Error(`Peer ${this.id} cannot reconnect because it is not disconnected from the server!`)}}listAllPeers(e=t=>{}){this._api.listAllPeers().then(t=>e(t)).catch(t=>this._abort(ye.ServerError,t))}};jc=new WeakMap,re(ss,jc,ss.DEFAULT_KEY="peerjs");let Ya=ss;var x1=Ya;const A4=Symbol.for("@libp2p/connection"),Ja=Symbol.for("@libp2p/content-routing"),Za=Symbol.for("@libp2p/peer-discovery"),Zc=Symbol.for("@libp2p/peer-id");function D2(n){return!!(n!=null&&n[Zc])}const Xa=Symbol.for("@libp2p/peer-routing"),Xc="keep-alive";var us;(function(n){n[n.FATAL_ALL=0]="FATAL_ALL",n[n.NO_FATAL=1]="NO_FATAL"})(us||(us={}));var $a;let ds=($a=class extends Error{constructor(e="The operation was aborted"){super(e),this.name="AbortError"}},d($a,"name","AbortError"),$a);class G extends Error{constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}}d(G,"name","InvalidParametersError");class hs extends Error{constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}}d(hs,"name","InvalidPublicKeyError");class B2 extends Error{constructor(e="The connection is closing"){super(e),this.name="ConnectionClosingError"}}d(B2,"name","ConnectionClosingError");class el extends Error{constructor(e="The connection is closed"){super(e),this.name="ConnectionClosedError"}}d(el,"name","ConnectionClosedError");var Va;let xr=(Va=class extends Error{constructor(e="Not found"){super(e),this.name="NotFoundError"}},d(Va,"name","NotFoundError"),Va);class tl extends Error{constructor(e="Invalid PeerID"){super(e),this.name="InvalidPeerIdError"}}d(tl,"name","InvalidPeerIdError");class vo extends Error{constructor(e="Invalid multiaddr"){super(e),this.name="InvalidMultiaddrError"}}d(vo,"name","InvalidMultiaddrError");class L2 extends Error{constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}}d(L2,"name","InvalidCIDError");class N2 extends Error{constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}}d(N2,"name","InvalidMultihashError");class Eo extends Error{constructor(e="Unsupported protocol error"){super(e),this.name="UnsupportedProtocolError"}}d(Eo,"name","UnsupportedProtocolError");class Ke extends Error{constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}}d(Ke,"name","InvalidMessageError");class O2 extends Error{constructor(e="Protocol error"){super(e),this.name="ProtocolError"}}d(O2,"name","ProtocolError");var Ha;let M2=(Ha=class extends Error{constructor(e="Timed out"){super(e),this.name="TimeoutError"}},d(Ha,"name","TimeoutError"),Ha);class fs extends Error{constructor(e="Not started"){super(e),this.name="NotStartedError"}}d(fs,"name","NotStartedError");class ki extends Error{constructor(e="Dial error"){super(e),this.name="DialError"}}d(ki,"name","DialError");class rl extends Error{constructor(e="Limited connection"){super(e),this.name="LimitedConnectionError"}}d(rl,"name","LimitedConnectionError");class U2 extends Error{constructor(e="Too many inbound protocol streams"){super(e),this.name="TooManyInboundProtocolStreamsError"}}d(U2,"name","TooManyInboundProtocolStreamsError");class F2 extends Error{constructor(e="Too many outbound protocol streams"){super(e),this.name="TooManyOutboundProtocolStreamsError"}}d(F2,"name","TooManyOutboundProtocolStreamsError");class So extends Error{constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}}d(So,"name","UnsupportedKeyTypeError");var Ut;class sr extends EventTarget{constructor(){super();re(this,Ut,new Map)}listenerCount(t){const r=D(this,Ut).get(t);return r==null?0:r.length}addEventListener(t,r,s){super.addEventListener(t,r,s);let i=D(this,Ut).get(t);i==null&&(i=[],D(this,Ut).set(t,i)),i.push({callback:r,once:(s!==!0&&s!==!1&&(s==null?void 0:s.once))??!1})}removeEventListener(t,r,s){super.removeEventListener(t.toString(),r??null,s);let i=D(this,Ut).get(t);i!=null&&(i=i.filter(({callback:o})=>o!==r),D(this,Ut).set(t,i))}dispatchEvent(t){const r=super.dispatchEvent(t);let s=D(this,Ut).get(t.type);return s==null||(s=s.filter(({once:i})=>!i),D(this,Ut).set(t.type,s)),r}safeDispatchEvent(t,r={}){return this.dispatchEvent(new CustomEvent(t,r))}}Ut=new WeakMap;function nl(n){return n!=null&&typeof n.start=="function"&&typeof n.stop=="function"}async function qi(...n){const e=[];for(const t of n)nl(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function sl(...n){const e=[];for(const t of n)nl(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}const Sn=Symbol.for("@libp2p/service-capabilities"),ec=Symbol.for("@libp2p/service-dependencies");function I4(n,e){if(n===e)return!0;if(n.byteLength!==e.byteLength)return!1;for(let t=0;t<n.byteLength;t++)if(n[t]!==e[t])return!1;return!0}function _o(n){if(n instanceof Uint8Array&&n.constructor.name==="Uint8Array")return n;if(n instanceof ArrayBuffer)return new Uint8Array(n);if(ArrayBuffer.isView(n))return new Uint8Array(n.buffer,n.byteOffset,n.byteLength);throw new Error("Unknown type, must be binary type")}function P4(n){return new TextEncoder().encode(n)}function T4(n){return new TextDecoder().decode(n)}function R4(n,e){if(n.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),r=0;r<t.length;r++)t[r]=255;for(var s=0;s<n.length;s++){var i=n.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=n.length,c=n.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(p){if(p instanceof Uint8Array||(ArrayBuffer.isView(p)?p=new Uint8Array(p.buffer,p.byteOffset,p.byteLength):Array.isArray(p)&&(p=Uint8Array.from(p))),!(p instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(p.length===0)return"";for(var m=0,y=0,E=0,_=p.length;E!==_&&p[E]===0;)E++,m++;for(var w=(_-E)*u+1>>>0,b=new Uint8Array(w);E!==_;){for(var v=p[E],x=0,C=w-1;(v!==0||x<y)&&C!==-1;C--,x++)v+=256*b[C]>>>0,b[C]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");y=x,E++}for(var R=w-y;R!==w&&b[R]===0;)R++;for(var F=c.repeat(m);R<w;++R)F+=n.charAt(b[R]);return F}function f(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return new Uint8Array;var m=0;if(p[m]!==" "){for(var y=0,E=0;p[m]===c;)y++,m++;for(var _=(p.length-m)*l+1>>>0,w=new Uint8Array(_);p[m];){var b=t[p.charCodeAt(m)];if(b===255)return;for(var v=0,x=_-1;(b!==0||v<E)&&x!==-1;x--,v++)b+=a*w[x]>>>0,w[x]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");E=v,m++}if(p[m]!==" "){for(var C=_-E;C!==_&&w[C]===0;)C++;for(var R=new Uint8Array(y+(_-C)),F=y;C!==_;)R[F++]=w[C++];return R}}}function g(p){var m=f(p);if(m)return m;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:f,decode:g}}var D4=R4,B4=D4;class L4{constructor(e,t,r){d(this,"name");d(this,"prefix");d(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=r}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class N4{constructor(e,t,r){d(this,"name");d(this,"prefix");d(this,"baseDecode");d(this,"prefixCodePoint");this.name=e,this.prefix=t;const s=t.codePointAt(0);if(s===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=s,this.baseDecode=r}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return $2(this,e)}}class O4{constructor(e){d(this,"decoders");this.decoders=e}or(e){return $2(this,e)}decode(e){const t=e[0],r=this.decoders[t];if(r!=null)return r.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function $2(n,e){return new O4({...n.decoders??{[n.prefix]:n},...e.decoders??{[e.prefix]:e}})}class M4{constructor(e,t,r,s){d(this,"name");d(this,"prefix");d(this,"baseEncode");d(this,"baseDecode");d(this,"encoder");d(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=r,this.baseDecode=s,this.encoder=new L4(e,t,r),this.decoder=new N4(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}function xo({name:n,prefix:e,encode:t,decode:r}){return new M4(n,e,t,r)}function Fs({name:n,prefix:e,alphabet:t}){const{encode:r,decode:s}=B4(t,n);return xo({prefix:e,name:n,encode:r,decode:i=>_o(s(i))})}function U4(n,e,t,r){const s={};for(let u=0;u<e.length;++u)s[e[u]]=u;let i=n.length;for(;n[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,l=0;for(let u=0;u<i;++u){const h=s[n[u]];if(h===void 0)throw new SyntaxError(`Non-${r} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function F4(n,e,t){const r=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<n.length;++c)for(a=a<<8|n[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o!==0&&(i+=e[s&a<<t-o]),r)for(;i.length*t&7;)i+="=";return i}function Fe({name:n,prefix:e,bitsPerChar:t,alphabet:r}){return xo({prefix:e,name:n,encode(s){return F4(s,r,t)},decode(s){return U4(s,r,t,n)}})}const fe=Fs({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),$4=Fs({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),V4=Object.freeze(Object.defineProperty({__proto__:null,base58btc:fe,base58flickr:$4},Symbol.toStringTag,{value:"Module"})),er=Fe({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),H4=Fe({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),q4=Fe({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),z4=Fe({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),K4=Fe({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),j4=Fe({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),G4=Fe({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),W4=Fe({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Q4=Fe({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),Y4=Object.freeze(Object.defineProperty({__proto__:null,base32:er,base32hex:K4,base32hexpad:G4,base32hexpadupper:W4,base32hexupper:j4,base32pad:q4,base32padupper:z4,base32upper:H4,base32z:Q4},Symbol.toStringTag,{value:"Module"})),Ci=Fs({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),J4=Fs({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),Z4=Object.freeze(Object.defineProperty({__proto__:null,base36:Ci,base36upper:J4},Symbol.toStringTag,{value:"Module"}));var X4=V2,k1=128,e6=-128,t6=Math.pow(2,31);function V2(n,e,t){e=e||[],t=t||0;for(var r=t;n>=t6;)e[t++]=n&255|k1,n/=128;for(;n&e6;)e[t++]=n&255|k1,n>>>=7;return e[t]=n|0,V2.bytes=t-r+1,e}var r6=tc,n6=128,C1=127;function tc(n,r){var t=0,r=r||0,s=0,i=r,o,a=n.length;do{if(i>=a)throw tc.bytes=0,new RangeError("Could not decode varint");o=n[i++],t+=s<28?(o&C1)<<s:(o&C1)*Math.pow(2,s),s+=7}while(o>=n6);return tc.bytes=i-r,t}var s6=Math.pow(2,7),i6=Math.pow(2,14),o6=Math.pow(2,21),a6=Math.pow(2,28),c6=Math.pow(2,35),l6=Math.pow(2,42),u6=Math.pow(2,49),d6=Math.pow(2,56),h6=Math.pow(2,63),f6=function(n){return n<s6?1:n<i6?2:n<o6?3:n<a6?4:n<c6?5:n<l6?6:n<u6?7:n<d6?8:n<h6?9:10},p6={encode:X4,decode:r6,encodingLength:f6},zi=p6;function rc(n,e=0){return[zi.decode(n,e),zi.decode.bytes]}function Ki(n,e,t=0){return zi.encode(n,e,t),e}function ji(n){return zi.encodingLength(n)}function Vr(n,e){const t=e.byteLength,r=ji(n),s=r+ji(t),i=new Uint8Array(s+t);return Ki(n,i,0),Ki(t,i,r),i.set(e,s),new il(n,t,e,i)}function ct(n){const e=_o(n),[t,r]=rc(e),[s,i]=rc(e.subarray(r)),o=e.subarray(r+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new il(t,s,o,e)}function g6(n,e){if(n===e)return!0;{const t=e;return n.code===t.code&&n.size===t.size&&t.bytes instanceof Uint8Array&&I4(n.bytes,t.bytes)}}class il{constructor(e,t,r,s){d(this,"code");d(this,"size");d(this,"digest");d(this,"bytes");this.code=e,this.size=t,this.digest=r,this.bytes=s}}function A1(n,e){const{bytes:t,version:r}=n;switch(r){case 0:return y6(t,nc(n),e??fe.encoder);default:return b6(t,nc(n),e??er.encoder)}}const I1=new WeakMap;function nc(n){const e=I1.get(n);if(e==null){const t=new Map;return I1.set(n,t),t}return e}var ud;class Z{constructor(e,t,r,s){d(this,"code");d(this,"version");d(this,"multihash");d(this,"bytes");d(this,"/");d(this,ud,"CID");this.code=t,this.version=e,this.multihash=r,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Kn)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==w6)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Z.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,r=Vr(e,t);return Z.createV1(this.code,r)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Z.equals(this,e)}static equals(e,t){const r=t;return r!=null&&e.code===r.code&&e.version===r.version&&g6(e.multihash,r.multihash)}toString(e){return A1(this,e)}toJSON(){return{"/":A1(this)}}link(){return this}[(ud=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Z)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:r,code:s,multihash:i,bytes:o}=t;return new Z(r,s,i,o??P1(r,s,i.bytes))}else if(t[v6]===!0){const{version:r,multihash:s,code:i}=t,o=ct(s);return Z.create(r,i,o)}else return null}static create(e,t,r){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(r.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Kn)throw new Error(`Version 0 CID must use dag-pb (code: ${Kn}) block encoding`);return new Z(e,t,r,r.bytes)}case 1:{const s=P1(e,t,r.bytes);return new Z(e,t,r,s)}default:throw new Error("Invalid version")}}static createV0(e){return Z.create(0,Kn,e)}static createV1(e,t){return Z.create(1,e,t)}static decode(e){const[t,r]=Z.decodeFirst(e);if(r.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Z.inspectBytes(e),r=t.size-t.multihashSize,s=_o(e.subarray(r,r+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new il(t.multihashCode,t.digestSize,i,s);return[t.version===0?Z.createV0(o):Z.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const r=()=>{const[h,f]=rc(e.subarray(t));return t+=f,h};let s=r(),i=Kn;if(s===18?(s=0,t=0):i=r(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=r(),c=r(),l=t+c,u=l-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:u,size:l}}static parse(e,t){const[r,s]=m6(e,t),i=Z.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return nc(i).set(r,e),i}}function m6(n,e){switch(n[0]){case"Q":{const t=e??fe;return[fe.prefix,t.decode(`${fe.prefix}${n}`)]}case fe.prefix:{const t=e??fe;return[fe.prefix,t.decode(n)]}case er.prefix:{const t=e??er;return[er.prefix,t.decode(n)]}case Ci.prefix:{const t=e??Ci;return[Ci.prefix,t.decode(n)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[n[0],e.decode(n)]}}}function y6(n,e,t){const{prefix:r}=t;if(r!==fe.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(r);if(s==null){const i=t.encode(n).slice(1);return e.set(r,i),i}else return s}function b6(n,e,t){const{prefix:r}=t,s=e.get(r);if(s==null){const i=t.encode(n);return e.set(r,i),i}else return s}const Kn=112,w6=18;function P1(n,e,t){const r=ji(n),s=r+ji(e),i=new Uint8Array(s+t.byteLength);return Ki(n,i,0),Ki(e,i,r),i.set(t,s),i}const v6=Symbol.for("@ipld/js-cid/CID"),H2=0,E6="identity",q2=_o;function S6(n){return Vr(H2,q2(n))}const It={code:H2,name:E6,encode:q2,digest:S6};function ie(n,e){if(n===e)return!0;if(n.byteLength!==e.byteLength)return!1;for(let t=0;t<n.byteLength;t++)if(n[t]!==e[t])return!1;return!0}function ke(n=0){return new Uint8Array(n)}function qt(n=0){return new Uint8Array(n)}function St(n,e){e==null&&(e=n.reduce((s,i)=>s+i.length,0));const t=qt(e);let r=0;for(const s of n)t.set(s,r),r+=s.length;return t}const z2=Symbol.for("@achingbrain/uint8arraylist");function T1(n,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(const r of n){const s=t+r.byteLength;if(e<s)return{buf:r,index:e-t};t=s}throw new RangeError("index is out of bounds")}function ei(n){return!!(n!=null&&n[z2])}var dd;class ve{constructor(...e){d(this,"bufs");d(this,"length");d(this,dd,!0);this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[(dd=z2,Symbol.iterator)](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(const r of e)if(r instanceof Uint8Array)t+=r.byteLength,this.bufs.push(r);else if(ei(r))t+=r.byteLength,this.bufs.push(...r.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(const r of e.reverse())if(r instanceof Uint8Array)t+=r.byteLength,this.bufs.unshift(r);else if(ei(r))t+=r.byteLength,this.bufs.unshift(...r.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){const t=T1(this.bufs,e);return t.buf[t.index]}set(e,t){const r=T1(this.bufs,e);r.buf[r.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let r=0;r<e.length;r++)this.set(t+r,e[r]);else if(ei(e))for(let r=0;r<e.length;r++)this.set(t+r,e.get(r));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){const{bufs:r,length:s}=this._subList(e,t);return St(r,s)}subarray(e,t){const{bufs:r,length:s}=this._subList(e,t);return r.length===1?r[0]:St(r,s)}sublist(e,t){const{bufs:r,length:s}=this._subList(e,t),i=new ve;return i.length=s,i.bufs=[...r],i}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:this.bufs,length:this.length};const r=[];let s=0;for(let i=0;i<this.bufs.length;i++){const o=this.bufs[i],a=s,c=a+o.byteLength;if(s=c,e>=c)continue;const l=e>=a&&e<c,u=t>a&&t<=c;if(l&&u){if(e===a&&t===c){r.push(o);break}const h=e-a;r.push(o.subarray(h,h+(t-e)));break}if(l){if(e===0){r.push(o);continue}r.push(o.subarray(e-a));continue}if(u){if(t===c){r.push(o);break}r.push(o.subarray(0,t-a));break}r.push(o)}return{bufs:r,length:t-e}}indexOf(e,t=0){if(!ei(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const r=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;const s=r.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");const i=256,o=new Int32Array(i);for(let h=0;h<i;h++)o[h]=-1;for(let h=0;h<s;h++)o[r[h]]=h;const a=o,c=this.byteLength-r.byteLength,l=r.byteLength-1;let u;for(let h=t;h<=c;h+=u){u=0;for(let f=l;f>=0;f--){const g=this.get(h+f);if(r[f]!==g){u=Math.max(1,f-a[g]);break}}if(u===0)return h}return-1}getInt8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){const r=qt(1);new DataView(r.buffer,r.byteOffset,r.byteLength).setInt8(0,t),this.write(r,e)}getInt16(e,t){const r=this.subarray(e,e+2);return new DataView(r.buffer,r.byteOffset,r.byteLength).getInt16(0,t)}setInt16(e,t,r){const s=ke(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,t,r),this.write(s,e)}getInt32(e,t){const r=this.subarray(e,e+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getInt32(0,t)}setInt32(e,t,r){const s=ke(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,t,r),this.write(s,e)}getBigInt64(e,t){const r=this.subarray(e,e+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getBigInt64(0,t)}setBigInt64(e,t,r){const s=ke(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,t,r),this.write(s,e)}getUint8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){const r=qt(1);new DataView(r.buffer,r.byteOffset,r.byteLength).setUint8(0,t),this.write(r,e)}getUint16(e,t){const r=this.subarray(e,e+2);return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint16(0,t)}setUint16(e,t,r){const s=ke(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,t,r),this.write(s,e)}getUint32(e,t){const r=this.subarray(e,e+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint32(0,t)}setUint32(e,t,r){const s=ke(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,t,r),this.write(s,e)}getBigUint64(e,t){const r=this.subarray(e,e+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getBigUint64(0,t)}setBigUint64(e,t,r){const s=ke(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,t,r),this.write(s,e)}getFloat32(e,t){const r=this.subarray(e,e+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getFloat32(0,t)}setFloat32(e,t,r){const s=ke(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,t,r),this.write(s,e)}getFloat64(e,t){const r=this.subarray(e,e+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getFloat64(0,t)}setFloat64(e,t,r){const s=ke(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,t,r),this.write(s,e)}equals(e){if(e==null||!(e instanceof ve)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!ie(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){const r=new ve;return r.bufs=e,t==null&&(t=e.reduce((s,i)=>s+i.byteLength,0)),r.length=t,r}}const _6=Fs({prefix:"9",name:"base10",alphabet:"0123456789"}),x6=Object.freeze(Object.defineProperty({__proto__:null,base10:_6},Symbol.toStringTag,{value:"Module"})),k6=Fe({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),C6=Fe({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),A6=Object.freeze(Object.defineProperty({__proto__:null,base16:k6,base16upper:C6},Symbol.toStringTag,{value:"Module"})),I6=Fe({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),P6=Object.freeze(Object.defineProperty({__proto__:null,base2:I6},Symbol.toStringTag,{value:"Module"})),K2=Array.from("🚀🪐☄🛰🌌🌑🌒🌓🌔🌕🌖🌗🌘🌍🌏🌎🐉☀💻🖥💾💿😂❤😍🤣😊🙏💕😭😘👍😅👏😁🔥🥰💔💖💙😢🤔😆🙄💪😉☺👌🤗💜😔😎😇🌹🤦🎉💞✌✨🤷😱😌🌸🙌😋💗💚😏💛🙂💓🤩😄😀🖤😃💯🙈👇🎶😒🤭❣😜💋👀😪😑💥🙋😞😩😡🤪👊🥳😥🤤👉💃😳✋😚😝😴🌟😬🙃🍀🌷😻😓⭐✅🥺🌈😈🤘💦✔😣🏃💐☹🎊💘😠☝😕🌺🎂🌻😐🖕💝🙊😹🗣💫💀👑🎵🤞😛🔴😤🌼😫⚽🤙☕🏆🤫👈😮🙆🍻🍃🐶💁😲🌿🧡🎁⚡🌞🎈❌✊👋😰🤨😶🤝🚶💰🍓💢🤟🙁🚨💨🤬✈🎀🍺🤓😙💟🌱😖👶🥴▶➡❓💎💸⬇😨🌚🦋😷🕺⚠🙅😟😵👎🤲🤠🤧📌🔵💅🧐🐾🍒😗🤑🌊🤯🐷☎💧😯💆👆🎤🙇🍑❄🌴💣🐸💌📍🥀🤢👅💡💩👐📸👻🤐🤮🎼🥵🚩🍎🍊👼💍📣🥂"),T6=K2.reduce((n,e,t)=>(n[t]=e,n),[]),R6=K2.reduce((n,e,t)=>{const r=e.codePointAt(0);if(r==null)throw new Error(`Invalid character: ${e}`);return n[r]=t,n},[]);function D6(n){return n.reduce((e,t)=>(e+=T6[t],e),"")}function B6(n){const e=[];for(const t of n){const r=t.codePointAt(0);if(r==null)throw new Error(`Invalid character: ${t}`);const s=R6[r];if(s==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(s)}return new Uint8Array(e)}const L6=xo({prefix:"🚀",name:"base256emoji",encode:D6,decode:B6}),N6=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:L6},Symbol.toStringTag,{value:"Module"})),ol=Fe({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),O6=Fe({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),j2=Fe({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),M6=Fe({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),U6=Object.freeze(Object.defineProperty({__proto__:null,base64:ol,base64pad:O6,base64url:j2,base64urlpad:M6},Symbol.toStringTag,{value:"Module"})),F6=Fe({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),$6=Object.freeze(Object.defineProperty({__proto__:null,base8:F6},Symbol.toStringTag,{value:"Module"})),V6=xo({prefix:"\0",name:"identity",encode:n=>T4(n),decode:n=>P4(n)}),H6=Object.freeze(Object.defineProperty({__proto__:null,identity:V6},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;const q6=85;function z6({name:n,code:e,encode:t}){return new K6(n,e,t)}class K6{constructor(e,t,r){d(this,"name");d(this,"code");d(this,"encode");this.name=e,this.code=t,this.encode=r}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?Vr(this.code,t):t.then(r=>Vr(this.code,r))}else throw Error("Unknown type, must be binary type")}}function j6(n){return async e=>new Uint8Array(await crypto.subtle.digest(n,e))}const tt=z6({name:"sha2-256",code:18,encode:j6("SHA-256")}),ps={...H6,...P6,...$6,...x6,...A6,...Y4,...Z4,...V4,...U6,...N6};function G2(n,e,t,r){return{name:n,prefix:e,encoder:{name:n,prefix:e,encode:t},decoder:{decode:r}}}const R1=G2("utf8","u",n=>"u"+new TextDecoder("utf8").decode(n),n=>new TextEncoder().encode(n.substring(1))),Xo=G2("ascii","a",n=>{let e="a";for(let t=0;t<n.length;t++)e+=String.fromCharCode(n[t]);return e},n=>{n=n.substring(1);const e=qt(n.length);for(let t=0;t<n.length;t++)e[t]=n.charCodeAt(t);return e}),W2={utf8:R1,"utf-8":R1,hex:ps.base16,latin1:Xo,ascii:Xo,binary:Xo,...ps};function O(n,e="utf8"){const t=W2[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.decoder.decode(`${t.prefix}${n}`)}function M(n,e="utf8"){const t=W2[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.encoder.encode(n).substring(1)}const G6=parseInt("11111",2),sc=parseInt("10000000",2),W6=parseInt("01111111",2),D1={0:jn,1:jn,2:Q6,3:Z6,4:X6,5:J6,6:Y6,16:jn,22:jn,48:jn};function ko(n,e={offset:0}){const t=n[e.offset]&G6;if(e.offset++,D1[t]!=null)return D1[t](n,e);throw new Error("No decoder for tag "+t)}function $s(n,e){let t=0;if((n[e.offset]&sc)===sc){const r=n[e.offset]&W6;let s="0x";e.offset++;for(let i=0;i<r;i++,e.offset++)s+=n[e.offset].toString(16).padStart(2,"0");t=parseInt(s,16)}else t=n[e.offset],e.offset++;return t}function jn(n,e){$s(n,e);const t=[];for(;!(e.offset>=n.byteLength);){const r=ko(n,e);if(r===null)break;t.push(r)}return t}function Q6(n,e){const t=$s(n,e),r=e.offset,s=e.offset+t,i=[];for(let o=r;o<s;o++)o===r&&n[o]===0||i.push(n[o]);return e.offset+=t,Uint8Array.from(i)}function Y6(n,e){const t=$s(n,e),r=e.offset+t,s=n[e.offset];e.offset++;let i=0,o=0;s<40?(i=0,o=s):s<80?(i=1,o=s-40):(i=2,o=s-80);let a=`${i}.${o}`,c=[];for(;e.offset<r;){const l=n[e.offset];if(e.offset++,c.push(l&127),l<128){c.reverse();let u=0;for(let h=0;h<c.length;h++)u+=c[h]<<h*7;a+=`.${u}`,c=[]}}return a}function J6(n,e){return e.offset++,null}function Z6(n,e){const t=$s(n,e),r=n[e.offset];e.offset++;const s=n.subarray(e.offset,e.offset+t-1);if(e.offset+=t,r!==0)throw new Error("Unused bits in bit string is unimplemented");return s}function X6(n,e){const t=$s(n,e),r=n.subarray(e.offset,e.offset+t);return e.offset+=t,r}function e5(n){let e=n.toString(16);e.length%2===1&&(e="0"+e);const t=new ve;for(let r=0;r<e.length;r+=2)t.append(Uint8Array.from([parseInt(`${e[r]}${e[r+1]}`,16)]));return t}function al(n){if(n.byteLength<128)return Uint8Array.from([n.byteLength]);const e=e5(n.byteLength);return new ve(Uint8Array.from([e.byteLength|sc]),e)}function ic(n){const e=new ve,t=128;return(n.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(n),new ve(Uint8Array.from([2]),al(e),e)}function Q2(n){const e=Uint8Array.from([0]),t=new ve(e,n);return new ve(Uint8Array.from([3]),al(t),t)}function Jn(n,e=48){const t=new ve;for(const r of n)t.append(r);return new ve(Uint8Array.from([e]),al(t),t)}async function t5(n,e,t){const r=await crypto.subtle.importKey("jwk",n,{name:"ECDSA",namedCurve:n.crv??"P-256"},!1,["verify"]);return crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},r,e,t.subarray())}const r5=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),n5=Uint8Array.from([6,5,43,129,4,0,34]),s5=Uint8Array.from([6,5,43,129,4,0,35]),i5={ext:!0,kty:"EC",crv:"P-256"},o5={ext:!0,kty:"EC",crv:"P-384"},a5={ext:!0,kty:"EC",crv:"P-521"},ea=32,ta=48,ra=66;function Y2(n){const e=ko(n);return c5(e)}function c5(n){const e=n[1][1][0],t=1;let r,s;if(e.byteLength===ea*2+1)return r=M(e.subarray(t,t+ea),"base64url"),s=M(e.subarray(t+ea),"base64url"),new na({...i5,key_ops:["verify"],x:r,y:s});if(e.byteLength===ta*2+1)return r=M(e.subarray(t,t+ta),"base64url"),s=M(e.subarray(t+ta),"base64url"),new na({...o5,key_ops:["verify"],x:r,y:s});if(e.byteLength===ra*2+1)return r=M(e.subarray(t,t+ra),"base64url"),s=M(e.subarray(t+ra),"base64url"),new na({...a5,key_ops:["verify"],x:r,y:s});throw new G(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function l5(n){return Jn([ic(Uint8Array.from([1])),Jn([u5(n.crv)],160),Jn([Q2(new ve(Uint8Array.from([4]),O(n.x??"","base64url"),O(n.y??"","base64url")))],161)]).subarray()}function u5(n){if(n==="P-256")return r5;if(n==="P-384")return n5;if(n==="P-521")return s5;throw new G(`Invalid curve ${n}`)}class na{constructor(e){d(this,"type","ECDSA");d(this,"jwk");d(this,"_raw");this.jwk=e}get raw(){return this._raw==null&&(this._raw=l5(this.jwk)),this._raw}toMultihash(){return It.digest(tr(this))}toCID(){return Z.createV1(114,this.toMultihash())}toString(){return fe.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:ie(this.raw,e.raw)}async verify(e,t){return t5(this.jwk,t,e)}}const tn=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function d5(n){return n instanceof Uint8Array||ArrayBuffer.isView(n)&&n.constructor.name==="Uint8Array"}function hn(n){if(!Number.isSafeInteger(n)||n<0)throw new Error("positive integer expected, got "+n)}function On(n,...e){if(!d5(n))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(n.length))throw new Error("Uint8Array expected of length "+e+", got length="+n.length)}function J2(n){if(typeof n!="function"||typeof n.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");hn(n.outputLen),hn(n.blockLen)}function Gi(n,e=!0){if(n.destroyed)throw new Error("Hash instance has been destroyed");if(e&&n.finished)throw new Error("Hash#digest() has already been called")}function h5(n,e){On(n);const t=e.outputLen;if(n.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function Hr(...n){for(let e=0;e<n.length;e++)n[e].fill(0)}function Ai(n){return new DataView(n.buffer,n.byteOffset,n.byteLength)}function Bt(n,e){return n<<32-e|n>>>e}const f5=async()=>{};async function p5(n,e,t){let r=Date.now();for(let s=0;s<n;s++){t(s);const i=Date.now()-r;i>=0&&i<e||(await f5(),r+=i)}}function Z2(n){if(typeof n!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(n))}function cl(n){return typeof n=="string"&&(n=Z2(n)),On(n),n}function B1(n){return typeof n=="string"&&(n=Z2(n)),On(n),n}function g5(...n){let e=0;for(let r=0;r<n.length;r++){const s=n[r];On(s),e+=s.length}const t=new Uint8Array(e);for(let r=0,s=0;r<n.length;r++){const i=n[r];t.set(i,s),s+=i.length}return t}function m5(n,e){if(e!==void 0&&{}.toString.call(e)!=="[object Object]")throw new Error("options should be object or undefined");return Object.assign(n,e)}class X2{}function eh(n){const e=r=>n().update(cl(r)).digest(),t=n();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>n(),e}function Co(n=32){if(tn&&typeof tn.getRandomValues=="function")return tn.getRandomValues(new Uint8Array(n));if(tn&&typeof tn.randomBytes=="function")return Uint8Array.from(tn.randomBytes(n));throw new Error("crypto.getRandomValues must be defined")}function y5(n,e,t,r){if(typeof n.setBigUint64=="function")return n.setBigUint64(e,t,r);const s=BigInt(32),i=BigInt(4294967295),o=Number(t>>s&i),a=Number(t&i),c=r?4:0,l=r?0:4;n.setUint32(e+c,o,r),n.setUint32(e+l,a,r)}function b5(n,e,t){return n&e^~n&t}function w5(n,e,t){return n&e^n&t^e&t}class th extends X2{constructor(e,t,r,s){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=r,this.isLE=s,this.buffer=new Uint8Array(e),this.view=Ai(this.buffer)}update(e){Gi(this),e=cl(e),On(e);const{view:t,buffer:r,blockLen:s}=this,i=e.length;for(let o=0;o<i;){const a=Math.min(s-this.pos,i-o);if(a===s){const c=Ai(e);for(;s<=i-o;o+=s)this.process(c,o);continue}r.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Gi(this),h5(e,this),this.finished=!0;const{buffer:t,view:r,blockLen:s,isLE:i}=this;let{pos:o}=this;t[o++]=128,Hr(this.buffer.subarray(o)),this.padOffset>s-o&&(this.process(r,0),o=0);for(let h=o;h<s;h++)t[h]=0;y5(r,s-8,BigInt(this.length*8),i),this.process(r,0);const a=Ai(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const l=c/4,u=this.get();if(l>u.length)throw new Error("_sha2: outputLen bigger than state");for(let h=0;h<l;h++)a.setUint32(4*h,u[h],i)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const r=e.slice(0,t);return this.destroy(),r}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:r,length:s,finished:i,destroyed:o,pos:a}=this;return e.destroyed=o,e.finished=i,e.length=s,e.pos=a,s%t&&e.buffer.set(r),e}clone(){return this._cloneInto()}}const lr=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Ve=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),ti=BigInt(2**32-1),L1=BigInt(32);function v5(n,e=!1){return e?{h:Number(n&ti),l:Number(n>>L1&ti)}:{h:Number(n>>L1&ti)|0,l:Number(n&ti)|0}}function E5(n,e=!1){const t=n.length;let r=new Uint32Array(t),s=new Uint32Array(t);for(let i=0;i<t;i++){const{h:o,l:a}=v5(n[i],e);[r[i],s[i]]=[o,a]}return[r,s]}const N1=(n,e,t)=>n>>>t,O1=(n,e,t)=>n<<32-t|e>>>t,rn=(n,e,t)=>n>>>t|e<<32-t,nn=(n,e,t)=>n<<32-t|e>>>t,ri=(n,e,t)=>n<<64-t|e>>>t-32,ni=(n,e,t)=>n>>>t-32|e<<64-t;function jt(n,e,t,r){const s=(e>>>0)+(r>>>0);return{h:n+t+(s/2**32|0)|0,l:s|0}}const S5=(n,e,t)=>(n>>>0)+(e>>>0)+(t>>>0),_5=(n,e,t,r)=>e+t+r+(n/2**32|0)|0,x5=(n,e,t,r)=>(n>>>0)+(e>>>0)+(t>>>0)+(r>>>0),k5=(n,e,t,r,s)=>e+t+r+s+(n/2**32|0)|0,C5=(n,e,t,r,s)=>(n>>>0)+(e>>>0)+(t>>>0)+(r>>>0)+(s>>>0),A5=(n,e,t,r,s,i)=>e+t+r+s+i+(n/2**32|0)|0,I5=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),ur=new Uint32Array(64);class P5 extends th{constructor(e=32){super(64,e,8,!1),this.A=lr[0]|0,this.B=lr[1]|0,this.C=lr[2]|0,this.D=lr[3]|0,this.E=lr[4]|0,this.F=lr[5]|0,this.G=lr[6]|0,this.H=lr[7]|0}get(){const{A:e,B:t,C:r,D:s,E:i,F:o,G:a,H:c}=this;return[e,t,r,s,i,o,a,c]}set(e,t,r,s,i,o,a,c){this.A=e|0,this.B=t|0,this.C=r|0,this.D=s|0,this.E=i|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let h=0;h<16;h++,t+=4)ur[h]=e.getUint32(t,!1);for(let h=16;h<64;h++){const f=ur[h-15],g=ur[h-2],p=Bt(f,7)^Bt(f,18)^f>>>3,m=Bt(g,17)^Bt(g,19)^g>>>10;ur[h]=m+ur[h-7]+p+ur[h-16]|0}let{A:r,B:s,C:i,D:o,E:a,F:c,G:l,H:u}=this;for(let h=0;h<64;h++){const f=Bt(a,6)^Bt(a,11)^Bt(a,25),g=u+f+b5(a,c,l)+I5[h]+ur[h]|0,m=(Bt(r,2)^Bt(r,13)^Bt(r,22))+w5(r,s,i)|0;u=l,l=c,c=a,a=o+g|0,o=i,i=s,s=r,r=g+m|0}r=r+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,u=u+this.H|0,this.set(r,s,i,o,a,c,l,u)}roundClean(){Hr(ur)}destroy(){this.set(0,0,0,0,0,0,0,0),Hr(this.buffer)}}const rh=E5(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(n=>BigInt(n))),T5=rh[0],R5=rh[1],dr=new Uint32Array(80),hr=new Uint32Array(80);class D5 extends th{constructor(e=64){super(128,e,16,!1),this.Ah=Ve[0]|0,this.Al=Ve[1]|0,this.Bh=Ve[2]|0,this.Bl=Ve[3]|0,this.Ch=Ve[4]|0,this.Cl=Ve[5]|0,this.Dh=Ve[6]|0,this.Dl=Ve[7]|0,this.Eh=Ve[8]|0,this.El=Ve[9]|0,this.Fh=Ve[10]|0,this.Fl=Ve[11]|0,this.Gh=Ve[12]|0,this.Gl=Ve[13]|0,this.Hh=Ve[14]|0,this.Hl=Ve[15]|0}get(){const{Ah:e,Al:t,Bh:r,Bl:s,Ch:i,Cl:o,Dh:a,Dl:c,Eh:l,El:u,Fh:h,Fl:f,Gh:g,Gl:p,Hh:m,Hl:y}=this;return[e,t,r,s,i,o,a,c,l,u,h,f,g,p,m,y]}set(e,t,r,s,i,o,a,c,l,u,h,f,g,p,m,y){this.Ah=e|0,this.Al=t|0,this.Bh=r|0,this.Bl=s|0,this.Ch=i|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=u|0,this.Fh=h|0,this.Fl=f|0,this.Gh=g|0,this.Gl=p|0,this.Hh=m|0,this.Hl=y|0}process(e,t){for(let w=0;w<16;w++,t+=4)dr[w]=e.getUint32(t),hr[w]=e.getUint32(t+=4);for(let w=16;w<80;w++){const b=dr[w-15]|0,v=hr[w-15]|0,x=rn(b,v,1)^rn(b,v,8)^N1(b,v,7),C=nn(b,v,1)^nn(b,v,8)^O1(b,v,7),R=dr[w-2]|0,F=hr[w-2]|0,j=rn(R,F,19)^ri(R,F,61)^N1(R,F,6),$=nn(R,F,19)^ni(R,F,61)^O1(R,F,6),z=x5(C,$,hr[w-7],hr[w-16]),H=k5(z,x,j,dr[w-7],dr[w-16]);dr[w]=H|0,hr[w]=z|0}let{Ah:r,Al:s,Bh:i,Bl:o,Ch:a,Cl:c,Dh:l,Dl:u,Eh:h,El:f,Fh:g,Fl:p,Gh:m,Gl:y,Hh:E,Hl:_}=this;for(let w=0;w<80;w++){const b=rn(h,f,14)^rn(h,f,18)^ri(h,f,41),v=nn(h,f,14)^nn(h,f,18)^ni(h,f,41),x=h&g^~h&m,C=f&p^~f&y,R=C5(_,v,C,R5[w],hr[w]),F=A5(R,E,b,x,T5[w],dr[w]),j=R|0,$=rn(r,s,28)^ri(r,s,34)^ri(r,s,39),z=nn(r,s,28)^ni(r,s,34)^ni(r,s,39),H=r&i^r&a^i&a,_e=s&o^s&c^o&c;E=m|0,_=y|0,m=g|0,y=p|0,g=h|0,p=f|0,{h,l:f}=jt(l|0,u|0,F|0,j|0),l=a|0,u=c|0,a=i|0,c=o|0,i=r|0,o=s|0;const P=S5(j,z,_e);r=_5(P,F,$,H),s=P|0}({h:r,l:s}=jt(this.Ah|0,this.Al|0,r|0,s|0)),{h:i,l:o}=jt(this.Bh|0,this.Bl|0,i|0,o|0),{h:a,l:c}=jt(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:u}=jt(this.Dh|0,this.Dl|0,l|0,u|0),{h,l:f}=jt(this.Eh|0,this.El|0,h|0,f|0),{h:g,l:p}=jt(this.Fh|0,this.Fl|0,g|0,p|0),{h:m,l:y}=jt(this.Gh|0,this.Gl|0,m|0,y|0),{h:E,l:_}=jt(this.Hh|0,this.Hl|0,E|0,_|0),this.set(r,s,i,o,a,c,l,u,h,f,g,p,m,y,E,_)}roundClean(){Hr(dr,hr)}destroy(){Hr(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}const nh=eh(()=>new P5),sh=eh(()=>new D5);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const ll=BigInt(0),oc=BigInt(1);function Vs(n){return n instanceof Uint8Array||ArrayBuffer.isView(n)&&n.constructor.name==="Uint8Array"}function ul(n){if(!Vs(n))throw new Error("Uint8Array expected")}function vr(n,e){if(typeof e!="boolean")throw new Error(n+" boolean expected, got "+e)}function si(n){const e=n.toString(16);return e.length&1?"0"+e:e}function ih(n){if(typeof n!="string")throw new Error("hex string expected, got "+typeof n);return n===""?ll:BigInt("0x"+n)}const oh=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",B5=Array.from({length:256},(n,e)=>e.toString(16).padStart(2,"0"));function _n(n){if(ul(n),oh)return n.toHex();let e="";for(let t=0;t<n.length;t++)e+=B5[n[t]];return e}const Gt={_0:48,_9:57,A:65,F:70,a:97,f:102};function M1(n){if(n>=Gt._0&&n<=Gt._9)return n-Gt._0;if(n>=Gt.A&&n<=Gt.F)return n-(Gt.A-10);if(n>=Gt.a&&n<=Gt.f)return n-(Gt.a-10)}function Wi(n){if(typeof n!="string")throw new Error("hex string expected, got "+typeof n);if(oh)return Uint8Array.fromHex(n);const e=n.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const r=new Uint8Array(t);for(let s=0,i=0;s<t;s++,i+=2){const o=M1(n.charCodeAt(i)),a=M1(n.charCodeAt(i+1));if(o===void 0||a===void 0){const c=n[i]+n[i+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+i)}r[s]=o*16+a}return r}function Ur(n){return ih(_n(n))}function Zn(n){return ul(n),ih(_n(Uint8Array.from(n).reverse()))}function Hs(n,e){return Wi(n.toString(16).padStart(e*2,"0"))}function Qi(n,e){return Hs(n,e).reverse()}function Se(n,e,t){let r;if(typeof e=="string")try{r=Wi(e)}catch(i){throw new Error(n+" must be hex string or Uint8Array, cause: "+i)}else if(Vs(e))r=Uint8Array.from(e);else throw new Error(n+" must be hex string or Uint8Array");const s=r.length;if(typeof t=="number"&&s!==t)throw new Error(n+" of length "+t+" expected, got "+s);return r}function xn(...n){let e=0;for(let r=0;r<n.length;r++){const s=n[r];ul(s),e+=s.length}const t=new Uint8Array(e);for(let r=0,s=0;r<n.length;r++){const i=n[r];t.set(i,s),s+=i.length}return t}const sa=n=>typeof n=="bigint"&&ll<=n;function dl(n,e,t){return sa(n)&&sa(e)&&sa(t)&&e<=n&&n<t}function kt(n,e,t,r){if(!dl(e,t,r))throw new Error("expected valid "+n+": "+t+" <= n < "+r+", got "+e)}function L5(n){let e;for(e=0;n>ll;n>>=oc,e+=1);return e}const Ao=n=>(oc<<BigInt(n))-oc,ia=n=>new Uint8Array(n),U1=n=>Uint8Array.from(n);function N5(n,e,t){if(typeof n!="number"||n<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");let r=ia(n),s=ia(n),i=0;const o=()=>{r.fill(1),s.fill(0),i=0},a=(...h)=>t(s,r,...h),c=(h=ia(0))=>{s=a(U1([0]),h),r=a(),h.length!==0&&(s=a(U1([1]),h),r=a())},l=()=>{if(i++>=1e3)throw new Error("drbg: tried 1000 values");let h=0;const f=[];for(;h<e;){r=a();const g=r.slice();f.push(g),h+=r.length}return xn(...f)};return(h,f)=>{o(),c(h);let g;for(;!(g=f(l()));)c();return o(),g}}const O5={bigint:n=>typeof n=="bigint",function:n=>typeof n=="function",boolean:n=>typeof n=="boolean",string:n=>typeof n=="string",stringOrUint8Array:n=>typeof n=="string"||Vs(n),isSafeInteger:n=>Number.isSafeInteger(n),array:n=>Array.isArray(n),field:(n,e)=>e.Fp.isValid(n),hash:n=>typeof n=="function"&&Number.isSafeInteger(n.outputLen)};function qs(n,e,t={}){const r=(s,i,o)=>{const a=O5[i];if(typeof a!="function")throw new Error("invalid validator function");const c=n[s];if(!(o&&c===void 0)&&!a(c,n))throw new Error("param "+String(s)+" is invalid. Expected "+i+", got "+c)};for(const[s,i]of Object.entries(e))r(s,i,!1);for(const[s,i]of Object.entries(t))r(s,i,!0);return n}function Yi(n){const e=new WeakMap;return(t,...r)=>{const s=e.get(t);if(s!==void 0)return s;const i=n(t,...r);return e.set(t,i),i}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const it=BigInt(0),Ne=BigInt(1),Lr=BigInt(2),M5=BigInt(3),ah=BigInt(4),ch=BigInt(5),lh=BigInt(8);function he(n,e){const t=n%e;return t>=it?t:e+t}function be(n,e,t){let r=n;for(;e-- >it;)r*=r,r%=t;return r}function ac(n,e){if(n===it)throw new Error("invert: expected non-zero number");if(e<=it)throw new Error("invert: expected positive modulus, got "+e);let t=he(n,e),r=e,s=it,i=Ne;for(;t!==it;){const a=r/t,c=r%t,l=s-i*a;r=t,t=c,s=i,i=l}if(r!==Ne)throw new Error("invert: does not exist");return he(s,e)}function uh(n,e){const t=(n.ORDER+Ne)/ah,r=n.pow(e,t);if(!n.eql(n.sqr(r),e))throw new Error("Cannot find square root");return r}function U5(n,e){const t=(n.ORDER-ch)/lh,r=n.mul(e,Lr),s=n.pow(r,t),i=n.mul(e,s),o=n.mul(n.mul(i,Lr),s),a=n.mul(i,n.sub(o,n.ONE));if(!n.eql(n.sqr(a),e))throw new Error("Cannot find square root");return a}function F5(n){if(n<BigInt(3))throw new Error("sqrt is not defined for small field");let e=n-Ne,t=0;for(;e%Lr===it;)e/=Lr,t++;let r=Lr;const s=zs(n);for(;F1(s,r)===1;)if(r++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return uh;let i=s.pow(r,e);const o=(e+Ne)/Lr;return function(c,l){if(c.is0(l))return l;if(F1(c,l)!==1)throw new Error("Cannot find square root");let u=t,h=c.mul(c.ONE,i),f=c.pow(l,e),g=c.pow(l,o);for(;!c.eql(f,c.ONE);){if(c.is0(f))return c.ZERO;let p=1,m=c.sqr(f);for(;!c.eql(m,c.ONE);)if(p++,m=c.sqr(m),p===u)throw new Error("Cannot find square root");const y=Ne<<BigInt(u-p-1),E=c.pow(h,y);u=p,h=c.sqr(E),f=c.mul(f,h),g=c.mul(g,E)}return g}}function $5(n){return n%ah===M5?uh:n%lh===ch?U5:F5(n)}const V5=(n,e)=>(he(n,e)&Ne)===Ne,H5=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function q5(n){const e={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},t=H5.reduce((r,s)=>(r[s]="function",r),e);return qs(n,t)}function z5(n,e,t){if(t<it)throw new Error("invalid exponent, negatives unsupported");if(t===it)return n.ONE;if(t===Ne)return e;let r=n.ONE,s=e;for(;t>it;)t&Ne&&(r=n.mul(r,s)),s=n.sqr(s),t>>=Ne;return r}function hl(n,e,t=!1){const r=new Array(e.length).fill(t?n.ZERO:void 0),s=e.reduce((o,a,c)=>n.is0(a)?o:(r[c]=o,n.mul(o,a)),n.ONE),i=n.inv(s);return e.reduceRight((o,a,c)=>n.is0(a)?o:(r[c]=n.mul(o,r[c]),n.mul(o,a)),i),r}function F1(n,e){const t=(n.ORDER-Ne)/Lr,r=n.pow(e,t),s=n.eql(r,n.ONE),i=n.eql(r,n.ZERO),o=n.eql(r,n.neg(n.ONE));if(!s&&!i&&!o)throw new Error("invalid Legendre symbol result");return s?1:i?0:-1}function dh(n,e){e!==void 0&&hn(e);const t=e!==void 0?e:n.toString(2).length,r=Math.ceil(t/8);return{nBitLength:t,nByteLength:r}}function zs(n,e,t=!1,r={}){if(n<=it)throw new Error("invalid field: expected ORDER > 0, got "+n);const{nBitLength:s,nByteLength:i}=dh(n,e);if(i>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let o;const a=Object.freeze({ORDER:n,isLE:t,BITS:s,BYTES:i,MASK:Ao(s),ZERO:it,ONE:Ne,create:c=>he(c,n),isValid:c=>{if(typeof c!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof c);return it<=c&&c<n},is0:c=>c===it,isOdd:c=>(c&Ne)===Ne,neg:c=>he(-c,n),eql:(c,l)=>c===l,sqr:c=>he(c*c,n),add:(c,l)=>he(c+l,n),sub:(c,l)=>he(c-l,n),mul:(c,l)=>he(c*l,n),pow:(c,l)=>z5(a,c,l),div:(c,l)=>he(c*ac(l,n),n),sqrN:c=>c*c,addN:(c,l)=>c+l,subN:(c,l)=>c-l,mulN:(c,l)=>c*l,inv:c=>ac(c,n),sqrt:r.sqrt||(c=>(o||(o=$5(n)),o(a,c))),toBytes:c=>t?Qi(c,i):Hs(c,i),fromBytes:c=>{if(c.length!==i)throw new Error("Field.fromBytes: expected "+i+" bytes, got "+c.length);return t?Zn(c):Ur(c)},invertBatch:c=>hl(a,c),cmov:(c,l,u)=>u?l:c});return Object.freeze(a)}function hh(n){if(typeof n!="bigint")throw new Error("field order must be bigint");const e=n.toString(2).length;return Math.ceil(e/8)}function fh(n){const e=hh(n);return e+Math.ceil(e/2)}function K5(n,e,t=!1){const r=n.length,s=hh(e),i=fh(e);if(r<16||r<i||r>1024)throw new Error("expected "+i+"-1024 bytes of input, got "+r);const o=t?Zn(n):Ur(n),a=he(o,e-Ne)+Ne;return t?Qi(a,s):Hs(a,s)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const $1=BigInt(0),cc=BigInt(1);function oa(n,e){const t=e.negate();return n?t:e}function ph(n,e){if(!Number.isSafeInteger(n)||n<=0||n>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+n)}function aa(n,e){ph(n,e);const t=Math.ceil(e/n)+1,r=2**(n-1),s=2**n,i=Ao(n),o=BigInt(n);return{windows:t,windowSize:r,mask:i,maxNumber:s,shiftBy:o}}function V1(n,e,t){const{windowSize:r,mask:s,maxNumber:i,shiftBy:o}=t;let a=Number(n&s),c=n>>o;a>r&&(a-=i,c+=cc);const l=e*r,u=l+Math.abs(a)-1,h=a===0,f=a<0,g=e%2!==0;return{nextN:c,offset:u,isZero:h,isNeg:f,isNegF:g,offsetF:l}}function j5(n,e){if(!Array.isArray(n))throw new Error("array expected");n.forEach((t,r)=>{if(!(t instanceof e))throw new Error("invalid point at index "+r)})}function G5(n,e){if(!Array.isArray(n))throw new Error("array of scalars expected");n.forEach((t,r)=>{if(!e.isValid(t))throw new Error("invalid scalar at index "+r)})}const ca=new WeakMap,gh=new WeakMap;function la(n){return gh.get(n)||1}function mh(n,e){return{constTimeNegate:oa,hasPrecomputes(t){return la(t)!==1},unsafeLadder(t,r,s=n.ZERO){let i=t;for(;r>$1;)r&cc&&(s=s.add(i)),i=i.double(),r>>=cc;return s},precomputeWindow(t,r){const{windows:s,windowSize:i}=aa(r,e),o=[];let a=t,c=a;for(let l=0;l<s;l++){c=a,o.push(c);for(let u=1;u<i;u++)c=c.add(a),o.push(c);a=c.double()}return o},wNAF(t,r,s){let i=n.ZERO,o=n.BASE;const a=aa(t,e);for(let c=0;c<a.windows;c++){const{nextN:l,offset:u,isZero:h,isNeg:f,isNegF:g,offsetF:p}=V1(s,c,a);s=l,h?o=o.add(oa(g,r[p])):i=i.add(oa(f,r[u]))}return{p:i,f:o}},wNAFUnsafe(t,r,s,i=n.ZERO){const o=aa(t,e);for(let a=0;a<o.windows&&s!==$1;a++){const{nextN:c,offset:l,isZero:u,isNeg:h}=V1(s,a,o);if(s=c,!u){const f=r[l];i=i.add(h?f.negate():f)}}return i},getPrecomputes(t,r,s){let i=ca.get(r);return i||(i=this.precomputeWindow(r,t),t!==1&&ca.set(r,s(i))),i},wNAFCached(t,r,s){const i=la(t);return this.wNAF(i,this.getPrecomputes(i,t,s),r)},wNAFCachedUnsafe(t,r,s,i){const o=la(t);return o===1?this.unsafeLadder(t,r,i):this.wNAFUnsafe(o,this.getPrecomputes(o,t,s),r,i)},setWindowSize(t,r){ph(r,e),gh.set(t,r),ca.delete(t)}}}function yh(n,e,t,r){j5(t,n),G5(r,e);const s=t.length,i=r.length;if(s!==i)throw new Error("arrays of points and scalars must have equal length");const o=n.ZERO,a=L5(BigInt(s));let c=1;a>12?c=a-3:a>4?c=a-2:a>0&&(c=2);const l=Ao(c),u=new Array(Number(l)+1).fill(o),h=Math.floor((e.BITS-1)/c)*c;let f=o;for(let g=h;g>=0;g-=c){u.fill(o);for(let m=0;m<i;m++){const y=r[m],E=Number(y>>BigInt(g)&l);u[E]=u[E].add(t[m])}let p=o;for(let m=u.length-1,y=o;m>0;m--)y=y.add(u[m]),p=p.add(y);if(f=f.add(p),g!==0)for(let m=0;m<c;m++)f=f.double()}return f}function fl(n){return q5(n.Fp),qs(n,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...dh(n.n,n.nBitLength),...n,p:n.Fp.ORDER})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Lt=BigInt(0),We=BigInt(1),H1=BigInt(2),W5=BigInt(8),Q5={zip215:!0};function Y5(n){const e=fl(n);return qs(n,{hash:"function",a:"bigint",d:"bigint",randomBytes:"function"},{adjustScalarBytes:"function",domain:"function",uvRatio:"function",mapToCurve:"function"}),Object.freeze({...e})}function J5(n){const e=Y5(n),{Fp:t,n:r,prehash:s,hash:i,randomBytes:o,nByteLength:a,h:c}=e,l=H1<<BigInt(a*8)-We,u=t.create,h=zs(e.n,e.nBitLength);function f(A,S){const k=t.sqr(A),T=t.sqr(S),V=t.add(t.mul(e.a,k),T),K=t.add(t.ONE,t.mul(e.d,t.mul(k,T)));return t.eql(V,K)}if(!f(e.Gx,e.Gy))throw new Error("bad curve params: generator point");const g=e.uvRatio||((A,S)=>{try{return{isValid:!0,value:t.sqrt(A*t.inv(S))}}catch{return{isValid:!1,value:Lt}}}),p=e.adjustScalarBytes||(A=>A),m=e.domain||((A,S,k)=>{if(vr("phflag",k),S.length||k)throw new Error("Contexts/pre-hash are not supported");return A});function y(A,S,k=!1){const T=k?We:Lt;kt("coordinate "+A,S,T,l)}function E(A){if(!(A instanceof b))throw new Error("ExtendedPoint expected")}const _=Yi((A,S)=>{const{ex:k,ey:T,ez:V}=A,K=A.is0();S==null&&(S=K?W5:t.inv(V));const W=u(k*S),Y=u(T*S),ee=u(V*S);if(K)return{x:Lt,y:We};if(ee!==We)throw new Error("invZ was invalid");return{x:W,y:Y}}),w=Yi(A=>{const{a:S,d:k}=e;if(A.is0())throw new Error("bad point: ZERO");const{ex:T,ey:V,ez:K,et:W}=A,Y=u(T*T),ee=u(V*V),ae=u(K*K),xe=u(ae*ae),Ee=u(Y*S),Te=u(ae*u(Ee+ee)),rt=u(xe+u(k*u(Y*ee)));if(Te!==rt)throw new Error("bad point: equation left != right (1)");const Ce=u(T*V),$e=u(K*W);if(Ce!==$e)throw new Error("bad point: equation left != right (2)");return!0});class b{constructor(S,k,T,V){y("x",S),y("y",k),y("z",T,!0),y("t",V),this.ex=S,this.ey=k,this.ez=T,this.et=V,Object.freeze(this)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static fromAffine(S){if(S instanceof b)throw new Error("extended point not allowed");const{x:k,y:T}=S||{};return y("x",k),y("y",T),new b(k,T,We,u(k*T))}static normalizeZ(S){const k=hl(t,S.map(T=>T.ez));return S.map((T,V)=>T.toAffine(k[V])).map(b.fromAffine)}static msm(S,k){return yh(b,h,S,k)}_setWindowSize(S){C.setWindowSize(this,S)}assertValidity(){w(this)}equals(S){E(S);const{ex:k,ey:T,ez:V}=this,{ex:K,ey:W,ez:Y}=S,ee=u(k*Y),ae=u(K*V),xe=u(T*Y),Ee=u(W*V);return ee===ae&&xe===Ee}is0(){return this.equals(b.ZERO)}negate(){return new b(u(-this.ex),this.ey,this.ez,u(-this.et))}double(){const{a:S}=e,{ex:k,ey:T,ez:V}=this,K=u(k*k),W=u(T*T),Y=u(H1*u(V*V)),ee=u(S*K),ae=k+T,xe=u(u(ae*ae)-K-W),Ee=ee+W,Te=Ee-Y,rt=ee-W,Ce=u(xe*Te),$e=u(Ee*rt),ut=u(xe*rt),Dt=u(Te*Ee);return new b(Ce,$e,Dt,ut)}add(S){E(S);const{a:k,d:T}=e,{ex:V,ey:K,ez:W,et:Y}=this,{ex:ee,ey:ae,ez:xe,et:Ee}=S,Te=u(V*ee),rt=u(K*ae),Ce=u(Y*T*Ee),$e=u(W*xe),ut=u((V+K)*(ee+ae)-Te-rt),Dt=$e-Ce,Kt=$e+Ce,d1=u(rt-k*Te),$3=u(ut*Dt),V3=u(Kt*d1),H3=u(ut*d1),q3=u(Dt*Kt);return new b($3,V3,q3,H3)}subtract(S){return this.add(S.negate())}wNAF(S){return C.wNAFCached(this,S,b.normalizeZ)}multiply(S){const k=S;kt("scalar",k,We,r);const{p:T,f:V}=this.wNAF(k);return b.normalizeZ([T,V])[0]}multiplyUnsafe(S,k=b.ZERO){const T=S;return kt("scalar",T,Lt,r),T===Lt?x:this.is0()||T===We?this:C.wNAFCachedUnsafe(this,T,b.normalizeZ,k)}isSmallOrder(){return this.multiplyUnsafe(c).is0()}isTorsionFree(){return C.unsafeLadder(this,r).is0()}toAffine(S){return _(this,S)}clearCofactor(){const{h:S}=e;return S===We?this:this.multiplyUnsafe(S)}static fromHex(S,k=!1){const{d:T,a:V}=e,K=t.BYTES;S=Se("pointHex",S,K),vr("zip215",k);const W=S.slice(),Y=S[K-1];W[K-1]=Y&-129;const ee=Zn(W),ae=k?l:t.ORDER;kt("pointHex.y",ee,Lt,ae);const xe=u(ee*ee),Ee=u(xe-We),Te=u(T*xe-V);let{isValid:rt,value:Ce}=g(Ee,Te);if(!rt)throw new Error("Point.fromHex: invalid y coordinate");const $e=(Ce&We)===We,ut=(Y&128)!==0;if(!k&&Ce===Lt&&ut)throw new Error("Point.fromHex: x=0 and x_0=1");return ut!==$e&&(Ce=u(-Ce)),b.fromAffine({x:Ce,y:ee})}static fromPrivateKey(S){const{scalar:k}=j(S);return v.multiply(k)}toRawBytes(){const{x:S,y:k}=this.toAffine(),T=Qi(k,t.BYTES);return T[T.length-1]|=S&We?128:0,T}toHex(){return _n(this.toRawBytes())}}b.BASE=new b(e.Gx,e.Gy,We,u(e.Gx*e.Gy)),b.ZERO=new b(Lt,We,We,Lt);const{BASE:v,ZERO:x}=b,C=mh(b,a*8);function R(A){return he(A,r)}function F(A){return R(Zn(A))}function j(A){const S=t.BYTES;A=Se("private key",A,S);const k=Se("hashed private key",i(A),2*S),T=p(k.slice(0,S)),V=k.slice(S,2*S),K=F(T);return{head:T,prefix:V,scalar:K}}function $(A){const{head:S,prefix:k,scalar:T}=j(A),V=v.multiply(T),K=V.toRawBytes();return{head:S,prefix:k,scalar:T,point:V,pointBytes:K}}function z(A){return $(A).pointBytes}function H(A=Uint8Array.of(),...S){const k=xn(...S);return F(i(m(k,Se("context",A),!!s)))}function _e(A,S,k={}){A=Se("message",A),s&&(A=s(A));const{prefix:T,scalar:V,pointBytes:K}=$(S),W=H(k.context,T,A),Y=v.multiply(W).toRawBytes(),ee=H(k.context,Y,K,A),ae=R(W+ee*V);kt("signature.s",ae,Lt,r);const xe=xn(Y,Qi(ae,t.BYTES));return Se("result",xe,t.BYTES*2)}const P=Q5;function I(A,S,k,T=P){const{context:V,zip215:K}=T,W=t.BYTES;A=Se("signature",A,2*W),S=Se("message",S),k=Se("publicKey",k,W),K!==void 0&&vr("zip215",K),s&&(S=s(S));const Y=Zn(A.slice(W,2*W));let ee,ae,xe;try{ee=b.fromHex(k,K),ae=b.fromHex(A.slice(0,W),K),xe=v.multiplyUnsafe(Y)}catch{return!1}if(!K&&ee.isSmallOrder())return!1;const Ee=H(V,ae.toRawBytes(),ee.toRawBytes(),S);return ae.add(ee.multiplyUnsafe(Ee)).subtract(xe).clearCofactor().equals(b.ZERO)}return v._setWindowSize(8),{CURVE:e,getPublicKey:z,sign:_e,verify:I,ExtendedPoint:b,utils:{getExtendedPublicKey:$,randomPrivateKey:()=>o(t.BYTES),precompute(A=8,S=b.BASE){return S._setWindowSize(A),S.multiply(BigInt(3)),S}}}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const pl=BigInt("57896044618658097711785492504343953926634992332820282019728792003956564819949"),q1=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");BigInt(0);const Z5=BigInt(1),z1=BigInt(2);BigInt(3);const X5=BigInt(5),e8=BigInt(8);function t8(n){const e=BigInt(10),t=BigInt(20),r=BigInt(40),s=BigInt(80),i=pl,a=n*n%i*n%i,c=be(a,z1,i)*a%i,l=be(c,Z5,i)*n%i,u=be(l,X5,i)*l%i,h=be(u,e,i)*u%i,f=be(h,t,i)*h%i,g=be(f,r,i)*f%i,p=be(g,s,i)*g%i,m=be(p,s,i)*g%i,y=be(m,e,i)*u%i;return{pow_p_5_8:be(y,z1,i)*n%i,b2:a}}function r8(n){return n[0]&=248,n[31]&=127,n[31]|=64,n}function n8(n,e){const t=pl,r=he(e*e*e,t),s=he(r*r*e,t),i=t8(n*s).pow_p_5_8;let o=he(n*r*i,t);const a=he(e*o*o,t),c=o,l=he(o*q1,t),u=a===n,h=a===he(-n,t),f=a===he(-n*q1,t);return u&&(o=c),(h||f)&&(o=l),V5(o,t)&&(o=he(-o,t)),{isValid:u||h,value:o}}const K1=zs(pl,void 0,!0),s8={a:K1.create(BigInt(-1)),d:BigInt("37095705934669439343138083508754565189542113879843219016388785533085940283555"),Fp:K1,n:BigInt("7237005577332262213973186563042994240857116359379907606001950938285454250989"),h:e8,Gx:BigInt("15112221349535400772501151409588531511454012693041857206046113283949847762202"),Gy:BigInt("46316835694926478169428394003475163141307993866256225615783033603165251855960"),hash:sh,randomBytes:Co,adjustScalarBytes:r8,uvRatio:n8},ir=J5(s8),bh=32,wh=64,lc=32;function i8(){const n=ir.utils.randomPrivateKey(),e=ir.getPublicKey(n);return{privateKey:c8(n,e),publicKey:e}}function o8(n,e){const t=n.subarray(0,lc);return ir.sign(e instanceof Uint8Array?e:e.subarray(),t)}function a8(n,e,t){return ir.verify(e,t instanceof Uint8Array?t:t.subarray(),n)}function c8(n,e){const t=new Uint8Array(wh);for(let r=0;r<lc;r++)t[r]=n[r],t[lc+r]=e[r];return t}let vh=class{constructor(e){d(this,"type","Ed25519");d(this,"raw");this.raw=gl(e,bh)}toMultihash(){return It.digest(tr(this))}toCID(){return Z.createV1(114,this.toMultihash())}toString(){return fe.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:ie(this.raw,e.raw)}verify(e,t){return a8(this.raw,t,e)}},l8=class{constructor(e,t){d(this,"type","Ed25519");d(this,"raw");d(this,"publicKey");this.raw=gl(e,wh),this.publicKey=new vh(t)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:ie(this.raw,e.raw)}sign(e){return o8(this.raw,e)}};function Eh(n){return n=gl(n,bh),new vh(n)}async function u8(){const{privateKey:n,publicKey:e}=i8();return new l8(n,e)}function gl(n,e){if(n=Uint8Array.from(n??[]),n.length!==e)throw new G(`Key must be a Uint8Array of length ${e}, got ${n.length}`);return n}const d8=Math.pow(2,7),h8=Math.pow(2,14),f8=Math.pow(2,21),ml=Math.pow(2,28),yl=Math.pow(2,35),bl=Math.pow(2,42),wl=Math.pow(2,49),ne=128,He=127;function mt(n){if(n<d8)return 1;if(n<h8)return 2;if(n<f8)return 3;if(n<ml)return 4;if(n<yl)return 5;if(n<bl)return 6;if(n<wl)return 7;if(Number.MAX_SAFE_INTEGER!=null&&n>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function Sh(n,e,t=0){switch(mt(n)){case 8:e[t++]=n&255|ne,n/=128;case 7:e[t++]=n&255|ne,n/=128;case 6:e[t++]=n&255|ne,n/=128;case 5:e[t++]=n&255|ne,n/=128;case 4:e[t++]=n&255|ne,n>>>=7;case 3:e[t++]=n&255|ne,n>>>=7;case 2:e[t++]=n&255|ne,n>>>=7;case 1:{e[t++]=n&255,n>>>=7;break}default:throw new Error("unreachable")}return e}function p8(n,e,t=0){switch(mt(n)){case 8:e.set(t++,n&255|ne),n/=128;case 7:e.set(t++,n&255|ne),n/=128;case 6:e.set(t++,n&255|ne),n/=128;case 5:e.set(t++,n&255|ne),n/=128;case 4:e.set(t++,n&255|ne),n>>>=7;case 3:e.set(t++,n&255|ne),n>>>=7;case 2:e.set(t++,n&255|ne),n>>>=7;case 1:{e.set(t++,n&255),n>>>=7;break}default:throw new Error("unreachable")}return e}function _h(n,e){let t=n[e],r=0;if(r+=t&He,t<ne||(t=n[e+1],r+=(t&He)<<7,t<ne)||(t=n[e+2],r+=(t&He)<<14,t<ne)||(t=n[e+3],r+=(t&He)<<21,t<ne)||(t=n[e+4],r+=(t&He)*ml,t<ne)||(t=n[e+5],r+=(t&He)*yl,t<ne)||(t=n[e+6],r+=(t&He)*bl,t<ne)||(t=n[e+7],r+=(t&He)*wl,t<ne))return r;throw new RangeError("Could not decode varint")}function g8(n,e){let t=n.get(e),r=0;if(r+=t&He,t<ne||(t=n.get(e+1),r+=(t&He)<<7,t<ne)||(t=n.get(e+2),r+=(t&He)<<14,t<ne)||(t=n.get(e+3),r+=(t&He)<<21,t<ne)||(t=n.get(e+4),r+=(t&He)*ml,t<ne)||(t=n.get(e+5),r+=(t&He)*yl,t<ne)||(t=n.get(e+6),r+=(t&He)*bl,t<ne)||(t=n.get(e+7),r+=(t&He)*wl,t<ne))return r;throw new RangeError("Could not decode varint")}function Ct(n,e,t=0){return e==null&&(e=qt(mt(n))),e instanceof Uint8Array?Sh(n,e,t):p8(n,e,t)}function Pr(n,e=0){return n instanceof Uint8Array?_h(n,e):g8(n,e)}const vl=new Float32Array([-0]),wr=new Uint8Array(vl.buffer);function m8(n,e,t){vl[0]=n,e[t]=wr[0],e[t+1]=wr[1],e[t+2]=wr[2],e[t+3]=wr[3]}function y8(n,e){return wr[0]=n[e],wr[1]=n[e+1],wr[2]=n[e+2],wr[3]=n[e+3],vl[0]}const El=new Float64Array([-0]),qe=new Uint8Array(El.buffer);function b8(n,e,t){El[0]=n,e[t]=qe[0],e[t+1]=qe[1],e[t+2]=qe[2],e[t+3]=qe[3],e[t+4]=qe[4],e[t+5]=qe[5],e[t+6]=qe[6],e[t+7]=qe[7]}function w8(n,e){return qe[0]=n[e],qe[1]=n[e+1],qe[2]=n[e+2],qe[3]=n[e+3],qe[4]=n[e+4],qe[5]=n[e+5],qe[6]=n[e+6],qe[7]=n[e+7],El[0]}const v8=BigInt(Number.MAX_SAFE_INTEGER),E8=BigInt(Number.MIN_SAFE_INTEGER);class ze{constructor(e,t){d(this,"lo");d(this,"hi");this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){const t=~this.lo+1>>>0;let r=~this.hi>>>0;return t===0&&(r=r+1>>>0),-(t+r*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){const t=~this.lo+1>>>0;let r=~this.hi>>>0;return t===0&&(r=r+1>>>0),-(BigInt(t)+(BigInt(r)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){const e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){const e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){const e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,r=this.hi>>>24;return r===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:r<128?9:10}static fromBigInt(e){if(e===0n)return Fr;if(e<v8&&e>E8)return this.fromNumber(Number(e));const t=e<0n;t&&(e=-e);let r=e>>32n,s=e-(r<<32n);return t&&(r=~r|0n,s=~s|0n,++s>j1&&(s=0n,++r>j1&&(r=0n))),new ze(Number(s),Number(r))}static fromNumber(e){if(e===0)return Fr;const t=e<0;t&&(e=-e);let r=e>>>0,s=(e-r)/4294967296>>>0;return t&&(s=~s>>>0,r=~r>>>0,++r>4294967295&&(r=0,++s>4294967295&&(s=0))),new ze(r,s)}static from(e){return typeof e=="number"?ze.fromNumber(e):typeof e=="bigint"?ze.fromBigInt(e):typeof e=="string"?ze.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new ze(e.low>>>0,e.high>>>0):Fr}}const Fr=new ze(0,0);Fr.toBigInt=function(){return 0n};Fr.zzEncode=Fr.zzDecode=function(){return this};Fr.length=function(){return 1};const j1=4294967296n;function S8(n){let e=0,t=0;for(let r=0;r<n.length;++r)t=n.charCodeAt(r),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(n.charCodeAt(r+1)&64512)===56320?(++r,e+=4):e+=3;return e}function _8(n,e,t){if(t-e<1)return"";let s;const i=[];let o=0,a;for(;e<t;)a=n[e++],a<128?i[o++]=a:a>191&&a<224?i[o++]=(a&31)<<6|n[e++]&63:a>239&&a<365?(a=((a&7)<<18|(n[e++]&63)<<12|(n[e++]&63)<<6|n[e++]&63)-65536,i[o++]=55296+(a>>10),i[o++]=56320+(a&1023)):i[o++]=(a&15)<<12|(n[e++]&63)<<6|n[e++]&63,o>8191&&((s??(s=[])).push(String.fromCharCode.apply(String,i)),o=0);return s!=null?(o>0&&s.push(String.fromCharCode.apply(String,i.slice(0,o))),s.join("")):String.fromCharCode.apply(String,i.slice(0,o))}function xh(n,e,t){const r=t;let s,i;for(let o=0;o<n.length;++o)s=n.charCodeAt(o),s<128?e[t++]=s:s<2048?(e[t++]=s>>6|192,e[t++]=s&63|128):(s&64512)===55296&&((i=n.charCodeAt(o+1))&64512)===56320?(s=65536+((s&1023)<<10)+(i&1023),++o,e[t++]=s>>18|240,e[t++]=s>>12&63|128,e[t++]=s>>6&63|128,e[t++]=s&63|128):(e[t++]=s>>12|224,e[t++]=s>>6&63|128,e[t++]=s&63|128);return t-r}function xt(n,e){return RangeError(`index out of range: ${n.pos} + ${e??1} > ${n.len}`)}function ii(n,e){return(n[e-4]|n[e-3]<<8|n[e-2]<<16|n[e-1]<<24)>>>0}class x8{constructor(e){d(this,"buf");d(this,"pos");d(this,"len");d(this,"_slice",Uint8Array.prototype.subarray);this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,xt(this,10);return e}int32(){return this.uint32()|0}sint32(){const e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw xt(this,4);return ii(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw xt(this,4);return ii(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw xt(this,4);const e=y8(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw xt(this,4);const e=w8(this.buf,this.pos);return this.pos+=8,e}bytes(){const e=this.uint32(),t=this.pos,r=this.pos+e;if(r>this.len)throw xt(this,e);return this.pos+=e,t===r?new Uint8Array(0):this.buf.subarray(t,r)}string(){const e=this.bytes();return _8(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw xt(this,e);this.pos+=e}else do if(this.pos>=this.len)throw xt(this);while(this.buf[this.pos++]&128);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){const e=new ze(0,0);let t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw xt(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw xt(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw xt(this,8);const e=ii(this.buf,this.pos+=4),t=ii(this.buf,this.pos+=4);return new ze(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){const e=_h(this.buf,this.pos);return this.pos+=mt(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}}function k8(n){return new x8(n instanceof Uint8Array?n:n.subarray())}function Oe(n,e,t){const r=k8(n);return e.decode(r,void 0,t)}function C8(n){let r,s=8192;return function(o){if(o<1||o>4096)return qt(o);s+o>8192&&(r=qt(8192),s=0);const a=r.subarray(s,s+=o);return s&7&&(s=(s|7)+1),a}}class Qn{constructor(e,t,r){d(this,"fn");d(this,"len");d(this,"next");d(this,"val");this.fn=e,this.len=t,this.next=void 0,this.val=r}}function ua(){}class A8{constructor(e){d(this,"head");d(this,"tail");d(this,"len");d(this,"next");this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}}const I8=C8();function P8(n){return globalThis.Buffer!=null?qt(n):I8(n)}class uc{constructor(){d(this,"len");d(this,"head");d(this,"tail");d(this,"states");this.len=0,this.head=new Qn(ua,0,0),this.tail=this.head,this.states=null}_push(e,t,r){return this.tail=this.tail.next=new Qn(e,t,r),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new R8((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(oi,10,ze.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){const t=ze.fromBigInt(e);return this._push(oi,t.length(),t)}uint64Number(e){return this._push(Sh,mt(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){const t=ze.fromBigInt(e).zzEncode();return this._push(oi,t.length(),t)}sint64Number(e){const t=ze.fromNumber(e).zzEncode();return this._push(oi,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(da,1,e?1:0)}fixed32(e){return this._push(Gn,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){const t=ze.fromBigInt(e);return this._push(Gn,4,t.lo)._push(Gn,4,t.hi)}fixed64Number(e){const t=ze.fromNumber(e);return this._push(Gn,4,t.lo)._push(Gn,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(m8,4,e)}double(e){return this._push(b8,8,e)}bytes(e){const t=e.length>>>0;return t===0?this._push(da,1,0):this.uint32(t)._push(D8,t,e)}string(e){const t=S8(e);return t!==0?this.uint32(t)._push(xh,t,e):this._push(da,1,0)}fork(){return this.states=new A8(this),this.head=this.tail=new Qn(ua,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Qn(ua,0,0),this.len=0),this}ldelim(){const e=this.head,t=this.tail,r=this.len;return this.reset().uint32(r),r!==0&&(this.tail.next=e.next,this.tail=t,this.len+=r),this}finish(){let e=this.head.next;const t=P8(this.len);let r=0;for(;e!=null;)e.fn(e.val,t,r),r+=e.len,e=e.next;return t}}function da(n,e,t){e[t]=n&255}function T8(n,e,t){for(;n>127;)e[t++]=n&127|128,n>>>=7;e[t]=n}class R8 extends Qn{constructor(t,r){super(T8,t,r);d(this,"next");this.next=void 0}}function oi(n,e,t){for(;n.hi!==0;)e[t++]=n.lo&127|128,n.lo=(n.lo>>>7|n.hi<<25)>>>0,n.hi>>>=7;for(;n.lo>127;)e[t++]=n.lo&127|128,n.lo=n.lo>>>7;e[t++]=n.lo}function Gn(n,e,t){e[t]=n&255,e[t+1]=n>>>8&255,e[t+2]=n>>>16&255,e[t+3]=n>>>24}function D8(n,e,t){e.set(n,t)}globalThis.Buffer!=null&&(uc.prototype.bytes=function(n){const e=n.length>>>0;return this.uint32(e),e>0&&this._push(B8,e,n),this},uc.prototype.string=function(n){const e=globalThis.Buffer.byteLength(n);return this.uint32(e),e>0&&this._push(L8,e,n),this});function B8(n,e,t){e.set(n,t)}function L8(n,e,t){n.length<40?xh(n,e,t):e.utf8Write!=null?e.utf8Write(n,t):e.set(O(n),t)}function N8(){return new uc}function Me(n,e){const t=N8();return e.encode(n,t,{lengthDelimited:!1}),t.finish()}var Ji;(function(n){n[n.VARINT=0]="VARINT",n[n.BIT64=1]="BIT64",n[n.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",n[n.START_GROUP=3]="START_GROUP",n[n.END_GROUP=4]="END_GROUP",n[n.BIT32=5]="BIT32"})(Ji||(Ji={}));function kh(n,e,t,r){return{name:n,type:e,encode:t,decode:r}}function Io(n){function e(s){if(n[s.toString()]==null)throw new Error("Invalid enum value");return n[s]}const t=function(i,o){const a=e(i);o.int32(a)},r=function(i){const o=i.int32();return e(o)};return kh("enum",Ji.VARINT,t,r)}function Ue(n,e){return kh("message",Ji.LENGTH_DELIMITED,n,e)}class kr extends Error{constructor(){super(...arguments);d(this,"code","ERR_MAX_LENGTH");d(this,"name","MaxLengthError")}}class G1 extends Error{constructor(){super(...arguments);d(this,"code","ERR_MAX_SIZE");d(this,"name","MaxSizeError")}}var Be;(function(n){n.RSA="RSA",n.Ed25519="Ed25519",n.secp256k1="secp256k1",n.ECDSA="ECDSA"})(Be||(Be={}));var dc;(function(n){n[n.RSA=0]="RSA",n[n.Ed25519=1]="Ed25519",n[n.secp256k1=2]="secp256k1",n[n.ECDSA=3]="ECDSA"})(dc||(dc={}));(function(n){n.codec=()=>Io(dc)})(Be||(Be={}));var kn;(function(n){let e;n.codec=()=>(e==null&&(e=Ue((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.Type!=null&&(r.uint32(8),Be.codec().encode(t.Type,r)),t.Data!=null&&(r.uint32(18),r.bytes(t.Data)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=Be.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),n.encode=t=>Me(t,n.codec()),n.decode=(t,r)=>Oe(t,n.codec(),r)})(kn||(kn={}));var W1;(function(n){let e;n.codec=()=>(e==null&&(e=Ue((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.Type!=null&&(r.uint32(8),Be.codec().encode(t.Type,r)),t.Data!=null&&(r.uint32(18),r.bytes(t.Data)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=Be.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),n.encode=t=>Me(t,n.codec()),n.decode=(t,r)=>Oe(t,n.codec(),r)})(W1||(W1={}));function Po(n){if(isNaN(n)||n<=0)throw new G("random bytes length must be a Number bigger than 0");return Co(n)}class Q1 extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}}class O8 extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}}const Y1={get(n=globalThis){const e=n.crypto;if((e==null?void 0:e.subtle)==null)throw new O8("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}},M8=nh;class U8{constructor(e,t){d(this,"type","RSA");d(this,"jwk");d(this,"_raw");d(this,"_multihash");this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=q8(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return Z.createV1(114,this._multihash)}toString(){return fe.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:ie(this.raw,e.raw)}verify(e,t){return j8(this.jwk,t,e)}}const F8=18,$8=1062,V8=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function H8(n){const e=ko(n[1],{offset:0});return{kty:"RSA",n:M(e[0],"base64url"),e:M(e[1],"base64url")}}function q8(n){if(n.n==null||n.e==null)throw new G("JWK was missing components");return Jn([V8,Q2(Jn([ic(O(n.n,"base64url")),ic(O(n.e,"base64url"))]))]).subarray()}function z8(n,e){if(n.byteLength>=$8)throw new hs("Key size is too large");const t=ko(n,{offset:0});return K8(t,n,e)}function K8(n,e,t){const r=H8(n);if(t==null){const s=M8(kn.encode({Type:Be.RSA,Data:e}));t=Vr(F8,s)}return new U8(r,t)}async function j8(n,e,t){const r=await Y1.get().subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return Y1.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},r,e,t instanceof Uint8Array?t:t.subarray())}class Ch extends X2{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,J2(e);const r=cl(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,i=new Uint8Array(s);i.set(r.length>s?e.create().update(r).digest():r);for(let o=0;o<i.length;o++)i[o]^=54;this.iHash.update(i),this.oHash=e.create();for(let o=0;o<i.length;o++)i[o]^=106;this.oHash.update(i),Hr(i)}update(e){return Gi(this),this.iHash.update(e),this}digestInto(e){Gi(this),On(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:r,finished:s,destroyed:i,blockLen:o,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=i,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=r._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const Sl=(n,e,t)=>new Ch(n,e).update(t).digest();Sl.create=(n,e)=>new Ch(n,e);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function J1(n){n.lowS!==void 0&&vr("lowS",n.lowS),n.prehash!==void 0&&vr("prehash",n.prehash)}function G8(n){const e=fl(n);qs(e,{a:"field",b:"field"},{allowInfinityPoint:"boolean",allowedPrivateKeyLengths:"array",clearCofactor:"function",fromBytes:"function",isTorsionFree:"function",toBytes:"function",wrapPrivateKey:"boolean"});const{endo:t,Fp:r,a:s}=e;if(t){if(!r.eql(s,r.ZERO))throw new Error("invalid endo: CURVE.a must be 0");if(typeof t!="object"||typeof t.beta!="bigint"||typeof t.splitScalar!="function")throw new Error('invalid endo: expected "beta": bigint and "splitScalar": function')}return Object.freeze({...e})}class W8 extends Error{constructor(e=""){super(e)}}const Jt={Err:W8,_tlv:{encode:(n,e)=>{const{Err:t}=Jt;if(n<0||n>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");const r=e.length/2,s=si(r);if(s.length/2&128)throw new t("tlv.encode: long form length too big");const i=r>127?si(s.length/2|128):"";return si(n)+i+s+e},decode(n,e){const{Err:t}=Jt;let r=0;if(n<0||n>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[r++]!==n)throw new t("tlv.decode: wrong tlv");const s=e[r++],i=!!(s&128);let o=0;if(!i)o=s;else{const c=s&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");const l=e.subarray(r,r+c);if(l.length!==c)throw new t("tlv.decode: length bytes not complete");if(l[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(const u of l)o=o<<8|u;if(r+=c,o<128)throw new t("tlv.decode(long): not minimal encoding")}const a=e.subarray(r,r+o);if(a.length!==o)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(r+o)}}},_int:{encode(n){const{Err:e}=Jt;if(n<Xt)throw new e("integer: negative integers are not allowed");let t=si(n);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(n){const{Err:e}=Jt;if(n[0]&128)throw new e("invalid signature integer: negative");if(n[0]===0&&!(n[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return Ur(n)}},toSig(n){const{Err:e,_int:t,_tlv:r}=Jt,s=Se("signature",n),{v:i,l:o}=r.decode(48,s);if(o.length)throw new e("invalid signature: left bytes after parsing");const{v:a,l:c}=r.decode(2,i),{v:l,l:u}=r.decode(2,c);if(u.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(l)}},hexFromSig(n){const{_tlv:e,_int:t}=Jt,r=e.encode(2,t.encode(n.r)),s=e.encode(2,t.encode(n.s)),i=r+s;return e.encode(48,i)}};function ha(n,e){return _n(Hs(n,e))}const Xt=BigInt(0),Ae=BigInt(1);BigInt(2);const fa=BigInt(3),Q8=BigInt(4);function Y8(n){const e=G8(n),{Fp:t}=e,r=zs(e.n,e.nBitLength),s=e.toBytes||((w,b,v)=>{const x=b.toAffine();return xn(Uint8Array.from([4]),t.toBytes(x.x),t.toBytes(x.y))}),i=e.fromBytes||(w=>{const b=w.subarray(1),v=t.fromBytes(b.subarray(0,t.BYTES)),x=t.fromBytes(b.subarray(t.BYTES,2*t.BYTES));return{x:v,y:x}});function o(w){const{a:b,b:v}=e,x=t.sqr(w),C=t.mul(x,w);return t.add(t.add(C,t.mul(w,b)),v)}function a(w,b){const v=t.sqr(b),x=o(w);return t.eql(v,x)}if(!a(e.Gx,e.Gy))throw new Error("bad curve params: generator point");const c=t.mul(t.pow(e.a,fa),Q8),l=t.mul(t.sqr(e.b),BigInt(27));if(t.is0(t.add(c,l)))throw new Error("bad curve params: a or b");function u(w){return dl(w,Ae,e.n)}function h(w){const{allowedPrivateKeyLengths:b,nByteLength:v,wrapPrivateKey:x,n:C}=e;if(b&&typeof w!="bigint"){if(Vs(w)&&(w=_n(w)),typeof w!="string"||!b.includes(w.length))throw new Error("invalid private key");w=w.padStart(v*2,"0")}let R;try{R=typeof w=="bigint"?w:Ur(Se("private key",w,v))}catch{throw new Error("invalid private key, expected hex or "+v+" bytes, got "+typeof w)}return x&&(R=he(R,C)),kt("private key",R,Ae,C),R}function f(w){if(!(w instanceof m))throw new Error("ProjectivePoint expected")}const g=Yi((w,b)=>{const{px:v,py:x,pz:C}=w;if(t.eql(C,t.ONE))return{x:v,y:x};const R=w.is0();b==null&&(b=R?t.ONE:t.inv(C));const F=t.mul(v,b),j=t.mul(x,b),$=t.mul(C,b);if(R)return{x:t.ZERO,y:t.ZERO};if(!t.eql($,t.ONE))throw new Error("invZ was invalid");return{x:F,y:j}}),p=Yi(w=>{if(w.is0()){if(e.allowInfinityPoint&&!t.is0(w.py))return;throw new Error("bad point: ZERO")}const{x:b,y:v}=w.toAffine();if(!t.isValid(b)||!t.isValid(v))throw new Error("bad point: x or y not FE");if(!a(b,v))throw new Error("bad point: equation left != right");if(!w.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});class m{constructor(b,v,x){if(b==null||!t.isValid(b))throw new Error("x required");if(v==null||!t.isValid(v)||t.is0(v))throw new Error("y required");if(x==null||!t.isValid(x))throw new Error("z required");this.px=b,this.py=v,this.pz=x,Object.freeze(this)}static fromAffine(b){const{x:v,y:x}=b||{};if(!b||!t.isValid(v)||!t.isValid(x))throw new Error("invalid affine point");if(b instanceof m)throw new Error("projective point not allowed");const C=R=>t.eql(R,t.ZERO);return C(v)&&C(x)?m.ZERO:new m(v,x,t.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(b){const v=hl(t,b.map(x=>x.pz));return b.map((x,C)=>x.toAffine(v[C])).map(m.fromAffine)}static fromHex(b){const v=m.fromAffine(i(Se("pointHex",b)));return v.assertValidity(),v}static fromPrivateKey(b){return m.BASE.multiply(h(b))}static msm(b,v){return yh(m,r,b,v)}_setWindowSize(b){_.setWindowSize(this,b)}assertValidity(){p(this)}hasEvenY(){const{y:b}=this.toAffine();if(t.isOdd)return!t.isOdd(b);throw new Error("Field doesn't support isOdd")}equals(b){f(b);const{px:v,py:x,pz:C}=this,{px:R,py:F,pz:j}=b,$=t.eql(t.mul(v,j),t.mul(R,C)),z=t.eql(t.mul(x,j),t.mul(F,C));return $&&z}negate(){return new m(this.px,t.neg(this.py),this.pz)}double(){const{a:b,b:v}=e,x=t.mul(v,fa),{px:C,py:R,pz:F}=this;let j=t.ZERO,$=t.ZERO,z=t.ZERO,H=t.mul(C,C),_e=t.mul(R,R),P=t.mul(F,F),I=t.mul(C,R);return I=t.add(I,I),z=t.mul(C,F),z=t.add(z,z),j=t.mul(b,z),$=t.mul(x,P),$=t.add(j,$),j=t.sub(_e,$),$=t.add(_e,$),$=t.mul(j,$),j=t.mul(I,j),z=t.mul(x,z),P=t.mul(b,P),I=t.sub(H,P),I=t.mul(b,I),I=t.add(I,z),z=t.add(H,H),H=t.add(z,H),H=t.add(H,P),H=t.mul(H,I),$=t.add($,H),P=t.mul(R,F),P=t.add(P,P),H=t.mul(P,I),j=t.sub(j,H),z=t.mul(P,_e),z=t.add(z,z),z=t.add(z,z),new m(j,$,z)}add(b){f(b);const{px:v,py:x,pz:C}=this,{px:R,py:F,pz:j}=b;let $=t.ZERO,z=t.ZERO,H=t.ZERO;const _e=e.a,P=t.mul(e.b,fa);let I=t.mul(v,R),U=t.mul(x,F),A=t.mul(C,j),S=t.add(v,x),k=t.add(R,F);S=t.mul(S,k),k=t.add(I,U),S=t.sub(S,k),k=t.add(v,C);let T=t.add(R,j);return k=t.mul(k,T),T=t.add(I,A),k=t.sub(k,T),T=t.add(x,C),$=t.add(F,j),T=t.mul(T,$),$=t.add(U,A),T=t.sub(T,$),H=t.mul(_e,k),$=t.mul(P,A),H=t.add($,H),$=t.sub(U,H),H=t.add(U,H),z=t.mul($,H),U=t.add(I,I),U=t.add(U,I),A=t.mul(_e,A),k=t.mul(P,k),U=t.add(U,A),A=t.sub(I,A),A=t.mul(_e,A),k=t.add(k,A),I=t.mul(U,k),z=t.add(z,I),I=t.mul(T,k),$=t.mul(S,$),$=t.sub($,I),I=t.mul(S,U),H=t.mul(T,H),H=t.add(H,I),new m($,z,H)}subtract(b){return this.add(b.negate())}is0(){return this.equals(m.ZERO)}wNAF(b){return _.wNAFCached(this,b,m.normalizeZ)}multiplyUnsafe(b){const{endo:v,n:x}=e;kt("scalar",b,Xt,x);const C=m.ZERO;if(b===Xt)return C;if(this.is0()||b===Ae)return this;if(!v||_.hasPrecomputes(this))return _.wNAFCachedUnsafe(this,b,m.normalizeZ);let{k1neg:R,k1:F,k2neg:j,k2:$}=v.splitScalar(b),z=C,H=C,_e=this;for(;F>Xt||$>Xt;)F&Ae&&(z=z.add(_e)),$&Ae&&(H=H.add(_e)),_e=_e.double(),F>>=Ae,$>>=Ae;return R&&(z=z.negate()),j&&(H=H.negate()),H=new m(t.mul(H.px,v.beta),H.py,H.pz),z.add(H)}multiply(b){const{endo:v,n:x}=e;kt("scalar",b,Ae,x);let C,R;if(v){const{k1neg:F,k1:j,k2neg:$,k2:z}=v.splitScalar(b);let{p:H,f:_e}=this.wNAF(j),{p:P,f:I}=this.wNAF(z);H=_.constTimeNegate(F,H),P=_.constTimeNegate($,P),P=new m(t.mul(P.px,v.beta),P.py,P.pz),C=H.add(P),R=_e.add(I)}else{const{p:F,f:j}=this.wNAF(b);C=F,R=j}return m.normalizeZ([C,R])[0]}multiplyAndAddUnsafe(b,v,x){const C=m.BASE,R=(j,$)=>$===Xt||$===Ae||!j.equals(C)?j.multiplyUnsafe($):j.multiply($),F=R(this,v).add(R(b,x));return F.is0()?void 0:F}toAffine(b){return g(this,b)}isTorsionFree(){const{h:b,isTorsionFree:v}=e;if(b===Ae)return!0;if(v)return v(m,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h:b,clearCofactor:v}=e;return b===Ae?this:v?v(m,this):this.multiplyUnsafe(e.h)}toRawBytes(b=!0){return vr("isCompressed",b),this.assertValidity(),s(m,this,b)}toHex(b=!0){return vr("isCompressed",b),_n(this.toRawBytes(b))}}m.BASE=new m(e.Gx,e.Gy,t.ONE),m.ZERO=new m(t.ZERO,t.ONE,t.ZERO);const{endo:y,nBitLength:E}=e,_=mh(m,y?Math.ceil(E/2):E);return{CURVE:e,ProjectivePoint:m,normPrivateKeyToScalar:h,weierstrassEquation:o,isWithinCurveOrder:u}}function J8(n){const e=fl(n);return qs(e,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...e})}function Z8(n){const e=J8(n),{Fp:t,n:r,nByteLength:s,nBitLength:i}=e,o=t.BYTES+1,a=2*t.BYTES+1;function c(P){return he(P,r)}function l(P){return ac(P,r)}const{ProjectivePoint:u,normPrivateKeyToScalar:h,weierstrassEquation:f,isWithinCurveOrder:g}=Y8({...e,toBytes(P,I,U){const A=I.toAffine(),S=t.toBytes(A.x),k=xn;return vr("isCompressed",U),U?k(Uint8Array.from([I.hasEvenY()?2:3]),S):k(Uint8Array.from([4]),S,t.toBytes(A.y))},fromBytes(P){const I=P.length,U=P[0],A=P.subarray(1);if(I===o&&(U===2||U===3)){const S=Ur(A);if(!dl(S,Ae,t.ORDER))throw new Error("Point is not on curve");const k=f(S);let T;try{T=t.sqrt(k)}catch(W){const Y=W instanceof Error?": "+W.message:"";throw new Error("Point is not on curve"+Y)}const V=(T&Ae)===Ae;return(U&1)===1!==V&&(T=t.neg(T)),{x:S,y:T}}else if(I===a&&U===4){const S=t.fromBytes(A.subarray(0,t.BYTES)),k=t.fromBytes(A.subarray(t.BYTES,2*t.BYTES));return{x:S,y:k}}else{const S=o,k=a;throw new Error("invalid Point, expected length of "+S+", or uncompressed "+k+", got "+I)}}});function p(P){const I=r>>Ae;return P>I}function m(P){return p(P)?c(-P):P}const y=(P,I,U)=>Ur(P.slice(I,U));class E{constructor(I,U,A){kt("r",I,Ae,r),kt("s",U,Ae,r),this.r=I,this.s=U,A!=null&&(this.recovery=A),Object.freeze(this)}static fromCompact(I){const U=s;return I=Se("compactSignature",I,U*2),new E(y(I,0,U),y(I,U,2*U))}static fromDER(I){const{r:U,s:A}=Jt.toSig(Se("DER",I));return new E(U,A)}assertValidity(){}addRecoveryBit(I){return new E(this.r,this.s,I)}recoverPublicKey(I){const{r:U,s:A,recovery:S}=this,k=C(Se("msgHash",I));if(S==null||![0,1,2,3].includes(S))throw new Error("recovery id invalid");const T=S===2||S===3?U+e.n:U;if(T>=t.ORDER)throw new Error("recovery id 2 or 3 invalid");const V=S&1?"03":"02",K=u.fromHex(V+ha(T,t.BYTES)),W=l(T),Y=c(-k*W),ee=c(A*W),ae=u.BASE.multiplyAndAddUnsafe(K,Y,ee);if(!ae)throw new Error("point at infinify");return ae.assertValidity(),ae}hasHighS(){return p(this.s)}normalizeS(){return this.hasHighS()?new E(this.r,c(-this.s),this.recovery):this}toDERRawBytes(){return Wi(this.toDERHex())}toDERHex(){return Jt.hexFromSig(this)}toCompactRawBytes(){return Wi(this.toCompactHex())}toCompactHex(){const I=s;return ha(this.r,I)+ha(this.s,I)}}const _={isValidPrivateKey(P){try{return h(P),!0}catch{return!1}},normPrivateKeyToScalar:h,randomPrivateKey:()=>{const P=fh(e.n);return K5(e.randomBytes(P),e.n)},precompute(P=8,I=u.BASE){return I._setWindowSize(P),I.multiply(BigInt(3)),I}};function w(P,I=!0){return u.fromPrivateKey(P).toRawBytes(I)}function b(P){if(typeof P=="bigint")return!1;if(P instanceof u)return!0;const U=Se("key",P).length,A=t.BYTES,S=A+1,k=2*A+1;if(!(e.allowedPrivateKeyLengths||s===S))return U===S||U===k}function v(P,I,U=!0){if(b(P)===!0)throw new Error("first arg must be private key");if(b(I)===!1)throw new Error("second arg must be public key");return u.fromHex(I).multiply(h(P)).toRawBytes(U)}const x=e.bits2int||function(P){if(P.length>8192)throw new Error("input is too large");const I=Ur(P),U=P.length*8-i;return U>0?I>>BigInt(U):I},C=e.bits2int_modN||function(P){return c(x(P))},R=Ao(i);function F(P){return kt("num < 2^"+i,P,Xt,R),Hs(P,s)}function j(P,I,U=$){if(["recovered","canonical"].some(Ee=>Ee in U))throw new Error("sign() legacy options not supported");const{hash:A,randomBytes:S}=e;let{lowS:k,prehash:T,extraEntropy:V}=U;k==null&&(k=!0),P=Se("msgHash",P),J1(U),T&&(P=Se("prehashed msgHash",A(P)));const K=C(P),W=h(I),Y=[F(W),F(K)];if(V!=null&&V!==!1){const Ee=V===!0?S(t.BYTES):V;Y.push(Se("extraEntropy",Ee))}const ee=xn(...Y),ae=K;function xe(Ee){const Te=x(Ee);if(!g(Te))return;const rt=l(Te),Ce=u.BASE.multiply(Te).toAffine(),$e=c(Ce.x);if($e===Xt)return;const ut=c(rt*c(ae+$e*W));if(ut===Xt)return;let Dt=(Ce.x===$e?0:2)|Number(Ce.y&Ae),Kt=ut;return k&&p(ut)&&(Kt=m(ut),Dt^=1),new E($e,Kt,Dt)}return{seed:ee,k2sig:xe}}const $={lowS:e.lowS,prehash:!1},z={lowS:e.lowS,prehash:!1};function H(P,I,U=$){const{seed:A,k2sig:S}=j(P,I,U),k=e;return N5(k.hash.outputLen,k.nByteLength,k.hmac)(A,S)}u.BASE._setWindowSize(8);function _e(P,I,U,A=z){var Dt;const S=P;I=Se("msgHash",I),U=Se("publicKey",U);const{lowS:k,prehash:T,format:V}=A;if(J1(A),"strict"in A)throw new Error("options.strict was renamed to lowS");if(V!==void 0&&V!=="compact"&&V!=="der")throw new Error("format must be compact or der");const K=typeof S=="string"||Vs(S),W=!K&&!V&&typeof S=="object"&&S!==null&&typeof S.r=="bigint"&&typeof S.s=="bigint";if(!K&&!W)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");let Y,ee;try{if(W&&(Y=new E(S.r,S.s)),K){try{V!=="compact"&&(Y=E.fromDER(S))}catch(Kt){if(!(Kt instanceof Jt.Err))throw Kt}!Y&&V!=="der"&&(Y=E.fromCompact(S))}ee=u.fromHex(U)}catch{return!1}if(!Y||k&&Y.hasHighS())return!1;T&&(I=e.hash(I));const{r:ae,s:xe}=Y,Ee=C(I),Te=l(xe),rt=c(Ee*Te),Ce=c(ae*Te),$e=(Dt=u.BASE.multiplyAndAddUnsafe(ee,rt,Ce))==null?void 0:Dt.toAffine();return $e?c($e.x)===ae:!1}return{CURVE:e,getPublicKey:w,getSharedSecret:v,sign:H,verify:_e,ProjectivePoint:u,Signature:E,utils:_}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function X8(n){return{hash:n,hmac:(e,...t)=>Sl(n,e,g5(...t)),randomBytes:Co}}function e7(n,e){const t=r=>Z8({...n,...X8(r)});return{...t(e),create:t}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Ah=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),Z1=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),t7=BigInt(0),r7=BigInt(1),hc=BigInt(2),X1=(n,e)=>(n+e/hc)/e;function n7(n){const e=Ah,t=BigInt(3),r=BigInt(6),s=BigInt(11),i=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),l=n*n*n%e,u=l*l*n%e,h=be(u,t,e)*u%e,f=be(h,t,e)*u%e,g=be(f,hc,e)*l%e,p=be(g,s,e)*g%e,m=be(p,i,e)*p%e,y=be(m,a,e)*m%e,E=be(y,c,e)*y%e,_=be(E,a,e)*m%e,w=be(_,t,e)*u%e,b=be(w,o,e)*p%e,v=be(b,r,e)*l%e,x=be(v,hc,e);if(!fc.eql(fc.sqr(x),n))throw new Error("Cannot find square root");return x}const fc=zs(Ah,void 0,void 0,{sqrt:n7}),gt=e7({a:t7,b:BigInt(7),Fp:fc,n:Z1,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:n=>{const e=Z1,t=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),r=-r7*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),s=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),i=t,o=BigInt("0x100000000000000000000000000000000"),a=X1(i*n,e),c=X1(-r*n,e);let l=he(n-a*t-c*s,e),u=he(-a*r-c*i,e);const h=l>o,f=u>o;if(h&&(l=e-l),f&&(u=e-u),l>o||u>o)throw new Error("splitScalar: Endomorphism failed, k="+n);return{k1neg:h,k1:l,k2neg:f,k2:u}}}},nh);function s7(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}function i7(n,e,t){const r=tt.digest(t instanceof Uint8Array?t:t.subarray());if(s7(r))return r.then(({digest:s})=>gt.verify(e,s,n)).catch(s=>{throw new Q1(String(s))});try{return gt.verify(e,r.digest,n)}catch(s){throw new Q1(String(s))}}let o7=class{constructor(e){d(this,"type","secp256k1");d(this,"raw");d(this,"_key");this._key=c7(e),this.raw=a7(this._key)}toMultihash(){return It.digest(tr(this))}toCID(){return Z.createV1(114,this.toMultihash())}toString(){return fe.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:ie(this.raw,e.raw)}verify(e,t){return i7(this._key,t,e)}};function Ih(n){return new o7(n)}function a7(n){return gt.ProjectivePoint.fromHex(n).toRawBytes(!0)}function c7(n){try{return gt.ProjectivePoint.fromHex(n),n}catch(e){throw new hs(String(e))}}async function l7(n,e){return u8()}function Zr(n,e){const{Type:t,Data:r}=kn.decode(n),s=r??new Uint8Array;switch(t){case Be.RSA:return z8(s,e);case Be.Ed25519:return Eh(s);case Be.secp256k1:return Ih(s);case Be.ECDSA:return Y2(s);default:throw new So}}function u7(n){const{Type:e,Data:t}=kn.decode(n.digest),r=t??new Uint8Array;switch(e){case Be.Ed25519:return Eh(r);case Be.secp256k1:return Ih(r);case Be.ECDSA:return Y2(r);default:throw new So}}function tr(n){return kn.encode({Type:Be[n.type],Data:n.raw})}const Ph=Symbol.for("nodejs.util.inspect.custom"),d7=114;var hd;let _l=class{constructor(e){d(this,"type");d(this,"multihash");d(this,"publicKey");d(this,"string");d(this,hd,!0);this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}toString(){return this.string==null&&(this.string=fe.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return Z.createV1(d7,this.multihash)}toJSON(){return this.toString()}equals(e){var t;if(e==null)return!1;if(e instanceof Uint8Array)return ie(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(((t=e==null?void 0:e.toMultihash())==null?void 0:t.bytes)!=null)return ie(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[(hd=Zc,Ph)](){return`PeerId(${this.toString()})`}};class Th extends _l{constructor(t){super({...t,type:"RSA"});d(this,"type","RSA");d(this,"publicKey");this.publicKey=t.publicKey}}class Rh extends _l{constructor(t){super({...t,type:"Ed25519"});d(this,"type","Ed25519");d(this,"publicKey");this.publicKey=t.publicKey}}class Dh extends _l{constructor(t){super({...t,type:"secp256k1"});d(this,"type","secp256k1");d(this,"publicKey");this.publicKey=t.publicKey}}const h7=2336;var fd,pd;class Bh{constructor(e){d(this,"type","url");d(this,"multihash");d(this,"publicKey");d(this,"url");d(this,fd,!0);this.url=e.toString(),this.multihash=It.digest(O(this.url))}[(pd=Ph,fd=Zc,pd)](){return`PeerId(${this.url})`}toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return Z.createV1(h7,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=M(e)),e.toString()===this.toString())}}const f7=114,eu=2336;function qr(n,e){let t;if(n.charAt(0)==="1"||n.charAt(0)==="Q")t=ct(fe.decode(`z${n}`));else{if(n.startsWith("k51qzi5uqu5")||n.startsWith("kzwfwjn5ji4")||n.startsWith("k2k4r8")||n.startsWith("bafz"))return Ks(Z.parse(n));throw new G('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return or(t)}function To(n){if(n.type==="Ed25519")return new Rh({multihash:n.toCID().multihash,publicKey:n});if(n.type==="secp256k1")return new Dh({multihash:n.toCID().multihash,publicKey:n});if(n.type==="RSA")return new Th({multihash:n.toCID().multihash,publicKey:n});throw new So}function p7(n){return To(n.publicKey)}function or(n){if(m7(n))return new Th({multihash:n});if(g7(n))try{const e=u7(n);if(e.type==="Ed25519")return new Rh({multihash:n,publicKey:e});if(e.type==="secp256k1")return new Dh({multihash:n,publicKey:e})}catch{const t=M(n.digest);return new Bh(new URL(t))}throw new N2("Supplied PeerID Multihash is invalid")}function Ks(n){if((n==null?void 0:n.multihash)==null||n.version==null||n.version===1&&n.code!==f7&&n.code!==eu)throw new L2("Supplied PeerID CID is invalid");if(n.code===eu){const e=M(n.multihash.digest);return new Bh(new URL(e))}return or(n.multihash)}function g7(n){return n.code===It.code}function m7(n){return n.code===tt.code}class ft extends Event{constructor(t,r){super(t);d(this,"type");d(this,"detail");this.type=t,this.detail=r}}var Lh={exports:{}};(function(n){var e=Object.prototype.hasOwnProperty,t="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(t=!1));function s(c,l,u){this.fn=c,this.context=l,this.once=u||!1}function i(c,l,u,h,f){if(typeof u!="function")throw new TypeError("The listener must be a function");var g=new s(u,h||c,f),p=t?t+l:l;return c._events[p]?c._events[p].fn?c._events[p]=[c._events[p],g]:c._events[p].push(g):(c._events[p]=g,c._eventsCount++),c}function o(c,l){--c._eventsCount===0?c._events=new r:delete c._events[l]}function a(){this._events=new r,this._eventsCount=0}a.prototype.eventNames=function(){var l=[],u,h;if(this._eventsCount===0)return l;for(h in u=this._events)e.call(u,h)&&l.push(t?h.slice(1):h);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(u)):l},a.prototype.listeners=function(l){var u=t?t+l:l,h=this._events[u];if(!h)return[];if(h.fn)return[h.fn];for(var f=0,g=h.length,p=new Array(g);f<g;f++)p[f]=h[f].fn;return p},a.prototype.listenerCount=function(l){var u=t?t+l:l,h=this._events[u];return h?h.fn?1:h.length:0},a.prototype.emit=function(l,u,h,f,g,p){var m=t?t+l:l;if(!this._events[m])return!1;var y=this._events[m],E=arguments.length,_,w;if(y.fn){switch(y.once&&this.removeListener(l,y.fn,void 0,!0),E){case 1:return y.fn.call(y.context),!0;case 2:return y.fn.call(y.context,u),!0;case 3:return y.fn.call(y.context,u,h),!0;case 4:return y.fn.call(y.context,u,h,f),!0;case 5:return y.fn.call(y.context,u,h,f,g),!0;case 6:return y.fn.call(y.context,u,h,f,g,p),!0}for(w=1,_=new Array(E-1);w<E;w++)_[w-1]=arguments[w];y.fn.apply(y.context,_)}else{var b=y.length,v;for(w=0;w<b;w++)switch(y[w].once&&this.removeListener(l,y[w].fn,void 0,!0),E){case 1:y[w].fn.call(y[w].context);break;case 2:y[w].fn.call(y[w].context,u);break;case 3:y[w].fn.call(y[w].context,u,h);break;case 4:y[w].fn.call(y[w].context,u,h,f);break;default:if(!_)for(v=1,_=new Array(E-1);v<E;v++)_[v-1]=arguments[v];y[w].fn.apply(y[w].context,_)}}return!0},a.prototype.on=function(l,u,h){return i(this,l,u,h,!1)},a.prototype.once=function(l,u,h){return i(this,l,u,h,!0)},a.prototype.removeListener=function(l,u,h,f){var g=t?t+l:l;if(!this._events[g])return this;if(!u)return o(this,g),this;var p=this._events[g];if(p.fn)p.fn===u&&(!f||p.once)&&(!h||p.context===h)&&o(this,g);else{for(var m=0,y=[],E=p.length;m<E;m++)(p[m].fn!==u||f&&!p[m].once||h&&p[m].context!==h)&&y.push(p[m]);y.length?this._events[g]=y.length===1?y[0]:y:o(this,g)}return this},a.prototype.removeAllListeners=function(l){var u;return l?(u=t?t+l:l,this._events[u]&&o(this,u)):(this._events=new r,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=t,a.EventEmitter=a,n.exports=a})(Lh);var y7=Lh.exports;const b7=Us(y7);class Nh extends Error{constructor(e){super(e),this.name="TimeoutError"}}let w7=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const tu=n=>globalThis.DOMException===void 0?new w7(n):new DOMException(n),ru=n=>{const e=n.reason===void 0?tu("This operation was aborted."):n.reason;return e instanceof Error?e:tu(e)};function xl(n,e){const{milliseconds:t,fallback:r,message:s,customTimers:i={setTimeout,clearTimeout}}=e;let o,a;const l=new Promise((u,h)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){const{signal:g}=e;g.aborted&&h(ru(g)),a=()=>{h(ru(g))},g.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){n.then(u,h);return}const f=new Nh;o=i.setTimeout.call(void 0,()=>{if(r){try{u(r())}catch(g){h(g)}return}typeof n.cancel=="function"&&n.cancel(),s===!1?u():s instanceof Error?h(s):(f.message=s??`Promise timed out after ${t} milliseconds`,h(f))},t),(async()=>{try{u(await n)}catch(g){h(g)}})()}).finally(()=>{l.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return l.clear=()=>{i.clearTimeout.call(void 0,o),o=void 0},l}function v7(n,e,t){let r=0,s=n.length;for(;s>0;){const i=Math.trunc(s/2);let o=r+i;t(n[o],e)<=0?(r=++o,s-=i+1):s=i}return r}var bt,gd;let E7=(gd=class{constructor(){re(this,bt,[])}enqueue(e,t){t={priority:0,...t};const r={priority:t.priority,id:t.id,run:e};if(this.size===0||D(this,bt)[this.size-1].priority>=t.priority){D(this,bt).push(r);return}const s=v7(D(this,bt),r,(i,o)=>o.priority-i.priority);D(this,bt).splice(s,0,r)}setPriority(e,t){const r=D(this,bt).findIndex(i=>i.id===e);if(r===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);const[s]=D(this,bt).splice(r,1);this.enqueue(s.run,{priority:t,id:e})}dequeue(){const e=D(this,bt).shift();return e==null?void 0:e.run}filter(e){return D(this,bt).filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return D(this,bt).length}},bt=new WeakMap,gd);var pn,gn,yr,Rs,mn,Ds,wt,yn,Ye,Bs,vt,bn,Zt,Ls,wo,X,Oh,Mh,Uh,Fh,$h,Ii,gc,mc,Pi,Vh,Ti;class pc extends b7{constructor(t){var r,s;super();re(this,X);re(this,pn);re(this,gn);re(this,yr,0);re(this,Rs);re(this,mn);re(this,Ds,0);re(this,wt);re(this,yn);re(this,Ye);re(this,Bs);re(this,vt,0);re(this,bn);re(this,Zt);re(this,Ls);re(this,wo,1n);d(this,"timeout");if(t={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:E7,...t},!(typeof t.intervalCap=="number"&&t.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${((r=t.intervalCap)==null?void 0:r.toString())??""}\` (${typeof t.intervalCap})`);if(t.interval===void 0||!(Number.isFinite(t.interval)&&t.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${((s=t.interval)==null?void 0:s.toString())??""}\` (${typeof t.interval})`);de(this,pn,t.carryoverConcurrencyCount),de(this,gn,t.intervalCap===Number.POSITIVE_INFINITY||t.interval===0),de(this,Rs,t.intervalCap),de(this,mn,t.interval),de(this,Ye,new t.queueClass),de(this,Bs,t.queueClass),this.concurrency=t.concurrency,this.timeout=t.timeout,de(this,Ls,t.throwOnTimeout===!0),de(this,Zt,t.autoStart===!1)}get concurrency(){return D(this,bn)}set concurrency(t){if(!(typeof t=="number"&&t>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${t}\` (${typeof t})`);de(this,bn,t),te(this,X,Pi).call(this)}setPriority(t,r){D(this,Ye).setPriority(t,r)}async add(t,r={}){return r.id??(r.id=(qn(this,wo)._++).toString()),r={timeout:this.timeout,throwOnTimeout:D(this,Ls),...r},new Promise((s,i)=>{D(this,Ye).enqueue(async()=>{var o;qn(this,vt)._++,qn(this,yr)._++;try{(o=r.signal)==null||o.throwIfAborted();let a=t({signal:r.signal});r.timeout&&(a=xl(Promise.resolve(a),{milliseconds:r.timeout})),r.signal&&(a=Promise.race([a,te(this,X,Vh).call(this,r.signal)]));const c=await a;s(c),this.emit("completed",c)}catch(a){if(a instanceof Nh&&!r.throwOnTimeout){s();return}i(a),this.emit("error",a)}finally{te(this,X,Uh).call(this)}},r),this.emit("add"),te(this,X,Ii).call(this)})}async addAll(t,r){return Promise.all(t.map(async s=>this.add(s,r)))}start(){return D(this,Zt)?(de(this,Zt,!1),te(this,X,Pi).call(this),this):this}pause(){de(this,Zt,!0)}clear(){de(this,Ye,new(D(this,Bs)))}async onEmpty(){D(this,Ye).size!==0&&await te(this,X,Ti).call(this,"empty")}async onSizeLessThan(t){D(this,Ye).size<t||await te(this,X,Ti).call(this,"next",()=>D(this,Ye).size<t)}async onIdle(){D(this,vt)===0&&D(this,Ye).size===0||await te(this,X,Ti).call(this,"idle")}get size(){return D(this,Ye).size}sizeBy(t){return D(this,Ye).filter(t).length}get pending(){return D(this,vt)}get isPaused(){return D(this,Zt)}}pn=new WeakMap,gn=new WeakMap,yr=new WeakMap,Rs=new WeakMap,mn=new WeakMap,Ds=new WeakMap,wt=new WeakMap,yn=new WeakMap,Ye=new WeakMap,Bs=new WeakMap,vt=new WeakMap,bn=new WeakMap,Zt=new WeakMap,Ls=new WeakMap,wo=new WeakMap,X=new WeakSet,Oh=function(){return D(this,gn)||D(this,yr)<D(this,Rs)},Mh=function(){return D(this,vt)<D(this,bn)},Uh=function(){qn(this,vt)._--,te(this,X,Ii).call(this),this.emit("next")},Fh=function(){te(this,X,mc).call(this),te(this,X,gc).call(this),de(this,yn,void 0)},$h=function(){const t=Date.now();if(D(this,wt)===void 0){const r=D(this,Ds)-t;if(r<0)de(this,yr,D(this,pn)?D(this,vt):0);else return D(this,yn)===void 0&&de(this,yn,setTimeout(()=>{te(this,X,Fh).call(this)},r)),!0}return!1},Ii=function(){if(D(this,Ye).size===0)return D(this,wt)&&clearInterval(D(this,wt)),de(this,wt,void 0),this.emit("empty"),D(this,vt)===0&&this.emit("idle"),!1;if(!D(this,Zt)){const t=!D(this,X,$h);if(D(this,X,Oh)&&D(this,X,Mh)){const r=D(this,Ye).dequeue();return r?(this.emit("active"),r(),t&&te(this,X,gc).call(this),!0):!1}}return!1},gc=function(){D(this,gn)||D(this,wt)!==void 0||(de(this,wt,setInterval(()=>{te(this,X,mc).call(this)},D(this,mn))),de(this,Ds,Date.now()+D(this,mn)))},mc=function(){D(this,yr)===0&&D(this,vt)===0&&D(this,wt)&&(clearInterval(D(this,wt)),de(this,wt,void 0)),de(this,yr,D(this,pn)?D(this,vt):0),te(this,X,Pi).call(this)},Pi=function(){for(;te(this,X,Ii).call(this););},Vh=async function(t){return new Promise((r,s)=>{t.addEventListener("abort",()=>{s(t.reason)},{once:!0})})},Ti=async function(t,r){return new Promise(s=>{const i=()=>{r&&!r()||(this.off(t,i),s())};this.on(t,i)})};function Hh(n){const e=[Cr.A];return n==null?e:Array.isArray(n)?n.length===0?e:n:[n]}const qh=60;function zh(n){return{Status:n.Status??0,TC:n.TC??n.flag_tc??!1,RD:n.RD??n.flag_rd??!1,RA:n.RA??n.flag_ra??!1,AD:n.AD??n.flag_ad??!1,CD:n.CD??n.flag_cd??!1,Question:(n.Question??n.questions??[]).map(e=>({name:e.name,type:Cr[e.type]})),Answer:(n.Answer??n.answers??[]).map(e=>({name:e.name,type:Cr[e.type],TTL:e.TTL??e.ttl??qh,data:e.data instanceof Uint8Array?M(e.data):e.data}))}}const S7=4;function nu(n,e={}){const t=new pc({concurrency:e.queryConcurrency??S7});return async(r,s={})=>{var a;const i=new URLSearchParams;i.set("name",r),Hh(s.types).forEach(c=>{i.append("type",Cr[c])}),(a=s.onProgress)==null||a.call(s,new ft("dns:query",{detail:r}));const o=await t.add(async()=>{var u;const c=await fetch(`${n}?${i}`,{headers:{accept:"application/dns-json"},signal:s==null?void 0:s.signal});if(c.status!==200)throw new Error(`Unexpected HTTP status: ${c.status} - ${c.statusText}`);const l=zh(await c.json());return(u=s.onProgress)==null||u.call(s,new ft("dns:response",{detail:l})),l},{signal:s.signal});if(o==null)throw new Error("No DNS response received");return o}}function _7(){return[nu("https://cloudflare-dns.com/dns-query"),nu("https://dns.google/resolve")]}var x7=function(n){if(!n)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),r=Object.create(null);function s(i,o){t[i]=o,e++,e>=n&&(e=0,r=t,t=Object.create(null))}return{has:function(i){return t[i]!==void 0||r[i]!==void 0},remove:function(i){t[i]!==void 0&&(t[i]=void 0),r[i]!==void 0&&(r[i]=void 0)},get:function(i){var o=t[i];if(o!==void 0)return o;if((o=r[i])!==void 0)return s(i,o),o},set:function(i,o){t[i]!==void 0?t[i]=o:s(i,o)},clear:function(){t=Object.create(null),r=Object.create(null)}}};const k7=Us(x7);class C7{constructor(e){d(this,"lru");this.lru=k7(e)}get(e,t){let r=!0;const s=[];for(const i of t){const o=this.getAnswers(e,i);if(o.length===0){r=!1;break}s.push(...o)}if(r)return zh({answers:s})}getAnswers(e,t){const r=`${e.toLowerCase()}-${t}`,s=this.lru.get(r);if(s!=null){const i=s.filter(o=>o.expires>Date.now()).map(({expires:o,value:a})=>({...a,TTL:Math.round((o-Date.now())/1e3),type:Cr[a.type]}));return i.length===0&&this.lru.remove(r),i}return[]}add(e,t){const r=`${e.toLowerCase()}-${t.type}`,s=this.lru.get(r)??[];s.push({expires:Date.now()+(t.TTL??qh)*1e3,value:t}),this.lru.set(r,s)}remove(e,t){const r=`${e.toLowerCase()}-${t}`;this.lru.remove(r)}clear(){this.lru.clear()}}function A7(n){return new C7(n)}const I7=1e3;class P7{constructor(e){d(this,"resolvers");d(this,"cache");this.resolvers={},this.cache=A7(e.cacheSize??I7),Object.entries(e.resolvers??{}).forEach(([t,r])=>{Array.isArray(r)||(r=[r]),t.endsWith(".")||(t=`${t}.`),this.resolvers[t]=r}),this.resolvers["."]==null&&(this.resolvers["."]=_7())}async query(e,t={}){var c,l,u;const r=Hh(t.types),s=t.cached!==!1?this.cache.get(e,r):void 0;if(s!=null)return(c=t.onProgress)==null||c.call(t,new ft("dns:cache",{detail:s})),s;const i=`${e.split(".").pop()}.`,o=(this.resolvers[i]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),a=[];for(const h of o){if(((l=t.signal)==null?void 0:l.aborted)===!0)break;try{const f=await h(e,{...t,types:r});for(const g of f.Answer)this.cache.add(e,g);return f}catch(f){a.push(f),(u=t.onProgress)==null||u.call(t,new ft("dns:error",{detail:f}))}}throw a.length===1?a[0]:new AggregateError(a,`DNS lookup of ${e} ${r} failed`)}}var Cr;(function(n){n[n.A=1]="A",n[n.CNAME=5]="CNAME",n[n.TXT=16]="TXT",n[n.AAAA=28]="AAAA"})(Cr||(Cr={}));function T7(n={}){return new P7(n)}class R7{constructor(){d(this,"index",0);d(this,"input","")}new(e){return this.index=0,this.input=e,this}readAtomically(e){const t=this.index,r=e();return r===void 0&&(this.index=t),r}parseWith(e){const t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{const t=this.readChar();if(t===e)return t})}readSeparator(e,t,r){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return r()})}readNumber(e,t,r,s){return this.readAtomically(()=>{let i=0,o=0;const a=this.peekChar();if(a===void 0)return;const c=a==="0",l=2**(8*s)-1;for(;;){const u=this.readAtomically(()=>{const h=this.readChar();if(h===void 0)return;const f=Number.parseInt(h,e);if(!Number.isNaN(f))return f});if(u===void 0)break;if(i*=e,i+=u,i>l||(o+=1,t!==void 0&&o>t))return}if(o!==0)return!r&&c&&o>1?void 0:i})}readIPv4Addr(){return this.readAtomically(()=>{const e=new Uint8Array(4);for(let t=0;t<e.length;t++){const r=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(r===void 0)return;e[t]=r}return e})}readIPv6Addr(){const e=t=>{for(let r=0;r<t.length/2;r++){const s=r*2;if(r<t.length-3){const o=this.readSeparator(":",r,()=>this.readIPv4Addr());if(o!==void 0)return t[s]=o[0],t[s+1]=o[1],t[s+2]=o[2],t[s+3]=o[3],[s+4,!0]}const i=this.readSeparator(":",r,()=>this.readNumber(16,4,!0,2));if(i===void 0)return[s,!1];t[s]=i>>8,t[s+1]=i&255}return[t.length,!1]};return this.readAtomically(()=>{const t=new Uint8Array(16),[r,s]=e(t);if(r===16)return t;if(s||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;const i=new Uint8Array(14),o=16-(r+2),[a]=e(i.subarray(0,o));return t.set(i.subarray(0,a),16-a),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}}const Kh=45,D7=15,Cn=new R7;function jh(n){if(!(n.length>D7))return Cn.new(n).parseWith(()=>Cn.readIPv4Addr())}function Gh(n){if(n.includes("%")&&(n=n.split("%")[0]),!(n.length>Kh))return Cn.new(n).parseWith(()=>Cn.readIPv6Addr())}function Zi(n,e=!1){if(n.includes("%")&&(n=n.split("%")[0]),n.length>Kh)return;const t=Cn.new(n).parseWith(()=>Cn.readIPAddr());if(t)return e&&t.length===4?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,t[0],t[1],t[2],t[3]]):t}function B7(n,e,t){let r=0;for(const s of n)if(!(r<e)){if(r>t)break;if(s!==255)return!1;r++}return!0}function L7(n,e,t,r){let s=0;for(const i of n)if(!(s<t)){if(s>r)break;if(i!==e[s])return!1;s++}return!0}function N7(n){switch(n.length){case gs:return n.join(".");case ms:{const e=[];for(let t=0;t<n.length;t++)t%2===0&&e.push(n[t].toString(16).padStart(2,"0")+n[t+1].toString(16).padStart(2,"0"));return e.join(":")}default:throw new Error("Invalid ip length")}}function O7(n){let e=0;for(let[t,r]of n.entries()){if(r===255){e+=8;continue}for(;r&128;)e++,r=r<<1;if(r&128)return-1;for(let s=t+1;s<n.length;s++)if(n[s]!=0)return-1;break}return e}function M7(n){let e="0x";for(const t of n)e+=(t>>4).toString(16)+(t&15).toString(16);return e}const gs=4,ms=16,U7=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function Wh(n,e){e.length===ms&&n.length===gs&&B7(e,0,11)&&(e=e.slice(12)),e.length===gs&&n.length===ms&&L7(n,U7,0,11)&&(n=n.slice(12));const t=n.length;if(t!=e.length)throw new Error("Failed to mask ip");const r=new Uint8Array(t);for(let s=0;s<t;s++)r[s]=n[s]&e[s];return r}function F7(n,e){if(typeof e=="string"&&(e=Zi(e)),e==null)throw new Error("Invalid ip");if(e.length!==n.network.length)return!1;for(let t=0;t<e.length;t++)if((n.network[t]&n.mask[t])!==(e[t]&n.mask[t]))return!1;return!0}function $7(n){const[e,t]=n.split("/");if(!e||!t)throw new Error("Failed to parse given CIDR: "+n);let r=gs,s=jh(e);if(s==null&&(r=ms,s=Gh(e),s==null))throw new Error("Failed to parse given CIDR: "+n);const i=parseInt(t,10);if(Number.isNaN(i)||String(i).length!==t.length||i<0||i>r*8)throw new Error("Failed to parse given CIDR: "+n);const o=Qh(i,8*r);return{network:Wh(s,o),mask:o}}function Qh(n,e){if(e!==8*gs&&e!==8*ms)throw new Error("Invalid CIDR mask");if(n<0||n>e)throw new Error("Invalid CIDR mask");const t=e/8,r=new Uint8Array(t);for(let s=0;s<t;s++){if(n>=8){r[s]=255,n-=8;continue}r[s]=255-(255>>n),n=0}return r}class Yh{constructor(e,t){if(t==null)({network:this.network,mask:this.mask}=$7(e));else{const r=Zi(e);if(r==null)throw new Error("Failed to parse network");t=String(t);const s=parseInt(t,10);if(Number.isNaN(s)||String(s).length!==t.length||s<0||s>r.length*8){const i=Zi(t);if(i==null)throw new Error("Failed to parse mask");this.mask=i}else this.mask=Qh(s,8*r.length);this.network=Wh(r,this.mask)}}contains(e){return F7({network:this.network,mask:this.mask},e)}toString(){const e=O7(this.mask),t=e!==-1?String(e):M7(this.mask);return N7(this.network)+"/"+t}}function V7(n,e){return new Yh(n).contains(e)}function An(n){return!!jh(n)}function kl(n){return!!Gh(n)}function Jh(n){return!!Zi(n)}const su=An,H7=kl,Zh=function(n){let e=0;if(n=n.toString().trim(),su(n)){const t=new Uint8Array(e+4);return n.split(/\./g).forEach(r=>{t[e++]=parseInt(r,10)&255}),t}if(H7(n)){const t=n.split(":",8);let r;for(r=0;r<t.length;r++){const i=su(t[r]);let o;i&&(o=Zh(t[r]),t[r]=M(o.slice(0,2),"base16")),o!=null&&++r<8&&t.splice(r,0,M(o.slice(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(r=0;r<t.length&&t[r]!=="";r++);const i=[r,1];for(r=9-t.length;r>0;r--)i.push("0");t.splice.apply(t,i)}const s=new Uint8Array(e+16);for(r=0;r<t.length;r++){const i=parseInt(t[r],16);s[e++]=i>>8&255,s[e++]=i&255}return s}throw new Error("invalid ip address")},q7=function(n,e=0,t){e=~~e,t=t??n.length-e;const r=new DataView(n.buffer);if(t===4){const s=[];for(let i=0;i<t;i++)s.push(n[e+i]);return s.join(".")}if(t===16){const s=[];for(let i=0;i<t;i+=2)s.push(r.getUint16(e+i).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},dt=-1,ys={},yc={},z7=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,dt,"ip6zone"],[43,8,"ipcidr"],[53,dt,"dns",!0],[54,dt,"dns4",!0],[55,dt,"dns6",!0],[56,dt,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,dt,"unix",!1,!0],[421,dt,"ipfs"],[421,dt,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,dt,"garlic64"],[448,0,"tls"],[449,dt,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,dt,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[481,dt,"http-path"],[777,dt,"memory"]];z7.forEach(n=>{const e=K7(...n);yc[e.code]=e,ys[e.name]=e});function K7(n,e,t,r,s){return{code:n,size:e,name:t,resolvable:!!r,path:!!s}}function ce(n){if(typeof n=="number"){if(yc[n]!=null)return yc[n];throw new Error(`no protocol with code: ${n}`)}else if(typeof n=="string"){if(ys[n]!=null)return ys[n];throw new Error(`no protocol with name: ${n}`)}throw new Error(`invalid protocol id type: ${typeof n}`)}const j7=ce("ip4"),G7=ce("ip6"),W7=ce("ipcidr");function Xh(n,e){switch(ce(n).code){case 4:case 41:return J7(e);case 42:return ma(e);case 43:return M(e,"base10");case 6:case 273:case 33:case 132:return e0(e).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return ma(e);case 421:return t9(e);case 444:return au(e);case 445:return au(e);case 466:return e9(e);case 481:return globalThis.encodeURIComponent(ma(e));default:return M(e,"base16")}}function iu(n,e){switch(ce(n).code){case 4:return ou(e);case 41:return ou(e);case 42:return ga(e);case 43:return O(e,"base10");case 6:case 273:case 33:case 132:return Cl(parseInt(e,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return ga(e);case 421:return Z7(e);case 444:return r9(e);case 445:return n9(e);case 466:return X7(e);case 481:return ga(globalThis.decodeURIComponent(e));default:return O(e,"base16")}}function Q7(n){let e,t;if(n.stringTuples().forEach(([r,s])=>{(r===j7.code||r===G7.code)&&(t=s),r===W7.code&&(e=s)}),e==null||t==null)throw new Error("Invalid multiaddr");return new Yh(t,e)}const pa=Object.values(ps).map(n=>n.decoder),Y7=function(){let n=pa[0].or(pa[1]);return pa.slice(2).forEach(e=>n=n.or(e)),n}();function ou(n){if(!Jh(n))throw new Error("invalid ip address");return Zh(n)}function J7(n){const e=q7(n,0,n.length);if(e==null)throw new Error("ipBuff is required");if(!Jh(e))throw new Error("invalid ip address");return e}function Cl(n){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,n),new Uint8Array(e)}function e0(n){return new DataView(n.buffer).getUint16(n.byteOffset)}function ga(n){const e=O(n),t=Uint8Array.from(Ct(e.length));return St([t,e],t.length+e.length)}function ma(n){const e=Pr(n);if(n=n.slice(mt(e)),n.length!==e)throw new Error("inconsistent lengths");return M(n)}function Z7(n){let e;n[0]==="Q"||n[0]==="1"?e=ct(fe.decode(`z${n}`)).bytes:e=Z.parse(n).multihash.bytes;const t=Uint8Array.from(Ct(e.length));return St([t,e],t.length+e.length)}function X7(n){const e=Y7.decode(n),t=Uint8Array.from(Ct(e.length));return St([t,e],t.length+e.length)}function e9(n){const e=Pr(n),t=n.slice(mt(e));if(t.length!==e)throw new Error("inconsistent lengths");return"u"+M(t,"base64url")}function t9(n){const e=Pr(n),t=n.slice(mt(e));if(t.length!==e)throw new Error("inconsistent lengths");return M(t,"base58btc")}function r9(n){const e=n.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=er.decode("b"+e[0]),r=parseInt(e[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const s=Cl(r);return St([t,s],t.length+s.length)}function n9(n){const e=n.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=er.decode(`b${e[0]}`),r=parseInt(e[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const s=Cl(r);return St([t,s],t.length+s.length)}function au(n){const e=n.slice(0,n.length-2),t=n.slice(n.length-2),r=M(e,"base32"),s=e0(t);return`${r}:${s}`}function s9(n){n=bc(n);const e=[],t=[];let r=null;const s=n.split("/").slice(1);if(s.length===1&&s[0]==="")return{bytes:new Uint8Array,string:"/",tuples:[],stringTuples:[],path:null};for(let i=0;i<s.length;i++){const o=s[i],a=ce(o);if(a.size===0){e.push([a.code]),t.push([a.code]);continue}if(i++,i>=s.length)throw new Al("invalid address: "+n);if(a.path===!0){r=bc(s.slice(i).join("/")),e.push([a.code,iu(a.code,r)]),t.push([a.code,r]);break}const c=iu(a.code,s[i]);e.push([a.code,c]),t.push([a.code,Xh(a.code,c)])}return{string:t0(t),bytes:r0(e),tuples:e,stringTuples:t,path:r}}function cu(n){const e=[],t=[];let r=null,s=0;for(;s<n.length;){const i=Pr(n,s),o=mt(i),a=ce(i),c=i9(a,n.slice(s+o));if(c===0){e.push([i]),t.push([i]),s+=o;continue}const l=n.slice(s+o,s+o+c);if(s+=c+o,s>n.length)throw new Al("Invalid address Uint8Array: "+M(n,"base16"));e.push([i,l]);const u=Xh(i,l);if(t.push([i,u]),a.path===!0){r=u;break}}return{bytes:Uint8Array.from(n),string:t0(t),tuples:e,stringTuples:t,path:r}}function t0(n){const e=[];return n.map(t=>{const r=ce(t[0]);return e.push(r.name),t.length>1&&t[1]!=null&&e.push(t[1]),null}),bc(e.join("/"))}function r0(n){return St(n.map(e=>{const t=ce(e[0]);let r=Uint8Array.from(Ct(t.code));return e.length>1&&e[1]!=null&&(r=St([r,e[1]])),r}))}function i9(n,e){if(n.size>0)return n.size/8;if(n.size===0)return 0;{const t=Pr(e instanceof Uint8Array?e:Uint8Array.from(e));return t+mt(t)}}function bc(n){return"/"+n.trim().split("/").filter(e=>e).join("/")}class Al extends Error{constructor(t){super(`Error parsing address: ${t}`);d(this,"name","ParseError")}}d(Al,"name","ParseError");const o9=Symbol.for("nodejs.util.inspect.custom"),n0=Symbol.for("@multiformats/js-multiaddr/multiaddr"),a9=[ce("dns").code,ce("dns4").code,ce("dns6").code,ce("dnsaddr").code];class c9 extends Error{constructor(e="No available resolver"){super(e),this.name="NoAvailableResolverError"}}var md,wn,br,Ns,Os;const ln=class ln{constructor(e){d(this,"bytes");re(this,wn);re(this,br);re(this,Ns);re(this,Os);d(this,md,!0);e==null&&(e="");let t;if(e instanceof Uint8Array)t=cu(e);else if(typeof e=="string"){if(e.length>0&&e.charAt(0)!=="/")throw new Error(`multiaddr "${e}" must start with a "/"`);t=s9(e)}else if(Ro(e))t=cu(e.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=t.bytes,de(this,wn,t.string),de(this,br,t.tuples),de(this,Ns,t.stringTuples),de(this,Os,t.path)}toString(){return D(this,wn)}toJSON(){return this.toString()}toOptions(){let e,t,r,s,i="";const o=ce("tcp"),a=ce("udp"),c=ce("ip4"),l=ce("ip6"),u=ce("dns6"),h=ce("ip6zone");for(const[g,p]of this.stringTuples())g===h.code&&(i=`%${p??""}`),a9.includes(g)&&(t=o.name==="tcp"?"tcp":"udp",s=443,r=`${p??""}${i}`,e=g===u.code?6:4),(g===o.code||g===a.code)&&(t=ce(g).name==="tcp"?"tcp":"udp",s=parseInt(p??"")),(g===c.code||g===l.code)&&(t=ce(g).name==="tcp"?"tcp":"udp",r=`${p??""}${i}`,e=g===l.code?6:4);if(e==null||t==null||r==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:r,transport:t,port:s}}protos(){return D(this,br).map(([e])=>Object.assign({},ce(e)))}protoCodes(){return D(this,br).map(([e])=>e)}protoNames(){return D(this,br).map(([e])=>ce(e).name)}tuples(){return D(this,br).map(([e,t])=>t==null?[e]:[e,t])}stringTuples(){return D(this,Ns).map(([e,t])=>t==null?[e]:[e,t])}encapsulate(e){return e=new ln(e),new ln(this.toString()+e.toString())}decapsulate(e){const t=e.toString(),r=this.toString(),s=r.lastIndexOf(t);if(s<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new ln(r.slice(0,s))}decapsulateCode(e){const t=this.tuples();for(let r=t.length-1;r>=0;r--)if(t[r][0]===e)return new ln(r0(t.slice(0,r)));return this}getPeerId(){try{let e=[];this.stringTuples().forEach(([r,s])=>{r===ys.p2p.code&&e.push([r,s]),r===ys["p2p-circuit"].code&&(e=[])});const t=e.pop();if((t==null?void 0:t[1])!=null){const r=t[1];return r[0]==="Q"||r[0]==="1"?M(fe.decode(`z${r}`),"base58btc"):M(Z.parse(r).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){return D(this,Os)}equals(e){return ie(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(i=>i.resolvable);if(t==null)return[this];const r=Il.get(t.name);if(r==null)throw new c9(`no available resolver for ${t.name}`);return(await r(this,e)).map(i=>se(i))}nodeAddress(){const e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){const t=(e??this).protos();return!(t.length!==2||t[0].code!==4&&t[0].code!==41||t[1].code!==6&&t[1].code!==273)}[(md=n0,o9)](){return`Multiaddr(${D(this,wn)})`}};wn=new WeakMap,br=new WeakMap,Ns=new WeakMap,Os=new WeakMap;let wc=ln;const Il=new Map;function Ro(n){return!!(n!=null&&n[n0])}function se(n){return new wc(n)}const l9=32,{code:u9}=ce("dnsaddr");class d9 extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}}const s0=async function(e,t={}){const r=t.maxRecursiveDepth??l9;if(r===0)throw new d9("Max recursive depth reached");const[,s]=e.stringTuples().find(([l])=>l===u9)??[],o=await((t==null?void 0:t.dns)??T7()).query(`_dnsaddr.${s}`,{signal:t==null?void 0:t.signal,types:[Cr.TXT]}),a=e.getPeerId(),c=[];for(const l of o.Answer){const u=l.data.replace(/["']/g,"").trim().split("=")[1];if(u==null||a!=null&&!u.includes(a))continue;const h=se(u);if(u.startsWith("/dnsaddr")){const f=await h.resolve({...t,maxRecursiveDepth:r-1});c.push(...f.map(g=>g.toString()))}else c.push(h.toString())}return c};var h9=n=>{if(Object.prototype.toString.call(n)!=="[object Object]")return!1;const e=Object.getPrototypeOf(n);return e===null||e===Object.prototype};const Xi=h9,{hasOwnProperty:i0}=Object.prototype,{propertyIsEnumerable:f9}=Object,In=(n,e,t)=>Object.defineProperty(n,e,{value:t,writable:!0,enumerable:!0,configurable:!0}),p9=_2,lu={concatArrays:!1,ignoreUndefined:!1},Do=n=>{const e=[];for(const t in n)i0.call(n,t)&&e.push(t);if(Object.getOwnPropertySymbols){const t=Object.getOwnPropertySymbols(n);for(const r of t)f9.call(n,r)&&e.push(r)}return e};function Mn(n){return Array.isArray(n)?g9(n):Xi(n)?m9(n):n}function g9(n){const e=n.slice(0,0);return Do(n).forEach(t=>{In(e,t,Mn(n[t]))}),e}function m9(n){const e=Object.getPrototypeOf(n)===null?Object.create(null):{};return Do(n).forEach(t=>{In(e,t,Mn(n[t]))}),e}const o0=(n,e,t,r)=>(t.forEach(s=>{typeof e[s]>"u"&&r.ignoreUndefined||(s in n&&n[s]!==Object.getPrototypeOf(n)?In(n,s,vc(n[s],e[s],r)):In(n,s,Mn(e[s])))}),n),y9=(n,e,t)=>{let r=n.slice(0,0),s=0;return[n,e].forEach(i=>{const o=[];for(let a=0;a<i.length;a++)i0.call(i,a)&&(o.push(String(a)),i===n?In(r,s++,i[a]):In(r,s++,Mn(i[a])));r=o0(r,i,Do(i).filter(a=>!o.includes(a)),t)}),r};function vc(n,e,t){return t.concatArrays&&Array.isArray(n)&&Array.isArray(e)?y9(n,e,t):!Xi(e)||!Xi(n)?Mn(e):o0(n,e,Do(e),t)}var b9=function(...n){const e=vc(Mn(lu),this!==p9&&this||{},lu);let t={_:{}};for(const r of n)if(r!==void 0){if(!Xi(r))throw new TypeError("`"+r+"` is not an Option Object");t=vc(t,{_:r},e)}return t._};const a0=Us(b9),w9={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:n=>n},connectionManager:{resolvers:{dnsaddr:s0}},transportManager:{faultTolerance:us.FATAL_ALL}};async function v9(n){var t,r;const e=a0(w9,n);if(e.connectionProtector===null&&((r=(t=globalThis.process)==null?void 0:t.env)==null?void 0:r.LIBP2P_FORCE_PNET)!=null)throw new G("Private network is enforced, but no protector was provided");return e}const Pn=1e3,Tn=Pn*60,Rn=Tn*60,zr=Rn*24,E9=zr*7,S9=zr*365.25;function c0(n,e){try{if(typeof n=="string"&&n.length>0)return _9(n);if(typeof n=="number"&&isFinite(n))return e!=null&&e.long?k9(n):x9(n);throw new Error("Value is not a string or number.")}catch(t){const r=C9(t)?`${t.message}. value=${JSON.stringify(n)}`:"An unknown error has occured.";throw new Error(r)}}function _9(n){if(n=String(n),n.length>100)throw new Error("Value exceeds the maximum length of 100 characters.");const e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(n);if(!e)return NaN;const t=parseFloat(e[1]),r=(e[2]||"ms").toLowerCase();switch(r){case"years":case"year":case"yrs":case"yr":case"y":return t*S9;case"weeks":case"week":case"w":return t*E9;case"days":case"day":case"d":return t*zr;case"hours":case"hour":case"hrs":case"hr":case"h":return t*Rn;case"minutes":case"minute":case"mins":case"min":case"m":return t*Tn;case"seconds":case"second":case"secs":case"sec":case"s":return t*Pn;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:throw new Error(`The unit ${r} was matched, but no matching case exists.`)}}function x9(n){const e=Math.abs(n);return e>=zr?`${Math.round(n/zr)}d`:e>=Rn?`${Math.round(n/Rn)}h`:e>=Tn?`${Math.round(n/Tn)}m`:e>=Pn?`${Math.round(n/Pn)}s`:`${n}ms`}function k9(n){const e=Math.abs(n);return e>=zr?ai(n,e,zr,"day"):e>=Rn?ai(n,e,Rn,"hour"):e>=Tn?ai(n,e,Tn,"minute"):e>=Pn?ai(n,e,Pn,"second"):`${n} ms`}function ai(n,e,t,r){const s=e>=t*1.5;return`${Math.round(n/t)} ${r}${s?"s":""}`}function C9(n){return typeof n=="object"&&n!==null&&"message"in n}function A9(n){t.debug=t,t.default=t,t.coerce=c,t.disable=i,t.enable=s,t.enabled=o,t.humanize=c0,t.destroy=l,Object.keys(n).forEach(u=>{t[u]=n[u]}),t.names=[],t.skips=[],t.formatters={};function e(u){let h=0;for(let f=0;f<u.length;f++)h=(h<<5)-h+u.charCodeAt(f),h|=0;return t.colors[Math.abs(h)%t.colors.length]}t.selectColor=e;function t(u){let h,f=null,g,p;function m(...y){if(!m.enabled)return;const E=m,_=Number(new Date),w=_-(h||_);E.diff=w,E.prev=h,E.curr=_,h=_,y[0]=t.coerce(y[0]),typeof y[0]!="string"&&y.unshift("%O");let b=0;y[0]=y[0].replace(/%([a-zA-Z%])/g,(x,C)=>{if(x==="%%")return"%";b++;const R=t.formatters[C];if(typeof R=="function"){const F=y[b];x=R.call(E,F),y.splice(b,1),b--}return x}),t.formatArgs.call(E,y),(E.log||t.log).apply(E,y)}return m.namespace=u,m.useColors=t.useColors(),m.color=t.selectColor(u),m.extend=r,m.destroy=t.destroy,Object.defineProperty(m,"enabled",{enumerable:!0,configurable:!1,get:()=>f!==null?f:(g!==t.namespaces&&(g=t.namespaces,p=t.enabled(u)),p),set:y=>{f=y}}),typeof t.init=="function"&&t.init(m),m}function r(u,h){const f=t(this.namespace+(typeof h>"u"?":":h)+u);return f.log=this.log,f}function s(u){t.save(u),t.namespaces=u,t.names=[],t.skips=[];let h;const f=(typeof u=="string"?u:"").split(/[\s,]+/),g=f.length;for(h=0;h<g;h++)f[h]&&(u=f[h].replace(/\*/g,".*?"),u[0]==="-"?t.skips.push(new RegExp("^"+u.substr(1)+"$")):t.names.push(new RegExp("^"+u+"$")))}function i(){const u=[...t.names.map(a),...t.skips.map(a).map(h=>"-"+h)].join(",");return t.enable(""),u}function o(u){if(u[u.length-1]==="*")return!0;let h,f;for(h=0,f=t.skips.length;h<f;h++)if(t.skips[h].test(u))return!1;for(h=0,f=t.names.length;h<f;h++)if(t.names[h].test(u))return!0;return!1}function a(u){return u.toString().substring(2,u.toString().length-2).replace(/\.\*\?$/,"*")}function c(u){return u instanceof Error?u.stack??u.message:u}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.setupFormatters(t.formatters),t.enable(t.load()),t}var I9={};const Ft=N9(),P9=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function T9(){var n,e,t,r,s;return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&((n=navigator.userAgent)==null?void 0:n.toLowerCase().match(/(edge|trident)\/(\d+)/))!=null?!1:typeof document<"u"&&((t=(e=document.documentElement)==null?void 0:e.style)==null?void 0:t.WebkitAppearance)||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&((r=navigator.userAgent)==null?void 0:r.toLowerCase().match(/firefox\/(\d+)/))!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&((s=navigator.userAgent)==null?void 0:s.toLowerCase().match(/applewebkit\/(\d+)/))}function R9(n){if(n[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+n[0]+(this.useColors?"%c ":" ")+"+"+c0(this.diff),!this.useColors)return;const e="color: "+this.color;n.splice(1,0,e,"color: inherit");let t=0,r=0;n[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(t++,s==="%c"&&(r=t))}),n.splice(r,0,e)}const D9=console.debug??console.log??(()=>{});function B9(n){try{n?Ft==null||Ft.setItem("debug",n):Ft==null||Ft.removeItem("debug")}catch{}}function L9(){let n;try{n=Ft==null?void 0:Ft.getItem("debug")}catch{}return!n&&typeof globalThis.process<"u"&&"env"in globalThis.process&&(n=I9.DEBUG),n}function N9(){try{return localStorage}catch{}}function O9(n){n.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}}const pt=A9({formatArgs:R9,save:B9,load:L9,useColors:T9,setupFormatters:O9,colors:P9,storage:Ft,log:D9});pt.formatters.b=n=>n==null?"undefined":fe.baseEncode(n);pt.formatters.t=n=>n==null?"undefined":er.baseEncode(n);pt.formatters.m=n=>n==null?"undefined":ol.baseEncode(n);pt.formatters.p=n=>n==null?"undefined":n.toString();pt.formatters.c=n=>n==null?"undefined":n.toString();pt.formatters.k=n=>n==null?"undefined":n.toString();pt.formatters.a=n=>n==null?"undefined":n.toString();pt.formatters.e=n=>n==null?"undefined":uu(n.stack)??uu(n.message)??n.toString();function M9(n){const e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=n,e.destroy=()=>!0,e.extend=()=>e,e}function l0(){return{forComponent(n){return U9(n)}}}function U9(n){let e=M9(`${n}:trace`);return pt.enabled(`${n}:trace`)&&pt.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=pt(`${n}:trace`)),Object.assign(pt(n),{error:pt(`${n}:error`),trace:e})}function uu(n){if(n!=null&&(n=n.trim(),n.length!==0))return n}function Xn(n,e){const t={[Symbol.iterator]:()=>t,next:()=>{const r=n.next(),s=r.value;return r.done===!0||s==null?{done:!0,value:void 0}:{done:!1,value:e(s)}}};return t}function ya(n){const e=ct(fe.decode(`z${n}`));return or(e)}class js{constructor(e){d(this,"map");if(this.map=new Map,e!=null)for(const[t,r]of e.entries())this.map.set(t.toString(),{key:t,value:r})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return Xn(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,r)=>{e(t.value,t.key,this)})}get(e){var t;return(t=this.map.get(e.toString()))==null?void 0:t.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return Xn(this.map.values(),e=>e.key)}values(){return Xn(this.map.values(),e=>e.value)}get size(){return this.map.size}}class Ht{constructor(e){d(this,"set");if(this.set=new Set,e!=null)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return Xn(this.set.entries(),e=>{const t=ya(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{const r=ya(t);e(r,r,this)})}has(e){return this.set.has(e.toString())}values(){return Xn(this.set.values(),e=>ya(e))}intersection(e){const t=new Ht;for(const r of e)this.has(r)&&t.add(r);return t}difference(e){const t=new Ht;for(const r of this)e.has(r)||t.add(r);return t}union(e){const t=new Ht;for(const r of e)t.add(r);for(const r of this)t.add(r);return t}}function F9(n,e,t,r){J2(n);const s=m5({dkLen:32,asyncTick:10},r),{c:i,dkLen:o,asyncTick:a}=s;if(hn(i),hn(o),hn(a),i<1)throw new Error("iterations (c) should be >= 1");const c=B1(e),l=B1(t),u=new Uint8Array(o),h=Sl.create(n,c),f=h._cloneInto().update(l);return{c:i,dkLen:o,asyncTick:a,DK:u,PRF:h,PRFSalt:f}}function $9(n,e,t,r,s){return n.destroy(),e.destroy(),r&&r.destroy(),Hr(s),t}async function V9(n,e,t,r){const{c:s,dkLen:i,asyncTick:o,DK:a,PRF:c,PRFSalt:l}=F9(n,e,t,r);let u;const h=new Uint8Array(4),f=Ai(h),g=new Uint8Array(c.outputLen);for(let p=1,m=0;m<i;p++,m+=c.outputLen){const y=a.subarray(m,m+c.outputLen);f.setInt32(0,p,!1),(u=l._cloneInto(u)).update(h).digestInto(g),y.set(g.subarray(0,y.length)),await p5(s-1,o,()=>{c._cloneInto(u).update(g).digestInto(g);for(let E=0;E<y.length;E++)y[E]^=g[E]})}return $9(c,l,a,u,g)}const H9=sh,Pl={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},u0={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},d0=new globalThis.TextEncoder;function q9(n,e){const t=Pl[e];let r=u0[e];for(let s=0;s<n.length;s++)r^=BigInt(n[s]),r=BigInt.asUintN(e,r*t);return r}function z9(n,e,t){if(t.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");const r=Pl[e];let s=u0[e],i=n;for(;i.length>0;){const o=d0.encodeInto(i,t);i=i.slice(o.read);for(let a=0;a<o.written;a++)s^=BigInt(t[a]),s=BigInt.asUintN(e,s*r)}return s}function K9(n,{size:e=32,utf8Buffer:t}={}){if(!Pl[e])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof n=="string"){if(t)return z9(n,e,t);n=d0.encode(n)}return q9(n,e)}const Tl={hash:n=>Number(K9(n,{size:32})),hashV:(n,e)=>j9(Tl.hash(n,e))};function j9(n){let e=n.toString(16);return e.length%2===1&&(e=`0${e}`),O(e,"base16")}const h0=64;class Nr{constructor(e,t,r,s=2){d(this,"fp");d(this,"h");d(this,"seed");if(s>h0)throw new TypeError("Invalid Fingerprint Size");const i=t.hashV(e,r),o=ke(s);for(let a=0;a<o.length;a++)o[a]=i[a];o.length===0&&(o[0]=7),this.fp=o,this.h=t,this.seed=r}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return(e==null?void 0:e.fp)instanceof Uint8Array?ie(this.fp,e.fp):!1}}function eo(n,e){return Math.floor(Math.random()*(e-n))+n}class ci{constructor(e){d(this,"contents");this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof Nr))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof Nr))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof Nr))throw new TypeError("Invalid Fingerprint");const t=eo(0,this.contents.length-1),r=this.contents[t];return this.contents[t]=e,r}remove(e){if(!(e instanceof Nr))throw new TypeError("Invalid Fingerprint");const t=this.contents.findIndex(r=>e.equals(r));return t>-1?(this.contents[t]=null,!0):!1}}const G9=500;class du{constructor(e){d(this,"bucketSize");d(this,"filterSize");d(this,"fingerprintSize");d(this,"buckets");d(this,"count");d(this,"hash");d(this,"seed");this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??Tl,this.seed=e.seed??eo(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=O(e));const t=new Nr(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,s=(r^t.hash())%this.filterSize;if(this.buckets[r]==null&&(this.buckets[r]=new ci(this.bucketSize)),this.buckets[s]==null&&(this.buckets[s]=new ci(this.bucketSize)),this.buckets[r].add(t)||this.buckets[s].add(t))return this.count++,!0;const i=[r,s];let o=i[eo(0,i.length-1)];this.buckets[o]==null&&(this.buckets[o]=new ci(this.bucketSize));for(let a=0;a<G9;a++){const c=this.buckets[o].swap(t);if(c!=null&&(o=(o^c.hash())%this.filterSize,this.buckets[o]==null&&(this.buckets[o]=new ci(this.bucketSize)),this.buckets[o].add(c)))return this.count++,!0}return!1}has(e){var o,a;typeof e=="string"&&(e=O(e));const t=new Nr(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,s=((o=this.buckets[r])==null?void 0:o.has(t))??!1;if(s)return s;const i=(r^t.hash())%this.filterSize;return((a=this.buckets[i])==null?void 0:a.has(t))??!1}remove(e){var a,c;typeof e=="string"&&(e=O(e));const t=new Nr(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,s=((a=this.buckets[r])==null?void 0:a.remove(t))??!1;if(s)return this.count--,s;const i=(r^t.hash())%this.filterSize,o=((c=this.buckets[i])==null?void 0:c.remove(t))??!1;return o&&this.count--,o}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}}const W9={1:.5,2:.84,4:.95,8:.98};function Q9(n=.001){return n>.002?2:n>1e-5?4:8}function Y9(n,e=.001){const t=Q9(e),r=W9[t],s=Math.round(n/r),i=Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*t)),h0);return{filterSize:s,bucketSize:t,fingerprintSize:i}}class J9{constructor(e){d(this,"filterSize");d(this,"bucketSize");d(this,"fingerprintSize");d(this,"scale");d(this,"filterSeries");d(this,"hash");d(this,"seed");this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??Tl,this.seed=e.seed??eo(0,Math.pow(2,10)),this.filterSeries=[new du({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=O(e)),this.has(e))return!0;let t=this.filterSeries.find(r=>r.reliable);if(t==null){const r=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new du({filterSize:r,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=O(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=O(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}}function f0(n,e=.001,t){return new J9({...Y9(n,e)})}var to;(function(n){let e;n.codec=()=>(e==null&&(e=Ue((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(r.uint32(10),r.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(r.uint32(18),r.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(r.uint32(26),r.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(r.uint32(42),r.bytes(t.signature)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={publicKey:ke(0),payloadType:ke(0),payload:ke(0),signature:ke(0)},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{i.payloadType=t.bytes();break}case 3:{i.payload=t.bytes();break}case 5:{i.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),n.encode=t=>Me(t,n.codec()),n.decode=(t,r)=>Oe(t,n.codec(),r)})(to||(to={}));class Z9 extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}}const pr=class pr{constructor(e){d(this,"publicKey");d(this,"payloadType");d(this,"payload");d(this,"signature");d(this,"marshaled");const{publicKey:t,payloadType:r,payload:s,signature:i}=e;this.publicKey=t,this.payloadType=r,this.payload=s,this.signature=i}marshal(){return this.marshaled==null&&(this.marshaled=to.encode({publicKey:tr(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return e==null?!1:ie(this.marshal(),e.marshal())}async validate(e){const t=hu(e,this.payloadType,this.payload);return this.publicKey.verify(t.subarray(),this.signature)}};d(pr,"createFromProtobuf",async e=>{const t=to.decode(e),r=Zr(t.publicKey);return new pr({publicKey:r,payloadType:t.payloadType,payload:t.payload,signature:t.signature})}),d(pr,"seal",async(e,t)=>{if(t==null)throw new Error("Missing private key");const r=e.domain,s=e.codec,i=e.marshal(),o=hu(r,s,i),a=await t.sign(o.subarray());return new pr({publicKey:t.publicKey,payloadType:s,payload:i,signature:a})}),d(pr,"openAndCertify",async(e,t)=>{const r=await pr.createFromProtobuf(e);if(!await r.validate(t))throw new Z9("Envelope signature is not valid for the given domain");return r});let Kr=pr;const hu=(n,e,t)=>{const r=O(n),s=Ct(r.byteLength),i=Ct(e.length),o=Ct(t.length);return new ve(s,r,i,e,o,t)};function X9(n,e){const t=(r,s)=>r.toString().localeCompare(s.toString());return n.length!==e.length?!1:(e.sort(t),n.sort(t).every((r,s)=>e[s].equals(r)))}const ep="libp2p-peer-record",tp=Uint8Array.from([3,1]);var ro;(function(n){(function(t){let r;t.codec=()=>(r==null&&(r=Ue((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.multiaddr!=null&&s.multiaddr.byteLength>0&&(i.uint32(10),i.bytes(s.multiaddr)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={multiaddr:ke(0)},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.multiaddr=s.bytes();break}default:{s.skipType(l&7);break}}}return a})),r),t.encode=s=>Me(s,t.codec()),t.decode=(s,i)=>Oe(s,t.codec(),i)})(n.AddressInfo||(n.AddressInfo={}));let e;n.codec=()=>(e==null&&(e=Ue((t,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),t.peerId!=null&&t.peerId.byteLength>0&&(r.uint32(10),r.bytes(t.peerId)),t.seq!=null&&t.seq!==0n&&(r.uint32(16),r.uint64(t.seq)),t.addresses!=null)for(const i of t.addresses)r.uint32(26),n.AddressInfo.codec().encode(i,r);s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{var a,c;const i={peerId:ke(0),seq:0n,addresses:[]},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.peerId=t.bytes();break}case 2:{i.seq=t.uint64();break}case 3:{if(((a=s.limits)==null?void 0:a.addresses)!=null&&i.addresses.length===s.limits.addresses)throw new kr('Decode error - map field "addresses" had too many elements');i.addresses.push(n.AddressInfo.codec().decode(t,t.uint32(),{limits:(c=s.limits)==null?void 0:c.addresses$}));break}default:{t.skipType(l&7);break}}}return i})),e),n.encode=t=>Me(t,n.codec()),n.decode=(t,r)=>Oe(t,n.codec(),r)})(ro||(ro={}));const Yt=class Yt{constructor(e){d(this,"peerId");d(this,"multiaddrs");d(this,"seqNumber");d(this,"domain",Yt.DOMAIN);d(this,"codec",Yt.CODEC);d(this,"marshaled");const{peerId:t,multiaddrs:r,seqNumber:s}=e;this.peerId=t,this.multiaddrs=r??[],this.seqNumber=s??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=ro.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof Yt)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!X9(this.multiaddrs,e.multiaddrs))}};d(Yt,"createFromProtobuf",e=>{const t=ro.decode(e),r=or(ct(t.peerId)),s=(t.addresses??[]).map(o=>se(o.multiaddr)),i=t.seq;return new Yt({peerId:r,multiaddrs:s,seqNumber:i})}),d(Yt,"DOMAIN",ep),d(Yt,"CODEC",tp);let rr=Yt;function rp(n){return n[Symbol.asyncIterator]!=null}function no(n){if(rp(n))return(async()=>{const t=[];for await(const r of n)t.push(r);return t})();const e=[];for(const t of n)e.push(t);return e}const Er={},jr=n=>{n.addEventListener("message",e=>{jr.dispatchEvent("message",n,e)}),n.port!=null&&n.port.addEventListener("message",e=>{jr.dispatchEvent("message",n,e)})};jr.addEventListener=(n,e)=>{Er[n]==null&&(Er[n]=[]),Er[n].push(e)};jr.removeEventListener=(n,e)=>{Er[n]!=null&&(Er[n]=Er[n].filter(t=>t===e))};jr.dispatchEvent=function(n,e,t){Er[n]!=null&&Er[n].forEach(r=>r(e,t))};const fu="lock:worker:request-read",pu="lock:worker:release-read",gu="lock:master:grant-read",mu="lock:worker:request-write",yu="lock:worker:release-write",bu="lock:master:grant-write",np=(n=21)=>Math.random().toString().substring(2),wu=(n,e,t,r,s)=>(i,o)=>{if(o.data.type!==t)return;const a={type:o.data.type,name:o.data.name,identifier:o.data.identifier};n.dispatchEvent(new MessageEvent(e,{data:{name:a.name,handler:async()=>{i.postMessage({type:s,name:a.name,identifier:a.identifier}),await new Promise(c=>{const l=u=>{if((u==null?void 0:u.data)==null)return;const h={type:u.data.type,name:u.data.name,identifier:u.data.identifier};h.type===r&&h.identifier===a.identifier&&(i.removeEventListener("message",l),c())};i.addEventListener("message",l)})}}}))},vu=(n,e,t,r)=>async()=>{const s=np();return globalThis.postMessage({type:e,identifier:s,name:n}),new Promise(i=>{const o=a=>{if((a==null?void 0:a.data)==null)return;const c={type:a.data.type,identifier:a.data.identifier};c.type===t&&c.identifier===s&&(globalThis.removeEventListener("message",o),i(()=>{globalThis.postMessage({type:r,identifier:s,name:n})}))};globalThis.addEventListener("message",o)})},sp={singleProcess:!1},ip=n=>{if(n=Object.assign({},sp,n),!!globalThis.document||n.singleProcess){const t=new EventTarget;return jr.addEventListener("message",wu(t,"requestReadLock",fu,pu,gu)),jr.addEventListener("message",wu(t,"requestWriteLock",mu,yu,bu)),t}return{isWorker:!0,readLock:t=>vu(t,fu,gu,pu),writeLock:t=>vu(t,mu,bu,yu)}},Rr={};let gr;async function ba(n,e){let t;const r=new Promise(s=>{t=s});return n.add(async()=>xl((async()=>{await new Promise(s=>{t(()=>{s()})})})(),{milliseconds:e.timeout})),r}const op=(n,e)=>{if(gr.isWorker===!0)return{readLock:gr.readLock(n,e),writeLock:gr.writeLock(n,e)};const t=new pc({concurrency:1});let r;return{async readLock(){if(r!=null)return ba(r,e);r=new pc({concurrency:e.concurrency,autoStart:!1});const s=r,i=ba(r,e);return t.add(async()=>{s.start(),await s.onIdle().then(()=>{r===s&&(r=null)})}),i},async writeLock(){return r=null,ba(t,e)}}},ap={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function p0(n){const e=Object.assign({},ap,n);return gr==null&&(gr=ip(e),gr.isWorker!==!0&&(gr.addEventListener("requestReadLock",t=>{Rr[t.data.name]!=null&&Rr[t.data.name].readLock().then(async r=>t.data.handler().finally(()=>{r()}))}),gr.addEventListener("requestWriteLock",async t=>{Rr[t.data.name]!=null&&Rr[t.data.name].writeLock().then(async r=>t.data.handler().finally(()=>{r()}))}))),Rr[e.name]==null&&(Rr[e.name]=op(e.name,e)),Rr[e.name]}const cp=36e5,lp=216e5;var Or;(function(n){(function(t){let r;t.codec=()=>(r==null&&(r=Ue((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&s.value.byteLength>0&&(i.uint32(18),i.bytes(s.value)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={key:"",value:ke(0)},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.key=s.string();break}case 2:{a.value=s.bytes();break}default:{s.skipType(l&7);break}}}return a})),r),t.encode=s=>Me(s,t.codec()),t.decode=(s,i)=>Oe(s,t.codec(),i)})(n.Peer$metadataEntry||(n.Peer$metadataEntry={})),function(t){let r;t.codec=()=>(r==null&&(r=Ue((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&(i.uint32(18),io.codec().encode(s.value,i)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{var l;const a={key:""},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const u=s.uint32();switch(u>>>3){case 1:{a.key=s.string();break}case 2:{a.value=io.codec().decode(s,s.uint32(),{limits:(l=o.limits)==null?void 0:l.value});break}default:{s.skipType(u&7);break}}}return a})),r),t.encode=s=>Me(s,t.codec()),t.decode=(s,i)=>Oe(s,t.codec(),i)}(n.Peer$tagsEntry||(n.Peer$tagsEntry={}));let e;n.codec=()=>(e==null&&(e=Ue((t,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),t.addresses!=null)for(const i of t.addresses)r.uint32(10),so.codec().encode(i,r);if(t.protocols!=null)for(const i of t.protocols)r.uint32(18),r.string(i);if(t.publicKey!=null&&(r.uint32(34),r.bytes(t.publicKey)),t.peerRecordEnvelope!=null&&(r.uint32(42),r.bytes(t.peerRecordEnvelope)),t.metadata!=null&&t.metadata.size!==0)for(const[i,o]of t.metadata.entries())r.uint32(50),n.Peer$metadataEntry.codec().encode({key:i,value:o},r);if(t.tags!=null&&t.tags.size!==0)for(const[i,o]of t.tags.entries())r.uint32(58),n.Peer$tagsEntry.codec().encode({key:i,value:o},r);t.updated!=null&&(r.uint32(64),r.uint64Number(t.updated)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{var a,c,l,u,h,f;const i={addresses:[],protocols:[],metadata:new Map,tags:new Map},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const g=t.uint32();switch(g>>>3){case 1:{if(((a=s.limits)==null?void 0:a.addresses)!=null&&i.addresses.length===s.limits.addresses)throw new kr('Decode error - map field "addresses" had too many elements');i.addresses.push(so.codec().decode(t,t.uint32(),{limits:(c=s.limits)==null?void 0:c.addresses$}));break}case 2:{if(((l=s.limits)==null?void 0:l.protocols)!=null&&i.protocols.length===s.limits.protocols)throw new kr('Decode error - map field "protocols" had too many elements');i.protocols.push(t.string());break}case 4:{i.publicKey=t.bytes();break}case 5:{i.peerRecordEnvelope=t.bytes();break}case 6:{if(((u=s.limits)==null?void 0:u.metadata)!=null&&i.metadata.size===s.limits.metadata)throw new G1('Decode error - map field "metadata" had too many elements');const p=n.Peer$metadataEntry.codec().decode(t,t.uint32());i.metadata.set(p.key,p.value);break}case 7:{if(((h=s.limits)==null?void 0:h.tags)!=null&&i.tags.size===s.limits.tags)throw new G1('Decode error - map field "tags" had too many elements');const p=n.Peer$tagsEntry.codec().decode(t,t.uint32(),{limits:{value:(f=s.limits)==null?void 0:f.tags$value}});i.tags.set(p.key,p.value);break}case 8:{i.updated=t.uint64Number();break}default:{t.skipType(g&7);break}}}return i})),e),n.encode=t=>Me(t,n.codec()),n.decode=(t,r)=>Oe(t,n.codec(),r)})(Or||(Or={}));var so;(function(n){let e;n.codec=()=>(e==null&&(e=Ue((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(r.uint32(10),r.bytes(t.multiaddr)),t.isCertified!=null&&(r.uint32(16),r.bool(t.isCertified)),t.observed!=null&&(r.uint32(24),r.uint64Number(t.observed)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={multiaddr:ke(0)},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.multiaddr=t.bytes();break}case 2:{i.isCertified=t.bool();break}case 3:{i.observed=t.uint64Number();break}default:{t.skipType(a&7);break}}}return i})),e),n.encode=t=>Me(t,n.codec()),n.decode=(t,r)=>Oe(t,n.codec(),r)})(so||(so={}));var io;(function(n){let e;n.codec=()=>(e==null&&(e=Ue((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.value!=null&&t.value!==0&&(r.uint32(8),r.uint32(t.value)),t.expiry!=null&&(r.uint32(16),r.uint64(t.expiry)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={value:0},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.value=t.uint32();break}case 2:{i.expiry=t.uint64();break}default:{t.skipType(a&7);break}}}return i})),e),n.encode=t=>Me(t,n.codec()),n.decode=(t,r)=>Oe(t,n.codec(),r)})(io||(io={}));function up(n,e){if(n.publicKey!=null||e.publicKey==null)return n;let t;if(n.type==="RSA"){const s=fe.decode(`z${n}`);t=ct(s)}const r=Zr(e.publicKey,t);return To(r)}function Ec(n,e,t){const r=Or.decode(e);return Sc(n,r,t)}function Sc(n,e,t){const r=new Map,s=BigInt(Date.now());for(const[i,o]of e.tags.entries())o.expiry!=null&&o.expiry<s||r.set(i,o);return{...e,id:up(n,e),addresses:e.addresses.filter(({observed:i})=>i!=null&&i>Date.now()-t).map(({multiaddr:i,isCertified:o})=>({multiaddr:se(i),isCertified:o??!1})),metadata:e.metadata,peerRecordEnvelope:e.peerRecordEnvelope??void 0,tags:r}}function dp(n,e){return hp(n.addresses,e.addresses)&&fp(n.protocols,e.protocols)&&pp(n.publicKey,e.publicKey)&&gp(n.peerRecordEnvelope,e.peerRecordEnvelope)&&mp(n.metadata,e.metadata)&&yp(n.tags,e.tags)}function hp(n,e){return m0(n,e,(t,r)=>!(t.isCertified!==r.isCertified||!ie(t.multiaddr,r.multiaddr)))}function fp(n,e){return m0(n,e,(t,r)=>t===r)}function pp(n,e){return g0(n,e)}function gp(n,e){return g0(n,e)}function mp(n,e){return y0(n,e,(t,r)=>ie(t,r))}function yp(n,e){return y0(n,e,(t,r)=>t.value===r.value&&t.expiry===r.expiry)}function g0(n,e){return n==null&&e==null?!0:n!=null&&e!=null?ie(n,e):!1}function m0(n,e,t){if(n.length!==e.length)return!1;for(let r=0;r<n.length;r++)if(!t(n[r],e[r]))return!1;return!0}function y0(n,e,t){if(n.size!==e.size)return!1;for(const[r,s]of n.entries()){const i=e.get(r);if(i==null||!t(s,i))return!1}return!0}const Wt="/",b0=new TextEncoder().encode(Wt),li=b0[0];class Re{constructor(e,t){d(this,"_buf");if(typeof e=="string")this._buf=O(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==li)throw new Error("Invalid key")}toString(e="utf8"){return M(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new Re(e.join(Wt))}static random(){return new Re(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new Re(e):typeof e.uint8Array=="function"?new Re(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=b0),this._buf[0]!==li){const e=new Uint8Array(this._buf.byteLength+1);e.fill(li,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===li;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),r=e.list();for(let s=0;s<t.length;s++){if(r.length<s+1)return!1;const i=t[s],o=r[s];if(i<o)return!0;if(i>o)return!1}return t.length<r.length}reverse(){return Re.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(Wt).slice(1)}type(){return bp(this.baseNamespace())}name(){return wp(this.baseNamespace())}instance(e){return new Re(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(Wt)||(e+=Wt),e+=this.type(),new Re(e)}parent(){const e=this.list();return e.length===1?new Re(Wt):new Re(e.slice(0,-1).join(Wt))}child(e){return this.toString()===Wt?e:e.toString()===Wt?this:new Re(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return Re.withNamespaces([...this.namespaces(),...vp(e.map(t=>t.namespaces()))])}}function bp(n){const e=n.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function wp(n){const e=n.split(":");return e[e.length-1]}function vp(n){return[].concat(...n)}const w0="/peers/";function ui(n){if(!D2(n)||n.type==null)throw new G("Invalid PeerId");const e=n.toCID().toString();return new Re(`${w0}${e}`)}async function Ep(n,e,t,r){const s=new Map;for(const i of t){if(i==null)continue;if(i.multiaddr instanceof Uint8Array&&(i.multiaddr=se(i.multiaddr)),!Ro(i.multiaddr))throw new G("Multiaddr was invalid");if(!await e(n,i.multiaddr))continue;const o=i.isCertified??!1,a=i.multiaddr.toString(),c=s.get(a);c!=null?i.isCertified=c.isCertified||o:s.set(a,{multiaddr:i.multiaddr,isCertified:o})}return[...s.values()].sort((i,o)=>i.multiaddr.toString().localeCompare(o.multiaddr.toString())).map(({isCertified:i,multiaddr:o})=>({isCertified:i,multiaddr:o.bytes}))}async function wa(n,e,t,r){var f,g;if(e==null)throw new G("Invalid PeerData");if(e.publicKey!=null&&n.publicKey!=null&&!e.publicKey.equals(n.publicKey))throw new G("publicKey bytes do not match peer id publicKey bytes");const s=(f=r.existingPeer)==null?void 0:f.peer;if(s!=null&&!n.equals(s.id))throw new G("peer id did not match existing peer id");let i=(s==null?void 0:s.addresses)??[],o=new Set((s==null?void 0:s.protocols)??[]),a=(s==null?void 0:s.metadata)??new Map,c=(s==null?void 0:s.tags)??new Map,l=s==null?void 0:s.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(i=[],e.multiaddrs!=null&&i.push(...e.multiaddrs.map(p=>({isCertified:!1,multiaddr:p}))),e.addresses!=null&&i.push(...e.addresses)),e.protocols!=null&&(o=new Set(e.protocols)),e.metadata!=null){const p=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);a=di(p,{validate:Eu})}if(e.tags!=null){const p=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);c=di(p,{validate:Su,map:_u})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&i.push(...e.multiaddrs.map(p=>({isCertified:!1,multiaddr:p}))),e.addresses!=null&&i.push(...e.addresses),e.protocols!=null&&(o=new Set([...o,...e.protocols])),e.metadata!=null){const p=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(const[m,y]of p)y==null?a.delete(m):a.set(m,y);a=di([...a.entries()],{validate:Eu})}if(e.tags!=null){const p=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),m=new Map(c);for(const[y,E]of p)E==null?m.delete(y):m.set(y,E);c=di([...m.entries()],{validate:Su,map:_u})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}let u;(s==null?void 0:s.id.publicKey)!=null?u=tr(s.id.publicKey):e.publicKey!=null?u=tr(e.publicKey):n.publicKey!=null&&(u=tr(n.publicKey));const h={addresses:await Ep(n,r.addressFilter??(async()=>!0),i,(g=r.existingPeer)==null?void 0:g.peerPB.addresses),protocols:[...o.values()].sort((p,m)=>p.localeCompare(m)),metadata:a,tags:c,publicKey:u,peerRecordEnvelope:l};return h.addresses.forEach(p=>{var m,y,E;p.observed=((E=(y=(m=r.existingPeer)==null?void 0:m.peerPB.addresses)==null?void 0:y.find(_=>ie(_.multiaddr,_.multiaddr)))==null?void 0:E.observed)??Date.now()}),n.type!=="RSA"&&delete h.publicKey,h}function di(n,e){var r;const t=new Map;for(const[s,i]of n)i!=null&&e.validate(s,i);for(const[s,i]of n.sort(([o],[a])=>o.localeCompare(a)))i!=null&&t.set(s,((r=e.map)==null?void 0:r.call(e,s,i))??i);return t}function Eu(n,e){if(typeof n!="string")throw new G("Metadata key must be a string");if(!(e instanceof Uint8Array))throw new G("Metadata value must be a Uint8Array")}function Su(n,e){if(typeof n!="string")throw new G("Tag name must be a string");if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new G("Tag value must be an integer");if(e.value<0||e.value>100)throw new G("Tag value must be between 0-100")}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new G("Tag ttl must be an integer");if(e.ttl<0)throw new G("Tag ttl must be between greater than 0")}}function _u(n,e){let t;return e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl))),{value:e.value??0,expiry:t}}function v0(n){const e=n.toString().split("/")[2],t=Z.parse(e,er);return Ks(t)}function va(n,e,t){const r=v0(n);return Ec(r,e,t)}function Sp(n,e){return{prefix:w0,filters:(n.filters??[]).map(t=>({key:r,value:s})=>t(va(r,s,e))),orders:(n.orders??[]).map(t=>(r,s)=>t(va(r.key,r.value,e),va(s.key,s.value,e)))}}var ot,Ri,Di,Bi;class _p{constructor(e,t={}){re(this,ot);d(this,"peerId");d(this,"datastore");d(this,"lock");d(this,"addressFilter");d(this,"log");d(this,"maxAddressAge");d(this,"maxPeerAge");this.log=e.logger.forComponent("libp2p:peer-store"),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.lock=p0({name:"peer-store",singleProcess:!0}),this.maxAddressAge=t.maxAddressAge??cp,this.maxPeerAge=t.maxPeerAge??lp}async has(e){try{return await this.load(e),!0}catch(t){if(t.name!=="NotFoundError")throw t}return!1}async delete(e){this.peerId.equals(e)||await this.datastore.delete(ui(e))}async load(e){const t=ui(e),r=await this.datastore.get(t),s=Or.decode(r);if(te(this,ot,Bi).call(this,e,s))throw await this.datastore.delete(t),new xr;return Sc(e,s,this.peerId.equals(e)?1/0:this.maxAddressAge)}async save(e,t){const r=await te(this,ot,Ri).call(this,e),s=await wa(e,t,"patch",{addressFilter:this.addressFilter});return te(this,ot,Di).call(this,e,s,r)}async patch(e,t){const r=await te(this,ot,Ri).call(this,e),s=await wa(e,t,"patch",{addressFilter:this.addressFilter,existingPeer:r});return te(this,ot,Di).call(this,e,s,r)}async merge(e,t){const r=await te(this,ot,Ri).call(this,e),s=await wa(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:r});return te(this,ot,Di).call(this,e,s,r)}async*all(e){for await(const{key:t,value:r}of this.datastore.query(Sp(e??{},this.maxAddressAge))){const s=v0(t);if(s.equals(this.peerId))continue;const i=Or.decode(r);if(te(this,ot,Bi).call(this,s,i)){await this.datastore.delete(t);continue}yield Sc(s,i,this.peerId.equals(s)?1/0:this.maxAddressAge)}}}ot=new WeakSet,Ri=async function(e){try{const t=ui(e),r=await this.datastore.get(t),s=Or.decode(r);if(te(this,ot,Bi).call(this,e,s))throw await this.datastore.delete(t),new xr;return{peerPB:s,peer:Ec(e,r,this.maxAddressAge)}}catch(t){t.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",t)}},Di=async function(e,t,r){t.updated=Date.now();const s=Or.encode(t);return await this.datastore.put(ui(e),s),{peer:Ec(e,s,this.maxAddressAge),previous:r==null?void 0:r.peer,updated:r==null||!dp(t,r.peerPB)}},Bi=function(e,t){if(t.updated==null)return!0;if(this.peerId.equals(e))return!1;const r=t.updated<Date.now()-this.maxPeerAge,s=Date.now()-this.maxAddressAge,i=t.addresses.filter(o=>o.observed!=null&&o.observed>s);return r&&i.length===0};var yd,vn,Li;yd=Symbol.toStringTag;class xp{constructor(e,t={}){re(this,vn);d(this,"store");d(this,"events");d(this,"peerId");d(this,"log");d(this,yd,"@libp2p/peer-store");this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new _p(e,t)}async forEach(e,t){this.log.trace("forEach await read lock");const r=await this.store.lock.readLock();this.log.trace("forEach got read lock");try{for await(const s of this.store.all(t))e(s)}finally{this.log.trace("forEach release read lock"),r()}}async all(e){this.log.trace("all await read lock");const t=await this.store.lock.readLock();this.log.trace("all got read lock");try{return await no(this.store.all(e))}finally{this.log.trace("all release read lock"),t()}}async delete(e){this.log.trace("delete await write lock");const t=await this.store.lock.writeLock();this.log.trace("delete got write lock");try{await this.store.delete(e)}finally{this.log.trace("delete release write lock"),t()}}async has(e){this.log.trace("has await read lock");const t=await this.store.lock.readLock();this.log.trace("has got read lock");try{return await this.store.has(e)}finally{this.log.trace("has release read lock"),t()}}async get(e){this.log.trace("get await read lock");const t=await this.store.lock.readLock();this.log.trace("get got read lock");try{return await this.store.load(e)}finally{this.log.trace("get release read lock"),t()}}async save(e,t){this.log.trace("save await write lock");const r=await this.store.lock.writeLock();this.log.trace("save got write lock");try{const s=await this.store.save(e,t);return te(this,vn,Li).call(this,e,s),s.peer}finally{this.log.trace("save release write lock"),r()}}async patch(e,t){this.log.trace("patch await write lock");const r=await this.store.lock.writeLock();this.log.trace("patch got write lock");try{const s=await this.store.patch(e,t);return te(this,vn,Li).call(this,e,s),s.peer}finally{this.log.trace("patch release write lock"),r()}}async merge(e,t){this.log.trace("merge await write lock");const r=await this.store.lock.writeLock();this.log.trace("merge got write lock");try{const s=await this.store.merge(e,t);return te(this,vn,Li).call(this,e,s),s.peer}finally{this.log.trace("merge release write lock"),r()}}async consumePeerRecord(e,t){const r=await Kr.openAndCertify(e,rr.DOMAIN),s=Ks(r.publicKey.toCID());if((t==null?void 0:t.equals(s))===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",t,s),!1;const i=rr.createFromProtobuf(r.payload);let o;try{o=await this.get(s)}catch(a){if(a.name!=="NotFoundError")throw a}if((o==null?void 0:o.peerRecordEnvelope)!=null){const a=await Kr.createFromProtobuf(o.peerRecordEnvelope),c=rr.createFromProtobuf(a.payload);if(c.seqNumber>=i.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",c.seqNumber,i.seqNumber),!1}return await this.patch(i.peerId,{peerRecordEnvelope:e,addresses:i.multiaddrs.map(a=>({isCertified:!0,multiaddr:a}))}),!0}}vn=new WeakSet,Li=function(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))};function kp(n,e={}){return new xp(n,e)}const un=class un extends Error{constructor(t="Not Found"){super(t);d(this,"name",un.name);d(this,"code",un.code)}};d(un,"name","NotFoundError"),d(un,"code","ERR_NOT_FOUND");let _c=un;function Cp(n){return n[Symbol.asyncIterator]!=null}function bs(n){if(Cp(n))return(async()=>{for await(const e of n);})();for(const e of n);}function E0(n){const[e,t]=n[Symbol.asyncIterator]!=null?[n[Symbol.asyncIterator](),Symbol.asyncIterator]:[n[Symbol.iterator](),Symbol.iterator],r=[];return{peek:()=>e.next(),push:s=>{r.push(s)},next:()=>r.length>0?{done:!1,value:r.shift()}:e.next(),[t](){return this}}}function Ap(n){return n[Symbol.asyncIterator]!=null}function sn(n,e){let t=0;if(Ap(n))return async function*(){for await(const c of n)await e(c,t++)&&(yield c)}();const r=E0(n),{value:s,done:i}=r.next();if(i===!0)return function*(){}();const o=e(s,t++);if(typeof o.then=="function")return async function*(){await o&&(yield s);for await(const c of r)await e(c,t++)&&(yield c)}();const a=e;return function*(){o===!0&&(yield s);for(const c of r)a(c,t++)&&(yield c)}()}function Ip(n){return n[Symbol.asyncIterator]!=null}function xu(n,e){return Ip(n)?async function*(){yield*(await no(n)).sort(e)}():function*(){yield*no(n).sort(e)}()}function Pp(n){return n[Symbol.asyncIterator]!=null}function xc(n,e){return Pp(n)?async function*(){let t=0;if(!(e<1)){for await(const r of n)if(yield r,t++,t===e)return}}():function*(){let t=0;if(!(e<1)){for(const r of n)if(yield r,t++,t===e)return}}()}class Tp{put(e,t,r){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:r,value:s}of e)await this.put(r,s,t),yield r}async*getMany(e,t={}){for await(const r of e)yield{key:r,value:await this.get(r,t)}}async*deleteMany(e,t={}){for await(const r of e)await this.delete(r,t),yield r}batch(){let e=[],t=[];return{put(r,s){e.push({key:r,value:s})},delete(r){t.push(r)},commit:async r=>{await bs(this.putMany(e,r)),e=[],await bs(this.deleteMany(t,r)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let r=this._all(e,t);if(e.prefix!=null){const s=e.prefix;r=sn(r,i=>i.key.toString().startsWith(s))}if(Array.isArray(e.filters)&&(r=e.filters.reduce((s,i)=>sn(s,i),r)),Array.isArray(e.orders)&&(r=e.orders.reduce((s,i)=>xu(s,i),r)),e.offset!=null){let s=0;const i=e.offset;r=sn(r,()=>s++>=i)}return e.limit!=null&&(r=xc(r,e.limit)),r}queryKeys(e,t){let r=this._allKeys(e,t);if(e.prefix!=null){const s=e.prefix;r=sn(r,i=>i.toString().startsWith(s))}if(Array.isArray(e.filters)&&(r=e.filters.reduce((s,i)=>sn(s,i),r)),Array.isArray(e.orders)&&(r=e.orders.reduce((s,i)=>xu(s,i),r)),e.offset!=null){const s=e.offset;let i=0;r=sn(r,()=>i++>=s)}return e.limit!=null&&(r=xc(r,e.limit)),r}}class Rp extends Tp{constructor(){super();d(this,"data");this.data=new Map}put(t,r){return this.data.set(t.toString(),r),t}get(t){const r=this.data.get(t.toString());if(r==null)throw new _c;return r}has(t){return this.data.has(t.toString())}delete(t){this.data.delete(t.toString())}*_all(){for(const[t,r]of this.data.entries())yield{key:new Re(t),value:r}}*_allKeys(){for(const t of this.data.keys())yield new Re(t)}}function kc(n,e){let t;const r=function(){const s=function(){t=void 0,n()};clearTimeout(t),t=setTimeout(s,e)};return r.start=()=>{},r.stop=()=>{clearTimeout(t)},r}var S0;(function(){var n,e,t,r,s,i,o,a;a=function(c){var l,u,h,f;return l=(c&255<<24)>>>24,u=(c&255<<16)>>>16,h=(c&65280)>>>8,f=c&255,[l,u,h,f].join(".")},o=function(c){var l,u,h,f,g,p;for(l=[],h=f=0;f<=3&&c.length!==0;h=++f){if(h>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}p=e(c),g=p[0],u=p[1],c=c.substring(u),l.push(g)}if(c.length!==0)throw new Error("Invalid IP");switch(l.length){case 1:if(l[0]>4294967295)throw new Error("Invalid IP");return l[0]>>>0;case 2:if(l[0]>255||l[1]>16777215)throw new Error("Invalid IP");return(l[0]<<24|l[1])>>>0;case 3:if(l[0]>255||l[1]>255||l[2]>65535)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2])>>>0;case 4:if(l[0]>255||l[1]>255||l[2]>255||l[3]>255)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2]<<8|l[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},r=t("0"),i=t("a"),s=t("A"),e=function(c){var l,u,h,f,g;for(f=0,l=10,u="9",h=0,c.length>1&&c[h]==="0"&&(c[h+1]==="x"||c[h+1]==="X"?(h+=2,l=16):"0"<=c[h+1]&&c[h+1]<="9"&&(h++,l=8,u="7")),g=h;h<c.length;){if("0"<=c[h]&&c[h]<=u)f=f*l+(t(c[h])-r)>>>0;else if(l===16)if("a"<=c[h]&&c[h]<="f")f=f*l+(10+t(c[h])-i)>>>0;else if("A"<=c[h]&&c[h]<="F")f=f*l+(10+t(c[h])-s)>>>0;else break;else break;if(f>4294967295)throw new Error("too large");h++}if(h===g)throw new Error("empty octet");return[f,h]},n=function(){function c(l,u){var h,f,g;if(typeof l!="string")throw new Error("Missing `net' parameter");if(u||(g=l.split("/",2),l=g[0],u=g[1]),u||(u=32),typeof u=="string"&&u.indexOf(".")>-1){try{this.maskLong=o(u)}catch{throw new Error("Invalid mask: "+u)}for(h=f=32;f>=0;h=--f)if(this.maskLong===4294967295<<32-h>>>0){this.bitmask=h;break}}else if(u||u===0)this.bitmask=parseInt(u,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(l)&this.maskLong)>>>0}catch{throw new Error("Invalid net address: "+l)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+u);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(l){return typeof l=="string"&&(l.indexOf("/")>0||l.split(".").length!==4)&&(l=new c(l)),l instanceof c?this.contains(l.base)&&this.contains(l.broadcast||l.last):(o(l)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(l){return l==null&&(l=1),new c(a(this.netLong+this.size*l),this.mask)},c.prototype.forEach=function(l){var u,h,f;for(f=o(this.first),h=o(this.last),u=0;f<=h;)l(a(f),f,u),u++,f++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c}(),S0=n}).call(_2);const Dp=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],Bp=Dp.map(n=>new S0(n));function Rl(n){for(const e of Bp)if(e.contains(n))return!0;return!1}function Lp(n){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(n)}function Np(n){const e=n.split(":");if(e.length<2)return!1;const t=e[e.length-1].padStart(4,"0"),r=e[e.length-2].padStart(4,"0"),s=`${parseInt(r.substring(0,2),16)}.${parseInt(r.substring(2),16)}.${parseInt(t.substring(0,2),16)}.${parseInt(t.substring(2),16)}`;return Rl(s)}function Op(n){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(n)}function Mp(n){const e=n.split(":"),t=e[e.length-1];return Rl(t)}function Up(n){return/^::$/.test(n)||/^::1$/.test(n)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(n)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(n)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(n)||/^ff([0-9a-fA-F]{2,2}):/i.test(n)}function Un(n){return An(n)?Rl(n):Lp(n)?Np(n):Op(n)?Mp(n):kl(n)?Up(n):void 0}const Fp=n=>n.toString().split("/").slice(1),Gs=n=>({match:e=>e.length<1?!1:n(e[0])?e.slice(1):!1,pattern:"fn"}),Q=n=>({match:e=>Gs(t=>t===n).match(e),pattern:n}),Fn=()=>({match:n=>Gs(e=>typeof e=="string").match(n),pattern:"{string}"}),ws=()=>({match:n=>Gs(e=>!isNaN(parseInt(e))).match(n),pattern:"{number}"}),le=()=>({match:n=>{if(n.length<2||n[0]!=="p2p"&&n[0]!=="ipfs")return!1;if(n[1].startsWith("Q")||n[1].startsWith("1"))try{fe.decode(`z${n[1]}`)}catch{return!1}else return!1;return n.slice(2)},pattern:"/p2p/{peerid}"}),oo=()=>({match:n=>{if(n.length<2||n[0]!=="certhash")return!1;try{j2.decode(n[1])}catch{return!1}return n.slice(2)},pattern:"/certhash/{certhash}"}),oe=n=>({match:e=>{const t=n.match(e);return t===!1?e:t},pattern:`optional(${n.pattern})`}),Xe=(...n)=>({match:e=>{let t;for(const r of n){const s=r.match(e);s!==!1&&(t==null||s.length<t.length)&&(t=s)}return t??!1},pattern:`or(${n.map(e=>e.pattern).join(", ")})`}),J=(...n)=>({match:e=>{for(const t of n){const r=t.match(e);if(r===!1)return!1;e=r}return e},pattern:`and(${n.map(e=>e.pattern).join(", ")})`});function me(...n){function e(s){let i=Fp(s);for(const o of n){const a=o.match(i);if(a===!1)return!1;i=a}return i}function t(s){return e(s)!==!1}function r(s){const i=e(s);return i===!1?!1:i.length===0}return{matchers:n,matches:t,exactMatch:r}}const $p=le(),Vp=me($p),Bo=J(Q("dns4"),Fn()),Lo=J(Q("dns6"),Fn()),No=J(Q("dnsaddr"),Fn()),Dl=J(Q("dns"),Fn());me(Bo,oe(le()));me(Lo,oe(le()));me(No,oe(le()));me(Xe(Dl,No,Bo,Lo),oe(le()));const _0=J(Q("ip4"),Gs(An)),x0=J(Q("ip6"),Gs(kl)),Bl=Xe(_0,x0),nr=Xe(Bl,Dl,Bo,Lo,No),Hp=me(Xe(Bl,J(Xe(Dl,No,Bo,Lo),oe(le())))),ku=me(_0),Cu=me(x0);me(Bl);const Ll=J(nr,Q("tcp"),ws()),Ws=J(nr,Q("udp"),ws()),ao=me(J(Ll,oe(le())));me(Ws);const Nl=J(Ws,Q("quic"),oe(le())),Oo=J(Ws,Q("quic-v1"),oe(le())),qp=Xe(Nl,Oo);me(Nl);const zp=me(Oo),Cc=Xe(nr,Ll,Ws,Nl,Oo),k0=Xe(J(Cc,Q("ws"),oe(le()))),co=me(k0),C0=Xe(J(Cc,Q("wss"),oe(le())),J(Cc,Q("tls"),oe(J(Q("sni"),Fn())),Q("ws"),oe(le()))),Ac=me(C0),A0=J(Ws,Q("webrtc-direct"),oe(oo()),oe(oo()),oe(le())),Au=me(A0),I0=J(Oo,Q("webtransport"),oe(oo()),oe(oo()),oe(le())),Iu=me(I0),lo=Xe(k0,C0,J(Ll,oe(le())),J(qp,oe(le())),J(nr,oe(le())),A0,I0,le());me(lo);const Kp=J(lo,Q("p2p-circuit"),le()),Ic=me(Kp),jp=Xe(J(lo,Q("p2p-circuit"),Q("webrtc"),oe(le())),J(lo,Q("webrtc"),oe(le())),J(Q("webrtc"),oe(le()))),Pu=me(jp),Gp=Xe(J(nr,Q("tcp"),ws(),Q("http"),oe(le())),J(nr,Q("http"),oe(le())));me(Gp);const Wp=Xe(J(nr,Q("tcp"),Xe(J(Q("443"),Q("http")),J(ws(),Q("https")),J(ws(),Q("tls"),Q("http"))),oe(le())),J(nr,Q("tls"),Q("http"),oe(le())),J(nr,Q("https"),oe(le())));me(Wp);const Qp=Xe(J(Q("memory"),Fn(),oe(le())));me(Qp);const Tu=864e13,Yp=448,Ea=449,Jp=53,Zp=54,Xp=55,eg=56;class tg{constructor(e,t={}){d(this,"log");d(this,"mappings");this.log=e.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=new Map}has(e){const t=this.findHost(e);for(const r of this.mappings.values())if(r.domain===t)return!0;return!1}add(e,t){t.forEach(r=>{this.log("add DNS mapping %s to %s",r,e);const s=Un(r)===!0;this.mappings.set(r,{domain:e,verified:s,expires:s?Tu-Date.now():0,lastVerified:s?Tu-Date.now():void 0})})}remove(e){const t=this.findHost(e);let r=!1;for(const[s,i]of this.mappings.entries())i.domain===t&&(this.log("removing %s to %s DNS mapping %e",s,i.domain,new Error("where")),this.mappings.delete(s),r=r||i.verified);return r}getAll(e){const t=[];for(let r=0;r<e.length;r++){const i=e[r].multiaddr.stringTuples(),o=i[0][1];if(o!=null)for(const[a,c]of this.mappings.entries()){if(o!==a)continue;this.maybeAddSNITuple(i,c.domain)&&(e.splice(r,1),r--,t.push({multiaddr:se(`/${i.map(u=>[ce(u[0]).name,u[1]].join("/")).join("/")}`),verified:c.verified,type:"dns-mapping",expires:c.expires,lastVerified:c.lastVerified}))}}return t}maybeAddSNITuple(e,t){var r;for(let s=0;s<e.length;s++)if(e[s][0]===Yp&&((r=e[s+1])==null?void 0:r[0])!==Ea)return e.splice(s+1,0,[Ea,t]),!0;return!1}confirm(e,t){const r=this.findHost(e);let s=!1;for(const[i,o]of this.mappings.entries())o.domain===r&&(this.log("marking %s to %s DNS mapping as verified",i,o.domain),s=o.verified,o.verified=!0,o.expires=Date.now()+t,o.lastVerified=Date.now());return s}unconfirm(e,t){const r=this.findHost(e);let s=!1;for(const[i,o]of this.mappings.entries())o.domain===r&&(this.log("removing verification of %s to %s DNS mapping",i,o.domain),s=s||o.verified,o.verified=!1,o.expires=Date.now()+t);return s}findHost(e){for(const t of e.stringTuples())if(t[0]===Ea||t[0]===Jp||t[0]===Zp||t[0]===Xp||t[0]===eg)return t[1]}}const Sa=4,_a=41,xa=6,rg=273;class ng{constructor(e,t={}){d(this,"log");d(this,"mappings");this.log=e.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=new Map}has(e){const t=e.stringTuples();for(const r of this.mappings.values())for(const s of r)if(s.externalIp===t[0][1])return!0;return!1}add(e,t,r,s=t,i="tcp"){const o=`${e}-${t}-${i}`,a=this.mappings.get(o)??[],c={internalIp:e,internalPort:t,externalIp:r,externalPort:s,externalFamily:An(r)?4:6,protocol:i,verified:!1,expires:0};a.push(c),this.mappings.set(o,a)}remove(e){const t=e.stringTuples(),r=t[0][1]??"",s=t[1][0]===xa?"tcp":"udp",i=parseInt(t[1][1]??"0");let o=!1;for(const[a,c]of this.mappings.entries()){for(let l=0;l<c.length;l++){const u=c[l];u.externalIp===r&&u.externalPort===i&&u.protocol===s&&(this.log("removing %s:%s to %s:%s %s IP mapping",u.externalIp,u.externalPort,r,i,s),o=o||u.verified,c.splice(l,1),l--)}c.length===0&&this.mappings.delete(a)}return o}getAll(e){const t=[];for(const{multiaddr:r}of e){const s=r.stringTuples();let i;if((s[0][0]===Sa||s[0][0]===_a)&&s[1][0]===xa?i=`${s[0][1]}-${s[1][1]}-tcp`:(s[0][0]===Sa||s[0][0]===_a)&&s[1][0]===rg&&(i=`${s[0][1]}-${s[1][1]}-udp`),i==null)continue;const o=this.mappings.get(i);if(o!=null)for(const a of o)s[0][0]=a.externalFamily===4?Sa:_a,s[0][1]=a.externalIp,s[1][1]=`${a.externalPort}`,t.push({multiaddr:se(`/${s.map(c=>[ce(c[0]).name,c[1]].join("/")).join("/")}`),verified:a.verified,type:"ip-mapping",expires:a.expires,lastVerified:a.lastVerified})}return t}confirm(e,t){const s=e.stringTuples()[0][1];let i=!1;for(const o of this.mappings.values())for(const a of o)a.externalIp===s&&(this.log("marking %s to %s IP mapping as verified",a.internalIp,a.externalIp),i=a.verified,a.verified=!0,a.expires=Date.now()+t,a.lastVerified=Date.now());return i}unconfirm(e,t){const r=e.stringTuples(),s=r[0][1]??"",i=r[1][0]===xa?"tcp":"udp",o=parseInt(r[1][1]??"0");let a=!1;for(const c of this.mappings.values())for(let l=0;l<c.length;l++){const u=c[l];u.externalIp===s&&u.externalPort===o&&u.protocol===i&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",u.externalIp,u.externalPort,s,o,i),a=a||u.verified,u.verified=!1,u.expires=Date.now()+t)}return a}}const sg=4,ig=41;function og(n){try{const[[e,t]]=n.stringTuples();if(t==null)return!1;if(e===sg)return t.startsWith("169.254.");if(e===ig)return t.toLowerCase().startsWith("fe80")}catch{}return!1}const ag=4,cg=41;function P0(n){try{const[[e]]=n.stringTuples();return e===ag||e===cg}catch{}return!1}function vs(n){try{if(!P0(n))return!1;const[[,e]]=n.stringTuples();return e==null?!1:Un(e)??!1}catch{}return!0}const lg={maxObservedAddresses:10};class ug{constructor(e,t={}){d(this,"log");d(this,"addresses");d(this,"maxObservedAddresses");this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=new Map,this.maxObservedAddresses=t.maxObservedAddresses??lg.maxObservedAddresses}has(e){return this.addresses.has(e.toString())}removePrefixed(e){for(const t of this.addresses.keys())t.toString().startsWith(e)&&this.addresses.delete(t)}add(e){this.addresses.size!==this.maxObservedAddresses&&(vs(e)||og(e)||(this.log("adding observed address %a",e),this.addresses.set(e.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([e,t])=>({multiaddr:se(e),verified:t.verified,type:"observed",expires:t.expires,lastVerified:t.lastVerified}))}remove(e){var r;const t=((r=this.addresses.get(e.toString()))==null?void 0:r.verified)??!1;return this.log("removing observed address %a",e),this.addresses.delete(e.toString()),t}confirm(e,t){const r=e.toString(),s=this.addresses.get(r)??{verified:!1,expires:Date.now()+t,lastVerified:Date.now()},i=s.verified;return s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now(),this.log("marking observed address %a as verified",r),this.addresses.set(r,s),i}}const dg=4,hg=41,fg=53,pg=54,gg=55,mg=56,yg=[dg,hg,fg,pg,gg,mg];function Ru(n){try{const[[e]]=n.stringTuples();return yg.includes(e)}catch{}return!1}const bg={maxObservedAddresses:10};class wg{constructor(e,t={}){d(this,"log");d(this,"addresses");d(this,"maxObservedAddresses");this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=new Map,this.maxObservedAddresses=t.maxObservedAddresses??bg.maxObservedAddresses}get(e,t){if(vs(e))return{multiaddr:e,verified:!0,type:"transport",expires:Date.now()+t,lastVerified:Date.now()};const r=this.toKey(e);let s=this.addresses.get(r);return s==null&&(s={verified:!Ru(e),expires:0},this.addresses.set(r,s)),{multiaddr:e,verified:s.verified,type:"transport",expires:s.expires,lastVerified:s.lastVerified}}has(e){const t=this.toKey(e);return this.addresses.has(t)}remove(e){var s;const t=this.toKey(e),r=((s=this.addresses.get(t))==null?void 0:s.verified)??!1;return this.log("removing observed address %a",e),this.addresses.delete(t),r}confirm(e,t){const r=this.toKey(e),s=this.addresses.get(r)??{verified:!1,expires:0,lastVerified:0},i=s.verified;return s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now(),this.addresses.set(r,s),i}unconfirm(e,t){const r=this.toKey(e),s=this.addresses.get(r)??{verified:!1,expires:0},i=s.verified;return s.verified=!1,s.expires=Date.now()+t,this.addresses.set(r,s),i}toKey(e){if(Ru(e)){const t=e.toOptions();return`${t.host}-${t.port}-${t.transport}`}return e.toString()}}const Du=6e4,Bu={addressVerificationTTL:Du*10,addressVerificationRetry:Du*5},vg=n=>n;function ka(n,e){const t=n.getPeerId();return t!=null&&qr(t).equals(e)&&(n=n.decapsulate(se(`/p2p/${e.toString()}`))),n}var bd;bd=Symbol.toStringTag;class Eg{constructor(e,t={}){d(this,"log");d(this,"components");d(this,"listen");d(this,"announce");d(this,"appendAnnounce");d(this,"announceFilter");d(this,"observed");d(this,"dnsMappings");d(this,"ipMappings");d(this,"transportAddresses");d(this,"observedAddressFilter");d(this,"addressVerificationTTL");d(this,"addressVerificationRetry");d(this,bd,"@libp2p/address-manager");const{listen:r=[],announce:s=[],appendAnnounce:i=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=r.map(o=>o.toString()),this.announce=new Set(s.map(o=>o.toString())),this.appendAnnounce=new Set(i.map(o=>o.toString())),this.observed=new ug(e,t),this.dnsMappings=new tg(e,t),this.ipMappings=new ng(e,t),this.transportAddresses=new wg(e,t),this.announceFilter=t.announceFilter??vg,this.observedAddressFilter=f0(1024),this.addressVerificationTTL=t.addressVerificationTTL??Bu.addressVerificationTTL,this.addressVerificationRetry=t.addressVerificationRetry??Bu.addressVerificationRetry,this._updatePeerStoreAddresses=kc(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}_updatePeerStoreAddresses(){const e=this.getAddresses().map(t=>t.getPeerId()===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{this.log.error("error updating addresses",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>se(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>se(e))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(e=>se(e))}getObservedAddrs(){return this.observed.getAll().map(e=>e.multiaddr)}addObservedAddr(e){const t=e.stringTuples(),r=`${t[0][1]}:${t[1][1]}`;this.observedAddressFilter.has(r)||(this.observedAddressFilter.add(r),e=ka(e,this.components.peerId),!this.ipMappings.has(e)&&(this.dnsMappings.has(e)||this.observed.add(e)))}confirmObservedAddr(e,t){e=ka(e,this.components.peerId);let r=!0;((t==null?void 0:t.type)==="transport"||this.transportAddresses.has(e))&&!this.transportAddresses.confirm(e,(t==null?void 0:t.ttl)??this.addressVerificationTTL)&&r&&(r=!1),((t==null?void 0:t.type)==="dns-mapping"||this.dnsMappings.has(e))&&!this.dnsMappings.confirm(e,(t==null?void 0:t.ttl)??this.addressVerificationTTL)&&r&&(r=!1),((t==null?void 0:t.type)==="ip-mapping"||this.ipMappings.has(e))&&!this.ipMappings.confirm(e,(t==null?void 0:t.ttl)??this.addressVerificationTTL)&&r&&(r=!1),((t==null?void 0:t.type)==="observed"||this.observed.has(e))&&(this.maybeUpgradeToIPMapping(e)?(this.ipMappings.confirm(e,(t==null?void 0:t.ttl)??this.addressVerificationTTL),r=!1):!this.observed.confirm(e,(t==null?void 0:t.ttl)??this.addressVerificationTTL)&&r&&(r=!1)),r||this._updatePeerStoreAddresses()}removeObservedAddr(e,t){e=ka(e,this.components.peerId),this.observed.has(e)&&this.observed.remove(e),this.transportAddresses.has(e)&&this.transportAddresses.unconfirm(e,(t==null?void 0:t.ttl)??this.addressVerificationRetry),this.dnsMappings.has(e)&&this.dnsMappings.unconfirm(e,(t==null?void 0:t.ttl)??this.addressVerificationRetry),this.ipMappings.has(e)&&this.ipMappings.unconfirm(e,(t==null?void 0:t.ttl)??this.addressVerificationRetry)}getAddresses(){const e=new Set,t=this.getAddressesWithMetadata().filter(r=>{if(!r.verified)return!1;const s=r.multiaddr.toString();return e.has(s)?!1:(e.add(s),!0)}).map(r=>r.multiaddr);return this.announceFilter(t.map(r=>{var i;const s=se(r);return((i=s.protos().pop())==null?void 0:i.path)===!0||s.getPeerId()===this.components.peerId.toString()?s:s.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){const e=this.getAnnounceAddrs();if(e.length>0)return this.components.transportManager.getListeners().forEach(s=>{s.updateAnnounceAddrs(e)}),e.map(s=>({multiaddr:s,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let t=[];t=t.concat(this.components.transportManager.getAddrs().map(s=>this.transportAddresses.get(s,this.addressVerificationTTL)));const r=this.getAppendAnnounceAddrs();return r.length>0&&(this.components.transportManager.getListeners().forEach(s=>{s.updateAnnounceAddrs(r)}),t=t.concat(r.map(s=>({multiaddr:s,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})))),t=t.concat(this.observed.getAll()),t=t.concat(this.ipMappings.getAll(t)),t=t.concat(this.dnsMappings.getAll(t)),t}addDNSMapping(e,t){this.dnsMappings.add(e,t)}removeDNSMapping(e){this.dnsMappings.remove(se(`/dns/${e}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(e,t,r,s=t,i="tcp"){this.ipMappings.add(e,t,r,s,i),this.observed.removePrefixed(`/ip${An(r)?4:6}/${r}/${i}/${s}`)}removePublicAddressMapping(e,t,r,s=t,i="tcp"){this.ipMappings.remove(se(`/ip${An(r)?4:6}/${r}/${i}/${s}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(e){if(this.ipMappings.has(e))return!1;const t=e.toOptions();if(t.family===6||t.host==="127.0.0.1"||Un(t.host)===!0)return!1;const r=this.components.transportManager.getListeners(),s=[i=>co.exactMatch(i)||Ac.exactMatch(i),i=>ao.exactMatch(i),i=>zp.exactMatch(i)];for(const i of s){if(!i(e))continue;const o=r.filter(l=>l.getAddrs().filter(u=>u.toOptions().family===4&&i(u)).length>0);if(o.length!==1)continue;const a=o[0].getAddrs().filter(l=>l.toOptions().host!=="127.0.0.1").pop();if(a==null)continue;const c=a.toOptions();return this.observed.remove(e),this.ipMappings.add(c.host,c.port,t.host,t.port,t.transport),!0}return!1}}var Lu;(function(n){n.NOT_STARTED_YET="The libp2p node is not started yet",n.NOT_FOUND="Not found"})(Lu||(Lu={}));class Sg extends Error{constructor(e="Missing service"){super(e),this.name="MissingServiceError"}}class _g extends Error{constructor(e="Unmet service dependencies"){super(e),this.name="UnmetServiceDependenciesError"}}class Ca extends Error{constructor(e="No content routers available"){super(e),this.name="NoContentRoutersError"}}class Nu extends Error{constructor(e="No peer routers available"){super(e),this.name="NoPeerRoutersError"}}class xg extends Error{constructor(e="Should not try to find self"){super(e),this.name="QueriedForSelfError"}}class kg extends Error{constructor(e="Unhandled protocol error"){super(e),this.name="UnhandledProtocolError"}}class Cg extends Error{constructor(e="Duplicate protocol handler error"){super(e),this.name="DuplicateProtocolHandlerError"}}class Ou extends Error{constructor(e="Dial denied error"){super(e),this.name="DialDeniedError"}}class Ag extends Error{constructor(e="No transport was configured to listen on this address"){super(e),this.name="UnsupportedListenAddressError"}}class Ig extends Error{constructor(e="Configured listen addresses could not be listened on"){super(e),this.name="UnsupportedListenAddressesError"}}class Pg extends Error{constructor(e="No valid addresses"){super(e),this.name="NoValidAddressesError"}}class Tg extends Error{constructor(e="Connection intercepted"){super(e),this.name="ConnectionInterceptedError"}}class Rg extends Error{constructor(e="Connection denied"){super(e),this.name="ConnectionDeniedError"}}class hi extends Error{constructor(e="Stream is not multiplexed"){super(e),this.name="MuxerUnavailableError"}}class fi extends Error{constructor(e="Encryption failed"){super(e),this.name="EncryptionFailedError"}}class Dg extends Error{constructor(e="Transport unavailable"){super(e),this.name="TransportUnavailableError"}}class Bg{constructor(e={}){d(this,"components",{});d(this,"_started",!1);this.components={};for(const[t,r]of Object.entries(e))this.components[t]=r;this.components.logger==null&&(this.components.logger=l0())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>nl(t)).map(async t=>{var r;await((r=t[e])==null?void 0:r.call(t))}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const Lg=["metrics","connectionProtector","dns"],Ng=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function Og(n={}){const e=new Bg(n);return new Proxy(e,{get(r,s,i){if(typeof s=="string"&&!Ng.includes(s)){const o=e.components[s];if(o==null&&!Lg.includes(s))throw new Sg(`${s} not set`);return o}return Reflect.get(r,s,i)},set(r,s,i){return typeof s=="string"?e.components[s]=i:Reflect.set(r,s,i),!0}})}function Mg(n){const e={};for(const t of Object.values(n.components))for(const r of Ug(t))e[r]=!0;for(const t of Object.values(n.components))for(const r of Fg(t))if(e[r]!==!0)throw new _g(`Service "${$g(t)}" required capability "${r}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function Ug(n){return Array.isArray(n==null?void 0:n[Sn])?n[Sn]:[]}function Fg(n){return Array.isArray(n==null?void 0:n[ec])?n[ec]:[]}function $g(n){return(n==null?void 0:n[Symbol.toStringTag])??(n==null?void 0:n.toString())??"unknown"}const Vg=4,Hg=41;function qg(n={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{if(co.matches(e))return!1;const t=e.stringTuples();return t[0][0]===Vg||t[0][0]===Hg?!!Un(`${t[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...n}}const Mu=()=>{const n=new Error("Delay aborted");return n.name="AbortError",n},zg=new WeakMap;function Kg({clearTimeout:n,setTimeout:e}={}){return(t,{value:r,signal:s}={})=>{if(s!=null&&s.aborted)return Promise.reject(Mu());let i,o,a;const c=n??clearTimeout,l=()=>{c(i),a(Mu())},u=()=>{s&&s.removeEventListener("abort",l)},h=new Promise((f,g)=>{o=()=>{u(),f(r)},a=g,i=(e??setTimeout)(o,t)});return s&&s.addEventListener("abort",l,{once:!0}),zg.set(h,()=>{c(i),i=null,o()}),h}}const jg=Kg();class Gg extends Error{constructor(t="Rate limit exceeded",r){super(t);d(this,"remainingPoints");d(this,"msBeforeNext");d(this,"consumedPoints");d(this,"isFirstInDuration");this.name="RateLimitError",this.remainingPoints=r.remainingPoints,this.msBeforeNext=r.msBeforeNext,this.consumedPoints=r.consumedPoints,this.isFirstInDuration=r.isFirstInDuration}}class T0 extends Error{constructor(e="The queue was full"){super(e),this.name="QueueFullError"}}d(T0,"name","QueueFullError");class Wg{constructor(e={}){d(this,"memoryStorage");d(this,"points");d(this,"duration");d(this,"blockDuration");d(this,"execEvenly");d(this,"execEvenlyMinDelayMs");d(this,"keyPrefix");this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.execEvenly=e.execEvenly??!1,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs??this.duration*1e3/this.points,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new Qg}async consume(e,t=1,r={}){const s=this.getKey(e),i=this._getKeySecDuration(r);let o=this.memoryStorage.incrby(s,t,i);if(o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.consumedPoints>this.points)throw this.blockDuration>0&&o.consumedPoints<=this.points+t&&(o=this.memoryStorage.set(s,o.consumedPoints,this.blockDuration)),new Gg("Rate limit exceeded",o);if(this.execEvenly&&o.msBeforeNext>0&&!o.isFirstInDuration){let a=Math.ceil(o.msBeforeNext/(o.remainingPoints+2));a<this.execEvenlyMinDelayMs&&(a=o.consumedPoints*this.execEvenlyMinDelayMs),await jg(a)}return o}penalty(e,t=1,r={}){const s=this.getKey(e),i=this._getKeySecDuration(r),o=this.memoryStorage.incrby(s,t,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}reward(e,t=1,r={}){const s=this.getKey(e),i=this._getKeySecDuration(r),o=this.memoryStorage.incrby(s,-t,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}block(e,t){const r=t*1e3,s=this.points+1;return this.memoryStorage.set(this.getKey(e),s,t),{remainingPoints:0,msBeforeNext:r===0?-1:r,consumedPoints:s,isFirstInDuration:!1}}set(e,t,r=0){const s=(r>=0?r:this.duration)*1e3;return this.memoryStorage.set(this.getKey(e),t,r),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:t,isFirstInDuration:!1}}get(e){const t=this.memoryStorage.get(this.getKey(e));return t!=null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return(e==null?void 0:e.customDuration)!=null&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}}class Qg{constructor(){d(this,"storage");this.storage=new Map}incrby(e,t,r){const s=this.storage.get(e);if(s!=null){const i=s.expiresAt!=null?s.expiresAt.getTime()-new Date().getTime():-1;return s.expiresAt==null||i>0?(s.value+=t,{remainingPoints:0,msBeforeNext:i,consumedPoints:s.value,isFirstInDuration:!1}):this.set(e,t,r)}return this.set(e,t,r)}set(e,t,r){const s=r*1e3,i=this.storage.get(e);i!=null&&clearTimeout(i.timeoutId);const o={value:t,expiresAt:s>0?new Date(Date.now()+s):void 0};return this.storage.set(e,o),s>0&&(o.timeoutId=setTimeout(()=>{this.storage.delete(e)},s),o.timeoutId.unref!=null&&o.timeoutId.unref()),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:o.value,isFirstInDuration:!0}}get(e){const t=this.storage.get(e);if(t!=null)return{remainingPoints:0,msBeforeNext:t.expiresAt!=null?t.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){const t=this.storage.get(e);return t!=null?(t.timeoutId!=null&&clearTimeout(t.timeoutId),this.storage.delete(e),!0):!1}}function R0(n){if(D2(n))return{peerId:n,multiaddrs:[]};let e=Array.isArray(n)?n:[n],t;if(e.length>0){const r=e[0].getPeerId();t=r==null?void 0:qr(r),e.forEach(s=>{if(!Ro(s))throw new vo("Invalid multiaddr");const i=s.getPeerId();if(i==null){if(t!=null)throw new G("Multiaddrs must all have the same peer id or have no peer id")}else{const o=qr(i);if((t==null?void 0:t.equals(o))!==!0)throw new G("Multiaddrs must all have the same peer id or have no peer id")}})}return e=e.filter(r=>!Vp.exactMatch(r)),{peerId:t,multiaddrs:e}}const Yg=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function Jg(n,e){var s;const t=((s=n==null?void 0:n.streams)==null?void 0:s.map(i=>i.protocol))??[],r=(e==null?void 0:e.closableProtocols)??Yg;if(!(t.filter(i=>i!=null&&!r.includes(i)).length>0))try{await(n==null?void 0:n.close(e))}catch(i){n==null||n.abort(i)}}const D0=1e4,Zg=1e4,Uu=1e4,B0=25,Xg=5,em=10,tm=5,rm="last-dial-failure",nm="last-dial-success",L0=500,N0=100,O0=50;async function sm(n,e){let t=!1;for(const s of Il.keys())if(t=n.protoNames().includes(s),t)break;if(!t)return[n];const r=await n.resolve(e);return e.log("resolved %s to",n,r.map(s=>s.toString())),r}function Pc(n){try{let e;if(typeof n=="string"?e=se(n):e=n,!e.protoNames().includes("ipcidr")){const r=e.protoNames().includes("ip6")?"/ipcidr/128":"/ipcidr/32";e=e.encapsulate(r)}return Q7(e)}catch{throw new Error(`Can't convert to IpNet, Invalid multiaddr format: ${n}`)}}const im={maxConnections:N0};class om{constructor(e,t={}){d(this,"maxConnections");d(this,"connectionManager");d(this,"peerStore");d(this,"allow");d(this,"events");d(this,"log");this.maxConnections=t.maxConnections??im.maxConnections,this.allow=(t.allow??[]).map(r=>Pc(r)),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(e=>{this.log.error("error while pruning connections %e",e)})}async _maybePruneConnections(){const e=this.connectionManager.getConnections(),t=e.length;if(this.log("checking max connections limit %d/%d",t,this.maxConnections),t<=this.maxConnections)return;const r=new js;for(const a of e){const c=a.remotePeer;if(!r.has(c)){r.set(c,0);try{const l=await this.peerStore.get(c);r.set(c,[...l.tags.values()].reduce((u,h)=>u+h.value,0))}catch(l){l.name!=="NotFoundError"&&this.log.error("error loading peer tags",l)}}}const s=this.sortConnections(e,r),i=Math.max(t-this.maxConnections,0),o=[];for(const a of s)if(this.log("too many connections open - closing a connection to %p",a.remotePeer),this.allow.some(l=>l.contains(a.remoteAddr.nodeAddress().address))||o.push(a),o.length===i)break;await Promise.all(o.map(async a=>{await Jg(a,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:o})}sortConnections(e,t){return e.sort((r,s)=>{const i=r.timeline.open,o=s.timeline.open;return i<o?1:i>o?-1:0}).sort((r,s)=>r.direction==="outbound"&&s.direction==="inbound"?1:r.direction==="inbound"&&s.direction==="outbound"?-1:0).sort((r,s)=>r.streams.length>s.streams.length?1:r.streams.length<s.streams.length?-1:0).sort((r,s)=>{const i=t.get(r.remotePeer)??0,o=t.get(s.remotePeer)??0;return i>o?1:i<o?-1:0})}}function Le(){const n={};return n.promise=new Promise((e,t)=>{n.resolve=e,n.reject=t}),n}class Fu{constructor(e){d(this,"buffer");d(this,"mask");d(this,"top");d(this,"btm");d(this,"next");if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}}class Aa{constructor(e={}){d(this,"size");d(this,"hwm");d(this,"head");d(this,"tail");this.hwm=e.splitLimit??16,this.head=new Fu(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return(e==null?void 0:e.byteLength)!=null?e.byteLength:1}push(e){if((e==null?void 0:e.value)!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new Fu(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return(e==null?void 0:e.value)!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}let am=class extends Error{constructor(t,r){super(t??"The operation was aborted");d(this,"type");d(this,"code");this.type="aborted",this.code=r??"ABORT_ERR"}};function M0(n={}){return cm(t=>{const r=t.shift();if(r==null)return{done:!0};if(r.error!=null)throw r.error;return{done:r.done===!0,value:r.value}},n)}function cm(n,e){e=e??{};let t=e.onEnd,r=new Aa,s,i,o,a=Le();const c=async()=>{try{return r.isEmpty()?o?{done:!0}:await new Promise((y,E)=>{i=_=>{i=null,r.push(_);try{y(n(r))}catch(w){E(w)}return s}}):n(r)}finally{r.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=Le()})}},l=y=>i!=null?i(y):(r.push(y),s),u=y=>(r=new Aa,i!=null?i({error:y}):(r.push({error:y}),s)),h=y=>{if(o)return s;if((e==null?void 0:e.objectMode)!==!0&&(y==null?void 0:y.byteLength)==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:y})},f=y=>o?s:(o=!0,y!=null?u(y):l({done:!0})),g=()=>(r=new Aa,f(),{done:!0}),p=y=>(f(y),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:c,return:g,throw:p,push:h,end:f,get readableLength(){return r.size},onEmpty:async y=>{const E=y==null?void 0:y.signal;if(E==null||E.throwIfAborted(),r.isEmpty())return;let _,w;E!=null&&(_=new Promise((b,v)=>{w=()=>{v(new am)},E.addEventListener("abort",w)}));try{await Promise.race([a.promise,_])}finally{w!=null&&E!=null&&(E==null||E.removeEventListener("abort",w))}}},t==null)return s;const m=s;return s={[Symbol.asyncIterator](){return this},next(){return m.next()},throw(y){return m.throw(y),t!=null&&(t(y),t=void 0),{done:!0}},return(){return m.return(),t!=null&&(t(),t=void 0),{done:!0}},push:h,end(y){return m.end(y),t!=null&&(t(y),t=void 0),s},get readableLength(){return m.readableLength},onEmpty:y=>m.onEmpty(y)},s}let lm=class extends Error{constructor(t,r){super(t??"The operation was aborted");d(this,"type");d(this,"code");this.type="aborted",this.name="AbortError",this.code=r??"ABORT_ERR"}};async function Ni(n,e,t,r){const s=new lm(r==null?void 0:r.errorMessage,r==null?void 0:r.errorCode);return(t==null?void 0:t.aborted)===!0?Promise.reject(s):new Promise((i,o)=>{function a(){t==null||t.removeEventListener("abort",u),n.removeEventListener(e,c),(r==null?void 0:r.errorEvent)!=null&&n.removeEventListener(r.errorEvent,l)}const c=h=>{var f;try{if(((f=r==null?void 0:r.filter)==null?void 0:f.call(r,h))===!1)return}catch(g){a(),o(g);return}a(),i(h)},l=h=>{a(),o(h.detail)},u=()=>{a(),o(s)};t==null||t.addEventListener("abort",u),n.addEventListener(e,c),(r==null?void 0:r.errorEvent)!=null&&n.addEventListener(r.errorEvent,l)})}let $u=class extends Error{constructor(t,r,s){super(t??"The operation was aborted");d(this,"type");d(this,"code");this.type="aborted",this.name=s??"AbortError",this.code=r??"ABORT_ERR"}};async function Gr(n,e,t){if(e==null)return n;if(e.aborted)return n.catch(()=>{}),Promise.reject(new $u(t==null?void 0:t.errorMessage,t==null?void 0:t.errorCode,t==null?void 0:t.errorName));let r;const s=new $u(t==null?void 0:t.errorMessage,t==null?void 0:t.errorCode,t==null?void 0:t.errorName);try{return await Promise.race([n,new Promise((i,o)=>{r=()=>{o(s)},e.addEventListener("abort",r)})])}finally{r!=null&&e.removeEventListener("abort",r)}}class um{constructor(e){d(this,"deferred");d(this,"signal");var t;this.signal=e,this.deferred=Le(),this.onAbort=this.onAbort.bind(this),(t=this.signal)==null||t.addEventListener("abort",this.onAbort)}onAbort(){var e;this.deferred.reject(((e=this.signal)==null?void 0:e.reason)??new ds)}cleanup(){var e;(e=this.signal)==null||e.removeEventListener("abort",this.onAbort)}}function dm(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}class hm{constructor(e,t){d(this,"id");d(this,"fn");d(this,"options");d(this,"recipients");d(this,"status");d(this,"timeline");d(this,"controller");this.id=dm(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,r)=>{var s;return t&&((s=r.signal)==null?void 0:s.aborted)===!0},!0)&&(this.controller.abort(new ds),this.cleanup())}async join(e={}){var r;const t=new um(e.signal);return this.recipients.push(t),(r=e.signal)==null||r.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await Gr(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{var t;e.cleanup(),(t=e.signal)==null||t.removeEventListener("abort",this.onAbort)})}}class Mo extends sr{constructor(t={}){var r;super();d(this,"concurrency");d(this,"maxSize");d(this,"queue");d(this,"pending");d(this,"sort");this.concurrency=t.concurrency??Number.POSITIVE_INFINITY,this.maxSize=t.maxSize??Number.POSITIVE_INFINITY,this.pending=0,t.metricName!=null&&((r=t.metrics)==null||r.registerMetricGroup(t.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})})),this.sort=t.sort,this.queue=[],this.emitEmpty=kc(this.emitEmpty.bind(this),1),this.emitIdle=kc(this.emitIdle.bind(this),1)}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let t;for(const r of this.queue)if(r.status==="queued"){t=r;break}return t==null?!1:(this.safeDispatchEvent("active"),this.pending++,t.run().finally(()=>{for(let r=0;r<this.queue.length;r++)if(this.queue[r]===t){this.queue.splice(r,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(t){this.queue.push(t),this.sort!=null&&this.queue.sort(this.sort)}async add(t,r){var i;if((i=r==null?void 0:r.signal)==null||i.throwIfAborted(),this.size===this.maxSize)throw new T0;const s=new hm(t,r);return this.enqueue(s),this.safeDispatchEvent("add"),this.tryToStartAnother(),s.join(r).then(o=>(this.safeDispatchEvent("completed",{detail:o}),this.safeDispatchEvent("success",{detail:{job:s,result:o}}),o)).catch(o=>{if(s.status==="queued"){for(let a=0;a<this.queue.length;a++)if(this.queue[a]===s){this.queue.splice(a,1);break}}throw this.safeDispatchEvent("error",{detail:o}),this.safeDispatchEvent("failure",{detail:{job:s,error:o}}),o})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(t=>{t.abort(new ds)}),this.clear()}async onEmpty(t){this.size!==0&&await Ni(this,"empty",t==null?void 0:t.signal)}async onSizeLessThan(t,r){this.size<t||await Ni(this,"next",r==null?void 0:r.signal,{filter:()=>this.size<t})}async onIdle(t){this.pending===0&&this.size===0||await Ni(this,"idle",t==null?void 0:t.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(t){var l,u,h;(l=t==null?void 0:t.signal)==null||l.throwIfAborted();const r=M0({objectMode:!0}),s=f=>{f!=null?this.abort():this.clear(),r.end(f)},i=f=>{f.detail!=null&&r.push(f.detail)},o=f=>{s(f.detail)},a=()=>{s()},c=()=>{s(new ds("Queue aborted"))};this.addEventListener("completed",i),this.addEventListener("error",o),this.addEventListener("idle",a),(u=t==null?void 0:t.signal)==null||u.addEventListener("abort",c);try{yield*r}finally{this.removeEventListener("completed",i),this.removeEventListener("error",o),this.removeEventListener("idle",a),(h=t==null?void 0:t.signal)==null||h.removeEventListener("abort",c),s()}}}class fm extends Mo{constructor(e={}){super({...e,sort:(t,r)=>t.options.priority>r.options.priority?-1:t.options.priority<r.options.priority?1:0})}}function zt(n){const e=new globalThis.AbortController;function t(){e.abort();for(const i of n)(i==null?void 0:i.removeEventListener)!=null&&i.removeEventListener("abort",t)}for(const i of n){if((i==null?void 0:i.aborted)===!0){t();break}(i==null?void 0:i.addEventListener)!=null&&i.addEventListener("abort",t)}function r(){for(const i of n)(i==null?void 0:i.removeEventListener)!=null&&i.removeEventListener("abort",t)}const s=e.signal;return s.clear=r,s}function pm(n){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(n)||/^::1$/.test(n)}function Vu(n){if(!P0(n))return!1;const{address:e}=n.nodeAddress();return pm(e)}function gm(n,e){const t=ao.exactMatch(n.multiaddr),r=ao.exactMatch(e.multiaddr);if(t&&!r)return-1;if(!t&&r)return 1;const s=Ac.exactMatch(n.multiaddr),i=Ac.exactMatch(e.multiaddr);if(s&&!i)return-1;if(!s&&i)return 1;const o=co.exactMatch(n.multiaddr),a=co.exactMatch(e.multiaddr);if(o&&!a)return-1;if(!o&&a)return 1;const c=Pu.exactMatch(n.multiaddr),l=Pu.exactMatch(e.multiaddr);if(c&&!l)return-1;if(!c&&l)return 1;const u=Au.exactMatch(n.multiaddr),h=Au.exactMatch(e.multiaddr);if(u&&!h)return-1;if(!u&&h)return 1;const f=Iu.exactMatch(n.multiaddr),g=Iu.exactMatch(e.multiaddr);return f&&!g?-1:!f&&g?1:0}function mm(n,e){const t=Vu(n.multiaddr),r=Vu(e.multiaddr);return t&&!r?1:!t&&r?-1:0}function ym(n,e){const t=vs(n.multiaddr),r=vs(e.multiaddr);return t&&!r?1:!t&&r?-1:0}function bm(n,e){return n.isCertified&&!e.isCertified?-1:!n.isCertified&&e.isCertified?1:0}function wm(n,e){const t=Ic.exactMatch(n.multiaddr),r=Ic.exactMatch(e.multiaddr);return t&&!r?1:!t&&r?-1:0}function vm(n){return n.sort(gm).sort(bm).sort(wm).sort(ym).sort(mm)}const pi={maxParallelDials:O0,maxDialQueueLength:L0,maxPeerAddrsToDial:B0,dialTimeout:D0};class Em{constructor(e,t={}){d(this,"queue");d(this,"components");d(this,"addressSorter");d(this,"maxPeerAddrsToDial");d(this,"maxDialQueueLength");d(this,"dialTimeout");d(this,"shutDownController");d(this,"connections");d(this,"log");this.addressSorter=t.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??pi.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??pi.maxDialQueueLength,this.dialTimeout=t.dialTimeout??pi.dialTimeout,this.connections=t.connections??new js,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.shutDownController=new AbortController,this.shutDownController.signal;for(const[r,s]of Object.entries(t.resolvers??{}))Il.set(r,s);this.queue=new fm({concurrency:t.maxParallelDials??pi.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("error",r=>{var s;((s=r.detail)==null?void 0:s.name)!==ds.name&&this.log.error("error in dial queue - %e",r.detail)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){var a,c,l;const{peerId:r,multiaddrs:s}=R0(e),i=Array.from(this.connections.values()).flat().find(u=>t.force===!0?!1:u.remotePeer.equals(r)?!0:s.find(h=>h.equals(u.remoteAddr)));if((i==null?void 0:i.status)==="open")return this.log("already connected to %a",i.remoteAddr),(a=t.onProgress)==null||a.call(t,new ft("dial-queue:already-connected")),i;const o=this.queue.queue.find(u=>{if((r==null?void 0:r.equals(u.options.peerId))===!0)return!0;const h=u.options.multiaddrs;if(h==null)return!1;for(const f of s)if(h.has(f.toString()))return!0;return!1});if(o!=null){this.log("joining existing dial target for %p",r);for(const u of s)o.options.multiaddrs.add(u.toString());return(c=t.onProgress)==null||c.call(t,new ft("dial-queue:already-in-dial-queue")),o.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new ki("Dial queue is full");return this.log("creating dial target for %p",r,s.map(u=>u.toString())),(l=t.onProgress)==null||l.call(t,new ft("dial-queue:add-to-dial-queue")),this.queue.add(async u=>{var f;(f=u.onProgress)==null||f.call(u,new ft("dial-queue:start-dial"));const h=zt([this.shutDownController.signal,u.signal]);try{return await this.dialPeer(u,h)}finally{h.clear()}},{peerId:r,priority:t.priority??F0,multiaddrs:new Set(s.map(u=>u.toString())),signal:t.signal??AbortSignal.timeout(this.dialTimeout),onProgress:t.onProgress})}async dialPeer(e,t){var u;const r=e.peerId,s=e.multiaddrs,i=new Set;let o=e.multiaddrs.size===0,a=0,c=0;const l=[];for(this.log("starting dial to %p",r);o||s.size>0;){c++,o=!1;const h=[],f=new Set(e.multiaddrs);s.clear(),this.log("calculating addrs to dial %p from %s",r,[...f]);const g=await this.calculateMultiaddrs(r,f,{...e,signal:t});for(const p of g){if(i.has(p.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",p.multiaddr,r);continue}h.push(p)}this.log("%s dial to %p with %s",c===1?"starting":"continuing",r,h.map(p=>p.multiaddr.toString())),(u=e==null?void 0:e.onProgress)==null||u.call(e,new ft("dial-queue:calculated-addresses",h));for(const p of h){if(a===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",a,e.peerId),new ki("Peer had more than maxPeerAddrsToDial");a++;try{const m=await this.components.transportManager.dial(p.multiaddr,{...e,signal:t});this.log("dial to %a succeeded",p.multiaddr);try{await this.components.peerStore.merge(m.remotePeer,{multiaddrs:[m.remoteAddr],metadata:{[nm]:O(Date.now().toString())}})}catch(y){this.log.error("could not update last dial failure key for %p",r,y)}return m}catch(m){if(this.log.error("dial failed to %a",p.multiaddr,m),i.add(p.multiaddr.toString()),r!=null)try{await this.components.peerStore.merge(r,{metadata:{[rm]:O(Date.now().toString())}})}catch(y){this.log.error("could not update last dial failure key for %p",r,y)}if(t.aborted)throw new M2(m.message);l.push(m)}}}throw l.length===1?l[0]:new AggregateError(l,"All multiaddr dials failed")}async calculateMultiaddrs(e,t=new Set,r={}){var h,f;const s=[...t].map(g=>({multiaddr:se(g),isCertified:!1}));if(e!=null){if(this.components.peerId.equals(e))throw new ki("Tried to dial self");if(await((f=(h=this.components.connectionGater).denyDialPeer)==null?void 0:f.call(h,e))===!0)throw new Ou("The dial request is blocked by gater.allowDialPeer");if(s.length===0){this.log("loading multiaddrs for %p",e);try{const g=await this.components.peerStore.get(e);s.push(...g.addresses),this.log("loaded multiaddrs for %p",e,s.map(({multiaddr:p})=>p.toString()))}catch(g){if(g.name!=="NotFoundError")throw g}}if(s.length===0){this.log("looking up multiaddrs for %p in the peer routing",e);try{const g=await this.components.peerRouting.findPeer(e,r);this.log("found multiaddrs for %p in the peer routing",e,s.map(({multiaddr:p})=>p.toString())),s.push(...g.multiaddrs.map(p=>({multiaddr:p,isCertified:!1})))}catch(g){g.name==="NoPeerRoutersError"?this.log("no peer routers configured",e):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",e,g)}}}let i=(await Promise.all(s.map(async g=>{const p=await sm(g.multiaddr,{dns:this.components.dns,...r,log:this.log});return p.length===1&&p[0].equals(g.multiaddr)?g:p.map(m=>({multiaddr:m,isCertified:!1}))}))).flat();if(e!=null){const g=`/p2p/${e.toString()}`;i=i.map(p=>{const m=p.multiaddr.protos().pop();return(m==null?void 0:m.path)===!0?p:p.multiaddr.getPeerId()==null?{multiaddr:p.multiaddr.encapsulate(g),isCertified:p.isCertified}:p})}const o=i.filter(g=>{if(this.components.transportManager.dialTransportForMultiaddr(g.multiaddr)==null)return!1;const p=g.multiaddr.getPeerId();return e!=null&&p!=null?e.equals(p):!0}),a=new Map;for(const g of o){const p=g.multiaddr.toString(),m=a.get(p);if(m!=null){m.isCertified=m.isCertified||g.isCertified||!1;continue}a.set(p,g)}const c=[...a.values()];if(c.length===0)throw new Pg("The dial request has no valid addresses");const l=[];for(const g of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(g.multiaddr)||l.push(g);const u=this.addressSorter==null?vm(l):l.sort(this.addressSorter);if(u.length===0)throw new Ou("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",e??"unknown peer",i.map(({multiaddr:g})=>g.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",u.map(({multiaddr:g})=>g.toString())),u}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{const r=await this.calculateMultiaddrs(void 0,new Set(e.map(s=>s.toString())),t);return t.runOnLimitedConnection===!1?r.find(s=>!Ic.matches(s.multiaddr))!=null:!0}catch(r){this.log.trace("error calculating if multiaddr(s) were dialable",r)}return!1}}class Tc extends Mo{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}}var U0={};function _t(n,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(n)),this._timeouts=n,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var Sm=_t;_t.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};_t.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};_t.prototype.retry=function(n){if(this._timeout&&clearTimeout(this._timeout),!n)return!1;var e=new Date().getTime();if(n&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(n),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(n);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},t),this._options.unref&&this._timer.unref(),!0};_t.prototype.attempt=function(n,e){this._fn=n,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};_t.prototype.try=function(n){console.log("Using RetryOperation.try() is deprecated"),this.attempt(n)};_t.prototype.start=function(n){console.log("Using RetryOperation.start() is deprecated"),this.attempt(n)};_t.prototype.start=_t.prototype.try;_t.prototype.errors=function(){return this._errors};_t.prototype.attempts=function(){return this._attempts};_t.prototype.mainError=function(){if(this._errors.length===0)return null;for(var n={},e=null,t=0,r=0;r<this._errors.length;r++){var s=this._errors[r],i=s.message,o=(n[i]||0)+1;n[i]=o,o>=t&&(e=s,t=o)}return e};(function(n){var e=Sm;n.operation=function(t){var r=n.timeouts(t);return new e(r,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},n.timeouts=function(t){if(t instanceof Array)return[].concat(t);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var s in t)r[s]=t[s];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],o=0;o<r.retries;o++)i.push(this.createTimeout(o,r));return t&&t.forever&&!i.length&&i.push(this.createTimeout(o,r)),i.sort(function(a,c){return a-c}),i},n.createTimeout=function(t,r){var s=r.randomize?Math.random()+1:1,i=Math.round(s*Math.max(r.minTimeout,1)*Math.pow(r.factor,t));return i=Math.min(i,r.maxTimeout),i},n.wrap=function(t,r,s){if(r instanceof Array&&(s=r,r=null),!s){s=[];for(var i in t)typeof t[i]=="function"&&s.push(i)}for(var o=0;o<s.length;o++){var a=s[o],c=t[a];t[a]=(function(u){var h=n.operation(r),f=Array.prototype.slice.call(arguments,1),g=f.pop();f.push(function(p){h.retry(p)||(p&&(arguments[0]=h.mainError()),g.apply(this,arguments))}),h.attempt(function(){u.apply(t,f)})}).bind(t,c),t[a].options=r}}})(U0);var _m=U0;const xm=Us(_m),km=Object.prototype.toString,Cm=n=>km.call(n)==="[object Error]",Am=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Load failed","Network request failed","fetch failed","terminated"]);function Im(n){return n&&Cm(n)&&n.name==="TypeError"&&typeof n.message=="string"?n.message==="Load failed"?n.stack===void 0:Am.has(n.message):!1}class Pm extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const Hu=(n,e,t)=>{const r=t.retries-(e-1);return n.attemptNumber=e,n.retriesLeft=r,n};async function Tm(n,e){return new Promise((t,r)=>{e={...e},e.onFailedAttempt??(e.onFailedAttempt=()=>{}),e.shouldRetry??(e.shouldRetry=()=>!0),e.retries??(e.retries=10);const s=xm.operation(e),i=()=>{var a;s.stop(),r((a=e.signal)==null?void 0:a.reason)};e.signal&&!e.signal.aborted&&e.signal.addEventListener("abort",i,{once:!0});const o=()=>{var a;(a=e.signal)==null||a.removeEventListener("abort",i),s.stop()};s.attempt(async a=>{try{const c=await n(a);o(),t(c)}catch(c){try{if(!(c instanceof Error))throw new TypeError(`Non-error was thrown: "${c}". You should only throw errors.`);if(c instanceof Pm)throw c.originalError;if(c instanceof TypeError&&!Im(c))throw c;if(Hu(c,a,e),await e.shouldRetry(c)||(s.stop(),r(c)),await e.onFailedAttempt(c),!s.retry(c))throw s.mainError()}catch(l){Hu(l,a,e),o(),r(l)}}})})}class Rm{constructor(e,t={}){d(this,"log");d(this,"queue");d(this,"started");d(this,"peerStore");d(this,"retries");d(this,"retryInterval");d(this,"backoffFactor");d(this,"connectionManager");d(this,"events");this.log=e.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.queue=new Tc({concurrency:t.maxParallelReconnects??tm,metricName:"libp2p_reconnect_queue",metrics:e.metrics}),this.started=!1,this.retries=t.retries??5,this.backoffFactor=t.backoffFactor,this.retryInterval=t.retryInterval,this.events=e.events,e.events.addEventListener("peer:disconnect",r=>{this.maybeReconnect(r.detail).catch(s=>{this.log.error("failed to maybe reconnect to %p - %e",r.detail,s)})})}async maybeReconnect(e){if(!this.started)return;const t=await this.peerStore.get(e);qu(t)&&(this.queue.has(e)||this.queue.add(async r=>{await Tm(async s=>{if(this.started)try{await this.connectionManager.openConnection(e,{signal:r==null?void 0:r.signal})}catch(i){throw this.log("reconnecting to %p attempt %d of %d failed - %e",e,s,this.retries,i),i}},{signal:r==null?void 0:r.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:e}).catch(async r=>{this.log.error("failed to reconnect to %p - %e",e,r);const s={};[...t.tags.keys()].forEach(i=>{i.startsWith(Xc)&&(s[i]=void 0)}),await this.peerStore.merge(e,{tags:s}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:e})}).catch(async r=>{this.log.error("failed to remove keep-alive tag from %p - %e",e,r)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>qu(t)]});await Promise.all(e.map(async t=>{await this.connectionManager.openConnection(t.id).catch(r=>{this.log.error(r)})}))}).catch(e=>{this.log.error(e)})}stop(){this.started=!1,this.queue.abort()}}function qu(n){for(const e of n.tags.keys())if(e.startsWith(Xc))return!0;return!1}const F0=50,Ia={maxConnections:N0,inboundConnectionThreshold:Xg,maxIncomingPendingConnections:em};var wd;wd=Symbol.toStringTag;class Dm{constructor(e,t={}){d(this,"started");d(this,"connections");d(this,"allow");d(this,"deny");d(this,"maxIncomingPendingConnections");d(this,"incomingPendingConnections");d(this,"outboundPendingConnections");d(this,"maxConnections");d(this,"dialQueue");d(this,"reconnectQueue");d(this,"connectionPruner");d(this,"inboundConnectionRateLimiter");d(this,"peerStore");d(this,"metrics");d(this,"events");d(this,"log");d(this,"peerId");d(this,wd,"@libp2p/connection-manager");var r;if(this.maxConnections=t.maxConnections??Ia.maxConnections,this.maxConnections<1)throw new G("Connection Manager maxConnections must be greater than 0");this.connections=new js,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(t.allow??[]).map(s=>Pc(s)),this.deny=(t.deny??[]).map(s=>Pc(s)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??Ia.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new Wg({points:t.inboundConnectionThreshold??Ia.inboundConnectionThreshold,duration:1}),this.connectionPruner=new om({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{maxConnections:this.maxConnections,allow:(r=t.allow)==null?void 0:r.map(s=>se(s))}),this.dialQueue=new Em(e,{addressSorter:t.addressSorter,maxParallelDials:t.maxParallelDials??O0,maxDialQueueLength:t.maxDialQueueLength??L0,maxPeerAddrsToDial:t.maxPeerAddrsToDial??B0,dialTimeout:t.dialTimeout??D0,resolvers:t.resolvers??{dnsaddr:s0},connections:this.connections}),this.reconnectQueue=new Rm({events:e.events,peerStore:e.peerStore,logger:e.logger,connectionManager:this},{retries:t.reconnectRetries,retryInterval:t.reconnectRetryInterval,backoffFactor:t.reconnectBackoffFactor,maxParallelReconnects:t.maxParallelReconnects})}async start(){var e,t,r;(e=this.metrics)==null||e.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const s={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(const i of this.connections.values())for(const o of i)s[o.direction]++;return s}}),(t=this.metrics)==null||t.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const s={};for(const i of this.connections.values())for(const o of i)for(const a of o.streams){const c=`${a.direction} ${a.protocol??"unnegotiated"}`;s[c]=(s[c]??0)+1}return s}}),(r=this.metrics)==null||r.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const s={};for(const o of this.connections.values())for(const a of o){const c={};for(const l of a.streams){const u=`${l.direction} ${l.protocol??"unnegotiated"}`;c[u]=(c[u]??0)+1}for(const[l,u]of Object.entries(c))s[l]=s[l]??[],s[l].push(u)}const i={};for(let[o,a]of Object.entries(s)){a=a.sort((l,u)=>l-u);const c=Math.floor(a.length*.9);i[o]=a[c]}return i}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await qi(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await sl(this.reconnectQueue,this.dialQueue,this.connectionPruner);const e=[];for(const t of this.connections.values())for(const r of t)e.push((async()=>{try{await r.close()}catch(s){this.log.error(s)}})());this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}onConnect(e){this._onConnect(e).catch(t=>{this.log.error(t)})}async _onConnect(e){const{detail:t}=e;if(!this.started){await t.close();return}if(t.status!=="open")return;const r=t.remotePeer,s=!this.connections.has(r),i=this.connections.get(r)??[];i.push(t),this.connections.set(r,i),r.publicKey!=null&&r.type==="RSA"&&await this.peerStore.patch(r,{publicKey:r.publicKey}),s&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){const{detail:t}=e,r=t.remotePeer,i=(this.connections.get(r)??[]).filter(o=>o.id!==t.id);this.connections.set(r,i),i.length===0&&(this.log("onDisconnect remove all connections for peer %p",r),this.connections.delete(r),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(const r of this.connections.values())t=t.concat(r);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){var r,s;if(!this.started)throw new fs("Not started");this.outboundPendingConnections++;try{(r=t.signal)==null||r.throwIfAborted();const{peerId:i}=R0(e);if(this.peerId.equals(i))throw new tl("Can not dial self");if(i!=null&&t.force!==!0){this.log("dial %p",i);const l=this.getConnections(i).find(u=>u.limits==null);if(l!=null)return this.log("had an existing non-limited connection to %p",i),(s=t.onProgress)==null||s.call(t,new ft("dial-queue:already-connected")),l}const o=await this.dialQueue.dial(e,{...t,priority:t.priority??F0});if(o.status!=="open")throw new el("Remote closed connection during opening");let a=this.connections.get(o.remotePeer);a==null&&(a=[],this.connections.set(o.remotePeer,a));let c=!1;for(const l of a)if(l.id===o.id&&(c=!0),t.force!==!0&&l.id!==o.id&&l.remoteAddr.equals(o.remoteAddr))return o.abort(new vo("Duplicate multiaddr connection")),l;return c||a.push(o),o}finally{this.outboundPendingConnections--}}async closeConnections(e,t={}){const r=this.connections.get(e)??[];await Promise.all(r.map(async s=>{try{await s.close(t)}catch(i){s.abort(i)}}))}async acceptIncomingConnection(e){if(this.deny.some(s=>s.contains(e.remoteAddr.nodeAddress().address)))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(s=>s.contains(e.remoteAddr.nodeAddress().address)))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){const s=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(s,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,s),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){const e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(r=>se(r))}))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}}class Pa{constructor(e){d(this,"movingAverage");d(this,"variance");d(this,"deviation");d(this,"forecast");d(this,"timeSpan");d(this,"previousTime");this.timeSpan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timeSpan)}push(e,t=Date.now()){if(this.previousTime!=null){const r=this.alpha(t,this.previousTime),s=e-this.movingAverage,i=r*s;this.movingAverage=r*e+(1-r)*this.movingAverage,this.variance=(1-r)*(this.variance+s*i),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+r*s}else this.movingAverage=e;this.previousTime=t}}const Bm=1.2,Lm=2,Nm=5e3;class Es{constructor(e={}){d(this,"success");d(this,"failure");d(this,"next");d(this,"metric");d(this,"timeoutMultiplier");d(this,"failureMultiplier");d(this,"minTimeout");var t;this.success=new Pa(e.interval??5e3),this.failure=new Pa(e.interval??5e3),this.next=new Pa(e.interval??5e3),this.failureMultiplier=e.failureMultiplier??Lm,this.timeoutMultiplier=e.timeoutMultiplier??Bm,this.minTimeout=e.minTimeout??Nm,e.metricName!=null&&(this.metric=(t=e.metrics)==null?void 0:t.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){const t=Math.max(Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier)),this.minTimeout),r=AbortSignal.timeout(t),s=zt([e.signal,r]);return s.start=Date.now(),s.timeout=t,s}cleanUp(e){var r,s;const t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),(r=this.metric)==null||r.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),(s=this.metric)==null||s.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}}class Om{constructor(){d(this,"readNext");d(this,"haveNext");d(this,"ended");d(this,"nextResult");d(this,"error");this.ended=!1,this.readNext=Le(),this.haveNext=Le()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=Le(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=Le(),await Gr(this.readNext.promise,t==null?void 0:t.signal,t)}}function $0(){return new Om}let Mm=class extends Error{constructor(){super(...arguments);d(this,"name","UnexpectedEOFError");d(this,"code","ERR_UNEXPECTED_EOF")}};function uo(n,e){const t=$0();n.sink(t).catch(async o=>{await t.end(o)}),n.sink=async o=>{for await(const a of o)await t.push(a);await t.end()};let r=n.source;n.source[Symbol.iterator]!=null?r=n.source[Symbol.iterator]():n.source[Symbol.asyncIterator]!=null&&(r=n.source[Symbol.asyncIterator]());const s=new ve;return{read:async o=>{var c;if((c=o==null?void 0:o.signal)==null||c.throwIfAborted(),(o==null?void 0:o.bytes)==null){const{done:l,value:u}=await Gr(r.next(),o==null?void 0:o.signal);return l===!0?null:u}for(;s.byteLength<o.bytes;){const{value:l,done:u}=await Gr(r.next(),o==null?void 0:o.signal);if(u===!0)throw new Mm("unexpected end of input");s.append(l)}const a=s.sublist(0,o.bytes);return s.consume(o.bytes),a},write:async(o,a)=>{var c;(c=a==null?void 0:a.signal)==null||c.throwIfAborted(),o instanceof Uint8Array?await t.push(o,a):await t.push(o.subarray(),a)},unwrap:()=>{if(s.byteLength>0){const o=n.source;n.source=async function*(){(e==null?void 0:e.yieldBytes)===!1?yield s:yield*s,yield*o}()}return n}}}const Um=1e4,Fm="1.0.0",$m="ping",Vm="ipfs",zu=32,Hm=!0;var vd,Ed;Ed=Symbol.toStringTag,vd=Sn;class qm{constructor(e,t={}){d(this,"protocol");d(this,"components");d(this,"log");d(this,"heartbeatInterval");d(this,"pingIntervalMs");d(this,"abortController");d(this,"timeout");d(this,"abortConnectionOnPingFailure");d(this,Ed,"@libp2p/connection-monitor");d(this,vd,["@libp2p/connection-monitor"]);this.components=e,this.protocol=`/${t.protocolPrefix??Vm}/${$m}/${Fm}`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??Um,this.abortConnectionOnPingFailure=t.abortConnectionOnPingFailure??Hm,this.timeout=new Es({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(e=>{Promise.resolve().then(async()=>{var r;let t=Date.now();try{const s=this.timeout.getTimeoutSignal({signal:(r=this.abortController)==null?void 0:r.signal}),i=await e.newStream(this.protocol,{signal:s,runOnLimitedConnection:!0}),o=uo(i);t=Date.now(),await Promise.all([o.write(Po(zu),{signal:s}),o.read({bytes:zu,signal:s})]),e.rtt=Date.now()-t,await o.unwrap().close({signal:s})}catch(s){if(s.name!=="UnsupportedProtocolError")throw s;e.rtt=(Date.now()-t)/2}}).catch(t=>{this.log.error("error during heartbeat",t),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),e.abort(t)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){var e;(e=this.abortController)==null||e.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}}function zm(n){return n[Symbol.asyncIterator]!=null}async function Km(n,e,t){try{await Promise.all(n.map(async r=>{for await(const s of r)await e.push(s,{signal:t}),t.throwIfAborted()})),await e.end(void 0,{signal:t})}catch(r){await e.end(r,{signal:t}).catch(()=>{})}}async function*jm(n){const e=new AbortController,t=$0();Km(n,t,e.signal).catch(()=>{});try{yield*t}finally{e.abort()}}function*Gm(n){for(const e of n)yield*e}function Ss(...n){const e=[];for(const t of n)zm(t)||e.push(t);return e.length===n.length?Gm(e):jm(n)}var Sd;Sd=Symbol.toStringTag;class Wm{constructor(e,t){d(this,"routers");d(this,"started");d(this,"components");d(this,Sd,"@libp2p/content-routing");var r,s,i,o,a;this.routers=t.routers??[],this.started=!1,this.components=e,this.findProviders=((r=e.metrics)==null?void 0:r.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([c],l)=>({...l,cid:c.toString()}),getAttributesFromYieldedValue:(c,l)=>({...l,providers:[...Array.isArray(l.providers)?l.providers:[],c.id.toString()]})}))??this.findProviders,this.provide=((s=e.metrics)==null?void 0:s.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([c],l)=>({...l,cid:c.toString()})}))??this.provide,this.cancelReprovide=((i=e.metrics)==null?void 0:i.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([c],l)=>({...l,cid:c.toString()})}))??this.cancelReprovide,this.put=((o=e.metrics)==null?void 0:o.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([c])=>({key:M(c,"base36")})}))??this.put,this.get=((a=e.metrics)==null?void 0:a.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([c])=>({key:M(c,"base36")})}))??this.get}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new Ca("No content routers available");const r=this,s=new Ht;for await(const i of Ss(...r.routers.map(o=>o.findProviders(e,t))))i!=null&&(i.multiaddrs.length>0&&await this.components.peerStore.merge(i.id,{multiaddrs:i.multiaddrs}),!s.has(i.id)&&(s.add(i.id),yield i))}async provide(e,t={}){if(this.routers.length===0)throw new Ca("No content routers available");await Promise.all(this.routers.map(async r=>{await r.provide(e,t)}))}async cancelReprovide(e,t={}){if(this.routers.length===0)throw new Ca("No content routers available");await Promise.all(this.routers.map(async r=>{await r.cancelReprovide(e,t)}))}async put(e,t,r){if(!this.isStarted())throw new fs;await Promise.all(this.routers.map(async s=>{await s.put(e,t,r)}))}async get(e,t){if(!this.isStarted())throw new fs;return Promise.any(this.routers.map(async r=>r.get(e,t)))}}const gi=globalThis.CustomEvent??Event;async function*Uo(n,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);const r=e.ordered??!1,s=new EventTarget,i=[];let o=Le(),a=Le(),c=!1,l,u=!1;s.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(const p of n){if(i.length===t&&(o=Le(),await o.promise),u)break;const m={done:!1};i.push(m),p().then(y=>{m.done=!0,m.ok=!0,m.value=y,s.dispatchEvent(new gi("task-complete"))},y=>{m.done=!0,m.err=y,s.dispatchEvent(new gi("task-complete"))})}c=!0,s.dispatchEvent(new gi("task-complete"))}catch(p){l=p,s.dispatchEvent(new gi("task-complete"))}});function h(){var p;return r?(p=i[0])==null?void 0:p.done:!!i.find(m=>m.done)}function*f(){for(;i.length>0&&i[0].done;){const p=i[0];if(i.shift(),p.ok)yield p.value;else throw u=!0,o.resolve(),p.err;o.resolve()}}function*g(){for(;h();)for(let p=0;p<i.length;p++)if(i[p].done){const m=i[p];if(i.splice(p,1),p--,m.ok)yield m.value;else throw u=!0,o.resolve(),m.err;o.resolve()}}for(;;){if(h()||(a=Le(),await a.promise),l!=null||(r?yield*f():yield*g(),l!=null))throw l;if(c&&i.length===0)break}}var _d;_d=Symbol.toStringTag;class Qm{constructor(e,t={}){d(this,"log");d(this,"peerId");d(this,"peerStore");d(this,"routers");d(this,_d,"@libp2p/peer-routing");var r,s;this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[],this.findPeer=((r=e.metrics)==null?void 0:r.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([i],o)=>({...o,peer:i.toString()})}))??this.findPeer,this.getClosestPeers=((s=e.metrics)==null?void 0:s.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([i],o)=>({...o,key:M(i,"base36")}),getAttributesFromYieldedValue:(i,o)=>({...o,peers:[...Array.isArray(o.peers)?o.peers:[],i.id.toString()]})}))??this.getClosestPeers}async findPeer(e,t){if(this.routers.length===0)throw new Nu("No peer routers available");if(e.toString()===this.peerId.toString())throw new xg("Should not try to find self");const r=this,s=Ss(...this.routers.map(i=>async function*(){try{yield await i.findPeer(e,t)}catch(o){r.log.error(o)}}()));for await(const i of s)if(i!=null)return i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs}),i;throw new xr}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new Nu("No peer routers available");const r=this,s=f0(1024);for await(const i of Uo(async function*(){const o=Ss(...r.routers.map(a=>a.getClosestPeers(e,t)));for await(let a of o)yield async()=>{if(a.multiaddrs.length===0)try{a=await r.findPeer(a.id,{...t,useCache:!1})}catch(c){r.log.error("could not find peer multiaddrs",c);return}return a}}()))i!=null&&(i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs}),!s.has(i.id.toMultihash().bytes)&&(s.add(i.id.toMultihash().bytes),yield i))}}var xd,kd;class Ym extends(kd=sr,xd=Symbol.toStringTag,kd){constructor(t){super();d(this,"peerRouting");d(this,"log");d(this,"walking");d(this,"walkers");d(this,"shutdownController");d(this,"walkController");d(this,"needNext");d(this,xd,"@libp2p/random-walk");this.log=t.logger.forComponent("libp2p:random-walk"),this.peerRouting=t.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(t){var s,i;this.walking||this.startWalk(),this.walkers++;const r=zt([this.shutdownController.signal,t==null?void 0:t.signal]);try{for(;;)(s=this.needNext)==null||s.resolve(),this.needNext=Le(),yield(await Ni(this,"walk:peer",r,{errorEvent:"walk:error"})).detail}finally{r.clear(),this.walkers--,this.walkers===0&&((i=this.walkController)==null||i.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;const t=zt([this.walkController.signal,this.shutdownController.signal]),r=Date.now();let s=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{const i=Po(32);let o=Date.now();for await(const a of this.peerRouting.getClosestPeers(i,{signal:t}))t.aborted&&this.log("aborting walk"),t.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",a.id,Date.now()-o,this.walkers),s++,this.safeDispatchEvent("walk:peer",{detail:a}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await Gr(this.needNext.promise,t)),o=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",i,this.walkers,s)}catch(i){this.log.error("random walk errored",i),this.safeDispatchEvent("walk:error",{detail:i})}this.log("no walkers left, ended walk")}).catch(i=>{this.log.error("random walk errored",i)}).finally(()=>{this.log("finished walk, found %d peers after %dms",s,Date.now()-r),this.walking=!1})}}const V0=32,H0=64;var Cd;Cd=Symbol.toStringTag;class Jm{constructor(e){d(this,"log");d(this,"topologies");d(this,"handlers");d(this,"components");d(this,Cd,"@libp2p/registrar");this.log=e.logger.forComponent("libp2p:registrar"),this.topologies=new Map,this.handlers=new Map,this.components=e,this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(t==null)throw new kg(`No handler registered for protocol ${e}`);return t}getTopologies(e){const t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,r){if(this.handlers.has(e)&&(r==null?void 0:r.force)!==!0)throw new Cg(`Handler already registered for protocol ${e}`);const s=a0.bind({ignoreUndefined:!0})({maxInboundStreams:V0,maxOutboundStreams:H0},r);this.handlers.set(e,{handler:t,options:s}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]})}async unhandle(e){(Array.isArray(e)?e:[e]).forEach(r=>{this.handlers.delete(r)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()})}async register(e,t){if(t==null)throw new G("invalid topology");const r=`${(Math.random()*1e9).toString(36)}${Date.now()}`;let s=this.topologies.get(e);return s==null&&(s=new Map,this.topologies.set(e,s)),s.set(r,t),r}unregister(e){for(const[t,r]of this.topologies.entries())r.has(e)&&(r.delete(e),r.size===0&&this.topologies.delete(t))}_onDisconnect(e){const t=e.detail;this.components.peerStore.get(t).then(r=>{var s,i,o;for(const a of r.protocols){const c=this.topologies.get(a);if(c!=null)for(const l of c.values())((s=l.filter)==null?void 0:s.has(t))!==!1&&((i=l.filter)==null||i.remove(t),(o=l.onDisconnect)==null||o.call(l,t))}}).catch(r=>{r.name!=="NotFoundError"&&this.log.error("could not inform topologies of disconnecting peer %p",t,r)})}_onPeerUpdate(e){var i,o,a;const{peer:t,previous:r}=e.detail,s=((r==null?void 0:r.protocols)??[]).filter(c=>!t.protocols.includes(c));for(const c of s){const l=this.topologies.get(c);if(l!=null)for(const u of l.values())((i=u.filter)==null?void 0:i.has(t.id))!==!1&&((o=u.filter)==null||o.remove(t.id),(a=u.onDisconnect)==null||a.call(u,t.id))}}_onPeerIdentify(e){var i,o,a;const t=e.detail.protocols,r=e.detail.connection,s=e.detail.peerId;for(const c of t){const l=this.topologies.get(c);if(l!=null)for(const u of l.values())r.limits!=null&&u.notifyOnLimitedConnection!==!0||((i=u.filter)==null?void 0:i.has(s))!==!0&&((o=u.filter)==null||o.add(s),(a=u.onConnect)==null||a.call(u,s,r))}}}class Zm extends Map{constructor(t){super();d(this,"metric");const{name:r,metrics:s}=t;this.metric=s.registerMetric(r),this.updateComponentMetric()}set(t,r){return super.set(t,r),this.updateComponentMetric(),this}delete(t){const r=super.delete(t);return this.updateComponentMetric(),r}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function Xm(n){const{name:e,metrics:t}=n;let r;return t!=null?r=new Zm({name:e,metrics:t}):r=new Map,r}var Ad;Ad=Symbol.toStringTag;class ey{constructor(e,t={}){d(this,"log");d(this,"components");d(this,"transports");d(this,"listeners");d(this,"faultTolerance");d(this,"started");d(this,Ad,"@libp2p/transport-manager");this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=new Map,this.listeners=Xm({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??us.FATAL_ALL}add(e){const t=e[Symbol.toStringTag];if(t==null)throw new G("Transport must have a valid tag");if(this.transports.has(t))throw new G(`There is already a transport with the tag ${t}`);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){const e=[];for(const[t,r]of this.listeners)for(this.log("closing listeners for %s",t);r.length>0;){const s=r.pop();s!=null&&e.push(s.close())}await Promise.all(e),this.log("all listeners closed");for(const t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){var s;const r=this.dialTransportForMultiaddr(e);if(r==null)throw new Dg(`No transport available for address ${String(e)}`);return(s=t==null?void 0:t.onProgress)==null||s.call(t,new ft("transport-manager:selected-transport",r[Symbol.toStringTag])),r.dial(e,{...t,upgrader:this.components.upgrader})}getAddrs(){let e=[];for(const t of this.listeners.values())for(const r of t)e=[...e,...r.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(const t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(const t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new fs("Not started");if(e==null||e.length===0){this.log("no addresses were provided for listening, this node is dial only");return}const t={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};e.forEach(i=>{t.errors.set(i.toString(),new Ag)});const r=[];for(const[i,o]of this.transports.entries()){const a=o.listenFilter(e);for(const c of a){this.log("creating listener for %s on %a",i,c);const l=o.createListener({upgrader:this.components.upgrader});let u=this.listeners.get(i)??[];u==null&&(u=[],this.listeners.set(i,u)),u.push(l),l.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:l})}),l.addEventListener("close",()=>{const h=u.findIndex(f=>f===l);u.splice(h,1),this.components.events.safeDispatchEvent("transport:close",{detail:l})}),ku.matches(c)?t.ipv4.attempts++:Cu.matches(c)&&t.ipv6.attempts++,r.push(l.listen(c).then(()=>{t.errors.delete(c.toString()),ku.matches(c)&&t.ipv4.success++,Cu.matches(c)&&t.ipv6.success++},h=>{throw this.log.error("transport %s could not listen on address %a - %e",i,c,h),t.errors.set(c.toString(),h),h}))}}const s=await Promise.allSettled(r);if(!(s.length>0&&s.every(i=>i.status==="fulfilled"))){if(this.ipv6Unsupported(t)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===us.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new Ig(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...t.errors.entries()].map(([i,o])=>`
  ${i}: ${`${o.stack??o}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(e){if(e.ipv4.attempts===0||e.ipv6.attempts===0)return!1;const t=e.ipv4.attempts===e.ipv4.success,r=e.ipv6.success===0;return t&&r}async remove(e){const t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);const r=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){const s=t.pop();s!=null&&r.push(s.close())}await Promise.all(r),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}const st="/multistream/1.0.0",Ol=1024;let ty=class extends Error{constructor(){super(...arguments);d(this,"name","InvalidMessageLengthError");d(this,"code","ERR_INVALID_MSG_LENGTH")}},ry=class extends Error{constructor(){super(...arguments);d(this,"name","InvalidDataLengthError");d(this,"code","ERR_MSG_DATA_TOO_LONG")}},ny=class extends Error{constructor(){super(...arguments);d(this,"name","InvalidDataLengthLengthError");d(this,"code","ERR_MSG_LENGTH_TOO_LONG")}};function Fo(n,e={}){const t=uo(n,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=mt(e.maxDataLength));const r=(e==null?void 0:e.lengthDecoder)??Pr,s=(e==null?void 0:e.lengthEncoder)??Ct;return{read:async o=>{let a=-1;const c=new ve;for(;;){c.append(await t.read({...o,bytes:1}));try{a=r(c)}catch(l){if(l instanceof RangeError)continue;throw l}if(a<0)throw new ty("Invalid message length");if((e==null?void 0:e.maxLengthLength)!=null&&c.byteLength>e.maxLengthLength)throw new ny("message length length too long");if(a>-1)break}if((e==null?void 0:e.maxDataLength)!=null&&a>e.maxDataLength)throw new ry("message length too long");return t.read({...o,bytes:a})},write:async(o,a)=>{await t.write(new ve(s(o.byteLength),o),a)},writeV:async(o,a)=>{const c=new ve(...o.flatMap(l=>[s(l.byteLength),l]));await t.write(c,a)},unwrap:()=>t.unwrap()}}const sy=O(`
`);async function Yn(n,e,t){await n.write(e,t)}async function iy(n,e,t){await n.writeV(e,t)}async function oy(n,e){const t=await n.read(e);if(t.byteLength===0||t.get(t.byteLength-1)!==sy[0])throw e.log.error("Invalid mss message - missing newline",t),new Ke("Missing newline");return t.sublist(0,-1)}async function fn(n,e){const t=await oy(n,e);return M(t.subarray())}async function Ta(n,e,t){if(e=Array.isArray(e)?[...e]:[e],e.length===1&&t.negotiateFully===!1)return ay(n,e[0],t);const r=Fo(n,{...t,maxDataLength:Ol}),s=e.shift();if(s==null)throw new Error("At least one protocol must be specified");t.log.trace('select: write ["%s", "%s"]',st,s);const i=O(`${st}
`),o=O(`${s}
`);await iy(r,[i,o],t),t.log.trace("select: reading multistream-select header");let a=await fn(r,t);if(t.log.trace('select: read "%s"',a),a===st&&(t.log.trace("select: reading protocol response"),a=await fn(r,t),t.log.trace('select: read "%s"',a)),a===s)return{stream:r.unwrap(),protocol:s};for(const c of e){t.log.trace('select: write "%s"',c),await Yn(r,O(`${c}
`),t),t.log.trace("select: reading protocol response");const l=await fn(r,t);if(t.log.trace('select: read "%s" for "%s"',l,c),l===c)return{stream:r.unwrap(),protocol:c}}throw new Eo("protocol selection failed")}function ay(n,e,t){const r=n.sink.bind(n),s=n.source;let i=!1,o=!1;const a=Le();let c=!1,l=!1;const u=Le();let h=!1,f=!1;const g=Le(),p=Fo({sink:r,source:s},{...t,maxDataLength:Ol});n.sink=async _=>{const{sink:w}=p.unwrap();await w(async function*(){let b=!1;for await(const v of _){if(l&&await u.promise,c)yield v;else{l=!0,t.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',st,e,v.byteLength);const x=`${e}
`;yield new ve(Uint8Array.from([19]),O(`${st}
`),Ct(x.length),O(x),v).subarray(),t.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',st,e,v.byteLength),c=!0,l=!1,u.resolve(),m().catch(C=>{t.log.error("could not finish optimistic protocol negotiation of %s",e,C)})}b=!0}b||await m()}())};async function m(){if(o){t.log.trace("optimistic: already negotiating %s stream",e),await a.promise;return}o=!0;try{c||(t.log.trace("optimistic: doing send protocol for %s stream",e),await y()),h||(t.log.trace("optimistic: doing read protocol for %s stream",e),await E())}finally{o=!1,i=!0,a.resolve()}}async function y(){if(l){await u.promise;return}l=!0;try{t.log.trace('optimistic: write ["%s", "%s", data] in source',st,e),await p.writeV([O(`${st}
`),O(`${e}
`)]),t.log.trace('optimistic: wrote ["%s", "%s", data] in source',st,e)}finally{c=!0,l=!1,u.resolve()}}async function E(){if(f){await g.promise;return}f=!0;try{t.log.trace("optimistic: reading multistream select header");let _=await fn(p,t);if(t.log.trace('optimistic: read multistream select header "%s"',_),_===st&&(_=await fn(p,t)),t.log.trace('optimistic: read protocol "%s", expecting "%s"',_,e),_!==e)throw new Eo("protocol selection failed")}finally{h=!0,f=!1,g.resolve()}}if(n.source=async function*(){await m(),t.log.trace('optimistic: reading data from "%s" stream',e),yield*p.unwrap().source}(),n.closeRead!=null){const _=n.closeRead.bind(n);n.closeRead=async w=>{i||await m().catch(b=>{t.log.error("could not negotiate protocol before close read",b)}),await _(w)}}if(n.closeWrite!=null){const _=n.closeWrite.bind(n);n.closeWrite=async w=>{i||await m().catch(b=>{t.log.error("could not negotiate protocol before close write",b)}),await _(w)}}if(n.close!=null){const _=n.close.bind(n);n.close=async w=>{const b=[];l&&b.push(u.promise),f&&b.push(g.promise),b.length>0?await Gr(Promise.all(b),w==null?void 0:w.signal):(i=!0,o=!1,a.resolve()),await _(w)}}return{stream:n,protocol:e}}const cy=8,Ml=1024*1024*4;class ly extends Error{constructor(){super(...arguments);d(this,"name","InvalidMessageLengthError");d(this,"code","ERR_INVALID_MSG_LENGTH")}}class q0 extends Error{constructor(){super(...arguments);d(this,"name","InvalidDataLengthError");d(this,"code","ERR_MSG_DATA_TOO_LONG")}}class uy extends Error{constructor(){super(...arguments);d(this,"name","InvalidDataLengthLengthError");d(this,"code","ERR_MSG_LENGTH_TOO_LONG")}}class Ku extends Error{constructor(){super(...arguments);d(this,"name","UnexpectedEOFError");d(this,"code","ERR_UNEXPECTED_EOF")}}function z0(n){return n[Symbol.asyncIterator]!=null}function K0(n,e){if(n.byteLength>e)throw new q0("Message length too long")}const $o=n=>{const e=mt(n),t=qt(e);return Ct(n,t),$o.bytes=e,t};$o.bytes=0;function Ul(n,e){e=e??{};const t=e.lengthEncoder??$o,r=(e==null?void 0:e.maxDataLength)??Ml;function*s(i){K0(i,r);const o=t(i.byteLength);o instanceof Uint8Array?yield o:yield*o,i instanceof Uint8Array?yield i:yield*i}return z0(n)?async function*(){for await(const i of n)yield*s(i)}():function*(){for(const i of n)yield*s(i)}()}Ul.single=(n,e)=>{e=e??{};const t=e.lengthEncoder??$o,r=(e==null?void 0:e.maxDataLength)??Ml;return K0(n,r),new ve(t(n.byteLength),n)};var Dr;(function(n){n[n.LENGTH=0]="LENGTH",n[n.DATA=1]="DATA"})(Dr||(Dr={}));const Fl=n=>{const e=Pr(n);return Fl.bytes=mt(e),e};Fl.bytes=0;function Rc(n,e){const t=new ve;let r=Dr.LENGTH,s=-1;const i=(e==null?void 0:e.lengthDecoder)??Fl,o=(e==null?void 0:e.maxLengthLength)??cy,a=(e==null?void 0:e.maxDataLength)??Ml;function*c(){for(;t.byteLength>0;){if(r===Dr.LENGTH)try{if(s=i(t),s<0)throw new ly("Invalid message length");if(s>a)throw new q0("Message length too long");const l=i.bytes;t.consume(l),(e==null?void 0:e.onLength)!=null&&e.onLength(s),r=Dr.DATA}catch(l){if(l instanceof RangeError){if(t.byteLength>o)throw new uy("Message length length too long");break}throw l}if(r===Dr.DATA){if(t.byteLength<s)break;const l=t.sublist(0,s);t.consume(s),(e==null?void 0:e.onData)!=null&&e.onData(l),yield l,r=Dr.LENGTH}}}return z0(n)?async function*(){for await(const l of n)t.append(l),yield*c();if(t.byteLength>0)throw new Ku("Unexpected end of input")}():function*(){for(const l of n)t.append(l),yield*c();if(t.byteLength>0)throw new Ku("Unexpected end of input")}()}Rc.fromReader=(n,e)=>{let t=1;const r=async function*(){for(;;)try{const{done:i,value:o}=await n.next(t);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}}();return Rc(r,{...e??{},onLength:i=>{t=i}})};async function Ra(n,e,t){e=Array.isArray(e)?e:[e],t.log.trace("handle: available protocols %s",e);const r=Fo(n,{...t,maxDataLength:Ol,maxLengthLength:2});for(;;){t.log.trace("handle: reading incoming string");const s=await fn(r,t);if(t.log.trace('handle: read "%s"',s),s===st){t.log.trace('handle: respond with "%s" for "%s"',st,s),await Yn(r,O(`${st}
`),t),t.log.trace('handle: responded with "%s" for "%s"',st,s);continue}if(e.includes(s))return t.log.trace('handle: respond with "%s" for "%s"',s,s),await Yn(r,O(`${s}
`),t),t.log.trace('handle: responded with "%s" for "%s"',s,s),{stream:r.unwrap(),protocol:s};if(s==="ls"){const i=new ve(...e.map(o=>Ul.single(O(`${o}
`))),O(`
`));t.log.trace('handle: respond with "%s" for %s',e,s),await Yn(r,i,t),t.log.trace('handle: responded with "%s" for %s',e,s);continue}t.log.trace('handle: respond with "na" for "%s"',s),await Yn(r,O(`na
`),t),t.log('handle: responded with "na" for "%s"',s)}}const dy=500;var Id,Pd;Pd=Symbol.toStringTag,Id=A4;class hy{constructor(e){d(this,"id");d(this,"remoteAddr");d(this,"remotePeer");d(this,"direction");d(this,"timeline");d(this,"multiplexer");d(this,"encryption");d(this,"status");d(this,"limits");d(this,"log");d(this,"tags");d(this,"_newStream");d(this,"_close");d(this,"_abort");d(this,"_getStreams");d(this,Pd,"Connection");d(this,Id,!0);const{remoteAddr:t,remotePeer:r,newStream:s,close:i,abort:o,getStreams:a}=e;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=r,this.direction=e.direction,this.status="open",this.timeline=e.timeline,this.multiplexer=e.multiplexer,this.encryption=e.encryption,this.limits=e.limits,this.log=e.logger.forComponent(`libp2p:connection:${this.direction}:${this.id}`),this.remoteAddr.getPeerId()==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this._newStream=s,this._close=i,this._abort=o,this._getStreams=a,this.tags=[]}get streams(){return this._getStreams()}async newStream(e,t){if(this.status==="closing")throw new B2("the connection is being closed");if(this.status==="closed")throw new el("the connection is closed");if(Array.isArray(e)||(e=[e]),this.limits!=null&&(t==null?void 0:t.runOnLimitedConnection)!==!0)throw new rl("Cannot open protocol stream on limited connection");const r=await this._newStream(e,t);return r.direction="outbound",r}async close(e={}){if(!(this.status==="closed"||this.status==="closing")){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",e.signal==null){const t=AbortSignal.timeout(dy);e={...e,signal:t}}try{this.log.trace("closing underlying transport"),await this._close(e),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(t){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,t),this.abort(t)}}}abort(e){this.status!=="closed"&&(this.log.error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this._abort(e),this.status="closed",this.timeline.close=Date.now())}}function fy(n){return new hy(n)}function py(n,e){try{const{options:t}=e.getHandler(n);return t.maxInboundStreams}catch(t){if(t.name!=="UnhandledProtocolError")throw t}return V0}function gy(n,e,t={}){try{const{options:r}=e.getHandler(n);if(r.maxOutboundStreams!=null)return r.maxOutboundStreams}catch(r){if(r.name!=="UnhandledProtocolError")throw r}return t.maxOutboundStreams??H0}function ju(n,e,t){let r=0;return t.streams.forEach(s=>{s.direction===e&&s.protocol===n&&r++}),r}var Td;Td=Symbol.toStringTag;class my{constructor(e,t){d(this,"components");d(this,"connectionEncrypters");d(this,"streamMuxers");d(this,"inboundUpgradeTimeout");d(this,"inboundStreamProtocolNegotiationTimeout");d(this,"outboundStreamProtocolNegotiationTimeout");d(this,"events");d(this,"metrics");d(this,Td,"@libp2p/upgrader");var r,s;this.components=e,this.connectionEncrypters=new Map,t.connectionEncrypters.forEach(i=>{this.connectionEncrypters.set(i.protocol,i)}),this.streamMuxers=new Map,t.streamMuxers.forEach(i=>{this.streamMuxers.set(i.protocol,i)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??Zg,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??Uu,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??Uu,this.events=e.events,this.metrics={dials:(r=e.metrics)==null?void 0:r.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:(s=e.metrics)==null?void 0:s.registerCounterGroup("libp2p_connection_manager_dial_errors_total")}}async shouldBlockConnection(e,...t){const r=this.components.connectionGater[e];if(r==null)return;if(await r.apply(this.components.connectionGater,t)===!0)throw new Tg(`The multiaddr connection is blocked by gater.${e}`)}createInboundAbortSignal(e){return zt([AbortSignal.timeout(this.inboundUpgradeTimeout),e])}async upgradeInbound(e,t){var i,o;let r=!1;const s=this.createInboundAbortSignal(t.signal);try{if((i=this.metrics.dials)==null||i.increment({inbound:!0}),r=await this.components.connectionManager.acceptIncomingConnection(e),!r)throw new Rg("Connection denied");await this.shouldBlockConnection("denyInboundConnection",e),await this._performUpgrade(e,"inbound",{...t,signal:s})}catch(a){throw(o=this.metrics.errors)==null||o.increment({inbound:!0}),a}finally{s.clear(),r&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){var r,s;try{(r=this.metrics.dials)==null||r.increment({outbound:!0});const i=e.remoteAddr.getPeerId();let o;i!=null&&(o=qr(i),await this.shouldBlockConnection("denyOutboundConnection",o,e));let a="outbound";return t.initiator===!1&&(a="inbound"),await this._performUpgrade(e,a,t)}catch(i){throw(s=this.metrics.errors)==null||s.increment({outbound:!0}),i}}async _performUpgrade(e,t,r){var u,h,f;let s,i,o,a,c;(u=this.components.metrics)==null||u.trackMultiaddrConnection(e),e.log.trace("starting the %s connection upgrade",t);let l=e;if((r==null?void 0:r.skipProtection)!==!0){const g=this.components.connectionProtector;g!=null&&(e.log("protecting the %s connection",t),l=await g.protect(e,r))}try{if(s=l,(r==null?void 0:r.skipEncryption)!==!0){(h=r==null?void 0:r.onProgress)==null||h.call(r,new ft(`upgrader:encrypt-${t}-connection`)),{conn:s,remotePeer:i,protocol:c,streamMuxer:a}=await(t==="inbound"?this._encryptInbound(l,r):this._encryptOutbound(l,r));const g={...l,...s};await this.shouldBlockConnection(t==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",i,g)}else{const g=e.remoteAddr.getPeerId();if(g==null)throw new vo(`${t} connection that skipped encryption must have a peer id`);const p=qr(g);c="native",i=p}if(i.equals(this.components.peerId)){const g=new tl("Can not dial self");throw e.abort(g),g}if(o=s,(r==null?void 0:r.muxerFactory)!=null)a=r.muxerFactory;else if(a==null&&this.streamMuxers.size>0){(f=r==null?void 0:r.onProgress)==null||f.call(r,new ft(`upgrader:multiplex-${t}-connection`));const g=await(t==="inbound"?this._multiplexInbound({...l,...s},this.streamMuxers,r):this._multiplexOutbound({...l,...s},this.streamMuxers,r));a=g.muxerFactory,o=g.stream}}catch(g){throw e.log.error("failed to upgrade inbound connection %s %a - %e",t==="inbound"?"from":"to",e.remoteAddr,g),g}return await this.shouldBlockConnection(t==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",i,e),e.log("successfully upgraded %s connection",t),this._createConnection({cryptoProtocol:c,direction:t,maConn:e,upgradedConn:o,muxerFactory:a,remotePeer:i,limits:r==null?void 0:r.limits})}_createConnection(e){const{cryptoProtocol:t,direction:r,maConn:s,upgradedConn:i,remotePeer:o,muxerFactory:a,limits:c}=e;let l,u,h;a!=null&&(l=a.createStreamMuxer({direction:r,onIncomingStream:p=>{h!=null&&Promise.resolve().then(async()=>{var v;const m=this.components.registrar.getProtocols(),y=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout),{stream:E,protocol:_}=await Ra(p,m,{signal:y,log:p.log,yieldBytes:!1});if(h==null)return;h.log("incoming stream opened on %s",_);const w=py(_,this.components.registrar);if(ju(_,"inbound",h)===w){const x=new U2(`Too many inbound protocol streams for protocol "${_}" - limit ${w}`);throw p.abort(x),x}p.source=E.source,p.sink=E.sink,p.protocol=_,E.closeWrite!=null&&(p.closeWrite=E.closeWrite),E.closeRead!=null&&(p.closeRead=E.closeRead),E.close!=null&&(p.close=E.close),await this.components.peerStore.merge(o,{protocols:[_]}),(v=this.components.metrics)==null||v.trackProtocolStream(p,h),this._onStream({connection:h,stream:p,protocol:_})}).catch(async m=>{h.log.error("error handling incoming stream id %s - %e",p.id,m),p.timeline.close==null&&await p.close()})}}),u=async(p,m={})=>{var E;if(l==null)throw new hi("Connection is not multiplexed");h.log.trace("starting new stream for protocols %s",p);const y=await l.newStream();h.log.trace("started new stream %s for protocols %s",y.id,p);try{if(m.signal==null){y.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",p);const x=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);m={...m,signal:x}}y.log.trace("selecting protocol from protocols %s",p);const{stream:_,protocol:w}=await Ta(y,p,{...m,log:y.log,yieldBytes:!0});y.log.trace("selected protocol %s",w);const b=gy(w,this.components.registrar,m),v=ju(w,"outbound",h);if(v>=b){const x=new F2(`Too many outbound protocol streams for protocol "${w}" - ${v}/${b}`);throw y.abort(x),x}return await this.components.peerStore.merge(o,{protocols:[w]}),y.source=_.source,y.sink=_.sink,y.protocol=w,_.closeWrite!=null&&(y.closeWrite=_.closeWrite),_.closeRead!=null&&(y.closeRead=_.closeRead),_.close!=null&&(y.close=_.close),(E=this.components.metrics)==null||E.trackProtocolStream(y,h),y}catch(_){throw h.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",r==="inbound"?"from":"to",e.maConn.remoteAddr,p,_),y.timeline.close==null&&y.abort(_),_}},Promise.all([l.sink(i.source),i.sink(l.source)]).catch(p=>{h.log.error("error piping data through muxer - %e",p)}));const f=s.timeline;s.timeline=new Proxy(f,{set:(...p)=>(p[1]==="close"&&p[2]!=null&&f.close==null&&(async()=>{try{h.status==="open"&&await h.close()}catch(m){h.log.error("error closing connection after timeline close %e",m)}finally{this.events.safeDispatchEvent("connection:close",{detail:h})}})().catch(m=>{h.log.error("error thrown while dispatching connection:close event %e",m)}),Reflect.set(...p))}),s.timeline.upgraded=Date.now();const g=()=>{throw new hi("Connection is not multiplexed")};return h=fy({remoteAddr:s.remoteAddr,remotePeer:o,status:"open",direction:r,timeline:s.timeline,multiplexer:l==null?void 0:l.protocol,encryption:t,limits:c,logger:this.components.logger,newStream:u??g,getStreams:()=>(l==null?void 0:l.streams)??[],close:async p=>{await(l==null?void 0:l.close(p)),await s.close(p)},abort:p=>{s.abort(p),l==null||l.abort(p)}}),this.events.safeDispatchEvent("connection:open",{detail:h}),h.__maConnTimeline=f,h}_onStream(e){const{connection:t,stream:r,protocol:s}=e,{handler:i,options:o}=this.components.registrar.getHandler(s);if(t.limits!=null&&o.runOnLimitedConnection!==!0)throw new rl("Cannot open protocol stream on limited connection");i({connection:t,stream:r})}async _encryptInbound(e,t){const r=Array.from(this.connectionEncrypters.keys());try{const{stream:s,protocol:i}=await Ra(e,r,{...t,log:e.log}),o=this.connectionEncrypters.get(i);if(o==null)throw new fi(`no crypto module found for ${i}`);return e.log("encrypting inbound connection to %a using %s",e.remoteAddr,i),{...await o.secureInbound(s,t),protocol:i}}catch(s){throw e.log.error("encrypting inbound connection from %a failed",e.remoteAddr,s),new fi(s.message)}}async _encryptOutbound(e,t){const r=Array.from(this.connectionEncrypters.keys());try{e.log.trace("selecting encrypter from %s",r);const{stream:s,protocol:i}=await Ta(e,r,{...t,log:e.log,yieldBytes:!0}),o=this.connectionEncrypters.get(i);if(o==null)throw new fi(`no crypto module found for ${i}`);return e.log("encrypting outbound connection to %a using %s",e.remoteAddr,i),{...await o.secureOutbound(s,t),protocol:i}}catch(s){throw e.log.error("encrypting outbound connection to %a failed",e.remoteAddr,s),new fi(s.message)}}async _multiplexOutbound(e,t,r){const s=Array.from(t.keys());e.log("outbound selecting muxer %s",s);try{e.log.trace("selecting stream muxer from %s",s);const{stream:i,protocol:o}=await Ta(e,s,{...r,log:e.log,yieldBytes:!0});e.log("selected %s as muxer protocol",o);const a=t.get(o);return{stream:i,muxerFactory:a}}catch(i){throw e.log.error("error multiplexing outbound connection",i),new hi(String(i))}}async _multiplexInbound(e,t,r){const s=Array.from(t.keys());e.log("inbound handling muxers %s",s);try{const{stream:i,protocol:o}=await Ra(e,s,{...r,log:e.log}),a=t.get(o);return{stream:i,muxerFactory:a}}catch(i){throw e.log.error("error multiplexing inbound connection",i),new hi(String(i))}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}}const j0="2.8.5",G0="js-libp2p";function yy(n,e){return`${n??G0}/${e??j0} browser/${globalThis.navigator.userAgent}`}var Ms,Dc;class by extends sr{constructor(t){var u,h,f,g,p,m,y,E,_,w,b,v;super();re(this,Ms);d(this,"peerId");d(this,"peerStore");d(this,"contentRouting");d(this,"peerRouting");d(this,"metrics");d(this,"services");d(this,"logger");d(this,"status");d(this,"components");d(this,"log");this.status="stopped";const r=new sr,s=r.dispatchEvent.bind(r);r.dispatchEvent=x=>{const C=s(x),R=this.dispatchEvent(new CustomEvent(x.type,{detail:x.detail}));return C||R},this.peerId=t.peerId,this.logger=t.logger??l0(),this.log=this.logger.forComponent("libp2p"),this.services={};const i=((u=t.nodeInfo)==null?void 0:u.name)??G0,o=((h=t.nodeInfo)==null?void 0:h.version)??j0,a=this.components=Og({peerId:t.peerId,privateKey:t.privateKey,nodeInfo:{name:i,version:o,userAgent:((f=t.nodeInfo)==null?void 0:f.userAgent)??yy(i,o)},logger:this.logger,events:r,datastore:t.datastore??new Rp,connectionGater:qg(t.connectionGater),dns:t.dns});this.peerStore=this.configureComponent("peerStore",kp(a,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...t.peerStore})),t.metrics!=null&&(this.metrics=this.configureComponent("metrics",t.metrics(this.components))),a.events.addEventListener("peer:update",x=>{if(x.detail.previous==null){const C={id:x.detail.peer.id,multiaddrs:x.detail.peer.addresses.map(R=>R.multiaddr)};a.events.safeDispatchEvent("peer:discovery",{detail:C})}}),t.connectionProtector!=null&&this.configureComponent("connectionProtector",t.connectionProtector(a)),this.components.upgrader=new my(this.components,{connectionEncrypters:(t.connectionEncrypters??[]).map((x,C)=>this.configureComponent(`connection-encryption-${C}`,x(this.components))),streamMuxers:(t.streamMuxers??[]).map((x,C)=>this.configureComponent(`stream-muxers-${C}`,x(this.components))),inboundUpgradeTimeout:(g=t.connectionManager)==null?void 0:g.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:((p=t.connectionManager)==null?void 0:p.inboundStreamProtocolNegotiationTimeout)??((m=t.connectionManager)==null?void 0:m.protocolNegotiationTimeout),outboundStreamProtocolNegotiationTimeout:((y=t.connectionManager)==null?void 0:y.outboundStreamProtocolNegotiationTimeout)??((E=t.connectionManager)==null?void 0:E.protocolNegotiationTimeout)}),this.configureComponent("transportManager",new ey(this.components,t.transportManager)),this.configureComponent("connectionManager",new Dm(this.components,t.connectionManager)),((_=t.connectionMonitor)==null?void 0:_.enabled)!==!1&&this.configureComponent("connectionMonitor",new qm(this.components,t.connectionMonitor)),this.configureComponent("registrar",new Jm(this.components)),this.configureComponent("addressManager",new Eg(this.components,t.addresses));const c=(t.peerRouters??[]).map((x,C)=>this.configureComponent(`peer-router-${C}`,x(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new Qm(this.components,{routers:c}));const l=(t.contentRouters??[]).map((x,C)=>this.configureComponent(`content-router-${C}`,x(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new Wm(this.components,{routers:l})),this.configureComponent("randomWalk",new Ym(this.components)),(t.peerDiscovery??[]).forEach((x,C)=>{this.configureComponent(`peer-discovery-${C}`,x(this.components)).addEventListener("peer",F=>{te(this,Ms,Dc).call(this,F)})}),(w=t.transports)==null||w.forEach((x,C)=>{this.components.transportManager.add(this.configureComponent(`transport-${C}`,x(this.components)))}),t.services!=null)for(const x of Object.keys(t.services)){const C=t.services[x],R=C(this.components);if(R==null){this.log.error("service factory %s returned null or undefined instance",x);continue}this.services[x]=R,this.configureComponent(x,R),R[Ja]!=null&&(this.log("registering service %s for content routing",x),l.push(R[Ja])),R[Xa]!=null&&(this.log("registering service %s for peer routing",x),c.push(R[Xa])),R[Za]!=null&&(this.log("registering service %s for peer discovery",x),(v=(b=R[Za]).addEventListener)==null||v.call(b,"peer",F=>{te(this,Ms,Dc).call(this,F)}))}Mg(a)}configureComponent(t,r){return r==null&&this.log.error("component %s was null or undefined",t),this.components[t]=r,r}async start(){var t,r,s,i;if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await((r=(t=this.components).beforeStart)==null?void 0:r.call(t)),await this.components.start(),await((i=(s=this.components).afterStart)==null?void 0:i.call(s)),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(o){throw this.log.error("An error occurred starting libp2p",o),this.status="started",await this.stop(),o}}}async stop(){var t,r,s,i;this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await((r=(t=this.components).beforeStop)==null?void 0:r.call(t)),await this.components.stop(),await((i=(s=this.components).afterStop)==null?void 0:i.call(s)),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(t){return this.components.connectionManager.getConnections(t)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const t=new Ht;for(const r of this.components.connectionManager.getConnections())t.add(r.remotePeer);return Array.from(t)}async dial(t,r={}){return this.components.connectionManager.openConnection(t,{priority:75,...r})}async dialProtocol(t,r,s={}){if(r==null)throw new G("no protocols were provided to open a stream");if(r=Array.isArray(r)?r:[r],r.length===0)throw new G("no protocols were provided to open a stream");return(await this.dial(t,s)).newStream(r,s)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(t,r={}){Ro(t)&&(t=qr(t.getPeerId()??"")),await this.components.connectionManager.closeConnections(t,r)}async getPublicKey(t,r={}){if(this.log("getPublicKey %p",t),t.publicKey!=null)return t.publicKey;try{const a=await this.peerStore.get(t);if(a.id.publicKey!=null)return a.id.publicKey}catch(a){if(a.name!=="NotFoundError")throw a}const s=St([O("/pk/"),t.toMultihash().bytes]),i=await this.contentRouting.get(s,r),o=Zr(i);return await this.peerStore.patch(t,{publicKey:o}),o}async handle(t,r,s){Array.isArray(t)||(t=[t]),await Promise.all(t.map(async i=>{await this.components.registrar.handle(i,r,s)}))}async unhandle(t){Array.isArray(t)||(t=[t]),await Promise.all(t.map(async r=>{await this.components.registrar.unhandle(r)}))}async register(t,r){return this.components.registrar.register(t,r)}unregister(t){this.components.registrar.unregister(t)}async isDialable(t,r={}){return this.components.connectionManager.isDialable(t,r)}}Ms=new WeakSet,Dc=function(t){const{detail:r}=t;if(r.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(r.id,{multiaddrs:r.multiaddrs}).catch(s=>{this.log.error(s)})};async function wy(n={}){n.privateKey??(n.privateKey=await l7());const e=new by({...await v9(n),peerId:p7(n.privateKey)});return n.start!==!1&&await e.start(),e}const Qs=1e3,$l=60*Qs,Vo=60*$l,vy=36*Vo,Ey="/ipfs/kad/1.0.0",Sy=48*Vo,_y=24*Vo,xy=10,ky=16384,Cy=Vo,W0=20,Vl=3,Ay=5*$l,Iy=Qs,Py=5*Qs,Ty=5*$l,Ry=30*Qs,Dy=180*Qs,Gu=`${Xc}-kad-dht`;var ho;(function(n){let e;n.codec=()=>(e==null&&(e=Ue((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.key!=null&&t.key.byteLength>0&&(r.uint32(10),r.bytes(t.key)),t.value!=null&&t.value.byteLength>0&&(r.uint32(18),r.bytes(t.value)),t.timeReceived!=null&&t.timeReceived!==""&&(r.uint32(42),r.string(t.timeReceived)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={key:ke(0),value:ke(0),timeReceived:""},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.key=t.bytes();break}case 2:{i.value=t.bytes();break}case 5:{i.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return i})),e),n.encode=t=>Me(t,n.codec()),n.decode=(t,r)=>Oe(t,n.codec(),r)})(ho||(ho={}));function By(n){const e=n.getUTCFullYear(),t=String(n.getUTCMonth()+1).padStart(2,"0"),r=String(n.getUTCDate()).padStart(2,"0"),s=String(n.getUTCHours()).padStart(2,"0"),i=String(n.getUTCMinutes()).padStart(2,"0"),o=String(n.getUTCSeconds()).padStart(2,"0"),a=n.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${e}-${t}-${r}T${s}:${i}:${o}.${c}Z`}function Ly(n){const e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(n).trim().match(e);if(t==null)throw new Error("Invalid format");const r=parseInt(t[1],10),s=parseInt(t[2],10)-1,i=parseInt(t[3],10),o=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),l=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(r,s,i,o,a,c,l))}class Et{constructor(e,t,r){d(this,"key");d(this,"value");d(this,"timeReceived");if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=r}serialize(){return ho.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:By(this.timeReceived)}}static deserialize(e){const t=ho.decode(e);return new Et(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){const t=Ly(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new Et(e.key,e.value,t)}}function Ny(n){return n[Symbol.asyncIterator]!=null}function Ho(n,e){let t=0;if(Ny(n))return async function*(){for await(const c of n)yield e(c,t++)}();const r=E0(n),{value:s,done:i}=r.next();if(i===!0)return function*(){}();const o=e(s,t++);if(typeof o.then=="function")return async function*(){yield await o;for await(const c of r)yield e(c,t++)}();const a=e;return function*(){yield o;for(const c of r)yield a(c,t++)}()}function qo(n,...e){if(n==null)throw new Error("Empty pipeline");if(Da(n)){const r=n;n=()=>r.source}else if(Y0(n)||Q0(n)){const r=n;n=()=>r}const t=[n,...e];if(t.length>1&&Da(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let r=1;r<t.length-1;r++)Da(t[r])&&(t[r]=My(t[r]));return Oy(...t)}const Oy=(...n)=>{let e;for(;n.length>0;)e=n.shift()(e);return e},Q0=n=>(n==null?void 0:n[Symbol.asyncIterator])!=null,Y0=n=>(n==null?void 0:n[Symbol.iterator])!=null,Da=n=>n==null?!1:n.sink!=null&&n.source!=null,My=n=>e=>{const t=n.sink(e);if((t==null?void 0:t.then)!=null){const r=M0({objectMode:!0});t.then(()=>{r.end()},o=>{r.end(o)});let s;const i=n.source;if(Q0(i))s=async function*(){yield*i,r.end()};else if(Y0(i))s=function*(){yield*i,r.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return Ss(r,s())}return n.source};class fo extends Error{constructor(e="Query error"){super(e),this.name="QueryError"}}class Uy extends Error{constructor(e="Query aborted"){super(e),this.name="QueryAbortedError"}}class Fy extends Error{constructor(e="Invalid record"){super(e),this.name="InvalidRecordError"}}class $y extends Error{constructor(e="No selector function configured for prefix"){super(e),this.name="MissingSelectorError"}}var Wu;(function(n){let e;n.codec=()=>(e==null&&(e=Ue((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.key!=null&&(r.uint32(10),r.bytes(t.key)),t.value!=null&&(r.uint32(18),r.bytes(t.value)),t.author!=null&&(r.uint32(26),r.bytes(t.author)),t.signature!=null&&(r.uint32(34),r.bytes(t.signature)),t.timeReceived!=null&&(r.uint32(42),r.string(t.timeReceived)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.key=t.bytes();break}case 2:{i.value=t.bytes();break}case 3:{i.author=t.bytes();break}case 4:{i.signature=t.bytes();break}case 5:{i.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return i})),e),n.encode=t=>Me(t,n.codec()),n.decode=(t,r)=>Oe(t,n.codec(),r)})(Wu||(Wu={}));var pe;(function(n){n.PUT_VALUE="PUT_VALUE",n.GET_VALUE="GET_VALUE",n.ADD_PROVIDER="ADD_PROVIDER",n.GET_PROVIDERS="GET_PROVIDERS",n.FIND_NODE="FIND_NODE",n.PING="PING"})(pe||(pe={}));var po;(function(n){n[n.PUT_VALUE=0]="PUT_VALUE",n[n.GET_VALUE=1]="GET_VALUE",n[n.ADD_PROVIDER=2]="ADD_PROVIDER",n[n.GET_PROVIDERS=3]="GET_PROVIDERS",n[n.FIND_NODE=4]="FIND_NODE",n[n.PING=5]="PING"})(po||(po={}));(function(n){n.codec=()=>Io(po)})(pe||(pe={}));var Dn;(function(n){n.NOT_CONNECTED="NOT_CONNECTED",n.CONNECTED="CONNECTED",n.CAN_CONNECT="CAN_CONNECT",n.CANNOT_CONNECT="CANNOT_CONNECT"})(Dn||(Dn={}));var Bc;(function(n){n[n.NOT_CONNECTED=0]="NOT_CONNECTED",n[n.CONNECTED=1]="CONNECTED",n[n.CAN_CONNECT=2]="CAN_CONNECT",n[n.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(Bc||(Bc={}));(function(n){n.codec=()=>Io(Bc)})(Dn||(Dn={}));var an;(function(n){let e;n.codec=()=>(e==null&&(e=Ue((t,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),t.id!=null&&t.id.byteLength>0&&(r.uint32(10),r.bytes(t.id)),t.multiaddrs!=null)for(const i of t.multiaddrs)r.uint32(18),r.bytes(i);t.connection!=null&&(r.uint32(24),Dn.codec().encode(t.connection,r)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{var a;const i={id:ke(0),multiaddrs:[]},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const c=t.uint32();switch(c>>>3){case 1:{i.id=t.bytes();break}case 2:{if(((a=s.limits)==null?void 0:a.multiaddrs)!=null&&i.multiaddrs.length===s.limits.multiaddrs)throw new kr('Decode error - map field "multiaddrs" had too many elements');i.multiaddrs.push(t.bytes());break}case 3:{i.connection=Dn.codec().decode(t);break}default:{t.skipType(c&7);break}}}return i})),e),n.encode=t=>Me(t,n.codec()),n.decode=(t,r)=>Oe(t,n.codec(),r)})(an||(an={}));var $r;(function(n){let e;n.codec=()=>(e==null&&(e=Ue((t,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),t.type!=null&&po[t.type]!==0&&(r.uint32(8),pe.codec().encode(t.type,r)),t.clusterLevel!=null&&(r.uint32(80),r.int32(t.clusterLevel)),t.key!=null&&(r.uint32(18),r.bytes(t.key)),t.record!=null&&(r.uint32(26),r.bytes(t.record)),t.closer!=null)for(const i of t.closer)r.uint32(66),an.codec().encode(i,r);if(t.providers!=null)for(const i of t.providers)r.uint32(74),an.codec().encode(i,r);s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{var a,c,l,u;const i={type:pe.PUT_VALUE,closer:[],providers:[]},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const h=t.uint32();switch(h>>>3){case 1:{i.type=pe.codec().decode(t);break}case 10:{i.clusterLevel=t.int32();break}case 2:{i.key=t.bytes();break}case 3:{i.record=t.bytes();break}case 8:{if(((a=s.limits)==null?void 0:a.closer)!=null&&i.closer.length===s.limits.closer)throw new kr('Decode error - map field "closer" had too many elements');i.closer.push(an.codec().decode(t,t.uint32(),{limits:(c=s.limits)==null?void 0:c.closer$}));break}case 9:{if(((l=s.limits)==null?void 0:l.providers)!=null&&i.providers.length===s.limits.providers)throw new kr('Decode error - map field "providers" had too many elements');i.providers.push(an.codec().decode(t,t.uint32(),{limits:(u=s.limits)==null?void 0:u.providers$}));break}default:{t.skipType(h&7);break}}}return i})),e),n.encode=t=>Me(t,n.codec()),n.decode=(t,r)=>Oe(t,n.codec(),r)})($r||($r={}));function Qu(n,e={}){var r;const t={...n,name:"SEND_QUERY",type:0,messageName:n.type,messageType:n.type};return(r=e.onProgress)==null||r.call(e,new CustomEvent("kad-dht:query:send-query",{detail:t})),t}function Lc(n,e={}){var r;const t={...n,name:"PEER_RESPONSE",type:1,messageName:n.messageType,closer:n.closer??[],providers:n.providers??[]};return(r=e.onProgress)==null||r.call(e,new CustomEvent("kad-dht:query:peer-response",{detail:t})),t}function Ba(n,e={}){var r;const t={...n,name:"FINAL_PEER",type:2};return(r=e.onProgress)==null||r.call(e,new CustomEvent("kad-dht:query:final-peer",{detail:t})),t}function Ar(n,e={}){var r;const t={...n,name:"QUERY_ERROR",type:3};return(r=e.onProgress)==null||r.call(e,new CustomEvent("kad-dht:query:query-error",{detail:t})),t}function Yu(n,e={}){var r;const t={...n,name:"PROVIDER",type:4};return(r=e.onProgress)==null||r.call(e,new CustomEvent("kad-dht:query:provider",{detail:t})),t}function Nc(n,e={}){var r;const t={...n,name:"VALUE",type:5};return(r=e.onProgress)==null||r.call(e,new CustomEvent("kad-dht:query:value",{detail:t})),t}function Ju(n,e={}){var r;const t={...n,name:"DIAL_PEER",type:7};return(r=e.onProgress)==null||r.call(e,new CustomEvent("kad-dht:query:dial-peer",{detail:t})),t}function Vy(n,e,t){if(t.length===0)throw new G("No records given");const s=M(e).split("/");if(s.length<3)throw new G("Record key does not have a selector function");const i=n[s[1].toString()];if(i==null)throw new $y(`No selector function configured for key type "${s[1]}"`);return t.length===1?0:i(e,t)}function Hy(n,e){return 0}const qy={pk:Hy};async function Hl(n,e){const t=e.key,s=M(t).split("/");if(s.length<3)return;const i=n[s[1].toString()];if(i==null)throw new G(`No validator available for key type "${s[1]}"`);await i(t,e.value)}const zy=async(n,e)=>{if(!(n instanceof Uint8Array))throw new G('"key" must be a Uint8Array');if(n.byteLength<5)throw new G("Invalid public key record");if(M(n.subarray(0,4))!=="/pk/")throw new G("key was not prefixed with /pk/");const r=Zr(e),s=n.slice(4);if(!ie(s,r.toMultihash().bytes))throw new G("public key does not match passed in key")},Ky={pk:zy},jy=O("/pk/");function Gy(n){return{...n,multiaddrs:n.multiaddrs.filter(e=>{const[[t,r]]=e.stringTuples();if(t===53||t===54||t===55)return r!=="localhost";if(t!==4&&t!==6||r==null)return!1;const s=Un(r);return s==null?!0:!s})}}async function _s(n){return(await tt.digest(n)).digest}async function Pt(n){return _s(n.toMultihash().bytes)}function es(n,e){return new Re(`${n}/${M(e,"base32")}`,!1)}function Wy(n){return St([jy,n.toMultihash().bytes])}function Qy(n){return M(n.subarray(0,4))==="/pk/"}function Yy(n){const e=ct(n.subarray(4));return or(e)}function Zu(n,e){const t=new Date;return new Et(n,e,t).serialize()}const Jy=290,Zy=54,Xy=55,eb=56,tb=4,rb=41;function nb(n){const e=n.stringTuples();for(const t of e)if(t[0]===Jy)return!1;if(e[0][0]===Zy||e[0][0]===Xy||e[0][0]===eb)return!0;if(e[0][0]===tb||e[0][0]===rb){const t=Un(`${e[0][1]}`);return t==null||!t}return!1}function J0(n){const e=n.toString().split("/"),t=e.pop(),r=e.pop();if(t==null||r==null)throw new Error(`incorrectly formatted provider entry key in datastore: ${n.toString()}`);return{cid:Z.createV1(q6,ct(O(r,"base32"))),peerId:qr(t)}}function La(n,e,t){const r=typeof e=="string"?e:M(e.multihash.bytes,"base32"),s=[n,r];return t!=null&&s.push(t.toString()),new Re(s.join("/"))}function Z0(n){return new Date(Pr(n))}function on(n,e,t){return async function*(...r){var a,c,l,u,h;const s=(a=e.queryTime)==null?void 0:a.timer(t),i=(c=e.errorTime)==null?void 0:c.timer(t);let o=!1;try{(l=e.queries)==null||l.increment({[t]:!0}),yield*n(...r)}catch(f){throw o=!0,i==null||i(),(u=e.errors)==null||u.increment({[t]:!0}),f}finally{(h=e.queries)==null||h.decrement({[t]:!0}),o||s==null||s()}}}function X0(n,e,t){return async function(...r){var a,c,l,u,h;const s=(a=e==null?void 0:e.queryTime)==null?void 0:a.timer(t),i=(c=e==null?void 0:e.errorTime)==null?void 0:c.timer(t);let o=!1;try{return(l=e.queries)==null||l.increment({[t]:!0}),await n(...r)}catch(f){throw o=!0,i==null||i(),(u=e.errors)==null||u.increment({[t]:!0}),f}finally{(h=e.queries)==null||h.decrement({[t]:!0}),o||s==null||s()}}}class sb{constructor(e,t){d(this,"log");d(this,"components");d(this,"validators");d(this,"selectors");d(this,"peerRouting");d(this,"queryManager");d(this,"network");d(this,"datastorePrefix");var l,u;const{validators:r,selectors:s,peerRouting:i,queryManager:o,network:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-fetching`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=r,this.selectors=s,this.peerRouting=i,this.queryManager=o,this.network=a,this.get=((l=e.metrics)==null?void 0:l.traceFunction("libp2p.kadDHT.get",this.get.bind(this),{optionsIndex:1}))??this.get,this.put=((u=e.metrics)==null?void 0:u.traceFunction("libp2p.kadDHT.put",this.put.bind(this),{optionsIndex:2}))??this.put}async getLocal(e){this.log("getLocal %b",e);const t=es(this.datastorePrefix,e);this.log("fetching record for key %k",t);const r=await this.components.datastore.get(t);this.log("found %k in local datastore",t);const s=Et.deserialize(r);return await Hl(this.validators,s),s}async*sendCorrectionRecord(e,t,r,s={}){this.log("sendCorrection for %b",e);const i=Zu(e,r);for(const{value:o,from:a}of t){if(ie(o,r)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{const u=es(this.datastorePrefix,e);this.log(`Storing corrected record for key ${u.toString()}`),await this.components.datastore.put(u,i.subarray())}catch(u){this.log.error("Failed error correcting self",u)}continue}let c=!1;const l={type:pe.PUT_VALUE,key:e,record:i};for await(const u of this.network.sendRequest(a,l,s))u.name==="PEER_RESPONSE"&&u.record!=null&&ie(u.record.value,Et.deserialize(i).value)&&(c=!0),yield u;c||(yield Ar({from:a,error:new fo("Value not put correctly")},s)),this.log.error("Failed error correcting entry")}}async*put(e,t,r={}){this.log("put key %b value %b",e,t);const s=Zu(e,t),i=es(this.datastorePrefix,e);this.log(`storing record for key ${i.toString()}`),await this.components.datastore.put(i,s.subarray()),yield*qo(this.peerRouting.getClosestPeers(e,{...r,signal:r.signal}),o=>Ho(o,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];const c=[],l={type:pe.PUT_VALUE,key:e,record:s};this.log("send put to %p",a.peer.id);for await(const u of this.network.sendRequest(a.peer.id,l,r))c.push(u),u.name==="PEER_RESPONSE"&&(u.record!=null&&ie(u.record.value,Et.deserialize(s).value)||c.push(Ar({from:a.peer.id,error:new fo("Value not put correctly")},r)));return c}),o=>Uo(o,{ordered:!1,concurrency:Vl}),async function*(o){for await(const a of o)yield*a})}async*get(e,t={}){this.log("get %b",e);const r=[];for await(const a of this.getMany(e,t))a.name==="VALUE"&&r.push(a),yield a;if(r.length===0)return;const s=r.map(a=>a.value);let i=0;try{i=Vy(this.selectors,e,s)}catch(a){if(a.name!=="InvalidParametersError")throw a}const o=s[i];if(this.log("GetValue %b %b",e,o),o==null)throw new xr("Best value was not found");yield*this.sendCorrectionRecord(e,r,o,t),yield r[i]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{const i=await this.getLocal(e);yield Nc({value:i.value,from:this.components.peerId},t)}catch(i){this.log("error getting local value for %b",e,i)}const r=this,s=async function*({peer:i,signal:o}){for await(const a of r.peerRouting.getValueOrPeers(i,e,{...t,signal:o}))yield a,a.name==="PEER_RESPONSE"&&a.record!=null&&(yield Nc({from:i,value:a.record.value},t))};yield*this.queryManager.run(e,s,t)}}function ib(n,e){return{id:n.id.toMultihash().bytes,multiaddrs:(n.multiaddrs??[]).map(r=>r.bytes),connection:e}}function mi(n){if(n.id==null)throw new Error("Invalid peer in message");const e=ct(n.id);return{id:or(e),multiaddrs:(n.multiaddrs??[]).map(t=>se(t))}}class ob{constructor(e,t){d(this,"log");d(this,"components");d(this,"network");d(this,"peerRouting");d(this,"queryManager");d(this,"routingTable");d(this,"providers");var l,u;const{network:r,peerRouting:s,queryManager:i,routingTable:o,providers:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-routing`),this.network=r,this.peerRouting=s,this.queryManager=i,this.routingTable=o,this.providers=a,this.findProviders=((l=e.metrics)==null?void 0:l.traceFunction("libp2p.kadDHT.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(h,f)=>(h.name==="PROVIDER"&&(f.providers??(f.providers=[]),f.providers.push(...h.providers.map(g=>g.id.toString()))),f)}))??this.findProviders,this.provide=((u=e.metrics)==null?void 0:u.traceFunction("libp2p.kadDHT.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(h,f)=>(h.name==="PEER_RESPONSE"&&h.messageName==="ADD_PROVIDER"&&(f.providers??(f.providers=[]),f.providers.push(h.from.toString())),f)}))??this.provide}async*provide(e,t,r={}){this.log("provide %s",e);const s=e.multihash.bytes;await this.providers.addProvider(e,this.components.peerId);const i={type:pe.ADD_PROVIDER,key:s,providers:[ib({id:this.components.peerId,multiaddrs:t})]};let o=0;const a=c=>async()=>{if(c.name!=="FINAL_PEER")return[c];const l=[];this.log("putProvider %s to %p",e,c.peer.id);try{this.log("sending provider record for %s to %p",e,c.peer.id);for await(const u of this.network.sendMessage(c.peer.id,i,r))u.name==="PEER_RESPONSE"&&(this.log("sent provider record for %s to %p",e,c.peer.id),o++),l.push(u)}catch(u){this.log.error("error sending provide record to peer %p",c.peer.id,u),l.push(Ar({from:c.peer.id,error:u},r))}return l};yield*qo(this.peerRouting.getClosestPeers(s,r),c=>Ho(c,l=>a(l)),c=>Uo(c,{ordered:!1,concurrency:Vl}),async function*(c){for await(const l of c)yield*l}),this.log("sent provider records to %d peers",o)}async*findProviders(e,t){const r=this.routingTable.kBucketSize;let s=0;const i=e.multihash.bytes,o=this;this.log("findProviders %c",e);const a=await this.providers.getProviders(e);if(a.length>0){const u=[];for(const h of a.slice(0,r))try{const f=await this.components.peerStore.get(h);u.push({id:h,multiaddrs:f.addresses.map(({multiaddr:g})=>g)})}catch(f){if(f.name!=="NotFoundError")throw f;this.log("no peer store entry for %p",h)}if(yield Lc({from:this.components.peerId,messageType:pe.GET_PROVIDERS,providers:u},t),yield Yu({from:this.components.peerId,providers:u},t),s+=u.length,s>=r)return}const c=async function*({peer:u,signal:h}){const f={type:pe.GET_PROVIDERS,key:i};yield*o.network.sendRequest(u,f,{...t,signal:h})},l=new Ht(a);for await(const u of this.queryManager.run(i,c,t))if(yield u,u.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",u.providers.length,e,u.closer.length);const h=[];for(const f of u.providers)l.has(f.id)||(l.add(f.id),h.push(f));if(h.length>0&&(yield Yu({from:u.from,providers:h},t),s+=h.length,s>=r))return}}}function go(n,e){const t=Fo(n,e),r={read:async(s,i)=>{const o=await t.read(i);return s.decode(o)},write:async(s,i,o)=>{await t.write(i.encode(s),o)},writeV:async(s,i,o)=>{await t.writeV(s.map(a=>i.encode(a)),o)},pb:s=>({read:async i=>r.read(s,i),write:async(i,o)=>r.write(i,s,o),writeV:async(i,o)=>r.writeV(i,s,o),unwrap:()=>r}),unwrap:()=>t.unwrap()};return r}class ab extends sr{constructor(t,r){var s,i,o,a;super();d(this,"log");d(this,"protocol");d(this,"running");d(this,"components");d(this,"timeout");d(this,"metrics");this.components=t,this.log=t.logger.forComponent(`${r.logPrefix}:network`),this.running=!1,this.protocol=r.protocol,this.timeout=new Es({...r.timeout??{},metrics:t.metrics,metricName:`${r.metricsPrefix}_network_message_send_times_milliseconds`}),this.metrics={operations:(s=t.metrics)==null?void 0:s.registerCounterGroup(`${r.metricsPrefix}_outbound_rpc_requests_total`),errors:(i=t.metrics)==null?void 0:i.registerCounterGroup(`${r.metricsPrefix}_outbound_rpc_errors_total`)},this.sendRequest=((o=t.metrics)==null?void 0:o.traceFunction("libp2p.kadDHT.sendRequest",this.sendRequest.bind(this),{optionsIndex:2,getAttributesFromArgs([c,l],u){return{...u,to:c.toString(),"message type":`${l.type}`}},getAttributesFromYieldedValue:(c,l)=>(c.name==="PEER_RESPONSE"&&(c.providers.length>0&&c.providers.forEach((u,h)=>{l[`providers-${h}`]=u.id.toString()}),c.closer.length>0&&c.closer.forEach((u,h)=>{l[`closer-${h}`]=u.id.toString()})),l)}))??this.sendRequest,this.sendMessage=((a=t.metrics)==null?void 0:a.traceFunction("libp2p.kadDHT.sendMessage",this.sendMessage.bind(this),{optionsIndex:2,getAttributesFromArgs([c,l],u){return{...u,to:c.toString(),"message type":`${l.type}`}},getAttributesFromYieldedValue:(c,l)=>(c.name==="PEER_RESPONSE"&&(c.providers.length>0&&c.providers.forEach((u,h)=>{l[`providers-${h}`]=u.id.toString()}),c.closer.length>0&&c.closer.forEach((u,h)=>{l[`closer-${h}`]=u.id.toString()})),l)}))??this.sendMessage}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(t,r,s={}){var c,l,u;if(!this.running)return;const i=r.type;if(i==null)throw new G("Message type was missing");this.log("sending %s to %p",r.type,t),yield Ju({peer:t},s),yield Qu({to:t,type:i},s);let o;const a=this.timeout.getTimeoutSignal(s);s={...s,signal:a};try{(c=this.metrics.operations)==null||c.increment({[i]:!0}),o=await(await this.components.connectionManager.openConnection(t,s)).newStream(this.protocol,s);const f=await this._writeReadMessage(o,r,s);o.close(s).catch(g=>{this.log.error("error closing stream to %p",t,g),o==null||o.abort(g)}),yield Lc({from:t,messageType:f.type,closer:f.closer.map(mi),providers:f.providers.map(mi),record:f.record==null?void 0:Et.deserialize(f.record)},s)}catch(h){(l=this.metrics.errors)==null||l.increment({[i]:!0}),o==null||o.abort(h),((u=s.signal)==null?void 0:u.aborted)!==!0&&this.log.error("could not send %s to %p - %e",r.type,t,h),yield Ar({from:t,error:h},s)}finally{this.timeout.cleanUp(a)}}async*sendMessage(t,r,s={}){var c,l;if(!this.running)return;const i=r.type;if(i==null)throw new G("Message type was missing");this.log("sending %s to %p",r.type,t),yield Ju({peer:t},s),yield Qu({to:t,type:i},s);let o;const a=this.timeout.getTimeoutSignal(s);s={...s,signal:a};try{(c=this.metrics.operations)==null||c.increment({[i]:!0}),o=await(await this.components.connectionManager.openConnection(t,s)).newStream(this.protocol,s),await this._writeMessage(o,r,s),o.close(s).catch(h=>{this.log.error("error closing stream to %p",t,h),o==null||o.abort(h)}),yield Lc({from:t,messageType:i},s)}catch(u){(l=this.metrics.errors)==null||l.increment({[i]:!0}),o==null||o.abort(u),yield Ar({from:t,error:u},s)}finally{this.timeout.cleanUp(a)}}async _writeMessage(t,r,s){await go(t).write(r,$r,s)}async _writeReadMessage(t,r,s){const i=go(t);await i.write(r,$r,s);const o=await i.read($r,s);return o.closer.forEach(a=>{this.safeDispatchEvent("peer",{detail:mi(a)})}),o.providers.forEach(a=>{this.safeDispatchEvent("peer",{detail:mi(a)})}),o}}function Ir(n,e){if(n.length!==e.length)throw new Error("Inputs should have the same length");const t=qt(n.length);for(let r=0;r<n.length;r++)t[r]=n[r]^e[r];return t}function xs(n,e){if(n.byteLength!==e.byteLength)throw new Error("Inputs should have the same length");for(let t=0;t<n.byteLength;t++)if(n[t]!==e[t])return n[t]<e[t]?-1:1;return 0}class ql{constructor(e,t){d(this,"originDhtKey");d(this,"capacity");d(this,"peerDistances");this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return this.peerDistances.map(e=>e.peer)}async add(e){const t=await Pt(e.id);this.addWithKadId(e,t)}addWithKadId(e,t){if(this.peerDistances.find(i=>i.peer.id.equals(e.id))!=null)return;const r={peer:e,distance:Ir(this.originDhtKey,t)};let s=!1;for(let i=0;i<this.peerDistances.length;i++){const o=xs(this.peerDistances[i].distance,r.distance);if(o===0||o===1){s=!0,this.peerDistances.splice(i,0,r);break}}s||this.peerDistances.push(r),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(e){if(this.length===0)return!0;const t=await Pt(e),r=Ir(t,this.originDhtKey),s=this.peerDistances[this.peerDistances.length-1].distance;return xs(r,s)===-1}async anyCloser(e){return e.length===0?!1:Promise.any(e.map(async t=>this.isCloser(t)))}}class cb{constructor(e,t){d(this,"log");d(this,"routingTable");d(this,"network");d(this,"validators");d(this,"queryManager");d(this,"peerStore");d(this,"peerId");var r,s;this.routingTable=t.routingTable,this.network=t.network,this.validators=t.validators,this.queryManager=t.queryManager,this.peerStore=e.peerStore,this.peerId=e.peerId,this.log=e.logger.forComponent(`${t.logPrefix}:peer-routing`),this.findPeer=((r=e.metrics)==null?void 0:r.traceFunction("libp2p.kadDHT.findPeer",this.findPeer.bind(this),{optionsIndex:1}))??this.findPeer,this.getClosestPeers=((s=e.metrics)==null?void 0:s.traceFunction("libp2p.kadDHT.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1}))??this.getClosestPeers}async findPeerLocal(e){let t;const r=await this.routingTable.find(e);if(r!=null){this.log("findPeerLocal found %p in routing table",e);try{t=await this.peerStore.get(r)}catch(s){if(s.name!=="NotFoundError")throw s}}if(t==null)try{t=await this.peerStore.get(e)}catch(s){if(s.name!=="NotFoundError")throw s}if(t!=null)return this.log("findPeerLocal found %p in peer store",e),{id:t.id,multiaddrs:t.addresses.map(s=>s.multiaddr)}}async*_getValueSingle(e,t,r={}){const s={type:pe.GET_VALUE,key:t};yield*this.network.sendRequest(e,s,r)}async*getPublicKeyFromNode(e,t={}){const r=Wy(e);for await(const s of this._getValueSingle(e,r,t))if(yield s,s.name==="PEER_RESPONSE"&&s.record!=null){const i=Zr(s.record.value),o=To(i);if(!o.equals(e))throw new hs("public key does not match id");if(o.publicKey==null)throw new hs("public key missing");yield Nc({from:e,value:s.record.value},t)}throw new fo(`Node not responding with its public key: ${e.toString()}`)}async*findPeer(e,t={}){if(this.log("findPeer %p",e),t.useCache!==!1){const s=await this.findPeerLocal(e);if(s!=null){this.log("found local"),yield Ba({from:this.peerId,peer:s},t);return}}let r=!1;if(t.useNetwork!==!1){const s=this,i=async function*({peer:o,signal:a}){const c={type:pe.FIND_NODE,key:e.toMultihash().bytes};for await(const l of s.network.sendRequest(o,c,{...t,signal:a}))if(yield l,l.name==="PEER_RESPONSE"){const u=l.closer.find(h=>h.id.equals(e));u!=null&&(yield Ba({from:l.from,peer:u},t))}};for await(const o of this.queryManager.run(e.toMultihash().bytes,i,t))o.name==="FINAL_PEER"&&(r=!0),yield o}r||(yield Ar({from:this.peerId,error:new xr("Not found")},t))}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);const r=await _s(e),s=this.routingTable.closestPeers(r),i=this,o=new ql(r,this.routingTable.kBucketSize);await Promise.all(s.map(async c=>{await o.add({id:c,multiaddrs:[]})}));const a=async function*({peer:c,signal:l}){i.log("closerPeersSingle %s from %p",M(e,"base32"),c);const u={type:pe.FIND_NODE,key:e};yield*i.network.sendRequest(c,u,{...t,signal:l})};for await(const c of this.queryManager.run(e,a,t))c.name==="PEER_RESPONSE"&&await Promise.all(c.closer.map(async l=>{await o.add(l)})),yield c;this.log("found %d peers close to %b",o.length,e);for(const c of o.peers)yield Ba({from:this.peerId,peer:c},t)}async*getValueOrPeers(e,t,r={}){for await(const s of this._getValueSingle(e,t,r)){if(s.name==="PEER_RESPONSE"&&s.record!=null)try{await this._verifyRecordOnline(s.record)}catch{const o="invalid record received, discarded";this.log(o),yield Ar({from:s.from,error:new fo(o)},r);continue}yield s}}async _verifyRecordOnline(e){if(e.timeReceived==null)throw new Fy("invalid record received");await Hl(this.validators,new Et(e.key,e.value,e.timeReceived))}async getCloserPeersOffline(e,t){const r=[];try{const c=ct(e),l=or(c),u=await this.peerStore.get(l);r.push({id:u.id,multiaddrs:u.addresses.map(({multiaddr:h})=>h)})}catch{}const s=await _s(e),i=this.routingTable.closestPeers(s),o=await Pt(t),a=Ir(o,s);for(const c of i){const l=await Pt(c),u=Ir(l,s);if(xs(u,a)===-1)try{const h=await this.peerStore.get(c);r.push({id:c,multiaddrs:h.addresses.map(({multiaddr:f})=>f)})}catch(h){if(h.name!=="NotFoundError")throw h}}return r.length>0?this.log("getCloserPeersOffline found %d peer(s) closer to %b than %p",r.length,e,t):this.log("getCloserPeersOffline could not find peer closer to %b than %p with %d peers in the routing table",e,t,this.routingTable.size),r}}class lb{constructor(e,t){d(this,"log");d(this,"datastore");d(this,"datastorePrefix");d(this,"lock");this.log=e.logger.forComponent(`${t.logPrefix}:providers`),this.datastorePrefix=`${t.datastorePrefix}/provider`,this.datastore=e.datastore,this.lock=t.lock}async addProvider(e,t){const r=await this.lock.readLock();try{this.log("%p provides %s",t,e),await this.writeProviderEntry(e,t)}finally{r()}}async removeProvider(e,t){const r=await this.lock.writeLock();try{const s=La(this.datastorePrefix,e,t);this.log("%p no longer provides %s",t,e),await this.datastore.delete(s)}finally{r()}}async getProviders(e){const t=await this.lock.readLock();try{this.log("get providers for %c",e);const r=await this.loadProviders(e);return this.log("got %d providers for %c",r.size,e),[...r.keys()]}finally{t()}}async writeProviderEntry(e,t,r=new Date){const s=La(this.datastorePrefix,e,t),i=Ct(r.getTime());await this.datastore.put(s,i)}async loadProviders(e){const t=new js,r=La(this.datastorePrefix,e);for await(const s of this.datastore.query({prefix:r.toString()})){const{peerId:i}=J0(s.key);t.set(i,Z0(s.value))}return t}}async function*ub(n){const{key:e,startingPeer:t,ourPeerId:r,signal:s,query:i,alpha:o,pathIndex:a,numPaths:c,queryFuncTimeout:l,log:u,peersSeen:h,connectionManager:f}=n,g=new Mo({concurrency:o,sort:(y,E)=>xs(y.options.distance,E.options.distance)}),p=await _s(e);function m(y,E){if(y==null)return;h.add(y);const _=Ir(E,p);g.add(async()=>{const w=[s];l!=null&&w.push(AbortSignal.timeout(l));const b=zt(w);try{for await(const v of i({...n,key:e,peer:y,signal:b,pathIndex:a,numPaths:c})){if(b.aborted)return;if(v.name==="PEER_RESPONSE")for(const x of v.closer){if(h.has(x.id)){u.trace("already seen %p in query",x.id);continue}if(r.equals(x.id)){u("not querying ourselves");continue}if(!await f.isDialable(x.multiaddrs)){u("not querying undialable peer");continue}const C=await Pt(x.id),R=Ir(C,p);if(xs(R,_)!==-1){u.trace("skipping %p as they are not closer to %b than %p",x.id,e,y);continue}u.trace("querying closer peer %p",x.id),m(x.id,C)}g.safeDispatchEvent("completed",{detail:v})}}catch(v){if(!s.aborted)return Ar({from:y,error:v},n)}finally{b.clear()}},{distance:_}).catch(w=>{u.error(w)})}m(t,await Pt(t));try{for await(const y of g.toGenerator({signal:s}))y!=null&&(yield y)}catch(y){throw s.aborted?new Uy("Query aborted"):y}}class db{constructor(e,t){d(this,"disjointPaths");d(this,"alpha");d(this,"shutDownController");d(this,"running");d(this,"logger");d(this,"peerId");d(this,"connectionManager");d(this,"routingTable");d(this,"initialQuerySelfHasRun");d(this,"logPrefix");this.logPrefix=t.logPrefix,this.disjointPaths=t.disjointPaths??W0,this.alpha=t.alpha??Vl,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.logger=e.logger,this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.shutDownController=new AbortController,this.shutDownController.signal,this.running=!1}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutDownController=new AbortController,this.shutDownController.signal,void 0)}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,r={}){if(!this.running)throw new Error("QueryManager not started");if(r.signal==null){const c=AbortSignal.timeout(Dy);r={...r,signal:c}}const s=new AbortController,i=zt([this.shutDownController.signal,s.signal,r.signal]);s.signal;const o=this.logger.forComponent(`${this.logPrefix}:query:`+M(e,"base58btc"));let a=!1;try{r.isSelfQuery!==!0&&this.initialQuerySelfHasRun!=null&&(o("waiting for initial query-self query before continuing"),await Gr(this.initialQuerySelfHasRun.promise,i),this.initialQuerySelfHasRun=void 0),o("query:start");const c=await _s(e),l=this.routingTable.closestPeers(c),u=l.slice(0,Math.min(this.disjointPaths,l.length));if(l.length===0){o.error("Running query with no peers");return}const h=new Ht,f=u.map((g,p)=>ub({...r,key:e,startingPeer:g,ourPeerId:this.peerId,signal:i,query:t,pathIndex:p,numPaths:u.length,alpha:this.alpha,queryFuncTimeout:r.queryFuncTimeout,log:o,peersSeen:h,onProgress:r.onProgress,connectionManager:this.connectionManager}));for await(const g of Ss(...f)){if(g.name==="QUERY_ERROR"&&o.error("query error",g.error),g.name==="PEER_RESPONSE")for(const p of[...g.closer,...g.providers])await this.connectionManager.isDialable(p.multiaddrs)&&await this.routingTable.add(p.id);yield g}a=!0}catch(c){if(!(!this.running&&c.name==="QueryAbortedError"))throw c}finally{a||(o("query exited early"),s.abort()),i.clear(),o("query:done")}}}function hb(n){return n[Symbol.asyncIterator]!=null}function ef(n){if(hb(n))return(async()=>{let e=0;for await(const t of n)e++;return e})();{let e=0;for(const t of n)e++;return e}}const fb=n=>{const e=n.addEventListener||n.on||n.addListener,t=n.removeEventListener||n.off||n.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(n),removeListener:t.bind(n)}};function pb(n,e,t){let r;const s=new Promise((i,o)=>{var g;if(t={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");(g=t.signal)==null||g.throwIfAborted();const a=[e].flat(),c=[],{addListener:l,removeListener:u}=fb(n),h=(...p)=>{const m=t.multiArgs?p:p[0];t.filter&&!t.filter(m)||(c.push(m),t.count===c.length&&(r(),i(c)))},f=p=>{r(),o(p)};r=()=>{for(const p of a)u(p,h);for(const p of t.rejectionEvents)u(p,f)};for(const p of a)l(p,h);for(const p of t.rejectionEvents)l(p,f);t.signal&&t.signal.addEventListener("abort",()=>{f(t.signal.reason)},{once:!0}),t.resolveImmediately&&i(c)});if(s.cancel=r,typeof t.timeout=="number"){const i=xl(s,{milliseconds:t.timeout});return i.cancel=r,i}return s}function gb(n,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};const r=pb(n,e,t),s=r.then(i=>i[0]);return s.cancel=r.cancel,s}class mb{constructor(e,t){d(this,"log");d(this,"peerId");d(this,"peerRouting");d(this,"routingTable");d(this,"count");d(this,"interval");d(this,"initialInterval");d(this,"queryTimeout");d(this,"running");d(this,"timeoutId");d(this,"controller");d(this,"initialQuerySelfHasRun");d(this,"querySelfPromise");this.peerId=e.peerId,this.log=e.logger.forComponent(`${t.logPrefix}:query-self`),this.running=!1,this.peerRouting=t.peerRouting,this.routingTable=t.routingTable,this.count=t.count??W0,this.interval=t.interval??Ay,this.initialInterval=t.initialInterval??Iy,this.queryTimeout=t.queryTimeout??Py,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.querySelf=X0(this.querySelf.bind(this),t.operationMetrics,"SELF_QUERY")}isStarted(){return this.running}start(){this.running||(this.running=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.initialInterval))}stop(){this.running=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}async querySelf(){if(!this.running){this.log("skip self-query because we are not started");return}if(this.querySelfPromise!=null)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=Le(),this.running){this.controller=new AbortController;const e=[this.controller.signal];if(this.initialQuerySelfHasRun==null){const r=AbortSignal.timeout(this.queryTimeout);e.push(r)}const t=zt(e);this.controller.signal;try{this.routingTable.size===0&&(this.log("routing table was empty, waiting for some peers before running query"),await gb(this.routingTable,"peer:add",{signal:t,filter:i=>!this.peerId.equals(i.detail)}),this.log("routing table has peers, continuing with query")),this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);const r=Date.now(),s=await qo(this.peerRouting.getClosestPeers(this.peerId.toMultihash().bytes,{signal:t,isSelfQuery:!0}),i=>xc(i,this.count),async i=>ef(i));this.log("self-query found %d peers in %dms",s,Date.now()-r)}catch(r){this.log.error("self-query error",r)}finally{t.clear(),this.initialQuerySelfHasRun!=null&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.running&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.interval))}}class yb extends sr{constructor(t,r){super();d(this,"log");d(this,"reprovideQueue");d(this,"maxQueueSize");d(this,"datastore");d(this,"timeout");d(this,"reprovideTimeout");d(this,"running");d(this,"shutdownController");d(this,"reprovideThreshold");d(this,"contentRouting");d(this,"datastorePrefix");d(this,"addressManager");d(this,"validity");d(this,"interval");d(this,"lock");d(this,"peerId");this.log=t.logger.forComponent(`${r.logPrefix}:reprovider`),this.peerId=t.peerId,this.reprovideQueue=new Mo({concurrency:r.concurrency??xy,metrics:t.metrics,metricName:`${r.metricsPrefix}_reprovide_queue`}),this.reprovideTimeout=new Es({...r.timeout??{},metrics:t.metrics,metricName:`${r.metricsPrefix}_reprovide_timeout_milliseconds`}),this.datastore=t.datastore,this.addressManager=t.addressManager,this.datastorePrefix=`${r.datastorePrefix}/provider`,this.reprovideThreshold=r.threshold??_y,this.maxQueueSize=r.maxQueueSize??ky,this.validity=r.validity??Sy,this.interval=r.interval??Cy,this.contentRouting=r.contentRouting,this.lock=r.lock,this.running=!1,this.reprovide=X0(this.reprovide.bind(this),r.operationMetrics,"PROVIDE")}start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,this.timeout=setTimeout(()=>{this.cleanUp().catch(t=>{this.log.error("error running reprovide/cleanup - %e",t)})},this.interval))}stop(){var t;this.running=!1,this.reprovideQueue.clear(),clearTimeout(this.timeout),(t=this.shutdownController)==null||t.abort()}async cleanUp(){const t=await this.lock.writeLock();try{this.safeDispatchEvent("reprovide:start");for await(const r of this.datastore.query({prefix:this.datastorePrefix}))try{const{cid:s,peerId:i}=J0(r.key),o=Z0(r.value).getTime(),a=o+this.validity,c=Date.now(),l=c>a;this.log.trace("comparing: %d < %d = %s %s",o,c-this.validity,l,l?"(expired)":""),l&&await this.datastore.delete(r.key),this.peerId.equals(i)&&c-a<this.reprovideThreshold&&this.queueReprovide(s).catch(u=>{this.log.error("could not reprovide %c - %e",s,u)})}catch(s){this.log.error("error processing datastore key %s - %e",r.key,s.message)}this.log("reprovide/cleanup successful")}finally{t(),this.safeDispatchEvent("reprovide:end"),this.running&&(this.timeout=setTimeout(()=>{this.cleanUp().catch(r=>{this.log.error("error running re-provide - %e",r)})},this.interval))}}async queueReprovide(t){var s;if(!this.running)return;this.log.trace("waiting for queue capacity before adding %c to re-provide queue",t),await this.reprovideQueue.onSizeLessThan(this.maxQueueSize);const r=this.reprovideQueue.queue.find(i=>i.options.cid.equals(t));if(r!=null)return this.log.trace("not adding %c to re-provide queue - already in queue",t),r.join();this.log.trace("adding %c to re-provide queue",t),this.reprovideQueue.add(async i=>{var a;if((a=i.signal)==null||a.throwIfAborted(),!this.running)return;this.log.trace("re-providing %c",t);const o=this.reprovideTimeout.getTimeoutSignal(i);try{await this.reprovide(i.cid,i)}finally{this.reprovideTimeout.cleanUp(o)}this.log.trace("re-provided %c",t)},{signal:(s=this.shutdownController)==null?void 0:s.signal,cid:t}).catch(i=>{this.log.error("could not re-provide key %c - %e",t,i)})}async reprovide(t,r){await bs(this.contentRouting.provide(t,this.addressManager.getAddresses(),r))}}const bb=20,wb=5e3,vb="kad-close",Eb=50;class Sb{constructor(e,t){d(this,"routingTable");d(this,"components");d(this,"closestPeers");d(this,"newPeers");d(this,"refreshInterval");d(this,"peerSetSize");d(this,"timeout");d(this,"closeTagName");d(this,"closeTagValue");d(this,"log");d(this,"running");this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.routingTable=t.routingTable,this.refreshInterval=t.refreshInterval??wb,this.peerSetSize=t.peerSetSize??bb,this.closeTagName=t.closeTagName??vb,this.closeTagValue=t.closeTagValue??Eb,this.closestPeers=new Ht,this.onPeerPing=this.onPeerPing.bind(this),this.running=!1}async start(){if(this.running)return;this.running=!0;const e=await Pt(this.components.peerId);this.newPeers=new ql(e,this.peerSetSize),this.routingTable.addEventListener("peer:ping",this.onPeerPing),this.timeout=setInterval(()=>{this.updatePeerTags().catch(t=>{this.log.error("error updating peer tags - %e",t)})},this.refreshInterval)}stop(){this.running=!1,this.routingTable.removeEventListener("peer:ping",this.onPeerPing),clearTimeout(this.timeout)}onPeerPing(e){var t;(t=this.newPeers)==null||t.add({id:e.detail,multiaddrs:[]}).catch(r=>{this.log.error("error adding peer to distance list - %e",r)})}async updatePeerTags(){var s;const e=new Ht((s=this.newPeers)==null?void 0:s.peers.map(i=>i.id)),t=e.difference(this.closestPeers),r=this.closestPeers.difference(e);this.closestPeers=e,await Promise.all([...[...t].map(async i=>{await this.components.peerStore.merge(i,{tags:{[this.closeTagName]:{value:this.closeTagValue},[Gu]:{value:1}}})}),...[...r].map(async i=>{await this.components.peerStore.merge(i,{tags:{[this.closeTagName]:void 0,[Gu]:void 0}})})])}}function Oi(n){return Array.isArray(n==null?void 0:n.peers)}class _b{constructor(e){d(this,"root");d(this,"localPeer");d(this,"prefixLength");d(this,"splitThreshold");d(this,"kBucketSize");d(this,"numberOfNodesToPing");d(this,"lastPingThreshold");d(this,"ping");d(this,"verify");d(this,"onAdd");d(this,"onRemove");d(this,"onMove");d(this,"addingPeerMap");this.prefixLength=e.prefixLength??Cb,this.kBucketSize=e.kBucketSize??tf,this.splitThreshold=e.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=e.numberOfOldContactsToPing??Pb,this.lastPingThreshold=e.lastPingThreshold??Bb,this.ping=e.ping,this.verify=e.verify,this.onAdd=e.onAdd,this.onRemove=e.onRemove,this.addingPeerMap=new js,this.root={prefix:"",depth:0,peers:[]}}async addSelfPeer(e){this.localPeer={peerId:e,kadId:await Pt(e),lastPing:Date.now()}}async add(e,t){const r={peerId:e,kadId:await Pt(e),lastPing:0},s=this.addingPeerMap.get(e);if(s!=null)return s;try{const i=this._add(r,t);this.addingPeerMap.set(e,i),await i}finally{this.addingPeerMap.delete(e)}}async _add(e,t){var o;const r=this._determineBucket(e.kadId);if(this._indexOf(r,e.kadId)>-1)return;if(r.peers.length===this.splitThreshold&&r.depth<this.prefixLength){await this._split(r),await this._add(e,t);return}if(r.peers.length<this.kBucketSize){if(!kb(e,this.lastPingThreshold)){r.peers.push(e),await((o=this.onAdd)==null?void 0:o.call(this,e,r));return}await this.verify(e,t)&&(e.lastPing=Date.now(),await this._add(e,t));return}const s=r.peers.filter(a=>{var c;return!(a.peerId.equals((c=this.localPeer)==null?void 0:c.peerId)||a.lastPing>Date.now()-this.lastPingThreshold)}).sort((a,c)=>a.lastPing<c.lastPing?-1:a.lastPing>c.lastPing?1:0).slice(0,this.numberOfNodesToPing);let i=!1;for await(const a of this.ping(s,t))i=!0,await this.remove(a.kadId);i&&await this._add(e,t)}*closest(e,t=this.kBucketSize){const r=new ql(e,t);for(const s of this.toIterable())r.addWithKadId({id:s.peerId,multiaddrs:[]},s.kadId);yield*Ho(r.peers,s=>s.id)}count(){function e(t){if(Oi(t))return t.peers.length;let r=0;return t.left!=null&&(r+=e(t.left)),t.right!=null&&(r+=e(t.right)),r}return e(this.root)}get(e){const t=this._determineBucket(e),r=this._indexOf(t,e);return t.peers[r]}async remove(e){var s;const t=this._determineBucket(e),r=this._indexOf(t,e);if(r>-1){const i=t.peers.splice(r,1)[0];await((s=this.onRemove)==null?void 0:s.call(this,i,t))}}*toIterable(){function*e(t){if(Oi(t)){yield*t.peers;return}yield*e(t.left),yield*e(t.right)}yield*e(this.root)}distance(e,t){return BigInt("0x"+M(Ir(e,t),"base16"))}_determineBucket(e){const t=M(e,"base2");function r(s,i=0){return Oi(s)?s:t[i]==="0"?r(s.left,i+1):r(s.right,i+1)}return r(this.root)}_indexOf(e,t){return e.peers.findIndex(r=>ie(r.kadId,t))}async _split(e){var s,i;const t={prefix:"0",depth:e.depth+1,peers:[]},r={prefix:"1",depth:e.depth+1,peers:[]};for(const o of e.peers)M(o.kadId,"base2")[e.depth]==="0"?(t.peers.push(o),await((s=this.onMove)==null?void 0:s.call(this,o,e,t))):(r.peers.push(o),await((i=this.onMove)==null?void 0:i.call(this,o,e,r)));xb(e,t,r)}}function xb(n,e,t){return delete n.peers,n.left=e,n.right=t,n.prefix===""&&(delete n.depth,delete n.prefix),!0}function kb(n,e){return n.lastPing<Date.now()-e}const tf=20,Cb=6,Ab=20,Ib=100,Pb=3,Tb=20,Rb=100,Xu="kad-peer",Db=1,Bb=6e5,Lb=!0,Nb=1e3;class Ob extends sr{constructor(t,r){super();d(this,"kBucketSize");d(this,"kb");d(this,"network");d(this,"closestPeerTagger");d(this,"log");d(this,"components");d(this,"running");d(this,"pingNewContactTimeout");d(this,"pingNewContactQueue");d(this,"pingOldContactTimeout");d(this,"pingOldContactQueue");d(this,"populateFromDatastoreOnStart");d(this,"populateFromDatastoreLimit");d(this,"protocol");d(this,"peerTagName");d(this,"peerTagValue");d(this,"metrics");this.components=t,this.log=t.logger.forComponent(`${r.logPrefix}:routing-table`),this.kBucketSize=r.kBucketSize??tf,this.running=!1,this.protocol=r.protocol,this.network=r.network,this.peerTagName=r.peerTagName??Xu,this.peerTagValue=r.peerTagValue??Db,this.pingOldContacts=this.pingOldContacts.bind(this),this.verifyNewContact=this.verifyNewContact.bind(this),this.peerAdded=this.peerAdded.bind(this),this.peerRemoved=this.peerRemoved.bind(this),this.populateFromDatastoreOnStart=r.populateFromDatastoreOnStart??Lb,this.populateFromDatastoreLimit=r.populateFromDatastoreLimit??Nb,this.pingOldContactQueue=new Tc({concurrency:r.pingOldContactConcurrency??Tb,metricName:`${r.metricsPrefix}_ping_old_contact_queue`,metrics:this.components.metrics,maxSize:r.pingOldContactMaxQueueSize??Rb}),this.pingOldContactTimeout=new Es({...r.pingOldContactTimeout??{},metrics:this.components.metrics,metricName:`${r.metricsPrefix}_routing_table_ping_old_contact_time_milliseconds`}),this.pingNewContactQueue=new Tc({concurrency:r.pingNewContactConcurrency??Ab,metricName:`${r.metricsPrefix}_ping_new_contact_queue`,metrics:this.components.metrics,maxSize:r.pingNewContactMaxQueueSize??Ib}),this.pingNewContactTimeout=new Es({...r.pingNewContactTimeout??{},metrics:this.components.metrics,metricName:`${r.metricsPrefix}_routing_table_ping_new_contact_time_milliseconds`}),this.kb=new _b({kBucketSize:r.kBucketSize,prefixLength:r.prefixLength,splitThreshold:r.splitThreshold,numberOfOldContactsToPing:r.numberOfOldContactsToPing,lastPingThreshold:r.lastPingThreshold,ping:this.pingOldContacts,verify:this.verifyNewContact,onAdd:this.peerAdded,onRemove:this.peerRemoved}),this.closestPeerTagger=new Sb(this.components,{logPrefix:r.logPrefix,routingTable:this,peerSetSize:r.closestPeerSetSize,refreshInterval:r.closestPeerSetRefreshInterval,closeTagName:r.closeTagName,closeTagValue:r.closeTagValue}),this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${r.metricsPrefix}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${r.metricsPrefix}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${r.metricsPrefix}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMinOccupancy:this.components.metrics.registerMetric(`${r.metricsPrefix}_routing_table_kad_bucket_min_occupancy`),routingTableKadBucketMaxOccupancy:this.components.metrics.registerMetric(`${r.metricsPrefix}_routing_table_kad_bucket_max_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${r.metricsPrefix}_routing_table_kad_bucket_max_depth`),kadBucketEvents:this.components.metrics.registerCounterGroup(`${r.metricsPrefix}_kad_bucket_events_total`)})}isStarted(){return this.running}async start(){this.running||(this.running=!0,await qi(this.closestPeerTagger),await this.kb.addSelfPeer(this.components.peerId))}async afterStart(){Promise.resolve().then(async()=>{if(!this.populateFromDatastoreOnStart)return;let t=0;for(const r of await this.components.peerStore.all({filters:[s=>s.protocols.includes(this.protocol)&&s.tags.has(Xu)],limit:this.populateFromDatastoreLimit})){if(!this.running)return;try{await this.add(r.id),t++}catch{this.log("failed to add peer %p to routing table, removing kad-dht peer tags - %e"),await this.components.peerStore.merge(r.id,{tags:{[this.peerTagName]:void 0}})}}this.log("added %d peer store peers to the routing table",t)}).catch(t=>{this.log.error("error adding peer store peers to the routing table %e",t)})}async stop(){this.running=!1,await sl(this.closestPeerTagger),this.pingOldContactQueue.abort(),this.pingNewContactQueue.abort()}async peerAdded(t,r){var s;this.components.peerId.equals(t.peerId)||await this.components.peerStore.merge(t.peerId,{tags:{[this.peerTagName]:{value:this.peerTagValue}}}),this.updateMetrics(),(s=this.metrics)==null||s.kadBucketEvents.increment({peer_added:!0}),this.safeDispatchEvent("peer:add",{detail:t.peerId})}async peerRemoved(t,r){var s;this.components.peerId.equals(t.peerId)||await this.components.peerStore.merge(t.peerId,{tags:{[this.peerTagName]:void 0}}),this.updateMetrics(),(s=this.metrics)==null||s.kadBucketEvents.increment({peer_removed:!0}),this.safeDispatchEvent("peer:remove",{detail:t.peerId})}async*pingOldContacts(t,r){var i;if(!this.running)return;const s=[];for(const o of t){if(this.kb.get(o.kadId)==null){this.log("asked to ping contact %p that was not in routing table",o.peerId);continue}(i=this.metrics)==null||i.kadBucketEvents.increment({ping_old_contact:!0}),s.push(async()=>{const a=this.pingOldContactQueue.find(o.peerId);if(a!=null)return this.log("asked to ping contact %p was already being pinged",o.peerId),await a.join(r)?void 0:o;if(!await this.pingOldContactQueue.add(async l=>{var f;const u=this.pingOldContactTimeout.getTimeoutSignal(),h=zt([u,l==null?void 0:l.signal]);try{return await this.pingContact(o,l)}catch{return(f=this.metrics)==null||f.kadBucketEvents.increment({ping_old_contact_error:!0}),!0}finally{this.pingOldContactTimeout.cleanUp(u),h.clear()}},{peerId:o.peerId,signal:r==null?void 0:r.signal}))return o})}for await(const o of Uo(s))o!=null&&(yield o)}async verifyNewContact(t,r){var o;const s=this.pingNewContactTimeout.getTimeoutSignal(),i=zt([s,r==null?void 0:r.signal]);try{const a=this.pingNewContactQueue.find(t.peerId);return a!=null?(this.log("joining existing ping to add new peer %p to routing table",t.peerId),await a.join({signal:i})):await this.pingNewContactQueue.add(async c=>{var l;return(l=this.metrics)==null||l.kadBucketEvents.increment({ping_new_contact:!0}),this.log("pinging new peer %p before adding to routing table",t.peerId),this.pingContact(t,c)},{peerId:t.peerId,signal:i})}catch{return this.log.trace("tried to add peer %p but they were not online",t.peerId),(o=this.metrics)==null||o.kadBucketEvents.increment({ping_new_contact_error:!0}),!1}finally{this.pingNewContactTimeout.cleanUp(s),i.clear()}}async pingContact(t,r){try{return this.log("pinging contact %p",t.peerId),await this.components.ping.ping(t.peerId,r),this.log("contact %p ping ok",t.peerId),this.safeDispatchEvent("peer:ping",{detail:t.peerId}),!0}catch(s){return this.log("error pinging old contact %p - %e",t.peerId,s),!1}}get size(){return this.kb==null?0:this.kb.count()}async find(t){var s;const r=await Pt(t);return(s=this.kb.get(r))==null?void 0:s.peerId}closestPeer(t){const r=this.closestPeers(t,1);if(r.length>0)return r[0]}closestPeers(t,r=this.kBucketSize){return this.kb==null?[]:[...this.kb.closest(t,r)]}async add(t,r){if(this.kb==null)throw new Error("RoutingTable is not started");await this.kb.add(t,r)}async remove(t){if(this.kb==null)throw new Error("RoutingTable is not started");const r=await Pt(t);await this.kb.remove(r)}updateMetrics(){if(this.metrics==null||this.kb==null)return;let t=0,r=0,s=0,i=20,o=0;function a(c){if(Oi(c)){c.depth>s&&(s=c.depth),r++,t+=c.peers.length,c.peers.length<i&&(i=c.peers.length),c.peers.length>o&&(o=c.peers.length);return}a(c.left),a(c.right)}a(this.kb.root),this.metrics.routingTableSize.update(t),this.metrics.routingTableKadBucketTotal.update(r),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(t/r)),this.metrics.routingTableKadBucketMinOccupancy.update(i),this.metrics.routingTableKadBucketMaxOccupancy.update(o),this.metrics.routingTableKadBucketMaxDepth.update(s)}}const Mb=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782],yi=15;class Ub{constructor(e,t){d(this,"log");d(this,"peerRouting");d(this,"routingTable");d(this,"refreshInterval");d(this,"refreshQueryTimeout");d(this,"commonPrefixLengthRefreshedAt");d(this,"refreshTimeoutId");const{peerRouting:r,routingTable:s,refreshInterval:i,refreshQueryTimeout:o,logPrefix:a}=t;this.log=e.logger.forComponent(`${a}:routing-table:refresh`),this.peerRouting=r,this.routingTable=s,this.refreshInterval=i??Ty,this.refreshQueryTimeout=o??Ry,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1){this.log("refreshing routing table");const t=this._maxCommonPrefix(),r=this._getTrackedCommonPrefixLengthsForRefresh(t);this.log(`max common prefix length ${t}`),this.log(`tracked CPLs [ ${r.map(s=>s.toISOString()).join(", ")} ]`),Promise.all(r.map(async(s,i)=>{try{if(await this._refreshCommonPrefixLength(i,s,e),this._numPeersForCpl(t)===0){const o=Math.min(2*(i+1),r.length-1);for(let a=i+1;a<o+1;a++)try{await this._refreshCommonPrefixLength(a,s,e)}catch(c){this.log.error(c)}}}catch(o){this.log.error(o)}})).catch(s=>{this.log.error(s)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(s=>{this.log.error(s)})}async _refreshCommonPrefixLength(e,t,r){if(!r&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}const s=await this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,s,this.routingTable.size);const i=AbortSignal.timeout(this.refreshQueryTimeout),o=await ef(this.peerRouting.getClosestPeers(s.toMultihash().bytes,{signal:i}));this.log(`found ${o} peers that were close to imaginary peer %p`,s),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,s,this.routingTable.size)}_getTrackedCommonPrefixLengthsForRefresh(e){e>yi&&(e=yi);const t=[];for(let r=0;r<=e;r++)t[r]=this.commonPrefixLengthRefreshedAt[r]??new Date;return t}async _generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");if(this.routingTable.kb.localPeer==null)throw new Error("Local peer not set");const t=Po(2),r=(t[1]<<8)+t[0],s=await this._makePeerId(this.routingTable.kb.localPeer.kadId,r,e),i=ct(s);return or(i)}async _makePeerId(e,t,r){if(r>yi)throw new Error(`Cannot generate peer ID for common prefix length greater than ${yi}`);const o=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>r,a=65535<<16-(r+1),c=o&a|t&~a,l=Mb[c],u=new ArrayBuffer(34),h=new DataView(u,0,u.byteLength);return h.setUint8(0,tt.code),h.setUint8(1,32),h.setUint32(2,l,!1),new Uint8Array(h.buffer,h.byteOffset,h.byteLength)}_maxCommonPrefix(){let e=0;for(const t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(const r of this._prefixLengths())r===e&&t++;return t}*_prefixLengths(){var e;if(((e=this.routingTable.kb)==null?void 0:e.localPeer)!=null)for(const{kadId:t}of this.routingTable.kb.toIterable()){const r=Ir(this.routingTable.kb.localPeer.kadId,t);let s=0;for(const i of r)if(i===0)s++;else break;yield s}}}class Fb{constructor(e,t){d(this,"peerId");d(this,"providers");d(this,"peerStore");d(this,"log");this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:add-provider`),this.peerId=e.peerId,this.providers=t.providers,this.peerStore=e.peerStore}async handle(e,t){if(t.key==null||t.key.length===0)throw new Ke("Missing key");let r;try{r=Z.decode(t.key)}catch{throw new Ke("Invalid CID")}(t.providers==null||t.providers.length===0)&&this.log.error("no providers found in message"),this.log("%p asked us, %p to store provider record for for %c",e,this.peerId,r),await Promise.all(t.providers.map(async s=>{const i=ct(s.id),o=or(i),a=s.multiaddrs.map(c=>se(c));if(!e.equals(o)){this.log("invalid provider peer %p from %p",s.id,e);return}if(s.multiaddrs.length<1){this.log("no valid addresses for provider %p. Ignore",e);return}this.log.trace("received provider %p for %s (addrs %s)",e,r,a),await this.providers.addProvider(r,o),await this.peerStore.merge(o,{multiaddrs:a})}))}}class $b{constructor(e,t){d(this,"peerRouting");d(this,"peerInfoMapper");d(this,"peerId");d(this,"addressManager");d(this,"log");const{peerRouting:r,logPrefix:s}=t;this.log=e.logger.forComponent(`${s}:rpc:handlers:find-node`),this.peerId=e.peerId,this.addressManager=e.addressManager,this.peerRouting=r,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(this.log("incoming request from %p for peers closer to %b",e,t.key),t.key==null)throw new Ke("Invalid FIND_NODE message received - key was missing");const r=await this.peerRouting.getCloserPeersOffline(t.key,e);ie(this.peerId.toMultihash().bytes,t.key)&&r.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map(i=>i.decapsulateCode(ce("p2p").code))});const s={type:pe.FIND_NODE,clusterLevel:t.clusterLevel,closer:r.map(this.peerInfoMapper).filter(({multiaddrs:i})=>i.length).map(i=>({id:i.id.toMultihash().bytes,multiaddrs:i.multiaddrs.map(o=>o.bytes)})),providers:[]};return s.closer.length===0&&this.log("could not find any peers closer to %b than %p",t.key,e),s}}class Vb{constructor(e,t){d(this,"peerId");d(this,"peerRouting");d(this,"providers");d(this,"peerStore");d(this,"peerInfoMapper");d(this,"log");const{peerRouting:r,providers:s,logPrefix:i}=t;this.log=e.logger.forComponent(`${i}:rpc:handlers:get-providers`),this.peerId=e.peerId,this.peerStore=e.peerStore,this.peerRouting=r,this.providers=s,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(t.key==null)throw new Ke("Invalid GET_PROVIDERS message received - key was missing");let r;try{r=Z.decode(t.key)}catch{throw new Ke("Invalid CID")}this.log("%p asking for providers for %s",e,r);const[s,i]=await Promise.all([no(Ho(await this.providers.getProviders(r),async a=>{const c=await this.peerStore.get(a);return{id:c.id,multiaddrs:c.addresses.map(({multiaddr:u})=>u)}})),this.peerRouting.getCloserPeersOffline(t.key,this.peerId)]),o={type:pe.GET_PROVIDERS,key:t.key,clusterLevel:t.clusterLevel,closer:i.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)})),providers:s.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))};return this.log("got %s providers %s closerPeers",o.providers.length,o.closer.length),o}async _getAddresses(e){return[]}}class Hb{constructor(e,t){d(this,"peerStore");d(this,"datastore");d(this,"peerRouting");d(this,"log");d(this,"datastorePrefix");this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:get-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.peerStore=e.peerStore,this.datastore=e.datastore,this.peerRouting=t.peerRouting}async handle(e,t){const r=t.key;if(this.log("%p asked for key %b",e,r),r==null||r.length===0)throw new Ke("Invalid key");const s={type:pe.GET_VALUE,key:r,clusterLevel:t.clusterLevel,closer:[],providers:[]};if(Qy(r)){this.log("is public key");const a=Yy(r);let c;try{const l=await this.peerStore.get(a);if(l.id.publicKey==null)throw new xr("No public key found in key book");c=tr(l.id.publicKey)}catch(l){if(l.name!=="NotFoundError")throw l}if(c!=null)return this.log("returning found public key"),s.record=new Et(r,c,new Date).serialize(),s}const[i,o]=await Promise.all([this._checkLocalDatastore(r),this.peerRouting.getCloserPeersOffline(r,e)]);return i!=null&&(this.log("had record for %b in local datastore",r),s.record=i.serialize()),o.length>0&&(this.log("had %s closer peers in routing table",o.length),s.closer=o.map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))),s}async _checkLocalDatastore(e){this.log("checkLocalDatastore looking for %b",e);const t=es(this.datastorePrefix,e);let r;try{r=await this.datastore.get(t)}catch(i){if(i.name==="NotFoundError")return;throw i}const s=Et.deserialize(r);if(s.timeReceived==null||Date.now()-s.timeReceived.getTime()>vy){await this.datastore.delete(t);return}return s}}class qb{constructor(e,t){d(this,"log");this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:ping`)}async handle(e,t){return this.log("ping from %p",e),t}}class zb{constructor(e,t){d(this,"components");d(this,"validators");d(this,"log");d(this,"datastorePrefix");const{validators:r}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:put-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=r}async handle(e,t){const r=t.key;if(this.log("%p asked us to store value for key %b",e,r),t.record==null){const s=`Empty record from: ${e.toString()}`;throw this.log.error(s),new Ke(s)}try{const s=Et.deserialize(t.record);await Hl(this.validators,s),s.timeReceived=new Date;const i=es(this.datastorePrefix,s.key);await this.components.datastore.put(i,s.serialize().subarray()),this.log("put record for %b into datastore under key %k",r,i)}catch(s){this.log("did not put record for key %b into datastore %o",r,s)}return t}}class Kb{constructor(e,t){d(this,"handlers");d(this,"routingTable");d(this,"log");d(this,"metrics");var r,s;this.metrics={operations:(r=e.metrics)==null?void 0:r.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_requests_total`),errors:(s=e.metrics)==null?void 0:s.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_errors_total`)},this.log=e.logger.forComponent(`${t.logPrefix}:rpc`),this.routingTable=t.routingTable,this.handlers={[pe.GET_VALUE.toString()]:new Hb(e,t),[pe.PUT_VALUE.toString()]:new zb(e,t),[pe.FIND_NODE.toString()]:new $b(e,t),[pe.ADD_PROVIDER.toString()]:new Fb(e,t),[pe.GET_PROVIDERS.toString()]:new Vb(e,t),[pe.PING.toString()]:new qb(e,t)}}async handleMessage(e,t){var s,i;const r=this.handlers[t.type];if(r==null){this.log.error(`no handler found for message type: ${t.type}`);return}try{return(s=this.metrics.operations)==null||s.increment({[t.type]:!0}),await r.handle(e,t)}catch{(i=this.metrics.errors)==null||i.increment({[t.type]:!0})}}onIncomingStream(e){let t="unknown";Promise.resolve().then(async()=>{const{stream:r,connection:s}=e,i=s.remotePeer,o=this;await qo(r,a=>Rc(a),async function*(a){for await(const c of a){const l=$r.decode(c);t=l.type,o.log("incoming %s from %p",l.type,i);const u=await o.handleMessage(i,l);u!=null&&(yield $r.encode(u))}},a=>Ul(a),r)}).catch(r=>{this.log.error("error handling %s RPC message from %p - %e",t,e.connection.remotePeer,r)})}}class jb extends sr{constructor(t,r){super();d(this,"log");d(this,"components");d(this,"protocol");d(this,"running");d(this,"registrarId");const{protocol:s,logPrefix:i}=r;this.components=t,this.log=t.logger.forComponent(`${i}:topology-listener`),this.running=!1,this.protocol=s}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:t=>{this.log("observed peer %p with protocol %s",t,this.protocol),this.dispatchEvent(new CustomEvent("peer",{detail:t}))}}))}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}}class Gb{constructor(e){d(this,"dht");this.dht=e}async provide(e,t={}){await bs(this.dht.provide(e,t))}async cancelReprovide(e){await this.dht.cancelReprovide(e)}async*findProviders(e,t={}){for await(const r of this.dht.findProviders(e,t))r.name==="PROVIDER"&&(yield*r.providers)}async put(e,t,r){await bs(this.dht.put(e,t,r))}async get(e,t){for await(const r of this.dht.get(e,t))if(r.name==="VALUE")return r.value;throw new xr("Could not find value for key")}}class Wb{constructor(e){d(this,"dht");this.dht=e}async findPeer(e,t={}){for await(const r of this.dht.findPeer(e,t))if(r.name==="FINAL_PEER")return r.peer;throw new xr("Peer not found")}async*getClosestPeers(e,t={}){for await(const r of this.dht.getClosestPeers(e,t))r.name==="FINAL_PEER"&&(yield r.peer)}}const Qb=32,Yb=64;var Rd,Dd,Bd;class Jb extends sr{constructor(t,r={}){var u,h,f,g;super();d(this,"protocol");d(this,"routingTable");d(this,"providers");d(this,"network");d(this,"peerRouting");d(this,"components");d(this,"log");d(this,"running");d(this,"kBucketSize");d(this,"clientMode");d(this,"validators");d(this,"selectors");d(this,"queryManager");d(this,"contentFetching");d(this,"contentRouting");d(this,"routingTableRefresh");d(this,"rpc");d(this,"topologyListener");d(this,"querySelf");d(this,"maxInboundStreams");d(this,"maxOutboundStreams");d(this,"dhtContentRouting");d(this,"dhtPeerRouting");d(this,"peerInfoMapper");d(this,"reprovider");d(this,Bd,"@libp2p/kad-dht");d(this,Dd,["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery"]);d(this,Rd,["@libp2p/identify","@libp2p/ping"]);const s=r.logPrefix??"libp2p:kad-dht",i=r.datastorePrefix??"/dht",o=r.metricsPrefix??"libp2p_kad_dht",a={queries:(u=t.metrics)==null?void 0:u.registerMetricGroup(`${o}_operations_total`,{label:"operation"}),errors:(h=t.metrics)==null?void 0:h.registerCounterGroup(`${o}_operation_errors_total`,{label:"operation"}),queryTime:(f=t.metrics)==null?void 0:f.registerMetricGroup(`${o}_operation_time_seconds`,{label:"operation"}),errorTime:(g=t.metrics)==null?void 0:g.registerMetricGroup(`${o}_operation_error_time_seconds`,{label:"operation"})};this.running=!1,this.components=t,this.log=t.logger.forComponent(s),this.protocol=r.protocol??Ey,this.kBucketSize=r.kBucketSize??20,this.clientMode=r.clientMode??!0,this.maxInboundStreams=r.maxInboundStreams??Qb,this.maxOutboundStreams=r.maxOutboundStreams??Yb,this.peerInfoMapper=r.peerInfoMapper??Gy;const c=p0();this.providers=new lb(t,{...r.providers,logPrefix:s,datastorePrefix:i,lock:c}),this.validators={...Ky,...r.validators},this.selectors={...qy,...r.selectors},this.network=new ab(t,{protocol:this.protocol,logPrefix:s,metricsPrefix:o}),this.routingTable=new Ob(t,{kBucketSize:r.kBucketSize,pingOldContactTimeout:r.pingOldContactTimeout,pingOldContactConcurrency:r.pingOldContactConcurrency,pingOldContactMaxQueueSize:r.pingOldContactMaxQueueSize,pingNewContactTimeout:r.pingNewContactTimeout,pingNewContactConcurrency:r.pingNewContactConcurrency,pingNewContactMaxQueueSize:r.pingNewContactMaxQueueSize,protocol:this.protocol,logPrefix:s,metricsPrefix:o,prefixLength:r.prefixLength,splitThreshold:r.kBucketSplitThreshold,network:this.network});const l=Le();r.allowQueryWithZeroPeers===!0&&l.resolve(),this.queryManager=new db(t,{disjointPaths:Math.ceil(this.kBucketSize/2),logPrefix:s,metricsPrefix:o,initialQuerySelfHasRun:l,routingTable:this.routingTable}),this.peerRouting=new cb(t,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:s}),this.contentFetching=new sb(t,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:s,datastorePrefix:i}),this.contentRouting=new ob(t,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:s}),this.routingTableRefresh=new Ub(t,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:s}),this.rpc=new Kb(t,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:s,metricsPrefix:o,datastorePrefix:i,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new jb(t,{protocol:this.protocol,logPrefix:s}),this.querySelf=new mb(t,{peerRouting:this.peerRouting,interval:r.querySelfInterval,initialInterval:r.initialQuerySelfInterval,logPrefix:s,initialQuerySelfHasRun:l,routingTable:this.routingTable,operationMetrics:a}),this.reprovider=new yb(t,{...r.reprovide,logPrefix:s,metricsPrefix:o,datastorePrefix:i,contentRouting:this.contentRouting,lock:c,operationMetrics:a}),this.network.addEventListener("peer",p=>{const m=p.detail;this.onPeerConnect(m).catch(y=>{this.log.error("could not add %p to routing table",m.id,y)}),this.dispatchEvent(new CustomEvent("peer",{detail:m}))}),this.topologyListener.addEventListener("peer",p=>{const m=p.detail;Promise.resolve().then(async()=>{const y=await this.components.peerStore.get(m),E={id:m,multiaddrs:y.addresses.map(({multiaddr:_})=>_),protocols:y.protocols};await this.onPeerConnect(E)}).catch(y=>{this.log.error("could not add %p to routing table - %e",m,y)})}),this.dhtPeerRouting=new Wb(this),this.dhtContentRouting=new Gb(this),r.clientMode==null&&t.events.addEventListener("self:peer:update",p=>{this.log("received update of self-peer info"),Promise.resolve().then(async()=>{const m=p.detail.peer.addresses.some(({multiaddr:E})=>nb(E)),y=this.getMode();m&&y==="client"?await this.setMode("server"):y==="server"&&!m&&await this.setMode("client")}).catch(m=>{this.log.error("error setting dht server mode",m)})}),this.get=on(this.get.bind(this),a,"GET_VALUE"),this.findProviders=on(this.findProviders.bind(this),a,"FIND_PROVIDERS"),this.findPeer=on(this.findPeer.bind(this),a,"FIND_PEER"),this.getClosestPeers=on(this.getClosestPeers.bind(this),a,"GET_CLOSEST_PEERS"),this.provide=on(this.provide.bind(this),a,"PROVIDE"),this.put=on(this.put.bind(this),a,"PUT_VALUE")}get[(Bd=Symbol.toStringTag,Dd=Sn,Rd=ec,Ja)](){return this.dhtContentRouting}get[Xa](){return this.dhtPeerRouting}get[Za](){return this}async onPeerConnect(t){if(this.log.trace("peer %p connected",t.id),t=this.peerInfoMapper(t),t.multiaddrs.length===0){this.log.trace("ignoring %p as there were no valid addresses in %s after filtering",t.id,t.multiaddrs.map(r=>r.toString()));return}try{await this.routingTable.add(t.id)}catch(r){this.log.error("could not add %p to routing table",t.id,r)}}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(t,r=!1){if(t===this.getMode()&&!r){this.log("already in %s mode",t);return}if(await this.components.registrar.unhandle(this.protocol),t===this.getMode()&&!r){this.log("already in %s mode",t);return}t==="client"?(this.log("enabling client mode while in %s mode",this.getMode()),this.clientMode=!0):(this.log("enabling server mode while in %s mode",this.getMode()),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running||(this.running=!0,await this.setMode(this.clientMode?"client":"server",!0),await qi(this.routingTable,this.queryManager,this.network,this.topologyListener,this.routingTableRefresh,this.reprovider),await qi(this.querySelf))}async stop(){this.running=!1,await sl(this.querySelf,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener,this.reprovider)}async*put(t,r,s={}){yield*this.contentFetching.put(t,r,s)}async*get(t,r={}){yield*this.contentFetching.get(t,r)}async*provide(t,r={}){yield*this.contentRouting.provide(t,this.components.addressManager.getAddresses(),r)}async cancelReprovide(t){await this.providers.removeProvider(t,this.components.peerId)}async*findProviders(t,r={}){yield*this.contentRouting.findProviders(t,r)}async*findPeer(t,r={}){yield*this.peerRouting.findPeer(t,r)}async*getClosestPeers(t,r={}){yield*this.peerRouting.getClosestPeers(t,r)}async refreshRoutingTable(){this.routingTableRefresh.refreshTable(!0)}}var ed;(function(n){n[n.SEND_QUERY=0]="SEND_QUERY",n[n.PEER_RESPONSE=1]="PEER_RESPONSE",n[n.FINAL_PEER=2]="FINAL_PEER",n[n.QUERY_ERROR=3]="QUERY_ERROR",n[n.PROVIDER=4]="PROVIDER",n[n.VALUE=5]="VALUE",n[n.ADD_PEER=6]="ADD_PEER",n[n.DIAL_PEER=7]="DIAL_PEER"})(ed||(ed={}));function Zb(n={}){return e=>new Jb(e,n)}const Xb={apiKey:"AIzaSyBrdrwvY-lPObZgortEgw7YWycUOGsBlyM",authDomain:"dcrypt-edb9c.firebaseapp.com",projectId:"dcrypt-edb9c",storageBucket:"dcrypt-edb9c.firebasestorage.app",messagingSenderId:"952133736604",appId:"1:952133736604:web:32d799360f200bce84f559",measurementId:"G-7KCDLQ6JNH"},zl=X3(Xb),ew=Z3(zl),tw=j3(zl),rf=Y3(zl),rw=Object.freeze(Object.defineProperty({__proto__:null,auth:tw,db:rf,storage:ew},Symbol.toStringTag,{value:"Module"}));var Ld;const Sr=(Ld=globalThis.crypto)==null?void 0:Ld.subtle;if(!Sr)throw new Error("Web Crypto API is not available in this environment");function nw(){const n=new Uint8Array(12);for(let e=0;e<12;e++)n[e]=Math.floor(Math.random()*256);return n}function sw(n,e,t,r,s,i,o){return{content:new Uint8Array(n),content_type:e,tags:t||[],is_premium:r,price_usd:s,creator_id:new Uint8Array(i),file_type:o}}function iw(n){return n.content}async function nf(n){const e=await Sr.digest("SHA-256",n);return new Uint8Array(e)}function ow(n){const e=new Uint8Array(new Int32Array([n.index]).buffer),t=new Uint8Array([...n.data,...n.nonce,...e]);return nf(t)}function td(n){return n.index}function sf(n){return new TextEncoder().encode(n).buffer}async function aw(n,e,t){const r=n.content,s=Math.ceil(r.length/t),i=[];Array.isArray(e)&&(e=e.join(""));const o=await Sr.digest("SHA-256",sf(e)),a=await Sr.importKey("raw",o,{name:"AES-GCM"},!1,["encrypt"]);for(let c=0;c<t;c++){const l=c*s,u=Math.min(l+s,r.length),h=r.slice(l,u),f=nw(),g=await Sr.encrypt({name:"AES-GCM",iv:f},a,h),p={data:new Uint8Array(g),nonce:f,index:c,file_type:n.file_type};i.push(p)}return i}async function cw(n,e){Array.isArray(e)&&(e=e.join(""));const t=await Sr.digest("SHA-256",sf(e)),r=await Sr.importKey("raw",t,{name:"AES-GCM"},!1,["decrypt"]),s=await Sr.decrypt({name:"AES-GCM",iv:n.nonce},r,n.data);return new Uint8Array(s)}function lw(n){return n.file_type}const of=Symbol.for("@libp2p/peer-id");class ge extends Error{constructor(t,r,s){super(t);d(this,"code");d(this,"props");this.code=r,this.name=(s==null?void 0:s.name)??"CodeError",this.props=s??{}}}function Tr(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}const ks=32,fr=64,mo=32;function uw(){const n=ir.utils.randomPrivateKey(),e=ir.getPublicKey(n);return{privateKey:af(n,e),publicKey:e}}function dw(n){if(n.length!==mo)throw new TypeError('"seed" must be 32 bytes in length.');if(!(n instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');const e=n,t=ir.getPublicKey(e);return{privateKey:af(e,t),publicKey:t}}function hw(n,e){const t=n.subarray(0,mo);return ir.sign(e instanceof Uint8Array?e:e.subarray(),t)}function fw(n,e,t){return ir.verify(e,t instanceof Uint8Array?t:t.subarray(),n)}function af(n,e){const t=new Uint8Array(fr);for(let r=0;r<mo;r++)t[r]=n[r],t[mo+r]=e[r];return t}const Tt={get(n=globalThis){const e=n.crypto;if((e==null?void 0:e.subtle)==null)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}},Na={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function pw(n){const e="AES-GCM";let t=16;const r=12,s="SHA-256",i=16,o=32767,a=Tt.get();t*=8;async function c(h,f){const g=a.getRandomValues(new Uint8Array(i)),p=a.getRandomValues(new Uint8Array(r)),m={name:e,iv:p};typeof f=="string"&&(f=O(f));let y;if(f.length===0){y=await a.subtle.importKey("jwk",Na,{name:"AES-GCM"},!0,["encrypt"]);try{const _={name:"PBKDF2",salt:g,iterations:o,hash:{name:s}},w=await a.subtle.importKey("raw",f,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(_,w,{name:e,length:t},!0,["encrypt"])}catch{y=await a.subtle.importKey("jwk",Na,{name:"AES-GCM"},!0,["encrypt"])}}else{const _={name:"PBKDF2",salt:g,iterations:o,hash:{name:s}},w=await a.subtle.importKey("raw",f,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(_,w,{name:e,length:t},!0,["encrypt"])}const E=await a.subtle.encrypt(m,y,h);return St([g,m.iv,new Uint8Array(E)])}async function l(h,f){const g=h.subarray(0,i),p=h.subarray(i,i+r),m=h.subarray(i+r),y={name:e,iv:p};typeof f=="string"&&(f=O(f));let E;if(f.length===0)try{const w={name:"PBKDF2",salt:g,iterations:o,hash:{name:s}},b=await a.subtle.importKey("raw",f,{name:"PBKDF2"},!1,["deriveKey"]);E=await a.subtle.deriveKey(w,b,{name:e,length:t},!0,["decrypt"])}catch{E=await a.subtle.importKey("jwk",Na,{name:"AES-GCM"},!0,["decrypt"])}else{const w={name:"PBKDF2",salt:g,iterations:o,hash:{name:s}},b=await a.subtle.importKey("raw",f,{name:"PBKDF2"},!1,["deriveKey"]);E=await a.subtle.deriveKey(w,b,{name:e,length:t},!0,["decrypt"])}const _=await a.subtle.decrypt(y,E,m);return new Uint8Array(_)}return{encrypt:c,decrypt:l}}async function Kl(n,e){const r=await pw().encrypt(n,e);return ol.encode(r)}var at;(function(n){n.RSA="RSA",n.Ed25519="Ed25519",n.Secp256k1="Secp256k1"})(at||(at={}));var Oc;(function(n){n[n.RSA=0]="RSA",n[n.Ed25519=1]="Ed25519",n[n.Secp256k1=2]="Secp256k1"})(Oc||(Oc={}));(function(n){n.codec=()=>Io(Oc)})(at||(at={}));var Cs;(function(n){let e;n.codec=()=>(e==null&&(e=Ue((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.Type!=null&&(r.uint32(8),at.codec().encode(t.Type,r)),t.Data!=null&&(r.uint32(18),r.bytes(t.Data)),s.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const s={},i=r==null?t.len:t.pos+r;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.Type=at.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(o&7);break}}return s})),e),n.encode=t=>Me(t,n.codec()),n.decode=t=>Oe(t,n.codec())})(Cs||(Cs={}));var As;(function(n){let e;n.codec=()=>(e==null&&(e=Ue((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.Type!=null&&(r.uint32(8),at.codec().encode(t.Type,r)),t.Data!=null&&(r.uint32(18),r.bytes(t.Data)),s.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const s={},i=r==null?t.len:t.pos+r;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.Type=at.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(o&7);break}}return s})),e),n.encode=t=>Me(t,n.codec()),n.decode=t=>Oe(t,n.codec())})(As||(As={}));class jl{constructor(e){d(this,"_key");this._key=Bn(e,ks)}verify(e,t){return fw(this._key,t,e)}marshal(){return this._key}get bytes(){return Cs.encode({Type:at.Ed25519,Data:this.marshal()}).subarray()}equals(e){return ie(this.bytes,e.bytes)}hash(){const e=tt.digest(this.bytes);return Tr(e)?e.then(({bytes:t})=>t):e.bytes}}class Is{constructor(e,t){d(this,"_key");d(this,"_publicKey");this._key=Bn(e,fr),this._publicKey=Bn(t,ks)}sign(e){return hw(this._key,e)}get public(){return new jl(this._publicKey)}marshal(){return this._key}get bytes(){return As.encode({Type:at.Ed25519,Data:this.marshal()}).subarray()}equals(e){return ie(this.bytes,e.bytes)}async hash(){const e=tt.digest(this.bytes);let t;return Tr(e)?{bytes:t}=await e:t=e.bytes,t}async id(){const e=It.digest(this.public.bytes);return fe.encode(e.bytes).substring(1)}async export(e,t="libp2p-key"){if(t==="libp2p-key")return Kl(this.bytes,e);throw new ge(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}function gw(n){if(n.length>fr){n=Bn(n,fr+ks);const r=n.subarray(0,fr),s=n.subarray(fr,n.length);return new Is(r,s)}n=Bn(n,fr);const e=n.subarray(0,fr),t=n.subarray(ks);return new Is(e,t)}function mw(n){return n=Bn(n,ks),new jl(n)}async function yw(){const{privateKey:n,publicKey:e}=uw();return new Is(n,e)}async function bw(n){const{privateKey:e,publicKey:t}=dw(n);return new Is(e,t)}function Bn(n,e){if(n=Uint8Array.from(n??[]),n.length!==e)throw new ge(`Key must be a Uint8Array of length ${e}, got ${n.length}`,"ERR_INVALID_KEY_TYPE");return n}const ww=Object.freeze(Object.defineProperty({__proto__:null,Ed25519PrivateKey:Is,Ed25519PublicKey:jl,generateKeyPair:yw,generateKeyPairFromSeed:bw,unmarshalEd25519PrivateKey:gw,unmarshalEd25519PublicKey:mw},Symbol.toStringTag,{value:"Module"}));function Mc(n){if(isNaN(n)||n<=0)throw new ge("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return Co(n)}/*!
 * MIT License
 * 
 * Copyright (c) 2017-2024 Peculiar Ventures, LLC
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
 */const vw="[object ArrayBuffer]";class ue{static isArrayBuffer(e){return Object.prototype.toString.call(e)===vw}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||e.byteOffset===0&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(e,t){const r=ue.toUint8Array(e),s=ue.toUint8Array(t);if(r.length!==s.byteLength)return!1;for(let i=0;i<r.length;i++)if(r[i]!==s[i])return!1;return!0}static concat(...e){let t;Array.isArray(e[0])&&!(e[1]instanceof Function)||Array.isArray(e[0])&&e[1]instanceof Function?t=e[0]:e[e.length-1]instanceof Function?t=e.slice(0,e.length-1):t=e;let r=0;for(const o of t)r+=o.byteLength;const s=new Uint8Array(r);let i=0;for(const o of t){const a=this.toUint8Array(o);s.set(a,i),i+=a.length}return e[e.length-1]instanceof Function?this.toView(s,e[e.length-1]):s.buffer}}const Oa="string",Ew=/^[0-9a-f\s]+$/i,Sw=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,_w=/^[a-zA-Z0-9-_]+$/;class rd{static fromString(e){const t=unescape(encodeURIComponent(e)),r=new Uint8Array(t.length);for(let s=0;s<t.length;s++)r[s]=t.charCodeAt(s);return r.buffer}static toString(e){const t=ue.toUint8Array(e);let r="";for(let i=0;i<t.length;i++)r+=String.fromCharCode(t[i]);return decodeURIComponent(escape(r))}}class Nt{static toString(e,t=!1){const r=ue.toArrayBuffer(e),s=new DataView(r);let i="";for(let o=0;o<r.byteLength;o+=2){const a=s.getUint16(o,t);i+=String.fromCharCode(a)}return i}static fromString(e,t=!1){const r=new ArrayBuffer(e.length*2),s=new DataView(r);for(let i=0;i<e.length;i++)s.setUint16(i*2,e.charCodeAt(i),t);return r}}class we{static isHex(e){return typeof e===Oa&&Ew.test(e)}static isBase64(e){return typeof e===Oa&&Sw.test(e)}static isBase64Url(e){return typeof e===Oa&&_w.test(e)}static ToString(e,t="utf8"){const r=ue.toUint8Array(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(r);case"binary":return this.ToBinary(r);case"hex":return this.ToHex(r);case"base64":return this.ToBase64(r);case"base64url":return this.ToBase64Url(r);case"utf16le":return Nt.toString(r,!0);case"utf16":case"utf16be":return Nt.toString(r);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return Nt.fromString(e,!0);case"utf16":case"utf16be":return Nt.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){const t=ue.toUint8Array(e);if(typeof btoa<"u"){const r=this.ToString(t,"binary");return btoa(r)}else return Buffer.from(t).toString("base64")}static FromBase64(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!we.isBase64(t))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(t)):new Uint8Array(Buffer.from(t,"base64")).buffer}static FromBase64Url(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!we.isBase64Url(t))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(t.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(e,t=we.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.FromBinary(e);case"utf8":return rd.fromString(e);case"utf16":case"utf16be":return Nt.fromString(e);case"utf16le":case"usc2":return Nt.fromString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToUtf8String(e,t=we.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.ToBinary(e);case"utf8":return rd.toString(e);case"utf16":case"utf16be":return Nt.toString(e);case"utf16le":case"usc2":return Nt.toString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromBinary(e){const t=e.length,r=new Uint8Array(t);for(let s=0;s<t;s++)r[s]=e.charCodeAt(s);return r.buffer}static ToBinary(e){const t=ue.toUint8Array(e);let r="";for(let s=0;s<t.length;s++)r+=String.fromCharCode(t[s]);return r}static ToHex(e){const t=ue.toUint8Array(e);let r="";const s=t.length;for(let i=0;i<s;i++){const o=t[i];o<16&&(r+="0"),r+=o.toString(16)}return r}static FromHex(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!we.isHex(t))throw new TypeError("Argument 'hexString' is not HEX encoded");t.length%2&&(t=`0${t}`);const r=new Uint8Array(t.length/2);for(let s=0;s<t.length;s=s+2){const i=t.slice(s,s+2);r[s/2]=parseInt(i,16)}return r.buffer}static ToUtf16String(e,t=!1){return Nt.toString(e,t)}static FromUtf16String(e,t=!1){return Nt.fromString(e,t)}static Base64Padding(e){const t=4-e.length%4;if(t<4)for(let r=0;r<t;r++)e+="=";return e}static formatString(e){return(e==null?void 0:e.replace(/[\n\r\t ]/g,""))||""}}we.DEFAULT_UTF8_ENCODING="utf8";/*!
 Copyright (c) Peculiar Ventures, LLC
*/function Ln(n,e){let t=0;if(n.length===1)return n[0];for(let r=n.length-1;r>=0;r--)t+=n[n.length-1-r]*Math.pow(2,e*r);return t}function Wr(n,e,t=-1){const r=t;let s=n,i=0,o=Math.pow(2,e);for(let a=1;a<8;a++){if(n<o){let c;if(r<0)c=new ArrayBuffer(a),i=a;else{if(r<a)return new ArrayBuffer(0);c=new ArrayBuffer(r),i=r}const l=new Uint8Array(c);for(let u=a-1;u>=0;u--){const h=Math.pow(2,u*e);l[i-u-1]=Math.floor(s/h),s-=l[i-u-1]*h}return c}o*=Math.pow(2,e)}return new ArrayBuffer(0)}function Uc(...n){let e=0,t=0;for(const i of n)e+=i.length;const r=new ArrayBuffer(e),s=new Uint8Array(r);for(const i of n)s.set(i,t),t+=i.length;return s}function cf(){const n=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){const a=n[0]===255&&n[1]&128,c=n[0]===0&&(n[1]&128)===0;(a||c)&&this.warnings.push("Needlessly long format")}const e=new ArrayBuffer(this.valueHex.byteLength),t=new Uint8Array(e);for(let a=0;a<this.valueHex.byteLength;a++)t[a]=0;t[0]=n[0]&128;const r=Ln(t,8),s=new ArrayBuffer(this.valueHex.byteLength),i=new Uint8Array(s);for(let a=0;a<this.valueHex.byteLength;a++)i[a]=n[a];return i[0]&=127,Ln(i,8)-r}function xw(n){const e=n<0?n*-1:n;let t=128;for(let r=1;r<8;r++){if(e<=t){if(n<0){const o=t-e,a=Wr(o,8,r),c=new Uint8Array(a);return c[0]|=128,a}let s=Wr(e,8,r),i=new Uint8Array(s);if(i[0]&128){const o=s.slice(0),a=new Uint8Array(o);s=new ArrayBuffer(s.byteLength+1),i=new Uint8Array(s);for(let c=0;c<o.byteLength;c++)i[c+1]=a[c];i[0]=0}return s}t*=Math.pow(2,8)}return new ArrayBuffer(0)}function kw(n,e){if(n.byteLength!==e.byteLength)return!1;const t=new Uint8Array(n),r=new Uint8Array(e);for(let s=0;s<t.length;s++)if(t[s]!==r[s])return!1;return!0}function ht(n,e){const t=n.toString(10);if(e<t.length)return"";const r=e-t.length,s=new Array(r);for(let o=0;o<r;o++)s[o]="0";return s.join("").concat(t)}/*!
 * Copyright (c) 2014, GMO GlobalSign
 * Copyright (c) 2015-2022, Peculiar Ventures
 * All rights reserved.
 * 
 * Author 2014-2019, Yury Strozhevsky
 * 
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 * 
 * * Redistributions of source code must retain the above copyright notice, this
 *   list of conditions and the following disclaimer.
 * 
 * * Redistributions in binary form must reproduce the above copyright notice, this
 *   list of conditions and the following disclaimer in the documentation and/or
 *   other materials provided with the distribution.
 * 
 * * Neither the name of the copyright holder nor the names of its
 *   contributors may be used to endorse or promote products derived from
 *   this software without specific prior written permission.
 * 
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 * 
 */function yo(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function Gl(n){let e=0,t=0;for(let s=0;s<n.length;s++){const i=n[s];e+=i.byteLength}const r=new Uint8Array(e);for(let s=0;s<n.length;s++){const i=n[s];r.set(new Uint8Array(i),t),t+=i.byteLength}return r.buffer}function ar(n,e,t,r){return e instanceof Uint8Array?e.byteLength?t<0?(n.error="Wrong parameter: inputOffset less than zero",!1):r<0?(n.error="Wrong parameter: inputLength less than zero",!1):e.byteLength-t-r<0?(n.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(n.error="Wrong parameter: inputBuffer has zero length",!1):(n.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}class Wl{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return Gl(this.items)}}const Wn=[new Uint8Array([1])],nd="0123456789",$n="",Rt=new ArrayBuffer(0),Ql=new Uint8Array(0),Ps="EndOfContent",lf="OCTET STRING",uf="BIT STRING";function cr(n){var e;return e=class extends n{get valueHex(){return this.valueHexView.slice().buffer}set valueHex(r){this.valueHexView=new Uint8Array(r)}constructor(...r){var s;super(...r);const i=r[0]||{};this.isHexOnly=(s=i.isHexOnly)!==null&&s!==void 0?s:!1,this.valueHexView=i.valueHex?ue.toUint8Array(i.valueHex):Ql}fromBER(r,s,i){const o=r instanceof ArrayBuffer?new Uint8Array(r):r;if(!ar(this,o,s,i))return-1;const a=s+i;return this.valueHexView=o.subarray(s,a),this.valueHexView.length?(this.blockLength=i,a):(this.warnings.push("Zero buffer length"),s)}toBER(r=!1){return this.isHexOnly?r?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",Rt)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:we.ToHex(this.valueHexView)}}},e.NAME="hexBlock",e}class Xr{static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}constructor({blockLength:e=0,error:t=$n,warnings:r=[],valueBeforeDecode:s=Ql}={}){this.blockLength=e,this.error=t,this.warnings=r,this.valueBeforeDecodeView=ue.toUint8Array(s)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:we.ToHex(this.valueBeforeDecodeView)}}}Xr.NAME="baseBlock";class lt extends Xr{fromBER(e,t,r){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}}lt.NAME="valueBlock";class df extends cr(Xr){constructor({idBlock:e={}}={}){var t,r,s,i;super(),e?(this.isHexOnly=(t=e.isHexOnly)!==null&&t!==void 0?t:!1,this.valueHexView=e.valueHex?ue.toUint8Array(e.valueHex):Ql,this.tagClass=(r=e.tagClass)!==null&&r!==void 0?r:-1,this.tagNumber=(s=e.tagNumber)!==null&&s!==void 0?s:-1,this.isConstructed=(i=e.isConstructed)!==null&&i!==void 0?i:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",Rt}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){const s=new Uint8Array(1);if(!e){let i=this.tagNumber;i&=31,t|=i,s[0]=t}return s.buffer}if(!this.isHexOnly){const s=Wr(this.tagNumber,7),i=new Uint8Array(s),o=s.byteLength,a=new Uint8Array(o+1);if(a[0]=t|31,!e){for(let c=0;c<o-1;c++)a[c+1]=i[c]|128;a[o]=i[o-1]}return a.buffer}const r=new Uint8Array(this.valueHexView.byteLength+1);if(r[0]=t|31,!e){const s=this.valueHexView;for(let i=0;i<s.length-1;i++)r[i+1]=s[i]|128;r[this.valueHexView.byteLength]=s[s.length-1]}return r.buffer}fromBER(e,t,r){const s=ue.toUint8Array(e);if(!ar(this,s,t,r))return-1;const i=s.subarray(t,t+r);if(i.length===0)return this.error="Zero buffer length",-1;switch(i[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(i[0]&32)===32,this.isHexOnly=!1;const a=i[0]&31;if(a!==31)this.tagNumber=a,this.blockLength=1;else{let c=1,l=this.valueHexView=new Uint8Array(255),u=255;for(;i[c]&128;){if(l[c-1]=i[c]&127,c++,c>=i.length)return this.error="End of input reached before message was fully decoded",-1;if(c===u){u+=255;const f=new Uint8Array(u);for(let g=0;g<l.length;g++)f[g]=l[g];l=this.valueHexView=new Uint8Array(u)}}this.blockLength=c+1,l[c-1]=i[c]&127;const h=new Uint8Array(c);for(let f=0;f<c;f++)h[f]=l[f];l=this.valueHexView=new Uint8Array(c),l.set(h),this.blockLength<=9?this.tagNumber=Ln(l,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}}df.NAME="identificationBlock";class hf extends Xr{constructor({lenBlock:e={}}={}){var t,r,s;super(),this.isIndefiniteForm=(t=e.isIndefiniteForm)!==null&&t!==void 0?t:!1,this.longFormUsed=(r=e.longFormUsed)!==null&&r!==void 0?r:!1,this.length=(s=e.length)!==null&&s!==void 0?s:0}fromBER(e,t,r){const s=ue.toUint8Array(e);if(!ar(this,s,t,r))return-1;const i=s.subarray(t,t+r);if(i.length===0)return this.error="Zero buffer length",-1;if(i[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=i[0]===128,this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(i[0]&128),this.longFormUsed===!1)return this.length=i[0],this.blockLength=1,t+this.blockLength;const o=i[0]&127;if(o>8)return this.error="Too big integer",-1;if(o+1>i.length)return this.error="End of input reached before message was fully decoded",-1;const a=t+1,c=s.subarray(a,a+o);return c[o-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=Ln(c,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=o+1,t+this.blockLength}toBER(e=!1){let t,r;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),e===!1&&(r=new Uint8Array(t),r[0]=128),t;if(this.longFormUsed){const s=Wr(this.length,8);if(s.byteLength>127)return this.error="Too big length",Rt;if(t=new ArrayBuffer(s.byteLength+1),e)return t;const i=new Uint8Array(s);r=new Uint8Array(t),r[0]=s.byteLength|128;for(let o=0;o<s.byteLength;o++)r[o+1]=i[o];return t}return t=new ArrayBuffer(1),e===!1&&(r=new Uint8Array(t),r[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}}hf.NAME="lengthBlock";const B={};class et extends Xr{constructor({name:e=$n,optional:t=!1,primitiveSchema:r,...s}={},i){super(s),this.name=e,this.optional=t,r&&(this.primitiveSchema=r),this.idBlock=new df(s),this.lenBlock=new hf(s),this.valueBlock=i?new i(s):new lt(s)}fromBER(e,t,r){const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}toBER(e,t){const r=t||new Wl;t||ff(this);const s=this.idBlock.toBER(e);if(r.write(s),this.lenBlock.isIndefiniteForm)r.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,r),r.write(new ArrayBuffer(2));else{const i=this.valueBlock.toBER(e);this.lenBlock.length=i.byteLength;const o=this.lenBlock.toBER(e);r.write(o),r.write(i)}return t?Rt:r.final()}toJSON(){const e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return e==="ascii"?this.onAsciiEncoding():we.ToHex(this.toBER())}onAsciiEncoding(){const e=this.constructor.NAME,t=we.ToHex(this.valueBlock.valueBeforeDecodeView);return`${e} : ${t}`}isEqual(e){if(this===e)return!0;if(!(e instanceof this.constructor))return!1;const t=this.toBER(),r=e.toBER();return kw(t,r)}}et.NAME="BaseBlock";function ff(n){var e;if(n instanceof B.Constructed)for(const t of n.valueBlock.value)ff(t)&&(n.lenBlock.isIndefiniteForm=!0);return!!(!((e=n.lenBlock)===null||e===void 0)&&e.isIndefiniteForm)}class pf extends et{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor({value:e=$n,...t}={},r){super(t,r),e&&this.fromString(e)}fromBER(e,t,r){const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}}pf.NAME="BaseStringBlock";class gf extends cr(lt){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}}gf.NAME="PrimitiveValueBlock";var mf;class yf extends et{constructor(e={}){super(e,gf),this.idBlock.isConstructed=!1}}mf=yf;B.Primitive=mf;yf.NAME="PRIMITIVE";function Cw(n,e){if(n instanceof e)return n;const t=new e;return t.idBlock=n.idBlock,t.lenBlock=n.lenBlock,t.warnings=n.warnings,t.valueBeforeDecodeView=n.valueBeforeDecodeView,t}function zo(n,e=0,t=n.length){const r=e;let s=new et({},lt);const i=new Xr;if(!ar(i,n,e,t))return s.error=i.error,{offset:-1,result:s};if(!n.subarray(e,e+t).length)return s.error="Zero buffer length",{offset:-1,result:s};let a=s.idBlock.fromBER(n,e,t);if(s.idBlock.warnings.length&&s.warnings.concat(s.idBlock.warnings),a===-1)return s.error=s.idBlock.error,{offset:-1,result:s};if(e=a,t-=s.idBlock.blockLength,a=s.lenBlock.fromBER(n,e,t),s.lenBlock.warnings.length&&s.warnings.concat(s.lenBlock.warnings),a===-1)return s.error=s.lenBlock.error,{offset:-1,result:s};if(e=a,t-=s.lenBlock.blockLength,!s.idBlock.isConstructed&&s.lenBlock.isIndefiniteForm)return s.error="Indefinite length form used for primitive encoding form",{offset:-1,result:s};let c=et;switch(s.idBlock.tagClass){case 1:if(s.idBlock.tagNumber>=37&&s.idBlock.isHexOnly===!1)return s.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:s};switch(s.idBlock.tagNumber){case 0:if(s.idBlock.isConstructed&&s.lenBlock.length>0)return s.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:s};c=B.EndOfContent;break;case 1:c=B.Boolean;break;case 2:c=B.Integer;break;case 3:c=B.BitString;break;case 4:c=B.OctetString;break;case 5:c=B.Null;break;case 6:c=B.ObjectIdentifier;break;case 10:c=B.Enumerated;break;case 12:c=B.Utf8String;break;case 13:c=B.RelativeObjectIdentifier;break;case 14:c=B.TIME;break;case 15:return s.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:s};case 16:c=B.Sequence;break;case 17:c=B.Set;break;case 18:c=B.NumericString;break;case 19:c=B.PrintableString;break;case 20:c=B.TeletexString;break;case 21:c=B.VideotexString;break;case 22:c=B.IA5String;break;case 23:c=B.UTCTime;break;case 24:c=B.GeneralizedTime;break;case 25:c=B.GraphicString;break;case 26:c=B.VisibleString;break;case 27:c=B.GeneralString;break;case 28:c=B.UniversalString;break;case 29:c=B.CharacterString;break;case 30:c=B.BmpString;break;case 31:c=B.DATE;break;case 32:c=B.TimeOfDay;break;case 33:c=B.DateTime;break;case 34:c=B.Duration;break;default:{const l=s.idBlock.isConstructed?new B.Constructed:new B.Primitive;l.idBlock=s.idBlock,l.lenBlock=s.lenBlock,l.warnings=s.warnings,s=l}}break;case 2:case 3:case 4:default:c=s.idBlock.isConstructed?B.Constructed:B.Primitive}return s=Cw(s,c),a=s.fromBER(n,e,s.lenBlock.isIndefiniteForm?t:s.lenBlock.length),s.valueBeforeDecodeView=n.subarray(r,r+s.blockLength),{offset:a,result:s}}function bf(n){if(!n.byteLength){const e=new et({},lt);return e.error="Input buffer has zero length",{offset:-1,result:e}}return zo(ue.toUint8Array(n).slice(),0,n.byteLength)}function Aw(n,e){return n?1:e}class _r extends lt{constructor({value:e=[],isIndefiniteForm:t=!1,...r}={}){super(r),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,r){const s=ue.toUint8Array(e);if(!ar(this,s,t,r))return-1;if(this.valueBeforeDecodeView=s.subarray(t,t+r),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),t;let i=t;for(;Aw(this.isIndefiniteForm,r)>0;){const o=zo(s,i,r);if(o.offset===-1)return this.error=o.result.error,this.warnings.concat(o.result.warnings),-1;if(i=o.offset,this.blockLength+=o.result.blockLength,r-=o.result.blockLength,this.value.push(o.result),this.isIndefiniteForm&&o.result.constructor.NAME===Ps)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===Ps?this.value.pop():this.warnings.push("No EndOfContent block encoded")),i}toBER(e,t){const r=t||new Wl;for(let s=0;s<this.value.length;s++)this.value[s].toBER(e,r);return t?Rt:r.final()}toJSON(){const e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(const t of this.value)e.value.push(t.toJSON());return e}}_r.NAME="ConstructedValueBlock";var wf;class Vn extends et{constructor(e={}){super(e,_r),this.idBlock.isConstructed=!0}fromBER(e,t,r){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){const e=[];for(const r of this.valueBlock.value)e.push(r.toString("ascii").split(`
`).map(s=>`  ${s}`).join(`
`));const t=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :
${e.join(`
`)}`:`${t} :`}}wf=Vn;B.Constructed=wf;Vn.NAME="CONSTRUCTED";class vf extends lt{fromBER(e,t,r){return t}toBER(e){return Rt}}vf.override="EndOfContentValueBlock";var Ef;class Sf extends et{constructor(e={}){super(e,vf),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}}Ef=Sf;B.EndOfContent=Ef;Sf.NAME=Ps;var _f;class Ts extends et{constructor(e={}){super(e,lt),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,r){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=r,t+r>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+r}toBER(e,t){const r=new ArrayBuffer(2);if(!e){const s=new Uint8Array(r);s[0]=5,s[1]=0}return t&&t.write(r),r}onAsciiEncoding(){return`${this.constructor.NAME}`}}_f=Ts;B.Null=_f;Ts.NAME="NULL";class xf extends cr(lt){get value(){for(const e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=ue.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}fromBER(e,t,r){const s=ue.toUint8Array(e);return ar(this,s,t,r)?(this.valueHexView=s.subarray(t,t+r),r>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,cf.call(this),this.blockLength=r,t+r):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}}xf.NAME="BooleanValueBlock";var kf;let Cf=class extends et{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor(e={}){super(e,xf),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};kf=Cf;B.Boolean=kf;Cf.NAME="BOOLEAN";class Af extends cr(_r){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,r){let s=0;if(this.isConstructed){if(this.isHexOnly=!1,s=_r.prototype.fromBER.call(this,e,t,r),s===-1)return s;for(let i=0;i<this.value.length;i++){const o=this.value[i].constructor.NAME;if(o===Ps){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(o!==lf)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,s=super.fromBER(e,t,r),this.blockLength=r;return s}toBER(e,t){return this.isConstructed?_r.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}}Af.NAME="OctetStringValueBlock";var Yl;class cn extends et{constructor({idBlock:e={},lenBlock:t={},...r}={}){var s,i;(s=r.isConstructed)!==null&&s!==void 0||(r.isConstructed=!!(!((i=r.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:r.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!r.isIndefiniteForm},...r},Af),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,r){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,r===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){const i=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+r);try{if(i.byteLength){const o=zo(i,0,i.byteLength);o.offset!==-1&&o.offset===r&&(this.valueBlock.value=[o.result])}}catch{}}return super.fromBER(e,t,r)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return Vn.prototype.onAsciiEncoding.call(this);const e=this.constructor.NAME,t=we.ToHex(this.valueBlock.valueHexView);return`${e} : ${t}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;const e=[];for(const t of this.valueBlock.value)t instanceof Yl&&e.push(t.valueBlock.valueHexView);return ue.concat(e)}}Yl=cn;B.OctetString=Yl;cn.NAME=lf;class If extends cr(_r){constructor({unusedBits:e=0,isConstructed:t=!1,...r}={}){super(r),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,r){if(!r)return t;let s=-1;if(this.isConstructed){if(s=_r.prototype.fromBER.call(this,e,t,r),s===-1)return s;for(const a of this.value){const c=a.constructor.NAME;if(c===Ps){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(c!==uf)return this.error="BIT STRING may consists of BIT STRINGs only",-1;const l=a.valueBlock;if(this.unusedBits>0&&l.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=l.unusedBits}return s}const i=ue.toUint8Array(e);if(!ar(this,i,t,r))return-1;const o=i.subarray(t,t+r);if(this.unusedBits=o[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){const a=o.subarray(1);try{if(a.byteLength){const c=zo(a,0,a.byteLength);c.offset!==-1&&c.offset===r-1&&(this.value=[c.result])}}catch{}}return this.valueHexView=o.subarray(1),this.blockLength=o.length,t+r}toBER(e,t){if(this.isConstructed)return _r.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength)return Rt;const r=new Uint8Array(this.valueHexView.length+1);return r[0]=this.unusedBits,r.set(this.valueHexView,1),r.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}}If.NAME="BitStringValueBlock";var Pf;class Jl extends et{constructor({idBlock:e={},lenBlock:t={},...r}={}){var s,i;(s=r.isConstructed)!==null&&s!==void 0||(r.isConstructed=!!(!((i=r.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:r.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!r.isIndefiniteForm},...r},If),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,r){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,r)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return Vn.prototype.onAsciiEncoding.call(this);{const e=[],t=this.valueBlock.valueHexView;for(const o of t)e.push(o.toString(2).padStart(8,"0"));const r=e.join(""),s=this.constructor.NAME,i=r.substring(0,r.length-this.valueBlock.unusedBits);return`${s} : ${i}`}}}Pf=Jl;B.BitString=Pf;Jl.NAME=uf;var Tf;function Iw(n,e){const t=new Uint8Array([0]),r=new Uint8Array(n),s=new Uint8Array(e);let i=r.slice(0);const o=i.length-1,a=s.slice(0),c=a.length-1;let l=0;const u=c<o?o:c;let h=0;for(let f=u;f>=0;f--,h++){switch(!0){case h<a.length:l=i[o-h]+a[c-h]+t[0];break;default:l=i[o-h]+t[0]}switch(t[0]=l/10,!0){case h>=i.length:i=Uc(new Uint8Array([l%10]),i);break;default:i[o-h]=l%10}}return t[0]>0&&(i=Uc(t,i)),i}function sd(n){if(n>=Wn.length)for(let e=Wn.length;e<=n;e++){const t=new Uint8Array([0]);let r=Wn[e-1].slice(0);for(let s=r.length-1;s>=0;s--){const i=new Uint8Array([(r[s]<<1)+t[0]]);t[0]=i[0]/10,r[s]=i[0]%10}t[0]>0&&(r=Uc(t,r)),Wn.push(r)}return Wn[n]}function Pw(n,e){let t=0;const r=new Uint8Array(n),s=new Uint8Array(e),i=r.slice(0),o=i.length-1,a=s.slice(0),c=a.length-1;let l,u=0;for(let h=c;h>=0;h--,u++)switch(l=i[o-u]-a[c-u]-t,!0){case l<0:t=1,i[o-u]=l+10;break;default:t=0,i[o-u]=l}if(t>0)for(let h=o-c+1;h>=0;h--,u++)if(l=i[o-u]-t,l<0)t=1,i[o-u]=l+10;else{t=0,i[o-u]=l;break}return i.slice()}class Zl extends cr(lt){setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=cf.call(this)))}constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),e!==void 0&&(this.valueDec=e)}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(xw(e))}get valueDec(){return this._valueDec}fromDER(e,t,r,s=0){const i=this.fromBER(e,t,r);if(i===-1)return i;const o=this.valueHexView;return o[0]===0&&o[1]&128?this.valueHexView=o.subarray(1):s!==0&&o.length<s&&(s-o.length>1&&(s=o.length+1),this.valueHexView=o.subarray(s-o.length)),i}toDER(e=!1){const t=this.valueHexView;switch(!0){case(t[0]&128)!==0:{const r=new Uint8Array(this.valueHexView.length+1);r[0]=0,r.set(t,1),this.valueHexView=r}break;case(t[0]===0&&(t[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(e)}fromBER(e,t,r){const s=super.fromBER(e,t,r);return s===-1||this.setValueHex(),s}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){const e=this.valueHexView.length*8-1;let t=new Uint8Array(this.valueHexView.length*8/3),r=0,s;const i=this.valueHexView;let o="",a=!1;for(let c=i.byteLength-1;c>=0;c--){s=i[c];for(let l=0;l<8;l++){if((s&1)===1)switch(r){case e:t=Pw(sd(r),t),o="-";break;default:t=Iw(t,sd(r))}r++,s>>=1}}for(let c=0;c<t.length;c++)t[c]&&(a=!0),a&&(o+=nd.charAt(t[c]));return a===!1&&(o+=nd.charAt(0)),o}}Tf=Zl;Zl.NAME="IntegerValueBlock";Object.defineProperty(Tf.prototype,"valueHex",{set:function(n){this.valueHexView=new Uint8Array(n),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var ts;class De extends et{constructor(e={}){super(e,Zl),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return yo(),BigInt(this.valueBlock.toString())}static fromBigInt(e){yo();const t=BigInt(e),r=new Wl,s=t.toString(16).replace(/^-/,""),i=new Uint8Array(we.FromHex(s));if(t<0){const a=new Uint8Array(i.length+(i[0]&128?1:0));a[0]|=128;const l=BigInt(`0x${we.ToHex(a)}`)+t,u=ue.toUint8Array(we.FromHex(l.toString(16)));u[0]|=128,r.write(u)}else i[0]&128&&r.write(new Uint8Array([0])),r.write(i);return new ts({valueHex:r.final()})}convertToDER(){const e=new ts({valueHex:this.valueBlock.valueHexView});return e.valueBlock.toDER(),e}convertFromDER(){return new ts({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}}ts=De;B.Integer=ts;De.NAME="INTEGER";var Rf;class Df extends De{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}}Rf=Df;B.Enumerated=Rf;Df.NAME="ENUMERATED";class Fc extends cr(lt){constructor({valueDec:e=-1,isFirstSid:t=!1,...r}={}){super(r),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,r){if(!r)return t;const s=ue.toUint8Array(e);if(!ar(this,s,t,r))return-1;const i=s.subarray(t,t+r);this.valueHexView=new Uint8Array(r);for(let a=0;a<r&&(this.valueHexView[a]=i[a]&127,this.blockLength++,!!(i[a]&128));a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,i[this.blockLength-1]&128?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=Ln(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){yo();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;const r=new Uint8Array(t.length/7);for(let s=0;s<r.length;s++)r[s]=parseInt(t.slice(s*7,s*7+7),2)+(s+1<r.length?128:0);this.fromBER(r.buffer,0,r.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)i[o]=s[o]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const t=Wr(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",Rt;const r=new Uint8Array(t.byteLength);if(!e){const s=new Uint8Array(t),i=t.byteLength-1;for(let o=0;o<i;o++)r[o]=s[o]|128;r[i]=s[i]}return r}toString(){let e="";if(this.isHexOnly)e=we.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}}Fc.NAME="sidBlock";class Bf extends lt{constructor({value:e=$n,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,r){let s=t;for(;r>0;){const i=new Fc;if(s=i.fromBER(e,s,r),s===-1)return this.blockLength=0,this.error=i.error,s;this.value.length===0&&(i.isFirstSid=!0),this.blockLength+=i.blockLength,r-=i.blockLength,this.value.push(i)}return s}toBER(e){const t=[];for(let r=0;r<this.value.length;r++){const s=this.value[r].toBER(e);if(s.byteLength===0)return this.error=this.value[r].error,Rt;t.push(s)}return Gl(t)}fromString(e){this.value=[];let t=0,r=0,s="",i=!1;do if(r=e.indexOf(".",t),r===-1?s=e.substring(t):s=e.substring(t,r),t=r+1,i){const o=this.value[0];let a=0;switch(o.valueDec){case 0:break;case 1:a=40;break;case 2:a=80;break;default:this.value=[];return}const c=parseInt(s,10);if(isNaN(c))return;o.valueDec=c+a,i=!1}else{const o=new Fc;if(s>Number.MAX_SAFE_INTEGER){yo();const a=BigInt(s);o.valueBigInt=a}else if(o.valueDec=parseInt(s,10),isNaN(o.valueDec))return;this.value.length||(o.isFirstSid=!0,i=!0),this.value.push(o)}while(r!==-1)}toString(){let e="",t=!1;for(let r=0;r<this.value.length;r++){t=this.value[r].isHexOnly;let s=this.value[r].toString();r!==0&&(e=`${e}.`),t?(s=`{${s}}`,this.value[r].isFirstSid?e=`2.{${s} - 80}`:e+=s):e+=s}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}Bf.NAME="ObjectIdentifierValueBlock";var Lf;class mr extends et{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,Bf),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}Lf=mr;B.ObjectIdentifier=Lf;mr.NAME="OBJECT IDENTIFIER";class $c extends cr(Xr){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,r){if(r===0)return t;const s=ue.toUint8Array(e);if(!ar(this,s,t,r))return-1;const i=s.subarray(t,t+r);this.valueHexView=new Uint8Array(r);for(let a=0;a<r&&(this.valueHexView[a]=i[a]&127,this.blockLength++,!!(i[a]&128));a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,i[this.blockLength-1]&128?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=Ln(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)i[o]=s[o]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const t=Wr(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",Rt;const r=new Uint8Array(t.byteLength);if(!e){const s=new Uint8Array(t),i=t.byteLength-1;for(let o=0;o<i;o++)r[o]=s[o]|128;r[i]=s[i]}return r.buffer}toString(){let e="";return this.isHexOnly?e=we.ToHex(this.valueHexView):e=this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}}$c.NAME="relativeSidBlock";class Nf extends lt{constructor({value:e=$n,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,r){let s=t;for(;r>0;){const i=new $c;if(s=i.fromBER(e,s,r),s===-1)return this.blockLength=0,this.error=i.error,s;this.blockLength+=i.blockLength,r-=i.blockLength,this.value.push(i)}return s}toBER(e,t){const r=[];for(let s=0;s<this.value.length;s++){const i=this.value[s].toBER(e);if(i.byteLength===0)return this.error=this.value[s].error,Rt;r.push(i)}return Gl(r)}fromString(e){this.value=[];let t=0,r=0,s="";do{r=e.indexOf(".",t),r===-1?s=e.substring(t):s=e.substring(t,r),t=r+1;const i=new $c;if(i.valueDec=parseInt(s,10),isNaN(i.valueDec))return!0;this.value.push(i)}while(r!==-1);return!0}toString(){let e="",t=!1;for(let r=0;r<this.value.length;r++){t=this.value[r].isHexOnly;let s=this.value[r].toString();r!==0&&(e=`${e}.`),t&&(s=`{${s}}`),e+=s}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}Nf.NAME="RelativeObjectIdentifierValueBlock";var Of;class Mf extends et{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,Nf),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}Of=Mf;B.RelativeObjectIdentifier=Of;Mf.NAME="RelativeObjectIdentifier";var Uf;class Je extends Vn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}}Uf=Je;B.Sequence=Uf;Je.NAME="SEQUENCE";var Ff;let $f=class extends Vn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};Ff=$f;B.Set=Ff;$f.NAME="SET";class Vf extends cr(lt){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=$n}toJSON(){return{...super.toJSON(),value:this.value}}}Vf.NAME="StringValueBlock";class Hf extends Vf{}Hf.NAME="SimpleStringValueBlock";class yt extends pf{constructor({...e}={}){super(e,Hf)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,ue.toUint8Array(e))}fromString(e){const t=e.length,r=this.valueBlock.valueHexView=new Uint8Array(t);for(let s=0;s<t;s++)r[s]=e.charCodeAt(s);this.valueBlock.value=e}}yt.NAME="SIMPLE STRING";class qf extends yt{fromBuffer(e){this.valueBlock.valueHexView=ue.toUint8Array(e);try{this.valueBlock.value=we.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=we.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(we.FromUtf8String(e)),this.valueBlock.value=e}}qf.NAME="Utf8StringValueBlock";var zf;class en extends qf{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}}zf=en;B.Utf8String=zf;en.NAME="UTF8String";class Kf extends yt{fromBuffer(e){this.valueBlock.value=we.ToUtf16String(e),this.valueBlock.valueHexView=ue.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(we.FromUtf16String(e))}}Kf.NAME="BmpStringValueBlock";var jf;class Gf extends Kf{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}}jf=Gf;B.BmpString=jf;Gf.NAME="BMPString";class Wf extends yt{fromBuffer(e){const t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),r=new Uint8Array(t);for(let s=0;s<r.length;s+=4)r[s]=r[s+3],r[s+1]=r[s+2],r[s+2]=0,r[s+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){const t=e.length,r=this.valueBlock.valueHexView=new Uint8Array(t*4);for(let s=0;s<t;s++){const i=Wr(e.charCodeAt(s),8),o=new Uint8Array(i);if(o.length>4)continue;const a=4-o.length;for(let c=o.length-1;c>=0;c--)r[s*4+c+a]=o[c]}this.valueBlock.value=e}}Wf.NAME="UniversalStringValueBlock";var Qf;class Yf extends Wf{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}}Qf=Yf;B.UniversalString=Qf;Yf.NAME="UniversalString";var Jf;class Zf extends yt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}}Jf=Zf;B.NumericString=Jf;Zf.NAME="NumericString";var Xf;class e3 extends yt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}}Xf=e3;B.PrintableString=Xf;e3.NAME="PrintableString";var t3;class r3 extends yt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}}t3=r3;B.TeletexString=t3;r3.NAME="TeletexString";var n3;class s3 extends yt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}}n3=s3;B.VideotexString=n3;s3.NAME="VideotexString";var i3;class o3 extends yt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}}i3=o3;B.IA5String=i3;o3.NAME="IA5String";var a3;class c3 extends yt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}}a3=c3;B.GraphicString=a3;c3.NAME="GraphicString";var l3;class Xl extends yt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}}l3=Xl;B.VisibleString=l3;Xl.NAME="VisibleString";var u3;class d3 extends yt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}}u3=d3;B.GeneralString=u3;d3.NAME="GeneralString";var h3;class f3 extends yt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}}h3=f3;B.CharacterString=h3;f3.NAME="CharacterString";var p3;class e1 extends Xl{constructor({value:e,valueDate:t,...r}={}){if(super(r),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let s=0;s<e.length;s++)this.valueBlock.valueHexView[s]=e.charCodeAt(s)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,ue.toUint8Array(e)))}toBuffer(){const e=this.toString(),t=new ArrayBuffer(e.length),r=new Uint8Array(t);for(let s=0;s<e.length;s++)r[s]=e.charCodeAt(s);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){const r=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(e);if(r===null){this.error="Wrong input string for conversion";return}const s=parseInt(r[1],10);s>=50?this.year=1900+s:this.year=2e3+s,this.month=parseInt(r[2],10),this.day=parseInt(r[3],10),this.hour=parseInt(r[4],10),this.minute=parseInt(r[5],10),this.second=parseInt(r[6],10)}toString(e="iso"){if(e==="iso"){const t=new Array(7);return t[0]=ht(this.year<2e3?this.year-1900:this.year-2e3,2),t[1]=ht(this.month,2),t[2]=ht(this.day,2),t[3]=ht(this.hour,2),t[4]=ht(this.minute,2),t[5]=ht(this.second,2),t[6]="Z",t.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}}p3=e1;B.UTCTime=p3;e1.NAME="UTCTime";var g3;class m3 extends e1{constructor(e={}){var t;super(e),(t=this.millisecond)!==null&&t!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){const e=Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond);return new Date(e)}fromString(e){let t=!1,r="",s="",i=0,o,a=0,c=0;if(e[e.length-1]==="Z")r=e.substring(0,e.length-1),t=!0;else{const h=new Number(e[e.length-1]);if(isNaN(h.valueOf()))throw new Error("Wrong input string for conversion");r=e}if(t){if(r.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(r.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let h=1,f=r.indexOf("+"),g="";if(f===-1&&(f=r.indexOf("-"),h=-1),f!==-1){if(g=r.substring(f+1),r=r.substring(0,f),g.length!==2&&g.length!==4)throw new Error("Wrong input string for conversion");let p=parseInt(g.substring(0,2),10);if(isNaN(p.valueOf()))throw new Error("Wrong input string for conversion");if(a=h*p,g.length===4){if(p=parseInt(g.substring(2,4),10),isNaN(p.valueOf()))throw new Error("Wrong input string for conversion");c=h*p}}}let l=r.indexOf(".");if(l===-1&&(l=r.indexOf(",")),l!==-1){const h=new Number(`0${r.substring(l)}`);if(isNaN(h.valueOf()))throw new Error("Wrong input string for conversion");i=h.valueOf(),s=r.substring(0,l)}else s=r;switch(!0){case s.length===8:if(o=/(\d{4})(\d{2})(\d{2})/ig,l!==-1)throw new Error("Wrong input string for conversion");break;case s.length===10:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let h=60*i;this.minute=Math.floor(h),h=60*(h-this.minute),this.second=Math.floor(h),h=1e3*(h-this.second),this.millisecond=Math.floor(h)}break;case s.length===12:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let h=60*i;this.second=Math.floor(h),h=1e3*(h-this.second),this.millisecond=Math.floor(h)}break;case s.length===14:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){const h=1e3*i;this.millisecond=Math.floor(h)}break;default:throw new Error("Wrong input string for conversion")}const u=o.exec(s);if(u===null)throw new Error("Wrong input string for conversion");for(let h=1;h<u.length;h++)switch(h){case 1:this.year=parseInt(u[h],10);break;case 2:this.month=parseInt(u[h],10);break;case 3:this.day=parseInt(u[h],10);break;case 4:this.hour=parseInt(u[h],10)+a;break;case 5:this.minute=parseInt(u[h],10)+c;break;case 6:this.second=parseInt(u[h],10);break;default:throw new Error("Wrong input string for conversion")}if(t===!1){const h=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=h.getUTCFullYear(),this.month=h.getUTCMonth(),this.day=h.getUTCDay(),this.hour=h.getUTCHours(),this.minute=h.getUTCMinutes(),this.second=h.getUTCSeconds(),this.millisecond=h.getUTCMilliseconds()}}toString(e="iso"){if(e==="iso"){const t=[];return t.push(ht(this.year,4)),t.push(ht(this.month,2)),t.push(ht(this.day,2)),t.push(ht(this.hour,2)),t.push(ht(this.minute,2)),t.push(ht(this.second,2)),this.millisecond!==0&&(t.push("."),t.push(ht(this.millisecond,3))),t.push("Z"),t.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}}g3=m3;B.GeneralizedTime=g3;m3.NAME="GeneralizedTime";var y3;class b3 extends en{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}}y3=b3;B.DATE=y3;b3.NAME="DATE";var w3;class v3 extends en{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}}w3=v3;B.TimeOfDay=w3;v3.NAME="TimeOfDay";var E3;class S3 extends en{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}}E3=S3;B.DateTime=E3;S3.NAME="DateTime";var _3;class x3 extends en{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}}_3=x3;B.Duration=_3;x3.NAME="Duration";var k3;class C3 extends en{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}}k3=C3;B.TIME=k3;C3.NAME="TIME";function Tw(n){const{result:e}=bf(n),t=e.valueBlock.value;return{n:M(Ot(t[1].toBigInt()),"base64url"),e:M(Ot(t[2].toBigInt()),"base64url"),d:M(Ot(t[3].toBigInt()),"base64url"),p:M(Ot(t[4].toBigInt()),"base64url"),q:M(Ot(t[5].toBigInt()),"base64url"),dp:M(Ot(t[6].toBigInt()),"base64url"),dq:M(Ot(t[7].toBigInt()),"base64url"),qi:M(Ot(t[8].toBigInt()),"base64url"),kty:"RSA",alg:"RS256"}}function Rw(n){if(n.n==null||n.e==null||n.d==null||n.p==null||n.q==null||n.dp==null||n.dq==null||n.qi==null)throw new ge("JWK was missing components","ERR_INVALID_PARAMETERS");const t=new Je({value:[new De({value:0}),De.fromBigInt(Mt(O(n.n,"base64url"))),De.fromBigInt(Mt(O(n.e,"base64url"))),De.fromBigInt(Mt(O(n.d,"base64url"))),De.fromBigInt(Mt(O(n.p,"base64url"))),De.fromBigInt(Mt(O(n.q,"base64url"))),De.fromBigInt(Mt(O(n.dp,"base64url"))),De.fromBigInt(Mt(O(n.dq,"base64url"))),De.fromBigInt(Mt(O(n.qi,"base64url")))]}).toBER();return new Uint8Array(t,0,t.byteLength)}function Dw(n){const{result:e}=bf(n),t=e.valueBlock.value[1].valueBlock.value[0].valueBlock.value;return{kty:"RSA",n:M(Ot(t[0].toBigInt()),"base64url"),e:M(Ot(t[1].toBigInt()),"base64url")}}function Bw(n){if(n.n==null||n.e==null)throw new ge("JWK was missing components","ERR_INVALID_PARAMETERS");const t=new Je({value:[new Je({value:[new mr({value:"1.2.840.113549.1.1.1"}),new Ts]}),new Jl({valueHex:new Je({value:[De.fromBigInt(Mt(O(n.n,"base64url"))),De.fromBigInt(Mt(O(n.e,"base64url")))]}).toBER()})]}).toBER();return new Uint8Array(t,0,t.byteLength)}function Ot(n){let e=n.toString(16);e.length%2>0&&(e=`0${e}`);const t=e.length/2,r=new Uint8Array(t);let s=0,i=0;for(;s<t;)r[s]=parseInt(e.slice(i,i+2),16),s+=1,i+=2;return r}function Mt(n){const e=[];return n.forEach(function(t){let r=t.toString(16);r.length%2>0&&(r=`0${r}`),e.push(r)}),BigInt("0x"+e.join(""))}const Lw=16,id=32,od=1e4;async function Nw(n,e){const t=Tt.get(),s=new Je({value:[new De({value:0}),new Je({value:[new mr({value:"1.2.840.113549.1.1.1"}),new Ts]}),new cn({valueHex:n.marshal()})]}).toBER(),i=new Uint8Array(s,0,s.byteLength),o=Mc(Lw),a=await V9(H9,e,o,{c:od,dkLen:id}),c=Mc(16),l=await t.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),u=await t.subtle.encrypt({name:"AES-CBC",iv:c},l,i),h=new Je({value:[new cn({valueHex:o}),new De({value:od}),new De({value:id}),new Je({value:[new mr({value:"1.2.840.113549.2.11"}),new Ts]})]}),f=new Je({value:[new mr({value:"1.2.840.113549.1.5.13"}),new Je({value:[new Je({value:[new mr({value:"1.2.840.113549.1.5.12"}),h]}),new Je({value:[new mr({value:"2.16.840.1.101.3.4.1.42"}),new cn({valueHex:c})]})]})]}),p=new Je({value:[f,new cn({valueHex:u})]}).toBER(),m=new Uint8Array(p,0,p.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...M(m,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function Ow(n){const e=await Tt.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:n,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),t=await I3(e);return{privateKey:t[0],publicKey:t[1]}}async function A3(n){const t=[await Tt.get().subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await Fw(n)],r=await I3({privateKey:t[0],publicKey:t[1]});return{privateKey:r[0],publicKey:r[1]}}async function Mw(n,e){const t=await Tt.get().subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),r=await Tt.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},t,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(r,0,r.byteLength)}async function Uw(n,e,t){const r=await Tt.get().subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return Tt.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},r,e,t instanceof Uint8Array?t:t.subarray())}async function I3(n){if(n.privateKey==null||n.publicKey==null)throw new ge("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([Tt.get().subtle.exportKey("jwk",n.privateKey),Tt.get().subtle.exportKey("jwk",n.publicKey)])}async function Fw(n){return Tt.get().subtle.importKey("jwk",{kty:n.kty,n:n.n,e:n.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function t1(n){if(n.kty!=="RSA")throw new ge("invalid key type","ERR_INVALID_KEY_TYPE");if(n.n==null)throw new ge("invalid key modulus","ERR_INVALID_KEY_MODULUS");return O(n.n,"base64url").length*8}const Ys=8192;class r1{constructor(e){d(this,"_key");this._key=e}verify(e,t){return Uw(this._key,t,e)}marshal(){return Bw(this._key)}get bytes(){return Cs.encode({Type:at.RSA,Data:this.marshal()}).subarray()}equals(e){return ie(this.bytes,e.bytes)}hash(){const e=tt.digest(this.bytes);return Tr(e)?e.then(({bytes:t})=>t):e.bytes}}class Ko{constructor(e,t){d(this,"_key");d(this,"_publicKey");this._key=e,this._publicKey=t}genSecret(){return Mc(16)}sign(e){return Mw(this._key,e)}get public(){if(this._publicKey==null)throw new ge("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new r1(this._publicKey)}marshal(){return Rw(this._key)}get bytes(){return As.encode({Type:at.RSA,Data:this.marshal()}).subarray()}equals(e){return ie(this.bytes,e.bytes)}hash(){const e=tt.digest(this.bytes);return Tr(e)?e.then(({bytes:t})=>t):e.bytes}async id(){const e=await this.public.hash();return M(e,"base58btc")}async export(e,t="pkcs-8"){if(t==="pkcs-8")return Nw(this,e);if(t==="libp2p-key")return Kl(this.bytes,e);throw new ge(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}async function $w(n){const e=Tw(n);if(t1(e)>Ys)throw new ge("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await A3(e);return new Ko(t.privateKey,t.publicKey)}function Vw(n){const e=Dw(n);if(t1(e)>Ys)throw new ge("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new r1(e)}async function Hw(n){if(t1(n)>Ys)throw new ge("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const e=await A3(n);return new Ko(e.privateKey,e.publicKey)}async function qw(n){if(n>Ys)throw new ge("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const e=await Ow(n);return new Ko(e.privateKey,e.publicKey)}const zw=Object.freeze(Object.defineProperty({__proto__:null,MAX_RSA_KEY_SIZE:Ys,RsaPrivateKey:Ko,RsaPublicKey:r1,fromJwk:Hw,generateKeyPair:qw,unmarshalRsaPrivateKey:$w,unmarshalRsaPublicKey:Vw},Symbol.toStringTag,{value:"Module"}));function Kw(){return gt.utils.randomPrivateKey()}function jw(n,e){const t=tt.digest(e instanceof Uint8Array?e:e.subarray());if(Tr(t))return t.then(({digest:r})=>gt.sign(r,n).toDERRawBytes()).catch(r=>{throw new ge(String(r),"ERR_INVALID_INPUT")});try{return gt.sign(t.digest,n).toDERRawBytes()}catch(r){throw new ge(String(r),"ERR_INVALID_INPUT")}}function Gw(n,e,t){const r=tt.digest(t instanceof Uint8Array?t:t.subarray());if(Tr(r))return r.then(({digest:s})=>gt.verify(e,s,n)).catch(s=>{throw new ge(String(s),"ERR_INVALID_INPUT")});try{return gt.verify(e,r.digest,n)}catch(s){throw new ge(String(s),"ERR_INVALID_INPUT")}}function Ww(n){return gt.ProjectivePoint.fromHex(n).toRawBytes(!0)}function Qw(n){try{gt.getPublicKey(n,!0)}catch(e){throw new ge(String(e),"ERR_INVALID_PRIVATE_KEY")}}function P3(n){try{gt.ProjectivePoint.fromHex(n)}catch(e){throw new ge(String(e),"ERR_INVALID_PUBLIC_KEY")}}function Yw(n){try{return gt.getPublicKey(n,!0)}catch(e){throw new ge(String(e),"ERR_INVALID_PRIVATE_KEY")}}class n1{constructor(e){d(this,"_key");P3(e),this._key=e}verify(e,t){return Gw(this._key,t,e)}marshal(){return Ww(this._key)}get bytes(){return Cs.encode({Type:at.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return ie(this.bytes,e.bytes)}async hash(){const e=tt.digest(this.bytes);let t;return Tr(e)?{bytes:t}=await e:t=e.bytes,t}}class s1{constructor(e,t){d(this,"_key");d(this,"_publicKey");this._key=e,this._publicKey=t??Yw(e),Qw(this._key),P3(this._publicKey)}sign(e){return jw(this._key,e)}get public(){return new n1(this._publicKey)}marshal(){return this._key}get bytes(){return As.encode({Type:at.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return ie(this.bytes,e.bytes)}hash(){const e=tt.digest(this.bytes);return Tr(e)?e.then(({bytes:t})=>t):e.bytes}async id(){const e=await this.public.hash();return M(e,"base58btc")}async export(e,t="libp2p-key"){if(t==="libp2p-key")return Kl(this.bytes,e);throw new ge(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}function Jw(n){return new s1(n)}function Zw(n){return new n1(n)}async function Xw(){const n=Kw();return new s1(n)}const ev=Object.freeze(Object.defineProperty({__proto__:null,Secp256k1PrivateKey:s1,Secp256k1PublicKey:n1,generateKeyPair:Xw,unmarshalSecp256k1PrivateKey:Jw,unmarshalSecp256k1PublicKey:Zw},Symbol.toStringTag,{value:"Module"})),T3={rsa:zw,ed25519:ww,secp256k1:ev};function tv(n){const e=Object.keys(T3).join(" / ");return new ge(`invalid or unsupported key type ${n}. Must be ${e}`,"ERR_UNSUPPORTED_KEY_TYPE")}function i1(n){if(n=n.toLowerCase(),n==="rsa"||n==="ed25519"||n==="secp256k1")return T3[n];throw tv(n)}async function rv(n,e){return i1(n).generateKeyPair(2048)}function nv(n,e){return e=(e??"rsa").toLowerCase(),i1(e),n.bytes}function sv(n,e){return e=(e??"rsa").toLowerCase(),i1(e),n.bytes}const R3=Symbol.for("nodejs.util.inspect.custom"),iv=Object.values(ps).map(n=>n.decoder).reduce((n,e)=>n.or(e),ps.identity.decoder),D3=114,o1=36,a1=37;var Nd;class c1{constructor(e){d(this,"type");d(this,"multihash");d(this,"privateKey");d(this,"publicKey");d(this,"string");d(this,Nd,!0);this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}toString(){return this.string==null&&(this.string=fe.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return Z.createV1(D3,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){var t;if(e==null)return!1;if(e instanceof Uint8Array)return ie(this.multihash.bytes,e);if(typeof e=="string")return av(e).equals(this);if(((t=e==null?void 0:e.multihash)==null?void 0:t.bytes)!=null)return ie(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[(Nd=of,R3)](){return`PeerId(${this.toString()})`}}class jo extends c1{constructor(t){super({...t,type:"RSA"});d(this,"type","RSA");d(this,"publicKey");this.publicKey=t.publicKey}}class Go extends c1{constructor(t){super({...t,type:"Ed25519"});d(this,"type","Ed25519");d(this,"publicKey");this.publicKey=t.multihash.digest}}class Wo extends c1{constructor(t){super({...t,type:"secp256k1"});d(this,"type","secp256k1");d(this,"publicKey");this.publicKey=t.multihash.digest}}const Vc=2336;var Od,Md;class ov{constructor(e){d(this,"type","url");d(this,"multihash");d(this,"privateKey");d(this,"publicKey");d(this,"url");d(this,Od,!0);this.url=e.toString(),this.multihash=It.digest(O(this.url))}[(Md=R3,Od=of,Md)](){return`PeerId(${this.url})`}toString(){return this.toCID().toString()}toCID(){return Z.createV1(Vc,this.multihash)}toBytes(){return this.toCID().bytes}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=M(e)),e.toString()===this.toString())}}function av(n,e){if(n.charAt(0)==="1"||n.charAt(0)==="Q"){const t=ct(fe.decode(`z${n}`));return n.startsWith("12D")?new Go({multihash:t}):n.startsWith("16U")?new Wo({multihash:t}):new jo({multihash:t})}return cv(iv.decode(n))}function cv(n){try{const e=ct(n);if(e.code===It.code){if(e.digest.length===o1)return new Go({multihash:e});if(e.digest.length===a1)return new Wo({multihash:e})}if(e.code===tt.code)return new jo({multihash:e})}catch{return lv(Z.decode(n))}throw new Error("Supplied PeerID CID is invalid")}function lv(n){if((n==null?void 0:n.multihash)==null||n.version==null||n.version===1&&n.code!==D3&&n.code!==Vc)throw new Error("Supplied PeerID CID is invalid");if(n.code===Vc){const t=M(n.multihash.digest);return new ov(new URL(t))}const e=n.multihash;if(e.code===tt.code)return new jo({multihash:n.multihash});if(e.code===It.code){if(e.digest.length===o1)return new Go({multihash:n.multihash});if(e.digest.length===a1)return new Wo({multihash:n.multihash})}throw new Error("Supplied PeerID CID is invalid")}async function uv(n,e){return n.length===o1?new Go({multihash:Vr(It.code,n),privateKey:e}):n.length===a1?new Wo({multihash:Vr(It.code,n),privateKey:e}):new jo({multihash:await tt.digest(n),publicKey:n,privateKey:e})}const dv=async()=>{const n=await rv("Ed25519"),e=await B3(n);if(e.type==="Ed25519")return e;throw new Error(`Generated unexpected PeerId type "${e.type}"`)};async function B3(n){return uv(nv(n.public),sv(n))}const hv="0.1.0",fv="id",pv="1.0.0",gv=1024*8;var bo;(function(n){let e;n.codec=()=>(e==null&&(e=Ue((t,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),t.protocolVersion!=null&&(r.uint32(42),r.string(t.protocolVersion)),t.agentVersion!=null&&(r.uint32(50),r.string(t.agentVersion)),t.publicKey!=null&&(r.uint32(10),r.bytes(t.publicKey)),t.listenAddrs!=null)for(const i of t.listenAddrs)r.uint32(18),r.bytes(i);if(t.observedAddr!=null&&(r.uint32(34),r.bytes(t.observedAddr)),t.protocols!=null)for(const i of t.protocols)r.uint32(26),r.string(i);t.signedPeerRecord!=null&&(r.uint32(66),r.bytes(t.signedPeerRecord)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{var a,c;const i={listenAddrs:[],protocols:[]},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 5:{i.protocolVersion=t.string();break}case 6:{i.agentVersion=t.string();break}case 1:{i.publicKey=t.bytes();break}case 2:{if(((a=s.limits)==null?void 0:a.listenAddrs)!=null&&i.listenAddrs.length===s.limits.listenAddrs)throw new kr('Decode error - map field "listenAddrs" had too many elements');i.listenAddrs.push(t.bytes());break}case 4:{i.observedAddr=t.bytes();break}case 3:{if(((c=s.limits)==null?void 0:c.protocols)!=null&&i.protocols.length===s.limits.protocols)throw new kr('Decode error - map field "protocols" had too many elements');i.protocols.push(t.string());break}case 8:{i.signedPeerRecord=t.bytes();break}default:{t.skipType(l&7);break}}}return i})),e),n.encode=t=>Me(t,n.codec()),n.decode=(t,r)=>Oe(t,n.codec(),r)})(bo||(bo={}));const Qt={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:gv,runOnConnectionOpen:!0,runOnLimitedConnection:!0};function mv(n){if(n!=null&&n.length>0)try{return se(n)}catch{}}function yv(n,e){return e??n.userAgent}async function bv(n,e,t,r,s){if(t("received identify from %p",r.remotePeer),s==null)throw new Ke("message was null or undefined");const i={};if(s.listenAddrs.length>0&&(i.addresses=s.listenAddrs.map(c=>({isCertified:!1,multiaddr:se(c)}))),s.protocols.length>0&&(i.protocols=s.protocols),s.publicKey!=null){const c=Zr(s.publicKey);if(!To(c).equals(r.remotePeer))throw new Ke("public key did not match remote PeerId");i.publicKey=c}let o;if(s.signedPeerRecord!=null){t.trace("received signedPeerRecord from %p",r.remotePeer);let c=s.signedPeerRecord;const l=await Kr.openAndCertify(c,rr.DOMAIN);let u=rr.createFromProtobuf(l.payload);const h=Ks(l.publicKey.toCID());if(!u.peerId.equals(h))throw new Ke("signing key does not match PeerId in the PeerRecord");if(!r.remotePeer.equals(u.peerId))throw new Ke("signing key does not match remote PeerId");let f;try{f=await n.get(u.peerId)}catch(g){if(g.name!=="NotFoundError")throw g}if(f!=null&&(i.metadata=f.metadata,f.peerRecordEnvelope!=null)){const g=await Kr.createFromProtobuf(f.peerRecordEnvelope),p=rr.createFromProtobuf(g.payload);p.seqNumber>=u.seqNumber&&(t("sequence number was lower or equal to existing sequence number - stored: %d received: %d",p.seqNumber,u.seqNumber),u=p,c=f.peerRecordEnvelope)}i.peerRecordEnvelope=c,i.addresses=u.multiaddrs.map(g=>({isCertified:!0,multiaddr:g})),o={seq:u.seqNumber,addresses:u.multiaddrs}}else t("%p did not send a signed peer record",r.remotePeer);if(t.trace("patching %p with",r.remotePeer,i),await n.patch(r.remotePeer,i),s.agentVersion!=null||s.protocolVersion!=null){const c={};s.agentVersion!=null&&(c.AgentVersion=O(s.agentVersion)),s.protocolVersion!=null&&(c.ProtocolVersion=O(s.protocolVersion)),t.trace("merging %p metadata",r.remotePeer,c),await n.merge(r.remotePeer,{metadata:c})}const a={peerId:r.remotePeer,protocolVersion:s.protocolVersion,agentVersion:s.agentVersion,publicKey:s.publicKey,listenAddrs:s.listenAddrs.map(c=>se(c)),observedAddr:s.observedAddr==null?void 0:se(s.observedAddr),protocols:s.protocols,signedPeerRecord:o,connection:r};return e.safeDispatchEvent("peer:identify",{detail:a}),a}class wv{constructor(e,t){d(this,"host");d(this,"protocol");d(this,"started");d(this,"timeout");d(this,"peerId");d(this,"privateKey");d(this,"peerStore");d(this,"registrar");d(this,"addressManager");d(this,"maxInboundStreams");d(this,"maxOutboundStreams");d(this,"maxMessageSize");d(this,"maxObservedAddresses");d(this,"events");d(this,"runOnLimitedConnection");d(this,"log");this.protocol=t.protocol,this.started=!1,this.peerId=e.peerId,this.privateKey=e.privateKey,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.events=e.events,this.log=t.log,this.timeout=t.timeout??Qt.timeout,this.maxInboundStreams=t.maxInboundStreams??Qt.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??Qt.maxOutboundStreams,this.maxMessageSize=t.maxMessageSize??Qt.maxMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??Qt.maxObservedAddresses,this.runOnLimitedConnection=t.runOnLimitedConnection??Qt.runOnLimitedConnection,this.host={protocolVersion:`${t.protocolPrefix??Qt.protocolPrefix}/${hv}`,agentVersion:yv(e.nodeInfo,t.agentVersion)}}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:O(this.host.agentVersion),ProtocolVersion:O(this.host.protocolVersion)}}),await this.registrar.handle(this.protocol,e=>{this.handleProtocol(e).catch(t=>{this.log.error(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.protocol),this.started=!1}}const vv=41;function Ev(n){try{const[[e,t]]=n.stringTuples();if(t==null)return!1;if(e===vv)return V7("2000::/3",t)}catch{}return!1}const Sv=41;var Ud,Fd;class _v extends(Fd=wv,Ud=Sn,Fd){constructor(t,r={}){super(t,{...r,protocol:`/${r.protocolPrefix??Qt.protocolPrefix}/${fv}/${pv}`,log:t.logger.forComponent("libp2p:identify")});d(this,Ud,["@libp2p/identify"]);(r.runOnConnectionOpen??Qt.runOnConnectionOpen)&&t.events.addEventListener("connection:open",s=>{const i=s.detail;this.identify(i).catch(o=>{o.name!==Eo.name&&this.log.error("error during identify trigged by connection:open",o)})})}async _identify(t,r={}){let s;if(r.signal==null){const i=AbortSignal.timeout(this.timeout);r={...r,signal:i}}try{s=await t.newStream(this.protocol,{...r,runOnLimitedConnection:this.runOnLimitedConnection});const o=await go(s,{maxDataLength:this.maxMessageSize}).pb(bo).read(r);return await s.close(r),o}catch(i){throw s==null||s.abort(i),i}}async identify(t,r={}){const s=await this._identify(t,r),{publicKey:i,protocols:o,observedAddr:a}=s;if(i==null)throw new Ke("public key was missing from identify message");const c=Zr(i),l=Ks(c.toCID());if(!t.remotePeer.equals(l))throw new Ke("identified peer does not match the expected peer");if(this.peerId.equals(l))throw new Ke("identified peer is our own peer id?");return this.maybeAddObservedAddress(a),this.log("identify completed for peer %p and protocols %o",l,o),bv(this.peerStore,this.events,this.log,t,s)}maybeAddObservedAddress(t){const r=mv(t);if(r==null)return;if(this.log.trace("our observed address was %a",r),vs(r)){this.log.trace("our observed address was private");return}if(r.stringTuples()[0][0]===Sv&&!Ev(r)){this.log.trace("our observed address was IPv6 but not a global unicast address");return}ao.exactMatch(r)||(this.log.trace("storing the observed address"),this.addressManager.addObservedAddr(r))}async handleProtocol(t){const{connection:r,stream:s}=t,i=AbortSignal.timeout(this.timeout);try{const o=await this.peerStore.get(this.peerId),a=this.addressManager.getAddresses().map(h=>h.decapsulateCode(ce("p2p").code));let c=o.peerRecordEnvelope;if(a.length>0&&c==null){const h=new rr({peerId:this.peerId,multiaddrs:a});c=(await Kr.seal(h,this.privateKey)).marshal().subarray()}let l=r.remoteAddr.bytes;Hp.matches(r.remoteAddr)||(l=void 0),await go(s).pb(bo).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:tr(this.privateKey.publicKey),listenAddrs:a.map(h=>h.bytes),signedPeerRecord:c,observedAddr:l,protocols:o.protocols},{signal:i}),await s.close({signal:i})}catch(o){this.log.error("could not respond to identify request",o),s.abort(o)}}}function xv(n={}){return e=>new _v(e,n)}const Ma=32,kv="1.0.0",Cv="ping",Av="ipfs",Iv=1e4,Pv=2,Tv=1;var $d,Vd;Vd=Symbol.toStringTag,$d=Sn;class Rv{constructor(e,t={}){d(this,"protocol");d(this,"components");d(this,"started");d(this,"timeout");d(this,"maxInboundStreams");d(this,"maxOutboundStreams");d(this,"runOnLimitedConnection");d(this,"log");d(this,Vd,"@libp2p/ping");d(this,$d,["@libp2p/ping"]);this.components=e,this.log=e.logger.forComponent("libp2p:ping"),this.started=!1,this.protocol=`/${t.protocolPrefix??Av}/${Cv}/${kv}`,this.timeout=t.timeout??Iv,this.maxInboundStreams=t.maxInboundStreams??Pv,this.maxOutboundStreams=t.maxOutboundStreams??Tv,this.runOnLimitedConnection=t.runOnLimitedConnection??!0,this.handleMessage=this.handleMessage.bind(this)}async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){this.log("incoming ping from %p",e.connection.remotePeer);const{stream:t}=e,r=Date.now(),s=uo(t);let i=!1;Promise.resolve().then(async()=>{for(;;){const o=AbortSignal.timeout(this.timeout);o.addEventListener("abort",()=>{t==null||t.abort(new M2("ping timeout"))});const a=await s.read({bytes:Ma,signal:o});await s.write(a,{signal:o}),i=!0}}).catch(o=>{i&&o.name==="UnexpectedEOFError"&&t.readStatus!=="ready"||(this.log.error("incoming ping from %p failed with error - %e",e.connection.remotePeer,o),t==null||t.abort(o))}).finally(()=>{const o=Date.now()-r;this.log("incoming ping from %p complete in %dms",e.connection.remotePeer,o);const a=AbortSignal.timeout(this.timeout);t.close({signal:a}).catch(c=>{this.log.error("error closing ping stream from %p - %e",e.connection.remotePeer,c),t==null||t.abort(c)})})}async ping(e,t={}){this.log("pinging %p",e);const r=Date.now(),s=Po(Ma),i=await this.components.connectionManager.openConnection(e,t);let o;if(t.signal==null){const a=AbortSignal.timeout(this.timeout);t={...t,signal:a}}try{o=await i.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});const a=uo(o),[,c]=await Promise.all([a.write(s,t),a.read({...t,bytes:Ma})]),l=Date.now()-r;if(!ie(s,c.subarray()))throw new O2(`Received wrong ping ack after ${l}ms`);return this.log("ping %p complete in %dms",i.remotePeer,l),l}catch(a){throw this.log.error("error while pinging %p",i.remotePeer,a),o==null||o.abort(a),a}finally{o!=null&&await o.close(t)}}}function Dv(n={}){return e=>new Rv(e,n)}async function Qe(n){const t=new TextEncoder().encode(n),r=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(r)).map(i=>i.toString(16).padStart(2,"0")).join("").substring(0,40)}class Hc{constructor(e){this.peer=e,this.connections=new Map,this.tag="peerjs-webrtc",Object.defineProperty(this,Symbol.toStringTag,{value:"peerjs-webrtc",writable:!1,enumerable:!1,configurable:!0}),console.log("PeerJsTransport created with Symbol.toStringTag:",this[Symbol.toStringTag],"tag:",this.tag)}async dial(e){const t=e.getPeerId();if(!t)throw new Error("No peer ID in multiaddr");const r=this.peer.connect(t,{reliable:!0});return new Promise((s,i)=>{r.on("open",()=>{this.connections.set(t,r),s({id:t,remotePeer:t,remoteAddr:e,close:()=>r.close(),abort:()=>r.close(),getStreams:()=>[{id:`stream-${t}`,protocol:"/webrtc/1.0.0",read:o=>{r.on("data",a=>o(null,a)),r.on("close",()=>o(new Error("Connection closed")))},write:o=>r.send(o),close:()=>r.close(),abort:()=>r.close()}]})}),r.on("error",i)})}createListener(e){return{listen:t=>{this.peer.on("connection",r=>{var s;this.connections.set(r.peer,r),(s=e.onConnection)==null||s.call(e,{id:r.peer,remotePeer:r.peer,remoteAddr:t,close:()=>r.close(),abort:()=>r.close(),getStreams:()=>[{id:`stream-${r.peer}`,protocol:"/webrtc/1.0.0",read:i=>{r.on("data",o=>i(null,o)),r.on("close",()=>i(new Error("Connection closed")))},write:i=>r.send(i),close:()=>r.close(),abort:()=>r.close()}]})})},close:()=>this.peer.destroy(),getAddrs:()=>{const t=se(`/webrtc/p2p/${this.peer.id}`);return console.log("Listener address:",t.toString()),[t]}}}listenFilter(e){return console.log("Filtering listen addresses:",e.map(t=>t.toString())),e.filter(t=>t.protoNames().includes("webrtc"))}}d(Hc,"tag","peerjs-webrtc");class L3{constructor(e,t=!1){this.peers=new Map,this.knownObjects=new Map,this.chunkToPeerMap=new Map,this.pendingRequests=new Map,this.db=null,this.keypair=e,this.activeNodes=new Set,this.nodes=new Set,this.offlineQueue=[],this.isNode=t,this.peerId=null,this.peer=null,this.libp2p=null,this.kadDht=null,this.connectionAttempts=new Map,this.maxConnectionAttempts=3,this.connectionRetryDelay=5e3,this.averageLatency=0,this.bootstrapNodes=new Set,this.nodeLatencies=new Map,this.peerId=this.isNode?`node-${this.keypair}`:e,Qe(this.peerId).then(r=>{this.kademliaId=r,console.log("DHT initialized with keypair:",e,"isNode:",t),this.initializeKnownNodes()}).catch(r=>{throw console.error("Failed to generate Kademlia ID:",r),r})}async initializeLibp2p(){if(!this.isNode)return;console.log("Initializing PeerJS with peerId:",this.peerId),this.peer=new x1(this.peerId,{host:"0.peerjs.com",port:443,path:"/",secure:!0,config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{url:"turn:192.158.29.39:3478?transport=tcp",credential:"JZEOEt2V3Qb0y27GRntt2u2PAYA=",username:"28224511:1379330808"}]},debug:3}),await new Promise((t,r)=>{this.peer.on("open",()=>{console.log("PeerJS opened"),t()}),this.peer.on("error",s=>{console.error("PeerJS error:",s),r(s)})});let e;try{if(console.log("Keypair input:",this.keypair),!this.keypair||typeof this.keypair!="string")throw new Error("Invalid keypair: must be a non-empty string");const t=this.base64UrlToUint8Array(this.keypair);if(!t||!(t instanceof Uint8Array))throw new Error("Failed to decode keypair to Uint8Array");if(e=await B3(t),await Qe(e.toString())!==this.kademliaId)throw console.warn("Derived PeerId does not match kademliaId, generating new PeerId"),new Error("PeerId mismatch")}catch(t){console.warn("Failed to create PeerId from keypair, generating new Ed25519 PeerId:",t),e=await dv(),this.kademliaId=await Qe(e.toString()),this.peerId=this.isNode?`node-${this.uint8ArrayToBase64Url(e.privateKey)}`:this.uint8ArrayToBase64Url(e.privateKey)}console.log("Configuring libp2p with peerId:",e.toString());try{const t=se(`/webrtc/p2p/${e.toString()}`);console.log("Listen address:",t.toString()),this.libp2p=await wy({peerId:e,transports:[()=>{const r=new Hc(this.peer);return console.log("Created PeerJsTransport with Symbol.toStringTag:",r[Symbol.toStringTag],"static tag:",Hc.tag,"instance tag:",r.tag),r}],addresses:{listen:[t.toString()]},services:{dht:Zb({kBucketSize:20,clientMode:!1}),identify:xv(),ping:Dv()}})}catch(t){throw console.error("Failed to create libp2p:",t),t}this.kadDht=this.libp2p.services.dht,console.log("libp2p initialized with PeerId:",e.toString(),"Services:",Object.keys(this.libp2p.services))}async initializeKnownNodes(){const e=async()=>{try{const t=await Ui(is(rf,"nodes"));if(this.nodes.clear(),t.forEach(r=>this.nodes.add(`node-${r.id}`)),console.log("Fetched nodes:",Array.from(this.nodes)),this.nodes.size>0){const r=await this.selectBootstrapNode();r&&(this.bootstrapNodes.add(r),await this.queryBootstrapNode(r))}}catch(t){console.error("Failed to fetch nodes from Firestore:",t),this.nodes.clear()}};this.isNode?await this.initializeLibp2p():await this.initSwarm(),await e(),setInterval(e,5*60*1e3),this.isNode&&(setInterval(()=>this.refreshRoutingTable(),10*60*1e3),setInterval(()=>this.republishData(),6*60*60*1e3),setInterval(()=>this.cleanupDHTStore(),24*60*60*1e3))}async selectBootstrapNode(){const e=Array.from(this.nodes).filter(s=>s!==this.peerId);if(e.length===0)return null;let t=1/0,r=null;for(const s of e.slice(0,5)){const i=await this.measureLatencyToPeer(s);i!==null&&i<t&&(t=i,r=s)}return r||(r=e[Math.floor(Math.random()*e.length)]),r}async queryBootstrapNode(e){try{if(!this.peer||this.peer.destroyed)throw new Error("PeerJS not initialized");await this.connectToPeer(e);const t=this.peers.get(e);if(t&&t.connected&&t.conn){const r=`${e}-getKnownNodes-${Date.now()}`;return t.conn.send({type:"getKnownNodes",requestId:r,peerId:this.peerId}),new Promise((s,i)=>{this.pendingRequests.set(r,{resolve:o=>{o.forEach(async a=>{if(a!==this.peerId&&(this.bootstrapNodes.add(a),this.isNode&&this.kadDht)){const c=await Qe(a);this.kadDht.addPeer(c,[se(`/webrtc/p2p/${a}`)]),this.nodeLatencies.set(c,1/0)}}),console.log("Received known nodes from bootstrap:",o),s()},reject:i}),setTimeout(()=>{this.pendingRequests.has(r)&&(this.pendingRequests.delete(r),i(new Error("Bootstrap query timed out")))},1e4)})}else console.warn(`Failed to connect to bootstrap node ${e}`)}catch(t){console.error("Failed to query bootstrap node:",t)}}async measureLatencyToPeer(e){const t=this.peers.get(e);if(t&&t.connected&&t.conn){const r=Date.now();try{await new Promise((i,o)=>{const a=`${e}-ping-${Date.now()}`;t.conn.send({type:"ping",requestId:a}),this.pendingRequests.set(a,{resolve:i,reject:o}),setTimeout(()=>{this.pendingRequests.has(a)&&(this.pendingRequests.delete(a),o(new Error("Ping timeout")))},2e3)});const s=Date.now()-r;if(this.isNode&&this.kadDht){const i=await Qe(e);this.nodeLatencies.set(i,s)}return s}catch(s){return console.warn(`Failed to measure latency for peer ${e}:`,s),null}}return null}async measureLatency(){const e=[],t=Array.from(this.activeNodes).slice(0,5);for(const r of t){const s=await this.measureLatencyToPeer(r);s!==null&&e.push(s)}this.averageLatency=e.length>0?e.reduce((r,s)=>r+s,0)/e.length:0,console.log(`Average latency: ${this.averageLatency} ms`)}async refreshRoutingTable(){if(this.isNode)try{const e=await Qe(String(Math.random())),t=await this.kadDht.getClosestPeers(e);for(const r of t)await this.connectToPeer(r.id.toString());console.log("Refreshed routing table")}catch(e){console.error("Failed to refresh routing table:",e)}}async initDB(){return new Promise((e,t)=>{const s=indexedDB.open("dcrypt_db",6);let i;s.onupgradeneeded=o=>{i=s.result,i.objectStoreNames.contains("store")||i.createObjectStore("store",{keyPath:"id"}),i.objectStoreNames.contains("transactions")||i.createObjectStore("transactions",{keyPath:"id",autoIncrement:!0}),i.objectStoreNames.contains("offlineQueue")||i.createObjectStore("offlineQueue",{keyPath:"id",autoIncrement:!0}),i.objectStoreNames.contains("chunkCache")||i.createObjectStore("chunkCache",{keyPath:"id"}),i.objectStoreNames.contains("dhtStore")||i.createObjectStore("dhtStore",{keyPath:"id"}),console.log("DHT database upgraded to version",6)},s.onsuccess=()=>{this.db=s.result,console.log("DHT IndexedDB opened at version",this.db.version),e()},s.onerror=o=>t(new Error(`Failed to open IndexedDB: ${o.target.error.message}`))})}async loadKnownObjects(){if(!this.db)throw new Error("IndexedDB not initialized");try{const r=this.db.transaction("store","readonly").objectStore("store").getAll();r.onsuccess=()=>{r.result.forEach(s=>{if(s.id!=="dcrypt_identity")try{const{metadata:i,chunks:o}=JSON.parse(s.value);this.knownObjects.set(s.id,{metadata:i,chunks:o})}catch(i){console.error("Failed to parse known object:",s.id,i)}}),console.log("Loaded known objects from IndexedDB")}}catch(e){console.error("Failed to load known objects:",e)}}async syncUserData(){if(!this.db)throw new Error("IndexedDB not initialized");try{await this.dbPut("store",{id:"dcrypt_identity",value:this.keypair}),await this.updateBalance(),this.activeNodes.size>0&&await this.processOfflineQueue();const e={type:"userData",peerId:this.peerId,keypair:this.keypair,balance:await this.getBalance(this.keypair),timestamp:Date.now()};this.broadcast(e),console.log("User data synced successfully")}catch(e){throw console.error("Sync failed:",e),e}}async saveUserData(){if(!this.db)throw new Error("IndexedDB not initialized");try{await this.dbPut("store",{id:"dcrypt_identity",value:this.keypair}),await this.updateBalance(),console.log("User data saved to IndexedDB")}catch(e){throw console.error("Save failed:",e),e}}async initSwarm(){try{return this.isNode?void 0:(console.log("Initializing PeerJS with Peer ID:",this.peerId),this.peer=new x1(this.peerId,{host:"0.peerjs.com",port:443,path:"/",secure:!0,config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{url:"turn:192.158.29.39:3478?transport=tcp",credential:"JZEOEt2V3Qb0y27GRntt2u2PAYA=",username:"28224511:1379330808"}]},debug:3}),await new Promise((e,t)=>{this.peer.on("open",r=>{console.log(`PeerJS connection opened with ID: ${r}`),this.activeNodes.add(this.peerId),this.peer.on("connection",s=>this.handleConnection(s)),this.peer.on("error",s=>{var i;if(console.error("PeerJS error:",s.type,s.message),s.type==="peer-unavailable"){const o=(i=s.message.match(/Peer (.+) is unavailable/))==null?void 0:i[1];o&&this.handlePeerDisconnect(o)}}),this.peer.on("disconnected",()=>{console.log("PeerJS disconnected. Attempting to reconnect..."),this.peer.reconnect()}),window.addEventListener("beforeunload",()=>{this.peer&&!this.peer.destroyed&&(this.peer.destroy(),console.log("PeerJS peer destroyed on page unload"))}),setInterval(()=>this.discoverPeers(),3e3),setInterval(()=>this.measureLatency(),6e4),e()}),this.peer.on("error",r=>t(r))}))}catch(e){throw console.error("initSwarm failed:",e),e}}async discoverPeers(){console.log("Discovering peers...");const e=[...Array.from(this.nodes),...Array.from(this.bootstrapNodes),...Array.from(this.activeNodes)].filter(t=>t!==this.peerId);if(e.length===0){console.warn("No known peers to connect to.");return}if(this.isNode&&this.kadDht){const t=await this.kadDht.getClosestPeers(this.kademliaId);e.push(...t.map(r=>r.id.toString()))}e.forEach(t=>{this.peers.has(t)?this.peers.get(t).connected||this.connectToPeer(t):(this.peers.set(t,{connected:!1,conn:null}),console.log("Discovered peer:",t),this.connectToPeer(t))}),this.peers.size>50&&Array.from(this.peers.entries()).filter(([r,s])=>!s.connected).sort((r,s)=>(this.connectionAttempts.get(s[0])||0)-(this.connectionAttempts.get(r[0])||0)).slice(0,this.peers.size-50).forEach(async([r])=>{if(this.peers.delete(r),this.connectionAttempts.delete(r),this.activeNodes.delete(r),this.isNode&&this.kadDht){const s=await Qe(r);this.kadDht.removePeer(s)}})}async connectToPeer(e,t=1){var s;if((s=this.peers.get(e))!=null&&s.connected)return;if(!this.peer||this.peer.destroyed){console.warn(`Cannot connect to peer ${e}: PeerJS not initialized`),t<this.maxConnectionAttempts&&setTimeout(()=>this.connectToPeer(e,t+1),this.connectionRetryDelay*t);return}console.log(`Connecting to peer: ${e} (Attempt ${t}/${this.maxConnectionAttempts})`);const r=this.peer.connect(e,{reliable:!0});r.on("open",async()=>{if(console.log(`Connection opened with peer: ${e}`),this.peers.set(e,{connected:!0,conn:r}),this.activeNodes.add(e),this.isNode&&this.kadDht){const i=await Qe(e);this.kadDht.addPeer(i,[se(`/webrtc/p2p/${e}`)]),this.nodeLatencies.set(i,1/0)}r.send({type:"handshake",peerId:this.peerId})}),r.on("data",i=>{console.log(`Received data from peer ${e}:`,i),this.handlePeerData(i,e)}),r.on("close",()=>{console.log(`Connection closed with peer ${e}`),this.handlePeerDisconnect(e)}),r.on("error",i=>{console.error(`Connection error with peer ${e}:`,i),t<this.maxConnectionAttempts?setTimeout(()=>this.connectToPeer(e,t+1),this.connectionRetryDelay*t):(console.log(`Max attempts reached for peer ${e}. Marking as unreachable.`),this.handlePeerDisconnect(e))})}async handleConnection(e){const t=e.peer;console.log(`Incoming connection from peer: ${t} at ${Date.now()}`),e.on("open",async()=>{if(console.log(`Connection opened with peer: ${t}`),this.peers.set(t,{connected:!0,conn:e}),this.activeNodes.add(t),this.isNode&&this.kadDht){const r=await Qe(t);this.kadDht.addPeer(r,[se(`/webrtc/p2p/${t}`)]),this.nodeLatencies.set(r,1/0)}}),e.on("data",r=>{console.log(`Received data from peer ${t}:`,r),this.handlePeerData(r,t)}),e.on("close",()=>{console.log(`Connection closed with peer ${t}`),this.handlePeerDisconnect(t)}),e.on("error",r=>{console.error(`Connection error with peer ${t}:`,r),this.handlePeerDisconnect(t)})}async handlePeerDisconnect(e){const t=this.peers.get(e);if(t){if(t.connected=!1,t.conn=null,this.activeNodes.delete(e),this.isNode&&this.kadDht){const r=await Qe(e);this.kadDht.removePeer(r),this.nodeLatencies.delete(r)}console.log(`Peer disconnected: ${e}. Will reconnect on next discovery.`)}}handlePeerData(e,t){switch(console.log(`Received data from peer ${t}:`,e),e.type){case"handshake":console.log(`Handshake from peer: ${t}`),this.activeNodes.add(t);break;case"chunk":this.chunkToPeerMap.set(e.chunkHash,new Set([...this.chunkToPeerMap.get(e.chunkHash)||[],t])),console.log(`Updated chunkToPeerMap for chunk ${e.chunkHash} with peer ${t}`);break;case"ip":this.knownObjects.set(e.ipHash,{metadata:e.metadata,chunks:e.chunkHashes}),this.dbPut("store",{id:e.ipHash,value:JSON.stringify({metadata:e.metadata,chunks:e.chunkHashes})}),console.log(`Received IP ${e.ipHash} from peer ${t}`);break;case"chunkRequest":this.handleChunkRequest(e,t);break;case"chunkResponse":this.handleChunkResponse(e);break;case"metadataRequest":this.handleMetadataRequest(e,t);break;case"metadataResponse":this.handleMetadataResponse(e);break;case"userData":console.log(`Received user data from peer ${t}:`,e);break;case"storeChunk":this.storeChunkFromPeer(e.chunkHash,e.chunkData,t);break;case"ping":peer=this.peers.get(t),peer&&peer.connected&&peer.conn&&peer.conn.send({type:"pong",requestId:e.requestId});break;case"pong":const r=this.pendingRequests.get(e.requestId);r&&(r.resolve(),this.pendingRequests.delete(e.requestId));break;case"commission":console.log(`Received commission of ${e.amount}. New balance: ${e.newBalance}`);break;case"getKnownNodes":if(peer=this.peers.get(t),peer&&peer.connected&&peer.conn){const o=Array.from(this.activeNodes);peer.conn.send({type:"knownNodesResponse",requestId:e.requestId,nodes:o,peerId:this.peerId})}break;case"knownNodesResponse":const s=this.pendingRequests.get(e.requestId);s&&(s.resolve(e.nodes),this.pendingRequests.delete(e.requestId));break;case"storeDHT":this.storeDHTFromPeer(e.key,e.value,e.ttl,t);break;case"findDHT":this.handleFindDHT(e,t);break;case"findDHTResponse":const i=this.pendingRequests.get(e.requestId);i&&(i.resolve({value:e.value,nodes:e.nodes}),this.pendingRequests.delete(e.requestId));break;default:console.warn(`Unknown data type from peer ${t}:`,e.type)}}async storeDHT(e,t,r=864e5){try{const s=await Qe(e);let i=[];if(this.isNode&&this.kadDht)i=(await this.kadDht.getClosestPeers(s)).map(a=>({id:a.id.toString()})).slice(0,20);else{const o=Array.from(this.bootstrapNodes)[0];if(!o)throw new Error("No bootstrap node available");i=await this.requestNodesFromPeer(o,s)}for(const o of i){const a=o.id||o.address,c=this.peers.get(a);c&&c.connected&&c.conn&&c.conn.send({type:"storeDHT",key:e,value:t,ttl:r,peerId:this.peerId})}this.isNode&&this.kadDht&&(await this.storeDHTFromPeer(e,t,r,this.peerId),await this.kadDht.put(Buffer.from(s),Buffer.from(t))),console.log(`Stored DHT key ${e} on ${i.length} nodes`)}catch(s){throw console.error("Failed to store DHT key:",s),s}}async storeDHTFromPeer(e,t,r,s){if(this.isNode)try{await this.dbPut("dhtStore",{id:e,value:t,ttl:r,timestamp:Date.now()});const i=await Qe(e);await this.kadDht.put(Buffer.from(i),Buffer.from(t)),console.log(`Stored DHT key ${e} from peer ${s}`)}catch(i){console.error(`Failed to store DHT key ${e} from peer ${s}:`,i)}}async findDHT(e){try{const t=await Qe(e);if(this.isNode&&this.kadDht){if(await this.kadDht.get(Buffer.from(t))){const i=await this.dbGet("dhtStore",e);if(i&&i.timestamp+i.ttl>Date.now())return i.value}const s=await this.kadDht.getClosestPeers(t);for(const i of s){const o=await this.requestDHTFromPeer(i.id.toString(),e);if(o)return o}}else{const r=Array.from(this.bootstrapNodes)[0];if(!r)throw new Error("No bootstrap node available");const s=await this.requestDHTFromPeer(r,e);if(s)return s}throw new Error(`DHT key ${e} not found`)}catch(t){throw console.error("Failed to find DHT key:",t),t}}async requestNodesFromPeer(e,t){const r=this.peers.get(e);if(!r||!r.connected||!r.conn)throw new Error(`Peer ${e} is not connected`);const s=`${e}-findNodes-${Date.now()}`;return r.conn.send({type:"findDHT",key:t,requestId:s,peerId:this.peerId}),new Promise((i,o)=>{this.pendingRequests.set(s,{resolve:({nodes:a})=>i(a.map(c=>({id:c}))),reject:o}),setTimeout(()=>{this.pendingRequests.has(s)&&(this.pendingRequests.delete(s),o(new Error(`Request for nodes for key ${t} timed out`)))},1e4)})}async requestDHTFromPeer(e,t){const r=this.peers.get(e);if(!r||!r.connected||!r.conn)throw new Error(`Peer ${e} is not connected`);const s=`${e}-findDHT-${Date.now()}`;return r.conn.send({type:"findDHT",key:t,requestId:s,peerId:this.peerId}),new Promise((i,o)=>{this.pendingRequests.set(s,{resolve:({value:a,nodes:c})=>i(a||null),reject:o}),setTimeout(()=>{this.pendingRequests.has(s)&&(this.pendingRequests.delete(s),o(new Error(`Request for DHT key ${t} timed out`)))},1e4)})}async handleFindDHT(e,t){if(!this.isNode)return;const{key:r,requestId:s}=e,i=this.peers.get(t);if(!i||!i.connected||!i.conn)return;const o=await this.dbGet("dhtStore",r);if(o&&o.timestamp+o.ttl>Date.now())i.conn.send({type:"findDHTResponse",requestId:s,value:o.value,nodes:[],peerId:this.peerId});else{const a=await Qe(r),c=await this.kadDht.getClosestPeers(a);i.conn.send({type:"findDHTResponse",requestId:s,value:null,nodes:c.map(l=>l.id.toString()),peerId:this.peerId})}}async republishData(){if(this.isNode)try{const e=await this.dbGetAll("dhtStore");for(const t of e)t.timestamp+t.ttl>Date.now()&&await this.storeDHT(t.id,t.value,t.ttl);console.log("Republished DHT data")}catch(e){console.error("Failed to republish DHT data:",e)}}async cleanupDHTStore(){if(this.isNode)try{const t=this.db.transaction("dhtStore","readwrite").objectStore("dhtStore"),r=await new Promise(s=>{t.getAll().onsuccess=i=>s(i.target.result)});for(const s of r)s.timestamp+s.ttl<=Date.now()&&await new Promise(i=>{t.delete(s.id).onsuccess=i});console.log("Cleaned up expired DHT entries")}catch(e){console.error("Failed to clean up DHT store:",e)}}async storeChunkFromPeer(e,t,r){if(this.isNode)try{await this.dbPut("chunkCache",{id:e,value:t});let s=this.chunkToPeerMap.get(e)||new Set;s.add(this.peerId),this.chunkToPeerMap.set(e,s),console.log(`Stored chunk ${e} from peer ${r}`)}catch(s){console.error(`Failed to store chunk ${e} from peer ${r}:`,s)}}async publishChunk(e,t,r,s){if(!this.db)throw new Error("IndexedDB not initialized");try{if(!e||typeof e!="string"||e.trim()==="")throw new Error("Invalid chunk hash");await this.dbPut("chunkCache",{id:e,value:t});let i=this.chunkToPeerMap.get(e)||new Set;if(i.add(this.peerId),this.chunkToPeerMap.set(e,i),this.activeNodes.size>0){const o=await Qe(e);let a=[];if(this.isNode&&this.kadDht)a=(await this.kadDht.getClosestPeers(o)).map(l=>({id:l.id.toString()})).slice(0,3);else{const c=Array.from(this.bootstrapNodes)[0];if(!c)throw new Error("No bootstrap node available");a=await this.requestNodesFromPeer(c,o),a=a.slice(0,3)}a=a.filter(c=>(c.id||c.address).startsWith("node-"));for(const c of a){const l=c.id||c.address,u=this.peers.get(l);u&&u.connected&&u.conn&&(u.conn.send({type:"storeChunk",chunkHash:e,chunkData:t,peerId:this.peerId}),i.add(l),this.chunkToPeerMap.set(e,i),console.log(`Sent chunk ${e} to node ${l}`))}if(r===s-1){const c={};this.chunkToPeerMap.forEach((u,h)=>{c[h]=Array.from(u)});const l=this.chunkToIpHash.get(e)||e;await this.storeDHT(l,JSON.stringify(c))}}else await this.queueOfflineOperation({type:"publishChunk",chunkHash:e,chunkData:t,chunkIndex:r,totalChunks:s});this.broadcastChunk(e)}catch(i){throw console.error("publishChunk failed:",i),i}}broadcastChunk(e){const t={type:"chunk",chunkHash:e,peerId:this.peerId};this.broadcast(t),console.log(`Broadcasted chunk ${e} to ${this.activeNodes.size} peers`)}async publishIP(e,t,r){if(!this.db||!this.keypair)throw new Error("IndexedDB or keypair not initialized");try{const s=Array.isArray(e.tags)?e.tags.map(v=>String(v).trim()).filter(v=>v!==""):[],i=!!e.isPremium,o=i?e.priceUsd||30:0,a=new Uint8Array(t),c=e.content_type||"",l=this.keypair,h=sw(a,c,s,i,o,l,r||"text/plain"),f=iw(h),g=await nf(f),p=this.uint8ArrayToBase64Url(g),m=Array.from(this.activeNodes).filter(v=>v.startsWith("node-")),y=m.length>0?m.length:1,E=await aw(h,this.keypair,y),_=await Promise.all(E.map(v=>ow(v).then(x=>this.uint8ArrayToBase64Url(x)))),w={...e,chunk_count:E.length,isPremium:i,priceUsd:o,chunks:_},b={metadata:w,chunks:_};this.knownObjects.set(p,b),await this.dbPut("store",{id:p,value:JSON.stringify(b)}),this.chunkToIpHash=new Map,_.forEach(v=>this.chunkToIpHash.set(v,p));for(let v=0;v<E.length;v++)await this.publishChunk(_[v],E[v],v,E.length);return this.activeNodes.size>0?this.broadcastIP(p,w,_):await this.queueOfflineOperation({type:"publishIP",ipHash:p,metadata:w,chunkHashes:_}),p}catch(s){throw console.error("publishIP failed:",s),s}}broadcastIP(e,t,r){const s={type:"ip",ipHash:e,metadata:t,chunkHashes:r,peerId:this.peerId};this.broadcast(s),console.log(`Broadcasted IP ${e} to ${this.activeNodes.size} peers`)}async requestData(e){if(!this.db)throw new Error("IndexedDB not initialized");try{if(!e)throw new Error("IP not found");const t=await this.findDHT(e.metadata.hash||e.chunks[0]),r=JSON.parse(t);this.chunkToPeerMap=new Map,Object.entries(r).forEach(([u,h])=>{this.chunkToPeerMap.set(u,new Set(h))});const s=[];for(const u of e.chunks){const h=await this.dbGet("chunkCache",u);if(h&&h.value){s.push({chunk:h.value,hash:u});continue}const f=this.chunkToPeerMap.get(u);if(!f||f.size===0)throw new Error(`No peers found with chunk ${u}`);const g=Array.from(f).filter(E=>E.startsWith("node-")),p=Array.from(f).filter(E=>!E.startsWith("node-"));let m=!1,y=null;for(const E of[...g,...p])if(this.activeNodes.has(E))try{const _=await this.fetchChunkFromPeer(E,u);await this.dbPut("chunkCache",{id:u,value:_}),s.push({chunk:_,hash:u}),m=!0;break}catch(_){y=_,console.error(`Failed to fetch chunk ${u} from peer ${E}:`,_)}if(!m)throw y||new Error(`No available peer for chunk ${u}`)}const i=s.sort((u,h)=>td(u.chunk)-td(h.chunk)),o=await Promise.all(i.map(({chunk:u})=>cw(u,this.keypair))),a=new Uint8Array(o.reduce((u,h)=>u+h.length,0));let c=0;for(const u of o)a.set(u,c),c+=u.length;const l=lw(i[0].chunk);return{data:a,fileType:l}}catch(t){throw console.error("requestData failed:",t),t}}async getIPmetadata(e){try{const t=this.knownObjects.get(e);if(t)return t;const r=await this.findDHT(e),s=JSON.parse(r);this.chunkToPeerMap=new Map,Object.entries(s).forEach(([l,u])=>{this.chunkToPeerMap.set(l,new Set(u))});const i=Array.from(this.activeNodes).find(l=>l.startsWith("node-"));if(!i)throw new Error("No nodes available");const o=i,a=`${o}-${e}-${Date.now()}`,c=this.peers.get(o);if(!c||!c.connected||!c.conn)throw new Error(`Peer ${o} is not connected`);return c.conn.send({type:"metadataRequest",requestId:a,ipHash:e,peerId:this.peerId}),new Promise((l,u)=>{this.pendingRequests.set(a,{resolve:l,reject:u,hash:e}),setTimeout(()=>{this.pendingRequests.has(a)&&(this.pendingRequests.delete(a),u(new Error(`Request for object ${e} from peer timed out`)))},1e4)})}catch(t){throw console.error("getIPmetadata failed:",t),t}}async fetchChunkFromPeer(e,t){const r=this.peers.get(e);if(!r||!r.connected||!r.conn)throw new Error(`Peer ${e} is not connected`);const s=`${e}-${t}-${Date.now()}`,i={type:"chunkRequest",requestId:s,chunkHash:t,peerId:this.peerId};return r.conn.send(i),new Promise((o,a)=>{this.pendingRequests.set(s,{resolve:o,reject:a,hash:t}),setTimeout(()=>{this.pendingRequests.has(s)&&(this.pendingRequests.delete(s),a(new Error(`Request for chunk ${t} from peer ${e} timed out`)))},1e4)})}handleChunkRequest(e,t){const{requestId:r,chunkHash:s}=e;this.dbGet("chunkCache",s).then(i=>{if(i&&i.value){const o=this.peers.get(t);o&&o.connected&&o.conn&&(o.conn.send({type:"chunkResponse",requestId:r,chunkHash:s,chunkData:i.value,peerId:this.peerId}),console.log(`Sent chunk ${s} to peer ${t}`))}else console.warn(`Chunk ${s} not found for peer ${t}`)}).catch(i=>console.error(`Failed to retrieve chunk ${s} for peer ${t}:`,i))}handleMetadataRequest(e,t){const{requestId:r,ipHash:s}=e,i=this.knownObjects.get(s),o=this.peers.get(t);o&&o.connected&&o.conn&&o.conn.send({type:"metadataResponse",requestId:r,ipObject:i,peerId:this.peerId,ipHash:s})}handleMetadataResponse(e){const{requestId:t,ipObject:r,ipHash:s}=e,i=this.pendingRequests.get(t);i&&(s===i.hash&&i.resolve(r),this.pendingRequests.delete(t))}handleChunkResponse(e){const{requestId:t,chunkHash:r,chunkData:s}=e,i=this.pendingRequests.get(t);i&&(i.hash===r?i.resolve(s):i.reject(new Error(`Received chunk hash ${r} does not match requested hash ${i.hash}`)),this.pendingRequests.delete(t))}async distributeCommission(e){const t=Array.from(this.activeNodes).filter(s=>s.startsWith("node-"));if(t.length===0){console.log("No active nodes to distribute commission to.");return}const r=e/t.length;console.log(`Distributing commission of ${e} to ${t.length} nodes (${r} per node)`);for(const s of t){const i=s.replace("node-",""),o=this.base64UrlToUint8Array(i),c=await this.getBalance(o)+r;await this.putBalance(o,c);const l=this.peers.get(s);l&&l.connected&&l.conn&&l.conn.send({type:"commission",amount:r,newBalance:c,peerId:this.peerId})}}async getBalance(e){if(!this.db)throw new Error("IndexedDB not initialized");const t=await this.dbGet("store","balance_"+e);return t&&t.value?parseFloat(t.value):0}async putBalance(e,t){if(!this.db)throw new Error("IndexedDB not initialized");if(typeof t!="number"||t<0)throw new Error("Invalid balance amount");await this.dbPut("store",{id:"balance_"+e,value:t.toString()}),this.activeNodes.size>0&&this.broadcast({type:"userData",peerId:this.peerId,keypair:this.keypair,balance:t,timestamp:Date.now()})}async updateBalance(){if(!this.db)throw new Error("IndexedDB not initialized");const e=await this.getBalance(this.keypair);await this.putBalance(this.keypair,e)}async queueOfflineOperation(e){if(!this.db)throw new Error("IndexedDB not initialized");this.offlineQueue.push(e),await this.dbAdd("offlineQueue",{id:Date.now().toString(),value:e}),console.log("Queued offline operation:",e)}async processOfflineQueue(){if(this.offlineQueue.length===0)return;console.log("Processing offline queue...");const e=[...this.offlineQueue];this.offlineQueue=[];const r=this.db.transaction("offlineQueue","readwrite").objectStore("offlineQueue");await new Promise(s=>r.clear().onsuccess=s);for(const s of e)try{switch(s.type){case"publishChunk":await this.publishChunk(s.chunkHash,s.chunkData,s.chunkIndex,s.totalChunks);break;case"publishIP":await this.broadcastIP(s.ipHash,s.metadata,s.chunkHashes);break;default:console.warn("Unknown offline operation type:",s.type)}}catch(i){console.error(`Failed to process offline operation ${s.type}:`,i),this.offlineQueue.push(s),await this.dbAdd("offlineQueue",{id:Date.now().toString(),value:s})}}async dbPut(e,t){if(!this.db)throw new Error("IndexedDB not initialized");return new Promise((r,s)=>{const a=this.db.transaction(e,"readwrite").objectStore(e).put(t);a.onsuccess=()=>r(),a.onerror=c=>s(new Error(`DB put failed: ${c.target.error.message}`))})}async dbAdd(e,t){if(!this.db)throw new Error("IndexedDB not initialized");return new Promise((r,s)=>{const a=this.db.transaction(e,"readwrite").objectStore(e).add(t);a.onsuccess=()=>r(),a.onerror=c=>s(new Error(`DB add failed: ${c.target.error.message}`))})}async dbGet(e,t){if(!this.db)throw new Error("IndexedDB not initialized");return new Promise((r,s)=>{const a=this.db.transaction(e,"readonly").objectStore(e).get(t);a.onsuccess=()=>r(a.result),a.onerror=c=>s(new Error(`DB get failed: ${c.target.error.message}`))})}async dbGetAll(e){if(!this.db)throw new Error("IndexedDB not initialized");return new Promise((t,r)=>{const o=this.db.transaction(e,"readonly").objectStore(e).getAll();o.onsuccess=()=>t(o.result),o.onerror=a=>r(new Error(`DB getAll failed: ${a.target.error.message}`))})}broadcast(e){this.activeNodes.forEach(t=>{if(t!==this.peerId){const r=this.peers.get(t);r&&r.connected&&r.conn&&r.conn.send(e)}})}uint8ArrayToBase64Url(e){const t=String.fromCharCode(...e);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}base64UrlToUint8Array(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");for(;t.length%4;)t+="=";const r=atob(t),s=new Uint8Array(r.length);for(let i=0;i<r.length;i++)s[i]=r.charCodeAt(i);return s}async destroy(){this.peer&&!this.peer.destroyed&&(this.peer.destroy(),console.log("PeerJS peer destroyed")),this.libp2p&&(await this.libp2p.stop(),console.log("libp2p stopped")),this.peers.clear(),this.activeNodes.clear(),this.pendingRequests.clear(),this.bootstrapNodes.clear()}}function N3(n){const e=String.fromCharCode(...n);return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}let Pe=null,Ge=null,Bv=null,N=null,Mi=!1,Mr=0,Ua=!1,Fa=!1;async function O3(){console.log("Starting Firebase initialization...");try{const n=await n4(()=>Promise.resolve().then(()=>rw),void 0);Pe=n.auth,Ge=n.db,Bv=n.storage,await G3(Pe,W3),console.log("Firebase services initialized successfully with local persistence")}catch(n){throw console.error("Failed to initialize Firebase services:",n),q("Failed to initialize Firebase. Please try again later.",!0),n}}function Lv(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)})}function Hn(){return!!(Pe!=null&&Pe.currentUser)||localStorage.getItem("role")==="node"}function q(n,e=!1){const t=document.getElementById("toast");t&&(t.textContent=n,t.className="toast",e&&t.classList.add("error-toast"),t.style.display="block",setTimeout(()=>{t.style.display="none"},3e3))}function Nv(){if(!Hn()||!N){q("Please sign in and ensure the app is initialized before publishing.",!0);return}try{document.getElementById("publishModal").classList.add("active"),console.log("Opened publish modal")}catch(n){console.error("Failed to open publish modal:",n),q("Failed to open publish modal. Please try again.",!0)}}async function Ov(n){let e=N.knownObjects.get(n).metadata;if(window.currentProduct=e.hash,!Hn()||!N){q("Please sign in and ensure the app is initialized before viewing.",!0);return}try{const t=document.getElementById("buyModal");document.getElementById("snippetTitle").value=e.content_type,document.getElementById("snippetDescription").value=e.description,document.getElementById("snippetPrice").value=e.priceUsd==0?"Free":e.priceUsd,t.classList.add("active")}catch(t){console.error("Failed to open buy/preview modal:",t),q("Failed to open buy/preview modal. Please try again.",!0)}}function rs(){var e,t;const n={publishedItemsTableBody:(e=document.getElementById("publishedItems"))==null?void 0:e.querySelector("tbody"),mySnippetsTableBody:(t=document.getElementById("mySnippets"))==null?void 0:t.querySelector("tbody"),transactionList:document.getElementById("transactionList"),userBalanceElement:document.getElementById("userBalance"),userNameElement:document.getElementById("userName"),userAvatarElement:document.querySelector(".user-avatar"),snippetsPostedElement:document.getElementById("snippetsPosted")};n.publishedItemsTableBody&&(n.publishedItemsTableBody.innerHTML=""),n.mySnippetsTableBody&&(n.mySnippetsTableBody.innerHTML=""),n.transactionList&&(n.transactionList.innerHTML="No transactions yet."),n.userBalanceElement&&(n.userBalanceElement.textContent="Balance: 0 DCT"),n.userNameElement&&(n.userNameElement.textContent="Guest User"),n.userAvatarElement&&(n.userAvatarElement.innerHTML='<i class="fas fa-user text-lg"></i>'),n.snippetsPostedElement&&(n.snippetsPostedElement.textContent="0"),Mr=0,localStorage.removeItem("userKeypair"),localStorage.removeItem("peerId"),localStorage.removeItem("dhtInitialized"),console.log("Cleared persisted state from localStorage on sign-out")}async function Js(){const n=document.getElementById("userBalance");if(n){if(!N){n.textContent="Balance: 0 DCT",Mr=0;return}try{Mr=await N.getBalance(N.keypair)||0,n.textContent=`Balance: ${Mr} DCT`}catch(e){console.error("Failed to update balance:",e),n.textContent="Balance: 0 DCT",Mr=0}}}async function Zs(){const n=document.getElementById("transactionList");if(n){if(!N){n.innerHTML="Not initialized.";return}try{const e=await N.dbGetAll("transactions");if(e.length===0){n.innerHTML="No transactions yet.";return}n.innerHTML=e.map(t=>`<p class="py-1">${t.type} - ${t.amount} DCT - ${new Date(t.timestamp).toLocaleString()}</p>`).join("")}catch(e){console.error("Failed to update transaction history:",e),n.innerHTML="Failed to load transactions."}}}async function Qo(){var e;const n=(e=document.getElementById("publishedItems"))==null?void 0:e.querySelector("tbody");if(n){n.innerHTML="";try{const t=$i(is(Ge,"snippets"));J3(t,async r=>{const s={};if(r.forEach(i=>{s[i.id]=i.data()}),N){N.knownObjects.clear();for(const[i,o]of Object.entries(s)){const a={content_type:o.title,hash:o.ipHash,description:o.description||"No description",tags:o.tags||[],isPremium:o.isPremium||!1,priceUsd:o.priceUsd||0};N.knownObjects.set(i,{metadata:a,chunks:o.chunks||[]})}N.knownObjects.forEach((i,o)=>{const a=s[o],l=(i.metadata.isPremium||!1)&&i.metadata.priceUsd||0,u=l>0?`${l} DCT`:"Free",h=document.createElement("tr");h.innerHTML=`
            <td class="py-2 px-4">${i.metadata.content_type}</td>
            <td class="py-2 px-4">${i.metadata.tags.join(", ")||"No tags"}</td>
            <td class="py-2 px-4">${a.likes}</td>
            <td class="py-2 px-4">${a.dislikes}</td>
            <td class="py-2 px-4">
            
              <button onclick="window.openBuyModal('${o}')" class="bg-purple-500 text-white rounded hover:bg-purple-600 px-3 py-1 mr-2">Get (${u})</button>
              <button onclick="window.flagSnippet('${o}')" class="bg-red-500 text-white rounded hover:bg-red-600 px-3 py-1">Flag</button>
            </td>
          `,n.appendChild(h)})}},r=>{console.error("Live feed snapshot error:",r),q("Failed to load live feed.",!0)})}catch(t){console.error("Failed to update live feed:",t),q("Failed to load live feed.",!0)}}}async function l1(){var e,t;const n=(e=document.getElementById("mySnippets"))==null?void 0:e.querySelector("tbody");if(n){n.innerHTML="";try{const r=((t=Pe.currentUser)==null?void 0:t.uid)||localStorage.getItem("nodeId");if(!r)return;const s=$i(is(Ge,"snippets"),qa("creatorId","==",r));(await Ui(s)).forEach(o=>{const a=o.data(),c=document.createElement("tr");c.innerHTML=`
        <td class="py-2 px-4">${a.title||"No title"}</td>
        <td class="py-2 px-4">${a.ipHash}</td>
        <td class="py-2 px-4">
          <button onclick="window.copyHash('${a.ipHash}')" class="bg-blue-500 text-white rounded hover:bg-blue-600 px-3 py-1">Copy Hash</button>
        </td>
      `,n.appendChild(c)})}catch(r){console.error("Failed to update my snippets:",r),q("Failed to load your snippets.",!0)}}}async function Mv(n){var t;const e=(t=document.getElementById("publishedItems"))==null?void 0:t.querySelector("tbody");if(e){e.innerHTML="";try{const r=n.split(",").map(o=>o.trim().toLowerCase()).filter(o=>o);let s;r.length===0?s=await Ui($i(is(Ge,"snippets"),qa("reviewStatus","==","active"))):s=await Ui($i(is(Ge,"snippets"),qa("reviewStatus","==","active")));const i={};if(s.forEach(o=>{i[o.id]=o.data()}),N){N.knownObjects.clear();for(const[o,a]of Object.entries(i)){const c={content_type:a.title,description:a.description||"No description",tags:a.tags||[],isPremium:a.isPremium||!1,priceUsd:a.priceUsd||0};N.knownObjects.set(o,{metadata:c,chunks:a.chunks||[]})}N.knownObjects.forEach((o,a)=>{const c=i[a]||{likes:0,dislikes:0},l=(o.metadata.tags||[]).map(p=>p.toLowerCase());if(r.length>0&&!r.some(p=>l.includes(p)))return;const h=(o.metadata.isPremium||!1)&&o.metadata.priceUsd||0,f=h>0?`${h} DCT`:"Free",g=document.createElement("tr");g.innerHTML=`
          <td class="py-2 px-4">${o.metadata.content_type}</td>
          <td class="py-2 px-4">${o.metadata.description||"No description"}</td>
          <td class="py-2 px-4">${o.metadata.tags.join(", ")||"No tags"}</td>
          <td class="py-2 px-4">${c.likes}</td>
          <td class="py-2 px-4">${c.dislikes}</td>
          <td class="py-2 px-4">
            <button onclick="window.openBuyModal(${a})" class="bg-purple-500 text-white rounded hover:bg-purple-600 px-3 py-1 mr-2">Get (${f})</button>
            <button onclick="window.flagSnippet('${a}')" class="bg-red-500 text-white rounded hover:bg-red-600 px-3 py-1">Flag</button>
          </td>
        `,e.appendChild(g)})}}catch(r){console.error("Failed to search snippets:",r),q("Search failed.",!0)}}}async function Xs(){var e;const n=((e=Pe.currentUser)==null?void 0:e.uid)||localStorage.getItem("nodeId");if(n)try{const t=At(Ge,"users",n),r=N?await N.getBalance(N.keypair):0;await Nn(t,{balance:r,lastUpdated:Date.now()},{merge:!0}),console.log("User data uploaded to Firebase")}catch(t){console.error("Failed to upload user data to Firebase:",t)}}function Uv(){const n=document.getElementById("transactionHistory");n&&(n.style.display=n.style.display==="none"?"block":"none")}function Fv(n,e,t){const r=document.getElementById("snippetDisplay");if(!r)return;r.innerHTML="";const s=document.createElement("div");s.className="p-4 bg-gray-800 rounded-lg mt-4";const i=document.createElement("h3");if(i.className="text-lg font-semibold mb-2",i.textContent=t||"Snippet Content",s.appendChild(i),e.startsWith("text")){const o=new TextDecoder().decode(n),a=document.createElement("pre");a.className="text-sm text-gray-300 whitespace-pre-wrap",a.textContent=o,s.appendChild(a)}else if(e.startsWith("image")){const o=new Blob([n],{type:e}),a=URL.createObjectURL(o),c=document.createElement("img");c.src=a,c.className="max-w-full h-auto rounded",c.onload=()=>URL.revokeObjectURL(a),s.appendChild(c)}else{const o=new Blob([n],{type:e}),a=URL.createObjectURL(o),c=document.createElement("a");c.href=a,c.download=t||"downloaded_file",c.className="text-blue-400 hover:underline",c.textContent="Download File",c.onclick=()=>setTimeout(()=>URL.revokeObjectURL(a),1e3),s.appendChild(c)}r.appendChild(s)}async function u1(){return new Promise((e,t)=>{console.log("Starting IndexedDB initialization...");const r=indexedDB.open("dcrypt_db");r.onsuccess=()=>{const s=r.result,i=s.version;console.log("Current IndexedDB version:",i),s.close();const o=indexedDB.open("dcrypt_db",Math.max(i,5));o.onupgradeneeded=a=>{const c=o.result;console.log("Upgrading database to version",5),c.objectStoreNames.contains("store")||(c.createObjectStore("store",{keyPath:"id"}),console.log("Created object store: store")),c.objectStoreNames.contains("transactions")||(c.createObjectStore("transactions",{keyPath:"id",autoIncrement:!0}),console.log("Created object store: transactions")),c.objectStoreNames.contains("offlineQueue")||(c.createObjectStore("offlineQueue",{keyPath:"id",autoIncrement:!0}),console.log("Created object store: offlineQueue")),c.objectStoreNames.contains("chunkCache")||(c.createObjectStore("chunkCache",{keyPath:"id"}),console.log("Created object store: chunkCache")),console.log("Database upgrade completed")},o.onsuccess=()=>{const a=o.result;console.log("IndexedDB opened successfully at version",a.version),e(a)},o.onerror=()=>{console.error("Failed to open IndexedDB:",o.error),t(new Error(`Failed to open IndexedDB: ${o.error.message}`))}},r.onerror=()=>{console.error("Failed to check IndexedDB version:",r.error),t(new Error(`Failed to check IndexedDB version: ${r.error.message}`))}})}async function M3(n){return new Promise((e,t)=>{try{const i=n.transaction("store","readonly").objectStore("store").get("dcrypt_identity");i.onsuccess=()=>{var a;const o=(a=i.result)==null?void 0:a.value;o&&typeof o=="string"?(console.log("Loaded keypair from IndexedDB:",o),e(o)):(console.log("No valid keypair found in IndexedDB."),e(null))},i.onerror=()=>{console.error("Failed to load keypair from IndexedDB:",i.error),t(new Error("Failed to load keypair from IndexedDB"))}}catch(r){console.error('Error accessing "store" object store:',r),t(r)}})}async function ad(n,e){return new Promise((t,r)=>{try{console.log("Storing keypair in IndexedDB:",e);const o=n.transaction("store","readwrite").objectStore("store").put({id:"dcrypt_identity",value:e});o.onsuccess=()=>{console.log("Successfully stored keypair in IndexedDB"),t()},o.onerror=()=>{console.error("Failed to store keypair in IndexedDB:",o.error),r(new Error("Failed to store keypair in IndexedDB"))}}catch(s){console.error('Error storing keypair in "store" object store:',s),r(s)}})}async function cd(n,e){if(Fa){console.log("Initialization already in progress, skipping...");return}Fa=!0,console.log("Initializing app with userId:",n);try{e||(e=await u1());let t=await M3(e);if(t instanceof Uint8Array&&(t=N3(t)),!t&&n)console.log("No keypair found, using userId as keypair:",n),await ad(e,n),t=n;else if(t)t.length>40&&(console.warn("Existing keypair is unusually large:",t.length,"characters. Overwriting with userId."),t=n,await ad(e,n));else throw new Error("No keypair available and no userId provided to create one");Mi=await $v(n),console.log(`User is ${Mi?"":"not "}a node.`),N=new L3(t,Mi),window.dht=N,await N.initDB(),console.log("DHT database initialized.");let r=3;for(;r>0;)try{await N.initSwarm();break}catch(s){if(s.message.includes("No bootstrap node available")&&r>1)console.warn("No nodes available, retrying...",r),await new Promise(i=>setTimeout(i,5e3)),r--;else throw s}console.log("DHT swarm initialized."),await N.syncUserData(),console.log("User data synced."),await Promise.all([Qo(),l1(),Js(),Zs()]),console.log("UI updated."),await F3(n)}catch(t){console.error("Error initializing application:",t),t.message.includes("ID conflict")?q("Failed to connect to the network due to an ID conflict. Please try signing out and signing in again.",!0):t.message.includes("No bootstrap node available")?q("No nodes available in the network. Please try again later.",!0):q(`Initialization failed: ${t.message}`,!0),N&&N.destroy(),N=null,window.dht=null,Mr=0,rs()}finally{Fa=!1}Xs()}async function $v(n){try{const e=At(Ge,"nodes",n);return(await Gc(e)).exists()}catch(e){return console.error("Failed to check node status:",e),!1}}async function Vv(n,e=800,t=800,r=.7){return new Promise((s,i)=>{const o=new Image;o.src=URL.createObjectURL(n),o.onload=()=>{const a=document.createElement("canvas");let c=o.width,l=o.height;c>l?c>e&&(l*=e/c,c=e):l>t&&(c*=t/l,l=t),a.width=c,a.height=l,a.getContext("2d").drawImage(o,0,0,c,l),a.toBlob(h=>s(h),n.type,r)},o.onerror=i})}async function Hv(n,e){if(!e)return console.log("No file provided for upload"),null;if(!Pe.currentUser||Pe.currentUser.uid!==n)return console.error("User not authenticated or ID mismatch"),q("Please sign in to upload a profile image.",!0),null;try{const t=await Vv(e),r=new FileReader,i=await new Promise((a,c)=>{r.onload=()=>a(r.result.split(",")[1]),r.onerror=c,r.readAsDataURL(t)}),o=At(Ge,"users",n);return await Nn(o,{profileImage:i,updatedAt:new Date().toISOString()},{merge:!0}),console.log("Compressed profile image stored in Firestore for user:",n),i}catch(t){return console.error("Failed to store profile image in Firestore:",t),q(`Failed to store profile image: ${t.message}`,!0),null}}async function qv(){if(console.log("handleSignup function called"),Ua){console.log("Signup already in progress, ignoring additional clicks");return}Ua=!0;const n=document.getElementById("signupButton");n&&(n.disabled=!0,n.textContent="Signing Up...",console.log("Signup button disabled and text updated")),localStorage.setItem("pendingRole","user");try{const e=new Hd,t=await qd(Pe,e);console.log("Sign-up successful, user:",t.user);const r=document.getElementById("usernameInput").value,i=document.getElementById("profileImageInput").files[0];console.log(i);const o=i?await Hv(t.user.uid,i):null,a=At(Ge,"users",t.user.uid);await Nn(a,{username:r||t.user.displayName||"Anonymous User",profileImageUrl:o||null,createdAt:Date.now(),snippetsPosted:0},{merge:!0}),console.log("User profile saved to Firestore"),q("Sign-up successful! Redirecting to dashboard..."),window.location.href="/datasharingApp/"}catch(e){console.error("Signup failed:",e),q(`Sign-up failed: ${e.message}`,!0),Ua=!1,n&&(n.disabled=!1,n.textContent="Sign Up with Google")}finally{localStorage.removeItem("pendingRole")}}async function zv(n){if(!Hn()){q("Please sign in to deposit.");return}try{if(!N)throw new Error("DHT not initialized");if(!n||n<=0)throw new Error("Invalid deposit amount");const t=await N.getBalance(N.keypair)+n;await N.putBalance(N.keypair,t),await N.dbAdd("transactions",{type:"deposit",amount:n,timestamp:Date.now()}),q(`Deposited ${n} DCT successfully!`),await Promise.all([Zs(),Js(),Xs()])}catch(e){console.error("deposit failed:",e),q(`Deposit failed: ${e.message}`,!0)}}async function Kv(n){if(!Hn()){q("Please sign in to withdraw.");return}try{if(!N)throw new Error("DHT not initialized");if(!n||n<=0)throw new Error("Invalid withdrawal amount");const e=await N.getBalance(N.keypair);if(e<n)throw new Error("Insufficient balance");await N.putBalance(N.keypair,e-n),await N.dbAdd("transactions",{type:"withdraw",amount:n,timestamp:Date.now()}),q(`Withdrew ${n} DCT successfully!`),await Promise.all([Zs(),Js(),Xs()])}catch(e){console.error("withdraw failed:",e),q(`Withdrawal failed: ${e.message}`,!0)}}async function jv(){console.log("signIn function called");try{Pe||(console.error("Firebase Auth is not initialized, initializing now..."),await O3());const n=new Hd,e=await qd(Pe,n);console.log("Sign-in successful, user:",e.user)}catch(n){console.error("Login failed:",n),q(`Login failed: ${n.message}`,!0)}}async function ld(){console.log("signOutUser function called");try{localStorage.getItem("role")==="node"?(localStorage.removeItem("nodeId"),localStorage.removeItem("role"),q("Node signed out successfully!")):(await Q3(Pe),q("Signed out successfully!")),N&&(N.destroy(),N=null,window.dht=null);const t=(await u1()).transaction("store","readwrite").objectStore("store");await new Promise((r,s)=>{const i=t.delete("dcrypt_identity");i.onsuccess=()=>{console.log("Successfully deleted keypair from IndexedDB"),r()},i.onerror=()=>{console.error("Failed to delete keypair from IndexedDB:",i.error),s(new Error("Failed to delete keypair from IndexedDB"))}}),Mr=0,rs()}catch(n){console.error("Sign-out failed:",n),q(`Sign-out failed: ${n.message}`,!0)}}async function Gv(n,e,t,r,s){var i,o;if(!Hn()){q("Please sign in to publish.");return}try{if(!N)throw new Error("DHT not initialized");if(!n)throw new Error("Title is required");let a=r||"",c="text/plain";if((i=s==null?void 0:s.files)!=null&&i.length){const _=s.files[0];c=_.type||"application/octet-stream",a=await new Promise((w,b)=>{const v=new FileReader;v.onload=x=>w(new Uint8Array(x.target.result)),v.onerror=()=>b(new Error("Failed to read file")),v.readAsArrayBuffer(_)})}else a=new TextEncoder().encode(a);const l=document.getElementById("modalPremium").checked,u=document.getElementById("modalPriceInput"),h=l&&u&&parseFloat(u.value)||0,f={content_type:c,title:n,description:e||"",tags:t?t.split(",").map(_=>_.trim()).filter(_=>_.length>0):[],isPremium:l,priceUsd:h},g=await N.publishIP(f,a,c),p=((o=Pe.currentUser)==null?void 0:o.uid)||localStorage.getItem("nodeId"),m=At(Ge,"snippets",g),y={ipHash:g,title:n,description:e||"",tags:f.tags,isPremium:l,priceUsd:h,flagCount:0,likes:0,dislikes:0,createdAt:Date.now(),creatorId:p};console.log("Saving snippet to Firestore: ",y),await Nn(m,y,{merge:!0});const E=At(Ge,"users",p);await os(E,{snippetsPosted:Fi(1)}),q("Snippet published successfully!"),window.closePublishModal(),await Promise.all([Qo(),l1(),Zs(),Js(),Xs(),F3(p)])}catch(a){throw console.error("publishSnippet failed:",a),q(`Publish failed: ${a.message}`,!0),a}}async function U3(n){if(!Hn())return q("Please sign in to buy."),null;try{if(!N)throw new Error("DHT not initialized");if(!n)throw new Error("Hash is required");let e=await N.getIPmetadata(n);console.log("IP Object:",e);const s=(e.metadata.isPremium||!1)&&e.metadata.priceUsd||0;if(s>0){const c=await N.getBalance(N.keypair);if(c<s)throw new Error("Insufficient balance");const l=s*.05;await N.distributeCommission(l),await N.putBalance(N.keypair,c-s),await N.dbAdd("transactions",{type:"buy",amount:s,timestamp:Date.now()})}else console.log("This snippet is free!"),await N.dbAdd("transactions",{type:"buy",amount:0,timestamp:Date.now()});const{data:i,fileType:o}=await N.requestData(e);q("Snippet retrieved successfully!"),await Promise.all([Zs(),Js(),Xs(),l1()]);const a=prompt('Do you like this snippet? Type "like" or "dislike":');if(a!==null){const c=a.trim().toLowerCase();c==="like"||c==="dislike"?(await Qv(n,c),q(`You ${c}d this snippet!`),await Qo()):q('Invalid input. Please type "like" or "dislike".',!0)}return Fv(i,o,e.metadata.title||e.metadata.content_type),{data:i,fileType:o}}catch(e){return console.error("buySnippet failed:",e),q(`Purchase failed: ${e.message}`,!0),null}}async function Wv(n){var r;const e=n||((r=document.getElementById("buyHashInput"))==null?void 0:r.value.trim());if(!e){q("Please enter a valid hash.",!0);return}await U3(e)&&q("Snippet purchased and displayed below!")}async function Qv(n,e){var r;const t=((r=Pe.currentUser)==null?void 0:r.uid)||localStorage.getItem("nodeId");if(t)try{const s=At(Ge,"snippets",n,"feedback",t);await Nn(s,{action:e,timestamp:Date.now()});const i=At(Ge,"snippets",n);e==="like"?await os(i,{likes:Fi(1)}):e==="dislike"&&await os(i,{dislikes:Fi(1)})}catch(s){console.error("Failed to submit feedback:",s),q(`Failed to submit feedback: ${s.message}`,!0)}}async function Yv(n){var t;if(!(((t=Pe.currentUser)==null?void 0:t.uid)||localStorage.getItem("nodeId"))){q("Please sign in to flag content.");return}try{const r=At(Ge,"snippets",n);await os(r,{flagCount:Fi(1)}),((await Gc(r)).data().flagCount||0)>=3?(await os(r,{reviewStatus:"under_review"}),q("Snippet has been flagged and is under review."),await Qo()):q("Snippet flagged. It will be reviewed if flagged by more users.")}catch(r){console.error("Failed to flag snippet:",r),q(`Failed to flag snippet: ${r.message}`,!0)}}async function Jv(){const n=Lv();console.log("Generated nodeId:",n),localStorage.setItem("nodeId",n),localStorage.setItem("role","node");const e=At(Ge,"nodes",n);if(await Nn(e,{role:"node",createdAt:Date.now(),status:"active"},{merge:!0}),console.log("Node registered in Firestore:",n),!window.location.pathname.includes("node-instructions.html")){console.log("Redirecting to node-instructions.html for node role"),window.location.href="/datasharingApp/node-instructions.html";return}}async function Zv(){try{const n=localStorage.getItem("nodeId"),e=localStorage.getItem("role");if(localStorage.removeItem("nodeId"),localStorage.removeItem("role"),sessionStorage.setItem("nodeId",n),sessionStorage.setItem("role",e),console.log("Moved to session storage"),e!=="node"||!n){q("You must be signed in as a node to view this page."),window.location.href="/datasharingApp/signup.html";return}async function t(a){const l=new TextEncoder().encode(a),u=await crypto.subtle.digest("SHA-256",l);return Array.from(new Uint8Array(u)).map(f=>f.toString(16).padStart(2,"0")).join("").substring(0,40)}const r=N3(new TextEncoder().encode(await t(n)));N=new L3(r,!0),window.dht=N,await N.initDB(),await N.initSwarm(),await N.syncUserData();const i=(await N.dbGetAll("transactions")).filter(a=>a.type==="commission").reduce((a,c)=>a+(c.amount||0),0),o=document.getElementById("nodeEarnings");o&&(o.textContent=`Total Earnings: ${i.toFixed(2)} DCT`)}catch(n){console.error("Error initializing node instructions:",n),q(`Initialization failed: ${n.message}`,!0)}}async function F3(n){if(n)try{const e=At(Ge,"users",n),t=await Gc(e);if(t.exists()){const r=t.data(),s=document.getElementById("userName"),i=document.querySelector(".user-avatar"),o=document.getElementById("snippetsPosted");s&&(s.textContent=r.username||"Anonymous User"),i&&(r.profileImageUrl?i.innerHTML=`<img src="${r.profileImageUrl}" alt="Profile Image" class="w-12 h-12 rounded-full object-cover">`:i.innerHTML='<i class="fas fa-user text-lg"></i>'),o&&(o.textContent=r.snippetsPosted||0)}}catch(e){console.error("Failed to fetch user profile:",e),q("Failed to load user profile.",!0)}}async function Xv(n){try{await navigator.clipboard.writeText(n),q("Hash copied to clipboard!")}catch(e){console.error("Failed to copy hash:",e),q("Failed to copy hash.",!0)}}document.addEventListener("DOMContentLoaded",async()=>{var r,s,i;if(console.log("DOMContentLoaded event fired"),console.log("Current pathname:",window.location.pathname),window.location.pathname.includes("signup")){const o=document.getElementById("userSignupForm");o&&o.addEventListener("submit",async a=>{a.preventDefault(),await window.handleSignup()})}window.location.pathname.includes("node")&&Zv();try{await O3()}catch(o){console.error("Firebase initialization failed, aborting setup:",o),q("Firebase initialization failed. Please check your configuration.",!0);return}const n=localStorage.getItem("role"),e=localStorage.getItem("nodeId"),t=!(window.location.pathname.includes("node")||window.location.pathname.includes("signup.html")||window.location.pathname.includes("publish"));if(t&&n==="node"&&e&&(console.log("Node detected on index.html, redirecting to node-instructions.html"),window.location.href="/datasharingApp/node-instructions.html"),t||window.location.pathname.includes("publish")){const o=await u1(),a=await M3(o);try{await Promise.all([new Promise(c=>{f1(Pe,async l=>{if(console.log("onAuthStateChanged triggered"),l)console.log("User is signed in:",l.uid),await cd(l.uid,o);else{console.log("No user is signed in. Checking IndexedDB for keypair...");try{a?(console.log("Found keypair in IndexedDB, initializing app..."),await cd(a,o)):(console.log("No keypair found in IndexedDB."),t&&rs())}catch(u){console.error("Failed to initialize IndexedDB or load keypair:",u),t&&rs()}}c()},l=>{console.error("onAuthStateChanged error:",l),q("Failed to monitor authentication state.",!0),c()})})])}catch(c){console.error("Initialization error:",c),q("An error occurred during initialization.",!0)}}if(t){const o={signupButton:document.getElementById("signupButton"),loginButton:document.getElementById("loginButton"),logoutButton:document.getElementById("logoutButton"),userBalanceElement:document.getElementById("userBalance"),searchButton:document.getElementById("searchButton"),depositButton:document.getElementById("depositButton"),withdrawButton:document.getElementById("withdrawButton"),toggleHistoryButton:document.getElementById("toggleHistoryButton"),transactionHistory:document.getElementById("transactionHistory"),publishedItemsTableBody:(r=document.getElementById("publishedItems"))==null?void 0:r.querySelector("tbody"),buyHashButton:document.getElementById("buyHashButton")};console.log("On index.html, setting up UI and event listeners"),n==="node"&&e&&(Mi=!0,console.log("Node detected, but should have been redirected already.")),(s=o.loginButton)==null||s.addEventListener("click",c=>{c.preventDefault(),console.log("Login button clicked"),jv()}),(i=o.logoutButton)==null||i.addEventListener("click",c=>{c.preventDefault(),console.log("Logout button clicked"),ld()}),f1(Pe,c=>{var l,u,h,f,g,p;c?((l=o.signupButton)==null||l.classList.add("hidden"),(u=o.loginButton)==null||u.classList.add("hidden"),(h=o.logoutButton)==null||h.classList.remove("hidden"),o.searchButton.disabled=!1,o.depositButton.disabled=!1,o.withdrawButton.disabled=!1,o.toggleHistoryButton.disabled=!1,o.buyHashButton.disabled=!1):((f=o.signupButton)==null||f.classList.remove("hidden"),(g=o.loginButton)==null||g.classList.remove("hidden"),(p=o.logoutButton)==null||p.classList.add("hidden"),o.searchButton.disabled=!0,o.depositButton.disabled=!0,o.withdrawButton.disabled=!0,o.toggleHistoryButton.disabled=!0,o.buyHashButton.disabled=!0,rs())});const a=document.getElementById("publishForm");a&&a.addEventListener("submit",async c=>{c.preventDefault();const l=document.getElementById("modalTitleInput").value,u=document.getElementById("modalDescriptionInput").value,h=document.getElementById("modalTagsInput").value,f=document.getElementById("modalContentInput").value,g=document.getElementById("modalFileInput");await window.publishSnippet(l,u,h,f,g)})}else console.log("Not on index.html, skipping index.html-specific setup");window.logout=ld,window.publishSnippet=Gv,window.buySnippet=U3,window.buySnippetByHash=Wv,window.toggleTransactionHistory=Uv,window.flagSnippet=Yv,window.handleSignup=qv,window.becomeNode=Jv,window.deposit=zv,window.withdraw=Kv,window.redirectToPublish=Nv,window.searchSnippets=Mv,window.copyHash=Xv,window.openBuyModal=Ov});
