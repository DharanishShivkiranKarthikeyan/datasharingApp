import{initializeApp as ce}from"https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";import{getAuth as de,GoogleAuthProvider as G,signInWithPopup as le,onAuthStateChanged as ue,signInWithRedirect as ee,signOut as he}from"https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";import{getFirestore as pe,getDocs as F,collection as H,doc as B,setDoc as $,getDoc as te,updateDoc as W,increment as fe}from"https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";import"https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/+esm";import ne from"https://cdn.jsdelivr.net/npm/peerjs@1.5.4/+esm";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}})();const ge={apiKey:"AIzaSyBrdrwvY-lPObZgortEgw7YWycUOGsBlyM",authDomain:"dcrypt-edb9c.firebaseapp.com",projectId:"dcrypt-edb9c",storageBucket:"dcrypt-edb9c.firebasestorage.app",messagingSenderId:"952133736604",appId:"1:952133736604:web:32d799360f200bce84f559",measurementId:"G-7KCDLQ6JNH"},oe=ce(ge),S=de(oe),I=pe(oe);var X;const C=(X=globalThis.crypto)==null?void 0:X.subtle;if(!C)throw new Error("Web Crypto API is not available in this environment");function me(){const o=new Uint8Array(12);for(let e=0;e<12;e++)o[e]=Math.floor(Math.random()*256);return o}function ye(o,e,t,s,n,r,c){return{content:new Uint8Array(o),content_type:e,tags:t||[],is_premium:s,price_usd:n,creator_id:new Uint8Array(r),file_type:c}}function we(o){return o.content}async function se(o){const e=await C.digest("SHA-256",o);return new Uint8Array(e)}async function be(o,e,t){const s=o.content,n=Math.ceil(s.length/t),r=[],c=await C.importKey("raw",new Uint8Array(e.slice(0,32)),{name:"AES-GCM"},!1,["encrypt"]);for(let a=0;a<t;a++){const i=a*n,d=Math.min(i+n,s.length),u=s.slice(i,d),p=me(),b=await C.encrypt({name:"AES-GCM",iv:p},c,u),m={data:new Uint8Array(b),nonce:p,index:a,file_type:o.file_type};r.push(m)}return r}function xe(o){const e=new Uint8Array(new Int32Array([o.index]).buffer),t=new Uint8Array([...o.data,...o.nonce,...e]);return se(t)}function Q(o){return o.index}async function Ie(o,e){const t=await C.importKey("raw",new Uint8Array(e.slice(0,32)),{name:"AES-GCM"},!1,["decrypt"]),s=await C.decrypt({name:"AES-GCM",iv:o.nonce},t,o.data);return new Uint8Array(s)}function ke(o){return o.file_type}class re{constructor(e,t=!1){this.peers=new Map,this.channels=new Map,this.knownObjects=new Map,this.chunkToPeerMap=new Map,this.pendingRequests=new Map,this.db=null,this.keypair=e,this.activeNodes=new Set,this.nodes=new Set,this.offlineQueue=[],this.isNode=t,this.peerId=null,this.peer=null,this.connectionAttempts=new Map,this.maxConnectionAttempts=3,this.connectionRetryDelay=5e3,this.averageLatency=0,this.initializeKnownNodes()}async initializeKnownNodes(){const e=async()=>{try{const t=await F(H(I,"nodes"));this.nodes.clear(),t.empty?console.warn("No nodes found in Firestore. Using empty node list."):t.forEach(s=>{const n=`node-${s.id}`;this.nodes.add(n)}),console.log("Fetched nodes:",Array.from(this.nodes))}catch(t){console.error("Failed to fetch nodes from Firestore:",t),this.nodes.clear(),console.warn("No nodes available. Peer discovery will be limited to regular peers.")}};await e(),setInterval(e,5*60*1e3)}async measureLatency(){const e=[],t=Array.from(this.activeNodes).slice(0,5);for(const s of t){const n=this.peers.get(s);if(n&&n.connected&&n.conn){const r=Date.now();await new Promise(a=>{const i=`${s}-ping-${Date.now()}`;n.conn.send({type:"ping",requestId:i}),this.pendingRequests.set(i,{resolve:a}),setTimeout(()=>{this.pendingRequests.has(i)&&(this.pendingRequests.delete(i),a())},2e3)});const c=Date.now()-r;e.push(c)}}this.averageLatency=e.length>0?e.reduce((s,n)=>s+n,0)/e.length:0,console.log(`Average latency: ${this.averageLatency} ms`)}async initDB(){return new Promise((e,t)=>{const s=indexedDB.open("dcrypt_db",3);s.onupgradeneeded=()=>{const n=s.result;n.objectStoreNames.contains("store")||n.createObjectStore("store",{keyPath:"id"}),n.objectStoreNames.contains("transactions")||n.createObjectStore("transactions",{keyPath:"id",autoIncrement:!0}),n.objectStoreNames.contains("offlineQueue")||n.createObjectStore("offlineQueue",{keyPath:"id",autoIncrement:!0}),n.objectStoreNames.contains("chunkCache")||n.createObjectStore("chunkCache",{keyPath:"id"})},s.onsuccess=()=>{this.db=s.result,this.loadIdentity(),this.loadOfflineQueue(),this.loadTransactions(),console.log("IndexedDB initialized successfully"),e()},s.onerror=n=>{console.error("Failed to initialize IndexedDB:",n.target.error),t(new Error(`Failed to initialize IndexedDB: ${n.target.error.message}`))}})}async syncUserData(){if(!this.db)throw new Error("IndexedDB not initialized");try{await this.dbPut("store",{id:"dcrypt_identity",value:this.uint8ArrayToHex(this.keypair)}),await this.updateBalance(),this.activeNodes.size>0&&await this.processOfflineQueue();const e={type:"userData",peerId:this.peerId,keypair:this.uint8ArrayToHex(this.keypair),balance:await this.getBalance(this.keypair),timestamp:Date.now()};this.broadcast(e),console.log("User data synced successfully")}catch(e){throw console.error("Sync failed:",e),e}}async saveUserData(){if(!this.db)throw new Error("IndexedDB not initialized");try{await this.dbPut("store",{id:"dcrypt_identity",value:this.uint8ArrayToHex(this.keypair)}),await this.updateBalance(),console.log("User data saved to IndexedDB")}catch(e){throw console.error("Save failed:",e),e}}async initSwarm(){try{const e=new TextDecoder().decode(this.keypair);return this.peerId=this.isNode?`node-${e}`:e,console.log("Initializing PeerJS with Peer ID:",this.peerId),this.peer=new ne(this.peerId,{host:"0.peerjs.com",port:443,path:"/",secure:!0,debug:2}),new Promise((t,s)=>{this.peer.on("open",n=>{console.log(`PeerJS connection opened with ID: ${n}`),this.activeNodes.add(this.peerId),this.peer.on("connection",r=>{this.handleConnection(r)}),this.peer.on("error",r=>{var c;if(console.error("PeerJS error:",r.type,r.message),r.type==="peer-unavailable"){const a=(c=r.message.match(/Peer (.+) is unavailable/))==null?void 0:c[1];a&&this.handlePeerDisconnect(a)}}),this.peer.on("disconnected",()=>{console.log("PeerJS disconnected. Attempting to reconnect..."),this.peer.reconnect()}),setInterval(()=>this.discoverPeers(),5e3),setInterval(()=>this.measureLatency(),6e4),t()}),this.peer.on("error",n=>{console.error("Failed to initialize PeerJS:",n),s(n)})})}catch(e){throw console.error("initSwarm failed:",e),e}}discoverPeers(){console.log("Discovering peers..."),console.log("My peer ID:",this.peerId),console.log("Known peer IDs:",Array.from(this.nodes));const e=[...Array.from(this.nodes)].filter(t=>t!==this.peerId);if(e.length===0){console.warn("No known peers to connect to. Waiting for nodes to be discovered.");return}e.forEach(t=>{this.peers.has(t)||(this.peers.set(t,{connected:!1,conn:null}),console.log("Discovered peer:",t),this.connectToPeer(t))}),this.peers.forEach((t,s)=>{!t.connected&&this.connectionAttempts.get(s)>=this.maxConnectionAttempts&&(console.log(`Removing unreachable peer: ${s}`),this.peers.delete(s),this.connectionAttempts.delete(s),this.activeNodes.delete(s))})}connectToPeer(e){var n;if((n=this.peers.get(e))!=null&&n.connected)return;const t=this.connectionAttempts.get(e)||0;if(t>=this.maxConnectionAttempts)return;console.log(`Attempting to connect to peer: ${e} (Attempt ${t+1}/${this.maxConnectionAttempts})`);const s=this.peer.connect(e,{reliable:!0});s.on("open",()=>{console.log(`Connected to peer: ${e}`),this.peers.set(e,{connected:!0,conn:s}),this.activeNodes.add(e),this.connectionAttempts.delete(e),s.send({type:"handshake",peerId:this.peerId})}),s.on("data",r=>{this.handlePeerData(r,e)}),s.on("close",()=>{console.log(`Connection closed with peer: ${e}`),this.handlePeerDisconnect(e)}),s.on("error",r=>{console.warn(`Connection error with peer ${e}: ${r.message}`),this.handlePeerDisconnect(e)}),this.connectionAttempts.set(e,t+1)}handleConnection(e){const t=e.peer;console.log(`Incoming connection from peer: ${t}`),this.peers.set(t,{connected:!0,conn:e}),this.activeNodes.add(t),e.on("data",s=>{this.handlePeerData(s,t)}),e.on("close",()=>{console.log(`Connection closed with peer: ${t}`),this.handlePeerDisconnect(t)}),e.on("error",s=>{console.error(`Connection error with peer ${t}:`,s),this.handlePeerDisconnect(t)})}handlePeerDisconnect(e){const t=this.peers.get(e);t&&(t.connected=!1,t.conn=null,this.activeNodes.delete(e),console.log(`Peer disconnected: ${e}. Will attempt to reconnect on next discovery.`))}handlePeerData(e,t){switch(console.log(`Received data from peer ${t}:`,e),e.type){case"handshake":console.log(`Handshake received from peer: ${t}`),this.activeNodes.add(t);break;case"chunk":this.chunkToPeerMap.set(e.chunkHash,new Set([...this.chunkToPeerMap.get(e.chunkHash)||[],t])),console.log(`Updated chunkToPeerMap for chunk ${e.chunkHash} with peer ${t}`);break;case"ip":this.knownObjects.set(e.ipHash,{metadata:e.metadata,chunks:e.chunkHashes}),this.dbPut("store",{id:e.ipHash,value:JSON.stringify({metadata:e.metadata,chunks:e.chunkHashes})}),console.log(`Received IP ${e.ipHash} from peer ${t}`);break;case"chunkRequest":this.handleChunkRequest(e,t);break;case"chunkResponse":this.handleChunkResponse(e);break;case"userData":console.log(`Received user data from peer ${t}:`,e);break;case"storeChunk":this.storeChunkFromPeer(e.chunkHash,e.chunkData,t);break;case"ping":const s=this.peers.get(t);s&&s.connected&&s.conn&&s.conn.send({type:"pong",requestId:e.requestId});break;case"pong":const n=this.pendingRequests.get(e.requestId);n&&(n.resolve(),this.pendingRequests.delete(e.requestId));break;case"commission":console.log(`Received commission of ${e.amount}. New balance: ${e.newBalance}`);break;default:console.warn(`Unknown data type received from peer ${t}:`,e.type)}}async storeChunkFromPeer(e,t,s){try{await this.dbPut("chunkCache",{id:e,value:t});let n=this.chunkToPeerMap.get(e)||new Set;n.add(this.peerId),this.chunkToPeerMap.set(e,n),console.log(`Stored chunk ${e} from peer ${s}`)}catch(n){console.error(`Failed to store chunk ${e} from peer ${s}:`,n)}}async publishChunk(e,t,s,n){if(!this.db)throw new Error("IndexedDB not initialized");try{if(console.log("publishChunk: chunkHash=",e,"chunkData=",t),!e||typeof e!="string"||e.trim()==="")throw new Error("Invalid chunk hash");await this.dbPut("chunkCache",{id:e,value:t});let r=this.chunkToPeerMap.get(e)||new Set;if(r.add(this.peerId),this.chunkToPeerMap.set(e,r),this.activeNodes.size>0){const c=Array.from(this.activeNodes).filter(i=>i.startsWith("node-"));if(c.length>0){const i=s%c.length,d=c[i],u=this.peers.get(d);u&&u.connected&&u.conn&&(u.conn.send({type:"storeChunk",chunkHash:e,chunkData:t,peerId:this.peerId}),r.add(d),this.chunkToPeerMap.set(e,r),console.log(`Sent chunk ${e} to node ${d}`))}const a=Array.from(this.activeNodes).filter(i=>!i.startsWith("node-")&&i!==this.peerId);if(a.length>0){const i=a[Math.floor(Math.random()*a.length)],d=this.peers.get(i);d&&d.connected&&d.conn&&(d.conn.send({type:"storeChunk",chunkHash:e,chunkData:t,peerId:this.peerId}),r.add(i),this.chunkToPeerMap.set(e,r),console.log(`Sent chunk ${e} to random peer ${i}`))}}else await this.queueOfflineOperation({type:"publishChunk",chunkHash:e,chunkData:t,chunkIndex:s,totalChunks:n});this.broadcastChunk(e)}catch(r){throw console.error("publishChunk failed:",r),r}}broadcastChunk(e){const t={type:"chunk",chunkHash:e,peerId:this.peerId};this.broadcast(t),console.log(`Broadcasted chunk ${e} to ${this.activeNodes.size} peers`)}async publishIP(e,t,s){if(!this.db)throw new Error("IndexedDB not initialized");if(!this.keypair)throw new Error("Keypair not initialized");try{const n=Array.isArray(e.tags)?e.tags.map(w=>typeof w!="string"?(console.warn(`Invalid tag: ${w}, converting to string`),String(w)):w).filter(w=>w.trim()!==""):[];console.log("Processed tags:",n);const r=!!e.isPremium,c=r?e.priceUsd||30:0,a=new Uint8Array(t),i=e.content_type||"",d=this.keypair instanceof Uint8Array?this.keypair:new Uint8Array(this.keypair),p=ye(a,i,n,r,c,d,s||"text/plain"),b=we(p),m=await se(b),x=this.uint8ArrayToHex(m),y=Array.from(this.activeNodes).filter(w=>w.startsWith("node-")),g=y.length>0?y.length:1,f=await be(p,Array.from(this.keypair),g),v=[];for(let w=0;w<f.length;w++){const M=f[w],j=await xe(M),ae=this.uint8ArrayToHex(j);v.push(ae)}const P={...e,chunk_count:f.length,isPremium:r,priceUsd:r?c:0},D={metadata:P,chunks:v};this.knownObjects.set(x,D),await this.dbPut("store",{id:x,value:JSON.stringify(D)});for(let w=0;w<f.length;w++){const M=f[w],j=v[w];await this.publishChunk(j,M,w,f.length)}return this.activeNodes.size>0?this.broadcastIP(x,P,v):await this.queueOfflineOperation({type:"publishIP",ipHash:x,metadata:P,chunkHashes:v}),x}catch(n){throw console.error("publishIP failed:",n),n}}broadcastIP(e,t,s){const n={type:"ip",ipHash:e,metadata:t,chunkHashes:s,peerId:this.peerId};this.broadcast(n),console.log(`Broadcasted IP ${e} to ${this.activeNodes.size} peers`)}async requestData(e){if(!this.db)throw new Error("IndexedDB not initialized");try{if(!e||typeof e!="string")throw new Error("Invalid IP hash");const t=this.knownObjects.get(e);if(!t)throw new Error("IP not found");const s=[];for(const d of t.chunks){const u=await this.dbGet("chunkCache",d);if(u&&u.value){s.push({chunk:u.value,hash:d});continue}const p=this.chunkToPeerMap.get(d);if(!p||p.size===0)throw new Error(`No peers found with chunk ${d}`);const b=Array.from(p).filter(g=>g.startsWith("node-")),m=Array.from(p).filter(g=>!g.startsWith("node-"));let x=!1,y=null;for(const g of[...b,...m])if(this.activeNodes.has(g))try{const f=await this.fetchChunkFromPeer(g,d);await this.dbPut("chunkCache",{id:d,value:f}),s.push({chunk:f,hash:d}),x=!0;break}catch(f){y=f,console.error(`Failed to fetch chunk ${d} from peer ${g}:`,f);continue}if(!x)throw y||new Error(`No available peer for chunk ${d}`)}const n=s.sort((d,u)=>{const p=Q(d.chunk),b=Q(u.chunk);return p-b}),r=[];for(const{chunk:d}of n){const u=await Ie(d,Array.from(this.keypair));r.push(u)}const c=new Uint8Array(r.reduce((d,u)=>d+u.length,0));let a=0;for(const d of r)c.set(d,a),a+=d.length;const i=ke(n[0].chunk);return{data:c,fileType:i}}catch(t){throw console.error("requestData failed:",t),t}}async fetchChunkFromPeer(e,t){const s=this.peers.get(e);if(!s||!s.connected||!s.conn)throw new Error(`Peer ${e} is not connected`);const n=`${e}-${t}-${Date.now()}`,r={type:"chunkRequest",requestId:n,chunkHash:t,peerId:this.peerId};return s.conn.send(r),new Promise((c,a)=>{this.pendingRequests.set(n,{resolve:c,reject:a,hash:t}),setTimeout(()=>{this.pendingRequests.has(n)&&(this.pendingRequests.delete(n),a(new Error(`Request for chunk ${t} from peer ${e} timed out`)))},1e4)})}handleChunkRequest(e,t){const{requestId:s,chunkHash:n}=e;this.dbGet("chunkCache",n).then(r=>{if(r&&r.value){const c={type:"chunkResponse",requestId:s,chunkHash:n,chunkData:r.value,peerId:this.peerId},a=this.peers.get(t);a&&a.connected&&a.conn&&(a.conn.send(c),console.log(`Sent chunk ${n} to peer ${t}`))}else console.warn(`Chunk ${n} not found for peer ${t}`)}).catch(r=>{console.error(`Failed to retrieve chunk ${n} for peer ${t}:`,r)})}handleChunkResponse(e){const{requestId:t,chunkHash:s,chunkData:n}=e,r=this.pendingRequests.get(t);r&&(r.hash===s?r.resolve(n):r.reject(new Error(`Received chunk hash ${s} does not match requested hash ${r.hash}`)),this.pendingRequests.delete(t))}async distributeCommission(e){const t=Array.from(this.activeNodes).filter(n=>n.startsWith("node-"));if(t.length===0){console.log("No active nodes to distribute commission to.");return}const s=e/t.length;console.log(`Distributing commission of ${e} to ${t.length} nodes (${s} per node)`);for(const n of t){const r=this.hexToUint8Array(n.replace("node-","")),a=await this.getBalance(r)+s;await this.putBalance(r,a),console.log(`Awarded ${s} to node ${n}. New balance: ${a}`);const i=this.peers.get(n);i&&i.connected&&i.conn&&i.conn.send({type:"commission",amount:s,newBalance:a,peerId:this.peerId})}}async getBalance(e){if(!this.db)throw new Error("IndexedDB not initialized");const t=await this.dbGet("store","balance_"+this.uint8ArrayToHex(e));return t&&t.value?parseFloat(t.value):0}async putBalance(e,t){if(!this.db)throw new Error("IndexedDB not initialized");if(typeof t!="number"||t<0)throw new Error("Invalid balance amount");await this.dbPut("store",{id:"balance_"+this.uint8ArrayToHex(e),value:t.toString()}),this.activeNodes.size>0&&this.broadcast({type:"userData",peerId:this.peerId,keypair:this.uint8ArrayToHex(this.keypair),balance:t,timestamp:Date.now()})}async updateBalance(){if(!this.db)throw new Error("IndexedDB not initialized");const e=await this.getBalance(this.keypair);await this.putBalance(this.keypair,e)}async queueOfflineOperation(e){if(!this.db)throw new Error("IndexedDB not initialized");this.offlineQueue.push(e),await this.dbAdd("offlineQueue",{id:Date.now().toString(),value:e}),console.log("Queued offline operation:",e)}async processOfflineQueue(){if(this.offlineQueue.length===0)return;console.log("Processing offline queue...");const e=[...this.offlineQueue];this.offlineQueue=[];const s=this.db.transaction("offlineQueue","readwrite").objectStore("offlineQueue");await new Promise(n=>{s.clear().onsuccess=n});for(const n of e)try{switch(n.type){case"publishChunk":await this.publishChunk(n.chunkHash,n.chunkData,n.chunkIndex,n.totalChunks);break;case"publishIP":await this.broadcastIP(n.ipHash,n.metadata,n.chunkHashes);break;default:console.warn("Unknown offline operation type:",n.type)}}catch(r){console.error(`Failed to process offline operation ${n.type}:`,r),this.offlineQueue.push(n),await this.dbAdd("offlineQueue",{id:Date.now().toString(),value:n})}}loadIdentity(){this.db&&this.dbGet("store","dcrypt_identity").then(e=>{e&&e.value&&typeof e.value=="string"&&(this.keypair=this.hexToUint8Array(e.value),console.log("Loaded identity from IndexedDB"))}).catch(e=>{console.error("Failed to load identity:",e)})}loadOfflineQueue(){this.db&&this.dbGetAll("offlineQueue").then(e=>{this.offlineQueue=e.map(t=>t.value),console.log("Loaded offline queue:",this.offlineQueue)}).catch(e=>{console.error("Failed to load offline queue:",e)})}loadTransactions(){this.db&&this.dbGetAll("transactions").then(e=>{console.log("Loaded transactions:",e)}).catch(e=>{console.error("Failed to load transactions:",e)})}async dbPut(e,t){if(!this.db)throw new Error("IndexedDB not initialized");return new Promise((s,n)=>{const a=this.db.transaction(e,"readwrite").objectStore(e).put(t);a.onsuccess=()=>s(),a.onerror=i=>n(new Error(`DB put failed: ${i.target.error.message}`))})}async dbAdd(e,t){if(!this.db)throw new Error("IndexedDB not initialized");return new Promise((s,n)=>{const a=this.db.transaction(e,"readwrite").objectStore(e).add(t);a.onsuccess=()=>s(),a.onerror=i=>n(new Error(`DB add failed: ${i.target.error.message}`))})}async dbGet(e,t){if(!this.db)throw new Error("IndexedDB not initialized");return new Promise((s,n)=>{const a=this.db.transaction(e,"readonly").objectStore(e).get(t);a.onsuccess=()=>s(a.result),a.onerror=i=>n(new Error(`DB get failed: ${i.target.error.message}`))})}async dbGetAll(e){if(!this.db)throw new Error("IndexedDB not initialized");return new Promise((t,s)=>{const c=this.db.transaction(e,"readonly").objectStore(e).getAll();c.onsuccess=()=>t(c.result),c.onerror=a=>s(new Error(`DB getAll failed: ${a.target.error.message}`))})}uint8ArrayToHex(e){return Array.from(e).map(t=>t.toString(16).padStart(2,"0")).join("")}hexToUint8Array(e){if(!e||typeof e!="string")return new Uint8Array(0);const t=e.match(/.{1,2}/g);return t?new Uint8Array(t.map(s=>parseInt(s,16))):new Uint8Array(0)}broadcast(e){this.peers.forEach((t,s)=>{t.connected&&t.conn&&t.conn.send(e)})}}function ve(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(o){const e=Math.random()*16|0;return(o==="x"?e:e&3|8).toString(16)})}async function Be(){const o=[];for(let t=0;t<3;t++){const s=`node-test-${ve()}`;console.log(`Initializing test peer with ID: ${s}`);const n=new ne(s,{host:"0.peerjs.com",port:443,path:"/",secure:!0,debug:2}),r=new Promise((c,a)=>{n.on("open",()=>{console.log(`Test peer ${s} opened`),o.push({peer:n,peerId:s}),c()}),n.on("error",i=>{console.error(`Test peer ${s} error:`,i),a(i)}),n.on("disconnected",()=>{console.log(`Test peer ${s} disconnected`)})});try{await r}catch(c){console.error(`Failed to initialize test peer ${s}:`,c)}}return o}(window.location.pathname==="/datasharingApp/signup.html"||window.location.pathname==="/signup.html")&&document.addEventListener("DOMContentLoaded",()=>{const o=document.getElementById("signupButton");if(!o){console.error("Sign-up button not found");return}o.addEventListener("click",Se)});async function Se(){K(!0);try{const o=new G,t=(await le(S,o)).user;if(console.log("Signed up user UID:",t.uid),document.querySelector('input[name="role"]:checked').value==="node"){const r=B(I,"nodes",t.uid);await $(r,{uid:t.uid,createdAt:Date.now(),status:"active"}),console.log("User registered as a node"),_("Signed up as a node successfully!"),window.location.href="/datasharingApp/node-instructions.html"}else{const r=B(I,"users",t.uid);await $(r,{uid:t.uid,createdAt:Date.now(),balance:0},{merge:!0}),console.log("User registered as a regular user"),_("Signed up successfully!"),window.location.href="/datasharingApp/index.html"}}catch(o){console.error("Sign-up failed:",o),_(`Sign-up failed: ${o.message}`)}finally{K(!1)}}function _(o){const e=document.getElementById("toast");e&&(e.textContent=o,e.style.display="block",setTimeout(()=>{e.style.display="none"},3e3))}function K(o){const e=document.getElementById("loading");e&&(e.style.display=o?"flex":"none")}if(window.location.pathname==="/datasharingApp/node-instructions.html"||window.location.pathname==="/node-instructions.html"){let o;document.addEventListener("DOMContentLoaded",async()=>{Y(!0);try{const e=localStorage.getItem("nodeId");if(localStorage.getItem("role")!=="node"||!e){J("You must be signed in as a node to view this page."),window.location.href="/datasharingApp/signup.html";return}const n=new TextEncoder().encode(e);o=new re(n,!0),await o.initDB(),await o.initSwarm(),await o.syncUserData();const c=(await o.dbGetAll("transactions")).filter(i=>i.type==="commission").reduce((i,d)=>i+(d.amount||0),0),a=document.getElementById("nodeEarnings");a&&(a.textContent=`Total Earnings: ${c.toFixed(2)} DCT`)}catch(e){console.error("Error initializing node instructions:",e),J(`Initialization failed: ${e.message}`)}finally{Y(!1)}})}function J(o){const e=document.getElementById("toast");e&&(e.textContent=o,e.style.display="block",setTimeout(()=>{e.style.display="none"},3e3))}function Y(o){const e=document.getElementById("loading");e&&(e.style.display=o?"flex":"none")}self.addEventListener("install",o=>{o.waitUntil(caches.open("dcrypt-v1").then(e=>e.addAll(["/","/index.html","/assets/index.js","/wasm/dcrypt_wasm.js","/wasm/dcrypt_wasm_bg.wasm"])))});self.addEventListener("fetch",o=>{o.respondWith(caches.match(o.request).then(e=>e||fetch(o.request).catch(()=>caches.match("/index.html"))))});self.addEventListener("message",async o=>{if(o.data.type==="cache_chunk"){const{chunkHash:e,data:t}=o.data,s=await caches.open("dcrypt-chunks"),n=new Blob([t],{type:"application/octet-stream"}),r=new Response(n,{headers:{"Content-Type":"application/octet-stream"}});await s.put(`/chunks/${e}`,r),console.log(`Service Worker: Cached chunk ${e}`)}});self.addEventListener("fetch",o=>{const e=new URL(o.request.url);e.pathname.startsWith("/chunks/")?o.respondWith(caches.open("dcrypt-chunks").then(t=>t.match(o.request).then(s=>s?(console.log(`Service Worker: Serving chunk ${e.pathname} from cache`),s):fetch(o.request).catch(()=>new Response("Chunk not available offline",{status:503}))))):o.respondWith(caches.match(o.request).then(t=>t||fetch(o.request).catch(()=>caches.match("/index.html"))))});let l=null,T=!1,E=0,q=[],A=!1;document.addEventListener("DOMContentLoaded",()=>{var x;const o=localStorage.getItem("role"),e=localStorage.getItem("nodeId");if(window.location.pathname.includes("index.html")&&o==="node"&&e){console.log("Node detected on index.html, redirecting to node-instructions.html"),window.location.href="/datasharingApp/node-instructions.html";return}const t=document.getElementById("signupButton"),s=document.getElementById("loginButton"),n=document.getElementById("logoutButton"),r=document.getElementById("userBalance"),c=document.getElementById("publishButton"),a=document.getElementById("searchButton"),i=document.getElementById("depositButton"),d=document.getElementById("withdrawButton"),u=document.getElementById("toggleHistoryButton"),p=document.getElementById("transactionHistory"),b=(x=document.getElementById("publishedItems"))==null?void 0:x.querySelector("tbody"),m=document.getElementById("buyHashButton");if(window.location.pathname.includes("index.html")){if(!t||!s||!n||!r||!c||!a||!i||!d||!u||!p||!b||!m){console.error("Required DOM elements not found:",{signupButton:!!t,loginButton:!!s,logoutButton:!!n,userBalanceElement:!!r,publishButton:!!c,searchButton:!!a,depositButton:!!i,withdrawButton:!!d,toggleHistoryButton:!!u,transactionHistory:!!p,publishedItemsTableBody:!!b,buyHashButton:!!m});return}o==="node"&&e&&(T=!0,console.log("Node detected, but should have been redirected already.")),ue(S,async y=>{if(y){console.log("User is signed in:",y.uid),t.classList.add("hidden"),s.classList.add("hidden"),n.classList.remove("hidden"),c.disabled=!1,a.disabled=!1,i.disabled=!1,d.disabled=!1,u.disabled=!1,m.disabled=!1;const g=localStorage.getItem("pendingRole")||"user";if(localStorage.removeItem("pendingRole"),g==="user"){const f=B(I,"users",y.uid);await $(f,{role:"user",createdAt:Date.now(),balance:0},{merge:!0}),window.location.href="/datasharingApp/index.html"}else{const f=De();localStorage.setItem("nodeId",f),localStorage.setItem("role","node");const v=B(I,"nodes",f);await $(v,{role:"node",createdAt:Date.now(),status:"active"},{merge:!0}),window.location.href="/datasharingApp/node-instructions.html"}await V(y.uid)}else{console.log("No user is signed in. Checking IndexedDB for keypair...");const g=indexedDB.open("dcrypt_db",3);g.onsuccess=async()=>{const D=g.result.transaction("store","readonly").objectStore("store").get("dcrypt_identity");D.onsuccess=async()=>{D.result&&D.result.value?(new TextEncoder().encode(D.result.value),console.log("Found keypair in IndexedDB, initializing app..."),t.classList.add("hidden"),s.classList.add("hidden"),n.classList.remove("hidden"),c.disabled=!1,a.disabled=!1,i.disabled=!1,d.disabled=!1,u.disabled=!1,m.disabled=!1,await V(D.result.value)):(console.log("No keypair found in IndexedDB."),t.classList.remove("hidden"),s.classList.remove("hidden"),n.classList.add("hidden"),c.disabled=!0,a.disabled=!0,i.disabled=!0,d.disabled=!0,u.disabled=!0,m.disabled=!0,L())},D.onerror=()=>{console.error("Failed to load keypair from IndexedDB"),t.classList.remove("hidden"),s.classList.remove("hidden"),n.classList.add("hidden"),c.disabled=!0,a.disabled=!0,i.disabled=!0,d.disabled=!0,u.disabled=!0,m.disabled=!0,L()}},g.onerror=()=>{console.error("Failed to open IndexedDB"),t.classList.remove("hidden"),s.classList.remove("hidden"),n.classList.add("hidden"),c.disabled=!0,a.disabled=!0,i.disabled=!0,d.disabled=!0,u.disabled=!0,m.disabled=!0,L()}}}),console.log("Attaching event listener to loginButton"),s.addEventListener("click",()=>{console.log("Login button clicked"),$e()}),n.addEventListener("click",Z)}window.logout=Z,window.publishSnippet=Ce,window.buySnippet=ie,window.buySnippetByHash=Ae,window.searchSnippets=Ue,window.deposit=Re,window.withdraw=Ne,window.toggleTransactionHistory=qe,window.flagSnippet=Le,window.handleSignup=Pe});function De(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(o){const e=Math.random()*16|0;return(o==="x"?e:e&3|8).toString(16)})}async function Pe(){var s;if(A){console.log("Signup already in progress, ignoring additional clicks");return}A=!0;const o=document.querySelector('button[onclick="window.handleSignup()"]');o&&(o.disabled=!0,o.textContent="Signing Up...");const e=document.querySelectorAll('input[name="role"]');if(!e){h("Role selection not found.",!0),A=!1,o&&(o.disabled=!1,o.textContent="Sign Up with Google");return}const t=(s=Array.from(e).find(n=>n.checked))==null?void 0:s.value;if(!t){h("Please select a role.",!0),A=!1,o&&(o.disabled=!1,o.textContent="Sign Up with Google");return}localStorage.setItem("pendingRole",t);try{const n=new G;await ee(S,n)}catch(n){console.error("Handling user signup with OAuth..."),console.error("Signup failed:",n),h(`Sign-up failed: ${n.message}`,!0),A=!1,o&&(o.disabled=!1,o.textContent="Sign Up with Google")}}async function V(o){console.log("Initializing app..."),k(!0);try{let e;const t=indexedDB.open("dcrypt_db",3);await new Promise((s,n)=>{t.onsuccess=()=>{const r=t.result,i=r.transaction("store","readonly").objectStore("store").get("dcrypt_identity");i.onsuccess=()=>{if(i.result&&i.result.value)e=new TextEncoder().encode(i.result.value),console.log("Loaded keypair from IndexedDB:",i.result.value);else if(o)e=new TextEncoder().encode(o),r.transaction("store","readwrite").objectStore("store").put({id:"dcrypt_identity",value:o});else{n(new Error("No user ID or stored keypair found"));return}s()},i.onerror=()=>n(new Error("Failed to load keypair from IndexedDB"))},t.onerror=()=>n(new Error("Failed to open IndexedDB"))}),T||(T=await Ee(o)),console.log(`User is ${T?"":"not "}a node.`),q.length===0&&(console.log("Creating test peers..."),q=await Be(),console.log("Test peers created:",q.map(s=>s.peerId))),console.log("Initializing DHT..."),l=new re(e,T),window.dht=l,await l.initDB(),console.log("IndexedDB initialized."),await l.initSwarm(),console.log("DHT initialized."),await l.syncUserData(),console.log("User data synced."),z(),console.log("Live feed updated."),N(),R()}catch(e){console.error("Error initializing application:",e),h(`Initialization failed: ${e.message}`,!0),l=null,window.dht=null,E=0,L()}finally{k(!1),Fe()}}async function Ee(o){try{const e=B(I,"nodes",o);return(await te(e)).exists()}catch(e){return console.error("Failed to check node status:",e),!1}}async function $e(){console.log("signIn function called");try{const o=new G;console.log("Initiating signInWithRedirect"),await ee(S,o),console.log("signInWithRedirect completed")}catch(o){console.error("Handling user login with OAuth..."),console.error("Login failed:",o),h(`Login failed: ${o.message}`,!0)}}async function Z(){try{localStorage.getItem("role")==="node"?(localStorage.removeItem("nodeId"),localStorage.removeItem("role"),h("Node signed out successfully!")):(await he(S),h("Signed out successfully!"));const o=indexedDB.open("dcrypt_db",3);o.onsuccess=()=>{o.result.transaction("store","readwrite").objectStore("store").delete("dcrypt_identity")},l=null,window.dht=null,q=[],E=0,L()}catch(o){console.error("Sign-out failed:",o),h(`Sign-out failed: ${o.message}`,!0)}}function U(){return!!S.currentUser||localStorage.getItem("role")==="node"}async function Ce(o,e,t,s,n){var r;if(!U()){h("Please sign in to publish.");return}k(!0);try{if(!l)throw new Error("DHT not initialized");if(!o)throw new Error("Title is required");let c=s||"",a="text/plain";if(n&&n.files&&n.files.length>0){const y=n.files[0];a=y.type||"application/octet-stream";const g=new FileReader;c=await new Promise((f,v)=>{g.onload=P=>f(new Uint8Array(P.target.result)),g.onerror=P=>v(new Error("Failed to read file")),g.readAsArrayBuffer(y)})}else c=new TextEncoder().encode(c);const i=document.getElementById("isPremium").checked,d=document.getElementById("priceInput"),u=i&&d&&parseFloat(d.value)||0,p={content_type:o,description:e||"",tags:t?t.split(",").map(y=>y.trim()):[],isPremium:i,priceUsd:u},b=await l.publishIP(p,c,a),m=((r=S.currentUser)==null?void 0:r.uid)||localStorage.getItem("nodeId"),x=B(I,"snippets",b);await $(x,{ipHash:b,flagCount:0,averageRating:0,reviewStatus:"active",createdAt:Date.now(),creatorId:m},{merge:!0}),h("Snippet published successfully!"),z(),R(),N(),await O()}catch(c){console.error("publishSnippet failed:",c),h(`Publish failed: ${c.message}`,!0)}finally{k(!1)}}async function ie(o){if(!U())return h("Please sign in to buy."),null;k(!0);try{if(!l)throw new Error("DHT not initialized");if(!o)throw new Error("Hash is required");const e=l.knownObjects.get(o);if(!e)throw new Error("Snippet not found");const n=(e.metadata.isPremium||!1)&&e.metadata.priceUsd||0;if(n>0){const i=await l.getBalance(l.keypair);if(i<n)throw new Error("Insufficient balance");const d=n*.05;await l.distributeCommission(d),await l.putBalance(l.keypair,i-n),await l.dbAdd("transactions",{type:"buy",amount:n,timestamp:Date.now()})}else console.log("This snippet is free!"),await l.dbAdd("transactions",{type:"buy",amount:0,timestamp:Date.now()});const{data:r,fileType:c}=await l.requestData(o);h("Snippet retrieved successfully!"),R(),N(),await O();const a=prompt("Please rate this snippet (1-5 stars):","5");if(a!==null){const i=parseInt(a);i>=1&&i<=5?(await Te(o,i),h(`Rated ${i} stars!`),z()):h("Invalid rating. Please enter a number between 1 and 5.",!0)}return He(r,c,e.metadata.content_type),{data:r,fileType:c}}catch(e){return console.error("buySnippet failed:",e),h(`Purchase failed: ${e.message}`,!0),null}finally{k(!1)}}async function Ae(o){const e=o||document.getElementById("buyHashInput").value.trim();if(!e){h("Please enter a valid hash.",!0);return}await ie(e)&&h("Snippet purchased and displayed below!")}async function Te(o,e){var s;const t=((s=S.currentUser)==null?void 0:s.uid)||localStorage.getItem("nodeId");if(t)try{const n=B(I,"snippets",o,"ratings",t);await $(n,{rating:e,timestamp:Date.now()});const c=(await F(H(I,"snippets",o,"ratings"))).docs.map(d=>d.data().rating),a=c.length>0?c.reduce((d,u)=>d+u,0)/c.length:0,i=B(I,"snippets",o);await W(i,{averageRating:a.toFixed(1)})}catch(n){console.error("Failed to submit rating:",n),h(`Failed to submit rating: ${n.message}`,!0)}}async function Le(o){var t;if(!(((t=S.currentUser)==null?void 0:t.uid)||localStorage.getItem("nodeId"))){h("Please sign in to flag content.");return}try{const s=B(I,"snippets",o);await W(s,{flagCount:fe(1)}),((await te(s)).data().flagCount||0)>=3?(await W(s,{reviewStatus:"under_review"}),h("Snippet has been flagged and is under review."),z()):h("Snippet flagged. It will be reviewed if flagged by more users.")}catch(s){console.error("Failed to flag snippet:",s),h(`Failed to flag snippet: ${s.message}`,!0)}}async function Ue(o){if(!U()){h("Please sign in to search.");return}k(!0);try{if(!l)throw new Error("DHT not initialized");if(!o)throw new Error("Search query is required");console.log("Starting search with query:",o),console.log("dht.knownObjects size:",l.knownObjects.size),console.log("dht.knownObjects:",Array.from(l.knownObjects.entries()));const e=document.getElementById("publishedItems").querySelector("tbody");e.innerHTML="";const t=await F(H(I,"snippets")),s={};t.forEach(r=>{s[r.id]=r.data()}),console.log("Snippets from Firestore:",s);let n=!1;l.knownObjects.forEach((r,c)=>{const{content_type:a,description:i,tags:d}=r.metadata,u=o.toLowerCase(),p=s[c]||{averageRating:0,reviewStatus:"active"};if(console.log(`Checking snippet ${c}:`,{content_type:a,description:i,tags:d,reviewStatus:p.reviewStatus}),p.reviewStatus==="active"&&(a.toLowerCase().includes(u)||i&&i.toLowerCase().includes(u)||d&&d.some(b=>b.toLowerCase().includes(u)))){n=!0;const m=(r.metadata.isPremium||!1)&&r.metadata.priceUsd||0,x=m>0?`${m} DCT`:"Free",y=document.createElement("tr");y.innerHTML=`
          <td class="py-2 px-4">${a}</td>
          <td class="py-2 px-4">${i||"No description"}</td>
          <td class="py-2 px-4">${d.join(", ")||"No tags"}</td>
          <td class="py-2 px-4">${p.averageRating} / 5</td>
          <td class="py-2 px-4">
            <button onclick="window.buySnippet('${c}')" class="bg-purple-500 text-white rounded hover:bg-purple-600 px-3 py-1 mr-2">Get (${x})</button>
            <button onclick="window.flagSnippet('${c}')" class="bg-red-500 text-white rounded hover:bg-red-600 px-3 py-1">Flag</button>
          </td>
        `,e.appendChild(y),console.log(`Found matching snippet ${c}`)}}),h(n?"Search completed!":"No snippets found matching your search.")}catch(e){console.error("searchSnippets failed:",e),h(`Search failed: ${e.message}`,!0)}finally{k(!1)}}async function Re(o){if(!U()){h("Please sign in to deposit.");return}k(!0);try{if(!l)throw new Error("DHT not initialized");if(!o||o<=0)throw new Error("Invalid deposit amount");const t=await l.getBalance(l.keypair)+o;await l.putBalance(l.keypair,t),await l.dbAdd("transactions",{type:"deposit",amount:o,timestamp:Date.now()}),h(`Deposited ${o} DCT successfully!`),R(),N(),await O()}catch(e){console.error("deposit failed:",e),h(`Deposit failed: ${e.message}`,!0)}finally{k(!1)}}async function Ne(o){if(!U()){h("Please sign in to withdraw.");return}k(!0);try{if(!l)throw new Error("DHT not initialized");if(!o||o<=0)throw new Error("Invalid withdrawal amount");const e=await l.getBalance(l.keypair);if(e<o)throw new Error("Insufficient balance");await l.putBalance(l.keypair,e-o),await l.dbAdd("transactions",{type:"withdraw",amount:o,timestamp:Date.now()}),h(`Withdrew ${o} DCT successfully!`),R(),N(),await O()}catch(e){console.error("withdraw failed:",e),h(`Withdrawal failed: ${e.message}`,!0)}finally{k(!1)}}function qe(){const o=document.getElementById("transactionHistory");o.style.display==="none"?o.style.display="block":o.style.display="none"}async function O(){var e;const o=((e=S.currentUser)==null?void 0:e.uid)||localStorage.getItem("nodeId");if(o)try{const t=B(I,"users",o),s=l?await l.getBalance(l.keypair):0;await $(t,{balance:s,lastUpdated:Date.now()},{merge:!0}),console.log("User data uploaded to Firebase")}catch(t){console.error("Failed to upload user data to Firebase:",t)}}function z(){var e;const o=(e=document.getElementById("publishedItems"))==null?void 0:e.querySelector("tbody");o&&(o.innerHTML="",F(H(I,"snippets")).then(t=>{const s={};t.forEach(n=>{s[n.id]=n.data()}),l&&l.knownObjects.forEach((n,r)=>{const c=s[r]||{averageRating:0,reviewStatus:"active"};if(c.reviewStatus!=="active")return;const i=(n.metadata.isPremium||!1)&&n.metadata.priceUsd||0,d=i>0?`${i} DCT`:"Free",u=document.createElement("tr");u.innerHTML=`
          <td class="py-2 px-4">${n.metadata.content_type}</td>
          <td class="py-2 px-4">${n.metadata.description||"No description"}</td>
          <td class="py-2 px-4">${n.metadata.tags.join(", ")||"No tags"}</td>
          <td class="py-2 px-4">${c.averageRating} / 5</td>
          <td class="py-2 px-4">
            <button onclick="window.buySnippet('${r}')" class="bg-purple-500 text-white rounded hover:bg-purple-600 px-3 py-1 mr-2">Get (${d})</button>
            <button onclick="window.flagSnippet('${r}')" class="bg-red-500 text-white rounded hover:bg-red-600 px-3 py-1">Flag</button>
          </td>
        `,o.appendChild(u)})}).catch(t=>{console.error("Failed to update live feed:",t),h("Failed to load live feed.",!0)}))}function R(){const o=document.getElementById("transactionList");if(o){if(!l){o.innerHTML="Not initialized.";return}l.dbGetAll("transactions").then(e=>{if(e.length===0){o.innerHTML="No transactions yet.";return}o.innerHTML=e.map(t=>`<p class="py-1">${t.type} - ${t.amount} DCT - ${new Date(t.timestamp).toLocaleString()}</p>`).join("")}).catch(e=>{console.error("Failed to update transaction history:",e),o.innerHTML="Failed to load transactions."})}}function N(){const o=document.getElementById("userBalance");if(o){if(!l){o.textContent="Balance: 0 DCT",E=0;return}l.getBalance(l.keypair).then(e=>{E=e||0,o.textContent=`Balance: ${E} DCT`}).catch(e=>{console.error("Failed to update balance:",e),o.textContent="Balance: 0 DCT",E=0})}}function L(){var s;const o=(s=document.getElementById("publishedItems"))==null?void 0:s.querySelector("tbody"),e=document.getElementById("transactionList"),t=document.getElementById("userBalance");o&&(o.innerHTML=""),e&&(e.innerHTML="No transactions yet."),t&&(t.textContent="Balance: 0 DCT"),E=0}function h(o,e=!1){const t=document.getElementById("toast");t&&(t.textContent=o,t.className="toast",e&&t.classList.add("error-toast"),t.style.display="block",setTimeout(()=>{t.style.display="none"},3e3))}function k(o){const e=document.getElementById("loading");e&&(e.style.display=o?"flex":"none")}function Fe(){const o=document.getElementById("isPremium"),e=document.getElementById("priceInput");o&&e&&o.addEventListener("change",t=>{console.log("Premium toggle:",t.target.checked),e.classList.toggle("hidden",!t.target.checked),t.target.checked||(e.value="")})}function He(o,e,t){const s=document.getElementById("snippetDisplay");if(!s)return;s.innerHTML="";const n=document.createElement("div");n.className="p-4 bg-gray-800 rounded-lg mt-4";const r=document.createElement("h3");if(r.className="text-lg font-semibold mb-2",r.textContent=t||"Snippet Content",n.appendChild(r),e.startsWith("text")){const c=new TextDecoder().decode(o),a=document.createElement("pre");a.className="text-sm text-gray-300 whitespace-pre-wrap",a.textContent=c,n.appendChild(a)}else if(e.startsWith("image")){const c=new Blob([o],{type:e}),a=URL.createObjectURL(c),i=document.createElement("img");i.src=a,i.className="max-w-full h-auto rounded",i.onload=()=>URL.revokeObjectURL(a),n.appendChild(i)}else{const c=new Blob([o],{type:e}),a=URL.createObjectURL(c),i=document.createElement("a");i.href=a,i.download=t||"downloaded_file",i.className="text-blue-400 hover:underline",i.textContent="Download File",i.onclick=()=>setTimeout(()=>URL.revokeObjectURL(a),1e3),n.appendChild(i)}s.appendChild(n)}
